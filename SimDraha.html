<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CNC SmartGrid CAM</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Fonty -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #374151; overflow: hidden; touch-action: none; user-select: none; -webkit-user-select: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; }
        ::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 4px; }
        .no-select { user-select: none; -webkit-touch-callout: none; }
        
        @keyframes slideIn {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useRef, useEffect, useMemo } = React;

        // --- UI HELPERY ---
        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);
            return (
                <div className="fixed bottom-4 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg z-[60] text-sm font-semibold toast-enter flex items-center gap-2">
                    <span>{message}</span>
                </div>
            );
        };

        const ConfirmDialog = ({ message, onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
                <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-200">
                    <h3 className="text-lg font-bold text-gray-900 mb-2">Potvrzení</h3>
                    <p className="text-gray-600 mb-6">{message}</p>
                    <div className="flex justify-end gap-3">
                        <button onClick={onCancel} className="px-4 py-2 text-gray-600 font-semibold hover:bg-gray-100 rounded-lg transition-colors">Zrušit</button>
                        <button onClick={onConfirm} className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 shadow-md transition-colors">Ano, provést</button>
                    </div>
                </div>
            </div>
        );

        // --- IKONY ---
        const Icon = ({ path, size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>
        );
        
        const Icons = {
            Menu: (p) => <Icon {...p} path={<><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></>} />,
            Close: (p) => <Icon {...p} path={<><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></>} />,
            Settings: (p) => <Icon {...p} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.35a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />,
            Upload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></>} />,
            Trash2: (p) => <Icon {...p} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />,
            Play: (p) => <Icon {...p} path={<polygon points="5 3 19 12 5 21 5 3"/>} />,
            Download: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></>} />,
            Plus: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />,
            Target: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="22" y1="12" x2="18" y2="12"/><line x1="6" y1="12" x2="2" y2="12"/><line x1="12" y1="6" x2="12" y2="2"/><line x1="12" y1="22" x2="12" y2="18"/></>} />,
            Diameter: (p) => <Icon {...p} path={<><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></>} />,
            Radius: (p) => <Icon {...p} path={<><path d="M19 12a7 7 0 0 0-7-7" /><circle cx="12" cy="12" r="1" /><line x1="12" y1="12" x2="12" y2="5" /></>} />,
            FileJson: (p) => <Icon {...p} path={<><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></>} />,
            Save: (p) => <Icon {...p} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></>} />,
            CloudDownload: (p) => <Icon {...p} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></>} />,
            Refresh: (p) => <Icon {...p} path={<><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></>} />,
            Layers: (p) => <Icon {...p} path={<><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></>} />,
            CheckCircle: (p) => <Icon {...p} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></>} />,
            Box: (p) => <Icon {...p} path={<><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></>} />,
            ArrowUp: (p) => <Icon {...p} path={<><line x1="12" y1="19" x2="12" y2="5" /><polyline points="5 12 12 5 19 12" /></>} />,
            ArrowDown: (p) => <Icon {...p} path={<><line x1="12" y1="5" x2="12" y2="19" /><polyline points="19 12 12 19 5 12" /></>} />,
            ArrowLeft: (p) => <Icon {...p} path={<><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></>} />,
            ArrowRight: (p) => <Icon {...p} path={<><line x1="5" y1="12" x2="19" y2="12" /><polyline points="12 5 19 12 12 19" /></>} />,
            ArrowUpRight: (p) => <Icon {...p} path={<><line x1="7" y1="17" x2="17" y2="7" /><polyline points="7 7 17 7 17 17" /></>} />,
            ArrowUpLeft: (p) => <Icon {...p} path={<><line x1="17" y1="17" x2="7" y2="7" /><polyline points="7 17 7 7 17 7" /></>} />,
            ArrowDownRight: (p) => <Icon {...p} path={<><line x1="7" y1="7" x2="17" y2="17" /><polyline points="17 7 17 17 7 17" /></>} />,
            ArrowDownLeft: (p) => <Icon {...p} path={<><line x1="17" y1="7" x2="7" y2="17" /><polyline points="17 17 7 17 7 7" /></>} />,
            Tool: (p) => <Icon {...p} path={<><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></>} />,
        };

        // --- KONFIGURACE ---
        // finishAllowance - přídavek na hotovo
        const DEFAULT_SETTINGS = { feedRate: 200, spindleSpeed: 800, toolDiameter: 0, safeZ: 10, feedMode: 'MM_MIN', offsetValue: 1.2, finishAllowance: 0.2 };
        const INITIAL_VB = { x: -50, y: -200, w: 400, h: 300 };

        const DEFAULT_MACHINING = {
            startX: 150,
            startZ: 250,
            direction: 'HORIZONTAL', 
            depth: 2.0,
            angle: 15, 
            retract: 0.5,
            safetyDist: 2.0, // Bezpečnostní vzdálenost
            maxRPM: 2500,    // Limit otáček G50
            coolant: false   // Chlazení M08
        };

        const DEMO_POINTS = [
            { id: 1, x: 0, z: 200, type: 'line', break: true },
            { id: 2, x: 50, z: 200, type: 'line', break: false },
            { id: 3, x: 50, z: 150, type: 'line', break: false },
            { id: 4, x: 70, z: 150, type: 'line', break: false },
            { id: 5, x: 80, z: 130, type: 'line', break: false },
            { id: 6, x: 80, z: 50, type: 'line', break: false },
            { id: 7, x: 100, z: 50, type: 'line', break: false },
            { id: 8, x: 100, z: 0, type: 'line', break: false },
            { id: 9, x: 0, z: 0, type: 'line', break: false },
            { id: 10, x: 0, z: 200, type: 'axis', break: false }
        ];

        // --- CALCULATION LOGIC ---
        const calculateOffsetPath = (points, offset) => {
            if (!points || points.length < 2) return [];

            const offsetPoints = [];
            let i = 0;

            const sub = (p1, p2) => ({ x: p1.x - p2.x, z: p1.z - p2.z });
            const add = (p1, p2) => ({ x: p1.x + p2.x, z: p1.z + p2.z });
            const normalize = (v) => {
                const len = Math.hypot(v.x, v.z);
                return len === 0 ? {x:0, z:0} : { x: v.x / len, z: v.z / len };
            };
            const getNormal = (p1, p2) => {
                const dx = p2.x - p1.x;
                const dz = p2.z - p1.z;
                return normalize({ x: -dz, z: dx });
            };

            while (i < points.length) {
                const p = points[i];
                if (p.type === 'axis') {
                    i++; continue;
                }
                let j = i + 1;
                while (j < points.length && !points[j].break && points[j].type !== 'axis') {
                    j++;
                }
                const chain = points.slice(i, j);
                if (chain.length < 2) { i = j; continue; }

                for (let k = 0; k < chain.length; k++) {
                    const curr = chain[k];
                    if (k === 0) {
                        const next = chain[k+1];
                        const n = getNormal(curr, next);
                        offsetPoints.push({ x: curr.x + n.x * offset, z: curr.z + n.z * offset, break: true });
                    }
                    else if (k === chain.length - 1) {
                        const prev = chain[k-1];
                        const n = getNormal(prev, curr);
                        offsetPoints.push({ x: curr.x + n.x * offset, z: curr.z + n.z * offset, break: false });
                    }
                    else {
                        const prev = chain[k-1];
                        const next = chain[k+1];
                        const n1 = getNormal(prev, curr);
                        const n2 = getNormal(curr, next);
                        const tangent = normalize(add(n1, n2));
                        const dot = n1.x * tangent.x + n1.z * tangent.z;
                        const miterLen = offset / (dot || 1);
                        const finalLen = Math.min(miterLen, offset * 5); 
                        offsetPoints.push({ x: curr.x + tangent.x * finalLen, z: curr.z + tangent.z * finalLen, break: false });
                    }
                }
                i = j;
            }
            return offsetPoints;
        };

        const parseDXF = (text) => {
            const lines = text.split(/\r\n|\r|\n/).map(l => l.trim());
            let points = [];
            let idCounter = 1;
            let i = 0;
            while (i < lines.length) {
                if (lines[i] === "2" && lines[i + 1] === "ENTITIES") { i += 2; break; }
                i++;
            }
            while (i < lines.length) {
                if (lines[i] === "0" && lines[i + 1] === "ENDSEC") break;
                if (lines[i] === "0") {
                    const type = lines[i + 1]; i += 2;
                    if (type === "LINE") {
                        let x1=0, z1=0, x2=0, z2=0;
                        while (lines[i] !== "0" && i < lines.length) {
                            const code = parseInt(lines[i]); const val = lines[i + 1]; i += 2;
                            if (code === 10) x1 = parseFloat(val); else if (code === 20) z1 = parseFloat(val); 
                            else if (code === 11) x2 = parseFloat(val); else if (code === 21) z2 = parseFloat(val);
                        }
                        points.push({ id: idCounter++, x: x1, z: z1, type: 'line', break: true });
                        points.push({ id: idCounter++, x: x2, z: z2, type: 'line', break: false });
                    } else { while (lines[i] !== "0" && i < lines.length) i += 2; }
                } else { i++; }
            }
            return points;
        };

        const generateGCode = (points, settings, machiningSettings) => {
            const { feedRate, spindleSpeed, feedMode } = settings;
            const { safetyDist, maxRPM, coolant } = machiningSettings || DEFAULT_MACHINING; // Fallback
            const date = new Date().toLocaleDateString('cs-CZ');
            const feedCmd = feedMode === 'MM_REV' ? 'G95' : 'G94';
            
            let gcode = `%; Program: ${date}\n`;
            gcode += `G21 (Metric)\n`;
            gcode += `G50 S${maxRPM} (Max RPM)\n`; // G50 Limit
            gcode += `${feedCmd} S${spindleSpeed} M03\n`;
            if (coolant) gcode += `M08 (Coolant ON)\n`;
            
            // Nájezd na bezpečný bod (z Machining Settings nebo default)
            const startX = machiningSettings?.startX || 150;
            const startZ = machiningSettings?.startZ || 250;
            gcode += `G00 X${startX} Z${startZ}\n`;

            points.forEach((p, index) => {
                if (p.type === 'axis') return;
                if (p.break || index === 0) {
                    // Aplikovat bezpečnostní vzdálenost před první bod?
                    // Pro jednoduchost zatím přímo na bod, ale v reálu by se jelo G00 kousek před
                    gcode += `G00 X${p.x.toFixed(3)} Z${p.z.toFixed(3)}\n`;
                } else {
                    if (p.type === 'line') gcode += `G01 X${p.x.toFixed(3)} Z${p.z.toFixed(3)} F${feedRate}\n`;
                    else if (p.type === 'arc') {
                        const r = p.r !== undefined ? `R${p.r.toFixed(3)}` : '';
                        const cmd = p.cw ? 'G02' : 'G03';
                        gcode += `${cmd} X${p.x.toFixed(3)} Z${p.z.toFixed(3)} ${r} F${feedRate}\n`;
                    }
                }
            });

            if (coolant) gcode += `M09 (Coolant OFF)\n`;
            gcode += `G00 X${startX} Z${startZ}\n`; // Odjezd
            gcode += `M30\n%`;
            return gcode;
        };

        const ToolbarButton = ({ icon: IconComp, label, onClick, active, color = "text-gray-500" }) => (
            <button 
                onClick={onClick}
                className={`flex flex-col items-center justify-center p-3 m-1 rounded-xl shadow-sm border transition-transform active:scale-95 ${active ? 'bg-orange-50 border-orange-500' : 'bg-white border-gray-200'}`}
            >
                <IconComp size={26} className={`mb-1 ${active ? 'text-orange-600' : color}`} />
                <span className={`text-[9px] font-bold uppercase tracking-wider ${active ? 'text-orange-600' : 'text-gray-500'}`}>{label}</span>
            </button>
        );

        // --- MODAL KOREKCE ---
        const OffsetModal = ({ isOpen, onClose, toolRadius, finishAllowance, onConfirm, onDisable }) => {
            const [localRadius, setLocalRadius] = useState(toolRadius);
            const [localAllowance, setLocalAllowance] = useState(finishAllowance);

            useEffect(() => {
                setLocalRadius(toolRadius);
                setLocalAllowance(finishAllowance);
            }, [toolRadius, finishAllowance, isOpen]);

            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-xs w-full p-6 animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Layers className="text-blue-600" size={24} /> Korekce</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-1"><Icons.Close size={20} /></button>
                        </div>
                        
                        <div className="space-y-4 mb-6">
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Rádius Plátku (mm)</label>
                                <input type="number" value={localRadius} onChange={(e) => setLocalRadius(parseFloat(e.target.value) || 0)} className="w-full bg-blue-50 border border-blue-200 rounded-lg p-2 text-xl font-mono font-bold text-blue-800 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none text-center" step={0.1} />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-500 uppercase mb-1 block">Přídavek na hotovo (mm)</label>
                                <input type="number" value={localAllowance} onChange={(e) => setLocalAllowance(parseFloat(e.target.value) || 0)} className="w-full bg-orange-50 border border-orange-200 rounded-lg p-2 text-xl font-mono font-bold text-orange-800 focus:border-orange-500 focus:ring-2 focus:ring-orange-200 outline-none text-center" step={0.1} />
                            </div>
                        </div>

                        <div className="flex flex-col gap-3">
                            <button onClick={() => onConfirm(localRadius, localAllowance)} className="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-all active:scale-95 flex items-center justify-center gap-2"><Icons.CheckCircle size={18} /> Použít Korekci</button>
                            <button onClick={onDisable} className="w-full py-3 bg-white border border-gray-200 hover:bg-gray-50 text-gray-600 font-bold rounded-lg transition-colors active:scale-95 text-xs uppercase tracking-wide">Vypnout Zobrazení</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MODAL OBRÁBĚNÍ ---
        const MachiningModal = ({ isOpen, onClose, settings, onSave, machineType }) => {
            const [localSettings, setLocalSettings] = useState(settings);
            useEffect(() => { if(isOpen) setLocalSettings(settings); }, [isOpen, settings]);
            const handleChange = (key, val) => setLocalSettings(prev => ({ ...prev, [key]: val }));
            if (!isOpen) return null;
            const isKarusel = machineType === 'KARUSEL';

            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-200 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Tool className="text-orange-600" size={24} /> Nastavení Obrábění</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-1"><Icons.Close size={20} /></button>
                        </div>
                        <div className="space-y-4">
                            {/* BEZPEČNOSTNÍ SEKY */}
                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                <label className="text-xs font-bold text-blue-700 uppercase mb-2 block">Bezpečnost & Limity</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <div>
                                        <label className="text-[10px] font-bold text-blue-500 uppercase mb-1">Max Otáčky (G50)</label>
                                        <input type="number" value={localSettings.maxRPM} onChange={(e) => handleChange('maxRPM', parseFloat(e.target.value))} className="w-full bg-white border border-blue-200 rounded p-2 text-sm font-bold" />
                                    </div>
                                    <div>
                                        <label className="text-[10px] font-bold text-blue-500 uppercase mb-1">Bezpečná Vzdál. (mm)</label>
                                        <input type="number" value={localSettings.safetyDist} onChange={(e) => handleChange('safetyDist', parseFloat(e.target.value))} className="w-full bg-white border border-blue-200 rounded p-2 text-sm font-bold" step={0.5} />
                                    </div>
                                </div>
                            </div>

                            <div className="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <label className="text-xs font-bold text-gray-500 uppercase mb-2 block">Startovní bod nože</label>
                                <div className="grid grid-cols-2 gap-3">
                                    <div><label className="text-[10px] font-bold text-gray-400 block mb-1">Osa {isKarusel ? 'X (Průměr)' : 'X (Průměr)'}</label><input type="number" value={localSettings.startX} onChange={(e) => handleChange('startX', parseFloat(e.target.value))} className="w-full border rounded p-2 text-sm font-bold" /></div>
                                    <div><label className="text-[10px] font-bold text-gray-400 block mb-1">Osa {isKarusel ? 'Z (Délka)' : 'Z (Délka)'}</label><input type="number" value={localSettings.startZ} onChange={(e) => handleChange('startZ', parseFloat(e.target.value))} className="w-full border rounded p-2 text-sm font-bold" /></div>
                                </div>
                            </div>
                            
                            {/* SMĚR & CHLAZENÍ */}
                            <div className="flex gap-3">
                                <div className="flex-1">
                                    <label className="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Směr</label>
                                    <div className="flex bg-gray-100 p-1 rounded-lg">
                                        <button onClick={() => handleChange('direction', 'HORIZONTAL')} className={`flex-1 py-2 text-[10px] font-bold rounded ${localSettings.direction==='HORIZONTAL' ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}>Podélně</button>
                                        <button onClick={() => handleChange('direction', 'VERTICAL')} className={`flex-1 py-2 text-[10px] font-bold rounded ${localSettings.direction==='VERTICAL' ? 'bg-white shadow text-orange-600' : 'text-gray-500'}`}>Čelně</button>
                                    </div>
                                </div>
                                <div className="w-1/3">
                                    <label className="text-[10px] font-bold text-gray-500 uppercase mb-1 block">Chlazení</label>
                                    <button onClick={() => handleChange('coolant', !localSettings.coolant)} className={`w-full py-2 rounded-lg border font-bold text-xs ${localSettings.coolant ? 'bg-blue-100 border-blue-400 text-blue-700' : 'bg-white border-gray-300 text-gray-400'}`}>
                                        {localSettings.coolant ? 'ZAP M08' : 'VYP'}
                                    </button>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-[10px] font-bold text-gray-500 uppercase mb-1">Hloubka (Ap)</label><input type="number" value={localSettings.depth} onChange={(e) => handleChange('depth', parseFloat(e.target.value))} className="w-full border border-gray-300 rounded p-2 text-sm font-bold" step={0.1} /></div>
                                <div><label className="text-[10px] font-bold text-gray-500 uppercase mb-1">Odskok (mm)</label><input type="number" value={localSettings.retract} onChange={(e) => handleChange('retract', parseFloat(e.target.value))} className="w-full border border-gray-300 rounded p-2 text-sm font-bold" step={0.1} /></div>
                            </div>
                            <div><label className="text-[10px] font-bold text-gray-500 uppercase mb-1">Max úhel zanoření (°)</label><input type="number" value={localSettings.angle} onChange={(e) => handleChange('angle', parseFloat(e.target.value))} className="w-full border border-gray-300 rounded p-2 text-sm font-bold" /></div>
                            
                            <button onClick={() => onSave(localSettings)} className="w-full py-3 bg-orange-600 hover:bg-orange-700 text-white font-bold rounded-lg shadow-md mt-2 flex items-center justify-center gap-2"><Icons.CheckCircle size={18} /> Uložit Nastavení</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- MODAL POLOTOVAR ---
        const StockModal = ({ isOpen, onClose, onGenerate, onDrawMode, onClear, lastStockPoint, onAddSegment, machineType }) => {
            const [marginX, setMarginX] = useState(2);
            const [marginZ, setMarginZ] = useState(2);
            const [marginZBack, setMarginZBack] = useState(10);
            const [mode, setMode] = useState('AUTO'); 
            const [activeDirection, setActiveDirection] = useState(null); 
            const [inputValue1, setInputValue1] = useState(''); 
            const [inputValue2, setInputValue2] = useState(''); 
            const [inputType, setInputType] = useState('LENGTH'); 
            const isKarusel = machineType === 'KARUSEL';
            const labelVertical = isKarusel ? 'Z' : 'X'; 
            const labelHorizontal = isKarusel ? 'X' : 'Z'; 

            const handleDirectionClick = (dir) => { setActiveDirection(dir); setInputValue1(''); setInputValue2(''); if (['UP','DOWN','LEFT','RIGHT'].includes(dir)) { setInputType('LENGTH'); } else { setInputType('LENGTH'); } };
            const confirmSegment = () => {
                if (!activeDirection) return;
                const v1 = parseFloat(inputValue1);
                const v2 = parseFloat(inputValue2);
                if (isNaN(v1)) return; 
                if (!lastStockPoint) { onAddSegment(activeDirection, 'COORD', { x: v1, z: v2 }); } else { onAddSegment(activeDirection, inputType, { val1: v1, val2: v2 }); }
                setActiveDirection(null);
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 animate-in fade-in zoom-in duration-200 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-gray-900 flex items-center gap-2"><Icons.Box className="text-purple-600" size={24} /> Polotovar</h3><button onClick={onClose} className="text-gray-400 hover:text-gray-600 p-1"><Icons.Close size={20} /></button></div>
                        <div className="flex bg-gray-100 p-1 rounded-lg mb-4"><button onClick={() => setMode('AUTO')} className={`flex-1 py-1 text-xs font-bold rounded ${mode==='AUTO' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}>Automaticky</button><button onClick={() => setMode('MANUAL')} className={`flex-1 py-1 text-xs font-bold rounded ${mode==='MANUAL' ? 'bg-white shadow text-purple-600' : 'text-gray-500'}`}>Ručně</button></div>
                        {mode === 'AUTO' ? (
                            <div className="space-y-3 mb-6">
                                <div className="grid grid-cols-2 gap-3"><div><label className="text-[10px] font-bold text-gray-500 uppercase mb-1">Přídavek X (na Ø)</label><input type="number" value={marginX} onChange={(e) => setMarginX(parseFloat(e.target.value)||0)} className="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-bold" /></div><div><label className="text-[10px] font-bold text-gray-500 uppercase mb-1">Přídavek Z+ (Čelo)</label><input type="number" value={marginZ} onChange={(e) => setMarginZ(parseFloat(e.target.value)||0)} className="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-bold" /></div></div>
                                <div><label className="text-[10px] font-bold text-gray-500 uppercase mb-1">Přídavek Z- (Upnutí)</label><input type="number" value={marginZBack} onChange={(e) => setMarginZBack(parseFloat(e.target.value)||0)} className="w-full bg-gray-50 border border-gray-200 rounded p-2 text-sm font-bold" placeholder="Konec polotovaru" /></div>
                                <button onClick={() => onGenerate(marginX, marginZ, marginZBack)} className="w-full py-3 bg-purple-600 hover:bg-purple-700 text-white font-bold rounded-lg shadow-md mt-2"><Icons.CheckCircle size={18} className="inline mr-2" /> Vypočítat</button>
                            </div>
                        ) : (
                            <div className="space-y-4 mb-6">
                                <div className="grid grid-cols-3 gap-2 w-48 mx-auto">
                                    <button onClick={()=>handleDirectionClick('UL')} className={`p-3 rounded-lg border ${activeDirection==='UL'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowUpLeft size={20} /></button><button onClick={()=>handleDirectionClick('UP')} className={`p-3 rounded-lg border ${activeDirection==='UP'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowUp size={20} /></button><button onClick={()=>handleDirectionClick('UR')} className={`p-3 rounded-lg border ${activeDirection==='UR'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowUpRight size={20} /></button>
                                    <button onClick={()=>handleDirectionClick('LEFT')} className={`p-3 rounded-lg border ${activeDirection==='LEFT'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowLeft size={20} /></button><div className="flex items-center justify-center"><div className="w-2 h-2 bg-purple-300 rounded-full"></div></div><button onClick={()=>handleDirectionClick('RIGHT')} className={`p-3 rounded-lg border ${activeDirection==='RIGHT'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowRight size={20} /></button>
                                    <button onClick={()=>handleDirectionClick('DL')} className={`p-3 rounded-lg border ${activeDirection==='DL'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowDownLeft size={20} /></button><button onClick={()=>handleDirectionClick('DOWN')} className={`p-3 rounded-lg border ${activeDirection==='DOWN'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowDown size={20} /></button><button onClick={()=>handleDirectionClick('DR')} className={`p-3 rounded-lg border ${activeDirection==='DR'?'bg-purple-100 border-purple-500 text-purple-700':'bg-gray-50 border-gray-200 text-gray-500 hover:bg-gray-100'}`}><Icons.ArrowDownRight size={20} /></button>
                                </div>
                                {activeDirection && (
                                    <div className="bg-purple-50 p-3 rounded-lg border border-purple-100 animate-in fade-in slide-in-from-top-2 duration-200">
                                        {!lastStockPoint ? (
                                            <div className="space-y-2">
                                                <p className="text-xs font-bold text-purple-700 text-center mb-2">Startovní Bod</p>
                                                <div className="grid grid-cols-2 gap-2">
                                                    <div><label className="text-[9px] font-bold text-gray-500">{labelHorizontal} (mm)</label><input type="number" value={inputValue2} onChange={e=>setInputValue2(e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="0" autoFocus /></div>
                                                    <div><label className="text-[9px] font-bold text-gray-500">{labelVertical} (mm)</label><input type="number" value={inputValue1} onChange={e=>setInputValue1(e.target.value)} className="w-full border rounded p-1 text-sm" placeholder="0" /></div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="space-y-2">
                                                <div className="flex text-[10px] bg-white rounded border overflow-hidden">
                                                    <button onClick={()=>setInputType('LENGTH')} className={`flex-1 py-1 ${inputType==='LENGTH'?'bg-purple-100 text-purple-700 font-bold':'text-gray-500'}`}>{['UP','DOWN','LEFT','RIGHT'].includes(activeDirection)?'Délka':'Délka (45°)'}</button>
                                                    <button onClick={()=>setInputType('COORD')} className={`flex-1 py-1 ${inputType==='COORD'?'bg-purple-100 text-purple-700 font-bold':'text-gray-500'}`}>Souřadnice</button>
                                                </div>
                                                {inputType === 'LENGTH' ? (
                                                    <div><label className="text-[10px] font-bold text-gray-500 block mb-1">{['UP','DOWN','LEFT','RIGHT'].includes(activeDirection) ? 'Délka úseku (mm)' : 'Délka šikminy (mm)'}</label><input type="number" value={inputValue1} onChange={e=>setInputValue1(e.target.value)} className="w-full bg-white border rounded p-2 text-sm font-bold" autoFocus /></div>
                                                ) : (
                                                    <div className="grid grid-cols-2 gap-2">
                                                        <div><label className="text-[9px] font-bold text-gray-500">{labelHorizontal}</label><input type="number" value={inputValue2} onChange={e=>setInputValue2(e.target.value)} className="w-full bg-white border rounded p-1 text-sm font-bold" /></div>
                                                        <div><label className="text-[9px] font-bold text-gray-500">{labelVertical}</label><input type="number" value={inputValue1} onChange={e=>setInputValue1(e.target.value)} className="w-full bg-white border rounded p-1 text-sm font-bold" /></div>
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                        <button onClick={confirmSegment} className="w-full mt-2 py-2 bg-purple-600 text-white rounded font-bold text-sm hover:bg-purple-700">Přidat</button>
                                    </div>
                                )}
                                <div className="border-t border-gray-100 pt-2 mt-2"><button onClick={onDrawMode} className="w-full py-2 bg-white border border-purple-200 text-purple-600 font-bold rounded-lg text-xs hover:bg-purple-50 flex items-center justify-center gap-2"><Icons.Play size={14} /> Nebo kreslit myší</button></div>
                            </div>
                        )}
                        <button onClick={onClear} className="w-full py-2 bg-white border border-gray-200 hover:bg-gray-50 text-red-500 font-bold rounded-lg text-xs uppercase mt-4">Smazat Polotovar</button>
                    </div>
                </div>
            );
        };

        const Sidebar = ({ isOpen, onClose, settings, setSettings, onImportDxf, onImportJson, onExportJson, onLoadFromDrawing, onGenerateGCode, onClear, machineType, setMachineType, gCodeOutput, onLoadDemo, diameterMode, setDiameterMode }) => {
            const handleSettingChange = (key, val) => setSettings({ ...settings, [key]: parseFloat(val) || 0 });
            const toggleFeedMode = (mode) => setSettings({...settings, feedMode: mode});
            const downloadGCode = () => { if(!gCodeOutput) return; const blob = new Blob([gCodeOutput], { type: 'text/plain' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'program.gcode'; a.click(); };

            return (
                <>
                    {isOpen && <div className="fixed inset-0 bg-black/30 z-40 backdrop-blur-sm" onClick={onClose} />}
                    <div className={`fixed inset-y-0 left-0 z-50 w-80 bg-white shadow-2xl transform transition-transform duration-300 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h2 className="text-lg font-bold text-gray-800 flex items-center gap-2"><Icons.Settings className="text-orange-500" /> Nastavení</h2>
                            <button onClick={onClose} className="p-2 bg-white rounded-lg border border-gray-200 text-gray-500 hover:bg-gray-100"><Icons.Close /></button>
                        </div>
                        <div className="p-4 space-y-6 overflow-y-auto h-[calc(100vh-60px)]">
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase mb-2 block">Typ Stroje</label>
                                <div className="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                                    <button onClick={() => setMachineType('KARUSEL')} className={`flex-1 py-2 rounded-md text-xs font-bold uppercase shadow-sm ${machineType === 'KARUSEL' ? 'bg-white text-orange-600' : 'text-gray-500 hover:text-gray-700'}`}>Karusel</button>
                                    <button onClick={() => setMachineType('SOUSTRUH')} className={`flex-1 py-2 rounded-md text-xs font-bold uppercase shadow-sm ${machineType === 'SOUSTRUH' ? 'bg-white text-blue-600' : 'text-gray-500 hover:text-gray-700'}`}>Soustruh</button>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-gray-400 uppercase mb-2 block">Průměr / Poloměr</label>
                                <div className="flex bg-gray-100 rounded-lg p-1 border border-gray-200">
                                    <button onClick={() => setDiameterMode(false)} className={`flex-1 py-2 rounded-md text-xs font-bold uppercase shadow-sm ${!diameterMode ? 'bg-white text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Poloměr</button>
                                    <button onClick={() => setDiameterMode(true)} className={`flex-1 py-2 rounded-md text-xs font-bold uppercase shadow-sm ${diameterMode ? 'bg-white text-pink-600' : 'text-gray-500 hover:text-gray-700'}`}>Průměr</button>
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                                <button onClick={()=>{onLoadFromDrawing(); onClose();}} className="col-span-2 flex flex-row items-center justify-center p-3 bg-indigo-50 border border-indigo-200 rounded-lg hover:bg-indigo-100 text-indigo-700 shadow-sm gap-2"><Icons.CloudDownload size={20} /><span className="text-[10px] font-bold">NAČÍST Z KRESLENÍ</span></button>
                                <button onClick={()=>{onLoadDemo(); onClose();}} className="col-span-2 flex flex-row items-center justify-center p-3 bg-teal-50 border border-teal-200 rounded-lg hover:bg-teal-100 text-teal-700 shadow-sm gap-2"><Icons.Refresh size={20} /><span className="text-[10px] font-bold">NAHRÁT DEMO</span></button>
                                <label className="flex flex-col items-center justify-center p-3 bg-white rounded-lg cursor-pointer border border-gray-200 hover:bg-gray-50 shadow-sm"><Icons.Upload size={20} className="text-blue-500 mb-1" /><span className="text-[9px] font-bold text-gray-600">Import DXF</span><input type="file" accept=".dxf" onChange={(e)=>{onImportDxf(e); onClose();}} className="hidden" /></label>
                                <label className="flex flex-col items-center justify-center p-3 bg-white rounded-lg cursor-pointer border border-gray-200 hover:bg-gray-50 shadow-sm"><Icons.FileJson size={20} className="text-yellow-500 mb-1" /><span className="text-[9px] font-bold text-gray-600">Nahrát Projekt</span><input type="file" accept=".json" onChange={(e)=>{onImportJson(e); onClose();}} className="hidden" /></label>
                                <button onClick={onExportJson} className="flex flex-col items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 shadow-sm"><Icons.Save size={20} className="text-green-500 mb-1" /><span className="text-[9px] font-bold text-gray-600">Uložit Projekt</span></button>
                                <button onClick={onClear} className="flex flex-col items-center justify-center p-3 bg-white rounded-lg border border-gray-200 hover:bg-gray-50 shadow-sm"><Icons.Trash2 size={20} className="text-red-500 mb-1" /><span className="text-[9px] font-bold text-gray-600">Smazat Vše</span></button>
                            </div>
                            <div className="space-y-3 p-3 bg-gray-50 rounded-lg border border-gray-200">
                                <div><label className="text-xs text-gray-500 font-semibold block mb-1">Rádius Plátku (mm)</label><input type="number" value={settings.offsetValue} onChange={(e) => handleSettingChange('offsetValue', e.target.value)} className="w-full bg-white border border-gray-300 rounded p-2 text-gray-800 font-mono text-right text-sm shadow-sm focus:border-orange-500 focus:ring-1 focus:ring-orange-500 outline-none" step={0.1} /></div>
                                <div><label className="text-xs text-gray-500 font-semibold block mb-1">Přídavek na hotovo (mm)</label><input type="number" value={settings.finishAllowance} onChange={(e) => handleSettingChange('finishAllowance', e.target.value)} className="w-full bg-orange-50 border border-orange-300 rounded p-2 text-gray-800 font-mono text-right text-sm shadow-sm focus:border-orange-500 focus:ring-1 focus:ring-orange-500 outline-none" step={0.1} /></div>
                                <div><div className="flex justify-between items-center mb-1"><label className="text-xs text-gray-500 font-semibold">Posuv (F)</label><div className="flex text-[9px] bg-white border border-gray-200 rounded overflow-hidden shadow-sm"><button onClick={() => toggleFeedMode('MM_MIN')} className={`px-2 py-1 ${settings.feedMode === 'MM_MIN' ? 'bg-orange-100 text-orange-700 font-bold' : 'text-gray-500'}`}>mm/min</button><button onClick={() => toggleFeedMode('MM_REV')} className={`px-2 py-1 ${settings.feedMode === 'MM_REV' ? 'bg-orange-100 text-orange-700 font-bold' : 'text-gray-500'}`}>mm/ot</button></div></div><input type="number" value={settings.feedRate} onChange={(e) => handleSettingChange('feedRate', e.target.value)} className="w-full bg-white border border-gray-300 rounded p-2 text-gray-800 font-mono text-right text-sm shadow-sm focus:border-orange-500 focus:ring-1 focus:ring-orange-500 outline-none" step={settings.feedMode==='MM_REV'?0.01:1} /></div>
                                <div><label className="text-xs text-gray-500 font-semibold block mb-1">Otáčky (S)</label><input type="number" value={settings.spindleSpeed} onChange={(e) => handleSettingChange('spindleSpeed', e.target.value)} className="w-full bg-white border border-gray-300 rounded p-2 text-gray-800 font-mono text-right text-sm shadow-sm focus:border-orange-500 focus:ring-1 focus:ring-orange-500 outline-none" /></div>
                            </div>
                            <button onClick={onGenerateGCode} className="w-full py-3 bg-gradient-to-r from-orange-600 to-orange-500 text-white font-bold rounded-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform hover:shadow-xl"><Icons.Play size={18} /> Generovat G-Kód</button>
                            {gCodeOutput && (<div className="space-y-2"><div className="flex justify-between items-center"><span className="text-xs font-bold text-gray-400">VÝSTUP</span><button onClick={downloadGCode} className="text-blue-600 text-xs font-bold bg-blue-50 border border-blue-100 px-2 py-1 rounded flex items-center gap-1 hover:bg-blue-100"><Icons.Download size={12}/> Uložit soubor</button></div><textarea className="w-full bg-gray-900 border border-gray-700 rounded p-2 text-xs font-mono text-green-400 h-32 resize-none shadow-inner" readOnly value={gCodeOutput} /></div>)}
                        </div>
                    </div>
                </>
            );
        };

        const Canvas = ({ points, stockPoints, isDrawingStock, machineType, viewBox, setViewBox, onCanvasClick, showOffset, offsetValue, finishAllowance, diameterMode, onCenter }) => {
            const containerRef = useRef(null);
            const [dragStart, setDragStart] = useState(null);
            
            const mapX = (x, z) => machineType === 'KARUSEL' ? x : z;
            const mapY = (x, z) => machineType === 'KARUSEL' ? -z : -x;

            const getClientCoords = (e) => {
                if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                return { x: e.clientX, y: e.clientY };
            };

            const handleWheel = (e) => {
                e.preventDefault();
                if (!containerRef.current) return;
                const { x, y } = getClientCoords(e);
                const rect = containerRef.current.getBoundingClientRect();
                const mouseX = x - rect.left;
                const mouseY = y - rect.top;
                const svgX = viewBox.x + (mouseX / rect.width) * viewBox.w;
                const svgY = viewBox.y + (mouseY / rect.height) * viewBox.h;
                const zoomFactor = e.deltaY > 0 ? 1.1 : 0.9;
                const newW = viewBox.w * zoomFactor;
                const newH = viewBox.h * zoomFactor;
                const newX = svgX - (mouseX / rect.width) * newW;
                const newY = svgY - (mouseY / rect.height) * newH;
                setViewBox({ ...viewBox, x: newX, y: newY, w: newW, h: newH });
            };

            const handleStart = (e) => {
                if(e.target.closest('button')) return;
                const { x, y } = getClientCoords(e);
                if(e.touches && e.touches.length === 2) {
                    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    setDragStart({ mode: 'pinch', dist, vb: { ...viewBox } });
                    return;
                }
                setDragStart({ mode: 'pan', x, y, vb: { ...viewBox }, hasMoved: false });
            };

            const handleMove = (e) => {
                if (!dragStart || !containerRef.current) return;
                e.preventDefault();
                if (dragStart.mode === 'pinch' && e.touches && e.touches.length === 2) {
                    const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                    const scale = dragStart.dist / dist;
                    const newW = dragStart.vb.w * scale;
                    const newH = dragStart.vb.h * scale;
                    const dW = newW - dragStart.vb.w;
                    const dH = newH - dragStart.vb.h;
                    setViewBox({ x: dragStart.vb.x - dW / 2, y: dragStart.vb.y - dH / 2, w: newW, h: newH });
                    return;
                }
                if (dragStart.mode === 'pan') {
                    const { x, y } = getClientCoords(e);
                    const dxPx = x - dragStart.x;
                    const dyPx = y - dragStart.y;
                    if (Math.abs(dxPx) > 2 || Math.abs(dyPx) > 2) {
                        dragStart.hasMoved = true; 
                    }
                    const scale = viewBox.w / containerRef.current.clientWidth;
                    setViewBox({ ...dragStart.vb, x: dragStart.vb.x - dxPx * scale, y: dragStart.vb.y - dyPx * scale });
                }
            };

            const handleEnd = (e) => {
                if (dragStart && !dragStart.hasMoved && isDrawingStock && containerRef.current) {
                    const rect = containerRef.current.getBoundingClientRect();
                    const { x, y } = getClientCoords(e.changedTouches ? e.changedTouches[0] : e);
                    const mouseX = x - rect.left;
                    const mouseY = y - rect.top;
                    const svgX = viewBox.x + (mouseX / rect.width) * viewBox.w;
                    const svgY = viewBox.y + (mouseY / rect.height) * viewBox.h;
                    let logicX, logicZ;
                    if (machineType === 'KARUSEL') {
                        logicX = svgX;
                        logicZ = -svgY;
                    } else {
                        logicZ = svgX;
                        logicX = -svgY;
                    }
                    onCanvasClick({ x: logicX, z: logicZ });
                }
                setDragStart(null);
            };

            const gridLines = useMemo(() => {
                const lines = [];
                const left = viewBox.x;
                const right = viewBox.x + viewBox.w;
                const top = viewBox.y;
                const bottom = viewBox.y + viewBox.h;
                const targetLines = 10;
                const rawStep = viewBox.w / targetLines;
                const magnitude = Math.pow(10, Math.floor(Math.log10(rawStep)));
                const residual = rawStep / magnitude;
                let step;
                if (residual > 5) step = 10 * magnitude;
                else if (residual > 2) step = 5 * magnitude;
                else if (residual > 1) step = 2 * magnitude;
                else step = 1 * magnitude;

                const scaleFactor = viewBox.w / 400; 
                const isKarusel = machineType === 'KARUSEL';

                const startX = Math.floor(left / step) * step;
                for (let v = startX; v <= right; v += step) {
                    const isZero = Math.abs(v) < 1e-10;
                    const axisColor = isKarusel ? '#22c55e' : '#ef4444'; 
                    const zeroColor = isKarusel ? '#ef4444' : '#22c55e';
                    if (isZero) {
                        lines.push(<g key={`v_axis_bg`}><line x1={0} y1={top} x2={0} y2={bottom} stroke={axisColor} strokeWidth={3} strokeDasharray={isKarusel ? "15, 5, 2, 5" : "none"} vectorEffect="non-scaling-stroke" className="opacity-50"/><text x={4 * scaleFactor} y={top + (20 * scaleFactor)} fontSize={14 * scaleFactor} fill={axisColor} className="select-none font-bold">{isKarusel ? 'Z' : 'X'}</text><text x={4 * scaleFactor} y={bottom - (50 * scaleFactor)} fontSize={12 * scaleFactor} fill={zeroColor} className="select-none font-bold">0</text></g>);
                    } else {
                        lines.push(<g key={`v${v}`}><line x1={v} y1={top} x2={v} y2={bottom} stroke="#e5e7eb" strokeWidth={1} vectorEffect="non-scaling-stroke" /><text x={v + (4 * scaleFactor)} y={bottom - (50 * scaleFactor)} fontSize={12 * scaleFactor} fill="#9ca3af" className="select-none font-bold">{parseFloat(v.toPrecision(6))}</text></g>);
                    }
                }
                const startY = Math.floor(top / step) * step;
                for (let v = startY; v <= bottom; v += step) {
                    const isZero = Math.abs(v) < 1e-10;
                    const val = -v;
                    const axisColor = isKarusel ? '#ef4444' : '#22c55e';
                    const zeroColor = isKarusel ? '#22c55e' : '#ef4444';
                    if (isZero) {
                        lines.push(<g key={`h_axis_bg`}><line x1={left} y1={0} x2={right} y2={0} stroke={axisColor} strokeWidth={3} strokeDasharray={isKarusel ? "none" : "15, 5, 2, 5"} vectorEffect="non-scaling-stroke" className="opacity-50"/><text x={right - (20 * scaleFactor)} y={-5 * scaleFactor} fontSize={14 * scaleFactor} fill={axisColor} className="select-none font-bold">{isKarusel ? 'X' : 'Z'}</text><text x={left + (5 * scaleFactor)} y={-4 * scaleFactor} fontSize={12 * scaleFactor} fill={zeroColor} className="select-none font-bold">0</text></g>);
                    } else {
                        let displayVal = parseFloat(val.toPrecision(6));
                        if (!isKarusel && diameterMode) displayVal *= 2;
                        lines.push(<g key={`h${v}`}><line x1={left} y1={v} x2={right} y2={v} stroke="#e5e7eb" strokeWidth={1} vectorEffect="non-scaling-stroke" /><text x={left + (5 * scaleFactor)} y={v - (4 * scaleFactor)} fontSize={12 * scaleFactor} fill="#9ca3af" className="select-none font-bold">{displayVal}</text></g>);
                    }
                }
                return lines;
            }, [viewBox, machineType, diameterMode]);

            const paths = useMemo(() => {
                let mainPath = "";
                let axisLines = [];
                if (points.length > 0) {
                    mainPath = points.filter(p => p.type !== 'axis').map((p, i) => {
                        const x = mapX(p.x, p.z);
                        const y = mapY(p.x, p.z);
                        if (i === 0 || p.break) return `M ${x} ${y}`;
                        return `L ${x} ${y}`;
                    }).join(" ");
                    axisLines = points.map((p, i) => {
                        if (p.type === 'axis' && i > 0) {
                            const prev = points[i-1];
                            return <line key={`axis-${i}`} x1={mapX(prev.x, prev.z)} y1={mapY(prev.x, prev.z)} x2={mapX(p.x, p.z)} y2={mapY(p.x, p.z)} stroke="#94a3b8" strokeWidth={1.5} strokeDasharray="15, 5, 2, 5" vectorEffect="non-scaling-stroke" />;
                        }
                        return null;
                    });
                }
                
                let offsetPathData = null;
                let roughingPathData = null; 

                if (showOffset && offsetValue !== 0) {
                    const offsetPts = calculateOffsetPath(points, offsetValue);
                    if (offsetPts.length > 0) {
                         offsetPathData = offsetPts.map((p, i) => {
                            const x = mapX(p.x, p.z);
                            const y = mapY(p.x, p.z);
                            if (i === 0 || p.break) return `M ${x} ${y}`;
                            return `L ${x} ${y}`;
                        }).join(" ");
                    }

                    if (finishAllowance > 0) {
                        const roughOffsetPts = calculateOffsetPath(points, offsetValue + finishAllowance);
                        if (roughOffsetPts.length > 0) {
                            roughingPathData = roughOffsetPts.map((p, i) => {
                                const x = mapX(p.x, p.z);
                                const y = mapY(p.x, p.z);
                                if (i === 0 || p.break) return `M ${x} ${y}`;
                                return `L ${x} ${y}`;
                            }).join(" ");
                        }
                    }
                }

                let stockPathData = null;
                if (stockPoints.length > 0) {
                    stockPathData = stockPoints.map((p, i) => {
                        const x = mapX(p.x, p.z);
                        const y = mapY(p.x, p.z);
                        return `${i===0?'M':'L'} ${x} ${y}`;
                    }).join(" ") + " Z";
                }

                return { mainPath, axisLines, offsetPathData, roughingPathData, stockPathData };
            }, [points, stockPoints, machineType, showOffset, offsetValue, finishAllowance]);

            return (
                <div 
                    ref={containerRef}
                    className={`w-full h-full bg-[#fafafa] relative overflow-hidden touch-none ${isDrawingStock ? 'cursor-crosshair' : 'cursor-default'}`}
                    onMouseDown={handleStart} onMouseMove={handleMove} onMouseUp={handleEnd} onMouseLeave={handleEnd}
                    onTouchStart={handleStart} onTouchMove={handleMove} onTouchEnd={handleEnd}
                    onWheel={handleWheel}
                >
                    {isDrawingStock && (
                        <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-purple-600 text-white px-4 py-1 rounded shadow-lg text-xs font-bold z-10 pointer-events-none animate-pulse">
                            REŽIM KRESLENÍ POLOTOVARU
                        </div>
                    )}

                    <svg width="100%" height="100%" viewBox={`${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`} preserveAspectRatio="xMidYMid slice" className="block no-select">
                        {gridLines}
                        {paths.stockPathData && (
                            <path d={paths.stockPathData} fill="rgba(100, 100, 100, 0.15)" stroke="gray" strokeWidth={1} strokeDasharray="5,5" vectorEffect="non-scaling-stroke" />
                        )}
                        {paths.axisLines}
                        {paths.roughingPathData && <path d={paths.roughingPathData} stroke="#d97706" strokeWidth={2} strokeDasharray="6,3" fill="none" vectorEffect="non-scaling-stroke" className="opacity-80" />}
                        {paths.offsetPathData && <path d={paths.offsetPathData} stroke="#2563eb" strokeWidth={2} strokeDasharray="4,2" fill="none" vectorEffect="non-scaling-stroke" className="opacity-70" />}
                        <path d={paths.mainPath} stroke="#16a34a" strokeWidth={3} fill="none" vectorEffect="non-scaling-stroke" />
                        
                        {points.map((p, i) => {
                            const mx = mapX(p.x, p.z);
                            const my = mapY(p.x, p.z);
                            const color = i === 0 ? "#16a34a" : (p.type === 'axis' ? "#94a3b8" : "#ea580c");
                            return <circle key={i} cx={mx} cy={my} r={4 * (viewBox.w/600)} fill="white" stroke={color} strokeWidth={1} vectorEffect="non-scaling-stroke" />;
                        })}

                        {isDrawingStock && stockPoints.map((p, i) => (
                            <circle key={`s-${i}`} cx={mapX(p.x, p.z)} cy={mapY(p.x, p.z)} r={3 * (viewBox.w/600)} fill="purple" />
                        ))}
                    </svg>

                    <div 
                        className="absolute top-4 right-4 cursor-pointer opacity-90 flex flex-col items-center gap-1 hover:scale-110 transition-transform active:scale-95 z-50" 
                        onClick={(e) => { e.stopPropagation(); onCenter(); }} 
                        title="Vycentrovat pohled"
                    >
                        <div className="relative w-16 h-16 border-2 border-gray-200 bg-white/90 backdrop-blur shadow-xl rounded-full hover:border-purple-400 transition-colors">
                            <div className={`absolute left-1/2 top-1 bottom-1 w-[2px] -translate-x-1/2 ${machineType === 'KARUSEL' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                            <span className={`absolute top-1 left-1/2 -translate-x-1/2 -translate-y-full text-[10px] font-bold ${machineType === 'KARUSEL' ? 'text-green-600' : 'text-red-600'}`}>{machineType === 'KARUSEL' ? 'Z+' : 'X+'}</span>
                            <div className={`absolute top-1/2 left-1 right-1 h-[2px] -translate-y-1/2 ${machineType === 'KARUSEL' ? 'bg-red-500' : 'bg-green-500'}`}></div>
                            <span className={`absolute top-1/2 right-1 translate-x-full -translate-y-1/2 text-[10px] font-bold ml-1 ${machineType === 'KARUSEL' ? 'text-red-600' : 'text-green-600'}`}>{machineType === 'KARUSEL' ? 'X+' : 'Z+'}</span>
                            <div className="absolute top-1/2 left-1/2 w-2 h-2 bg-white rounded-full -translate-x-1/2 -translate-y-1/2 border border-gray-400"></div>
                        </div>
                    </div>

                    <div className="absolute bottom-2 left-2 text-[10px] text-gray-400 pointer-events-none font-mono font-bold bg-white/80 px-2 py-1 rounded shadow-sm border border-gray-100">
                        {machineType} | Korekce: {showOffset ? `${offsetValue}mm + ${finishAllowance}mm` : 'VYP'} | Ø Režim: {diameterMode ? 'ZAP' : 'VYP'}
                    </div>
                </div>
            );
        };

        const App = () => {
            const [points, setPoints] = useState(DEMO_POINTS);
            const [stockPoints, setStockPoints] = useState([]);
            const [isDrawingStock, setIsDrawingStock] = useState(false);
            const [settings, setSettings] = useState(DEFAULT_SETTINGS);
            const [machiningSettings, setMachiningSettings] = useState(DEFAULT_MACHINING);
            const [viewBox, setViewBox] = useState(INITIAL_VB);
            const [machineType, setMachineType] = useState('SOUSTRUH'); 
            const [sidebarOpen, setSidebarOpen] = useState(false);
            const [gCode, setGCode] = useState("");
            const [showOffset, setShowOffset] = useState(false); 
            const [diameterMode, setDiameterMode] = useState(false);
            const [toast, setToast] = useState(null);
            const [confirmState, setConfirmState] = useState(null);
            const [offsetModalOpen, setOffsetModalOpen] = useState(false);
            const [stockModalOpen, setStockModalOpen] = useState(false);
            const [machiningModalOpen, setMachiningModalOpen] = useState(false); 

            const showToast = (msg) => setToast(msg);
            
            const handleLoadDemo = () => {
                setPoints(DEMO_POINTS);
                setStockPoints([]);
                setViewBox(INITIAL_VB);
                showToast("Demo obrobek načten");
            };

            const handleLoadFromDrawing = () => {
                const raw = localStorage.getItem('cnc_transfer_data');
                if(!raw) { showToast("Žádná data v mezipaměti."); return; }
                try {
                    const data = JSON.parse(raw);
                    if(data.points) setPoints(data.points);
                    if(data.machineType) setMachineType(data.machineType);
                    if(data.settings) setSettings({...settings, ...data.settings});
                    setViewBox(INITIAL_VB);
                    showToast("Data úspěšně načtena!");
                } catch(e) {
                    showToast("Chyba při načítání dat.");
                }
            };

            const handleImportDxf = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const pts = parseDXF(evt.target.result);
                    if (pts.length) {
                        setPoints(pts);
                        setViewBox(INITIAL_VB);
                    }
                };
                reader.readAsText(file);
            };

            const handleImportJson = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const data = JSON.parse(evt.target.result);
                        if (data.points) setPoints(data.points);
                        if (data.settings) setSettings(data.settings);
                        if (data.machineType) setMachineType(data.machineType);
                    } catch (err) {
                        showToast("Chyba při načítání projektu.");
                    }
                };
                reader.readAsText(file);
            };

            const handleExportJson = () => {
                const data = { points, settings, machineType, version: "1.0" };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'projekt.json';
                a.click();
            };

            const handleClear = () => {
                setConfirmState({
                    message: "Opravdu smazat vše?",
                    onConfirm: () => {
                        setPoints([]);
                        setStockPoints([]);
                        setGCode("");
                        setConfirmState(null);
                        showToast("Vše smazáno");
                    },
                    onCancel: () => setConfirmState(null)
                });
            };

            const handleCenter = () => setViewBox(INITIAL_VB);

            const updateMachiningStart = (currentStockPoints) => {
                if (currentStockPoints && currentStockPoints.length > 0) {
                    let maxX = -Infinity;
                    let maxZ = -Infinity;
                    currentStockPoints.forEach(p => {
                        if (p.x > maxX) maxX = p.x;
                        if (p.z > maxZ) maxZ = p.z;
                    });
                    
                    setMachiningSettings(prev => ({
                        ...prev,
                        startX: maxX + 5,
                        startZ: maxZ + 5
                    }));
                }
            };

            const handleGenerateStock = (mx, mz, mzBack) => {
                if (points.length === 0) { showToast("Chybí body obrobku"); return; }
                const validPoints = points.filter(p => p.type !== 'axis');
                let maxX = -Infinity;
                let maxZ = -Infinity;
                let minZ = Infinity;
                validPoints.forEach(p => {
                    if (p.x > maxX) maxX = p.x;
                    if (p.z > maxZ) maxZ = p.z;
                    if (p.z < minZ) minZ = p.z;
                });
                const stockR = maxX + mx;
                const stockZFront = maxZ + mz;
                const stockZBack = minZ - mzBack;
                const newStock = [
                    { x: 0, z: stockZBack },
                    { x: stockR, z: stockZBack },
                    { x: stockR, z: stockZFront },
                    { x: 0, z: stockZFront }
                ];
                setStockPoints(newStock);
                updateMachiningStart(newStock); 
                setStockModalOpen(false);
                showToast("Polotovar vygenerován");
            };

            const handleDrawStockClick = (pt) => {
                setStockPoints(prev => [...prev, pt]);
            };

            const handleAddStockSegment = (direction, type, values) => {
                if (stockPoints.length === 0 && type === 'COORD' && values.x !== undefined) {
                    setStockPoints([{x: values.x, z: values.z}]);
                    showToast("Startovní bod přidán");
                    return;
                }

                const last = stockPoints[stockPoints.length - 1];
                if (!last) return;

                let nextPoint = { ...last };
                const { val1, val2 } = values; 
                
                const isKarusel = machineType === 'KARUSEL';
                
                const moveX = (amount) => nextPoint.x += amount;
                const moveZ = (amount) => nextPoint.z += amount;
                const setX = (val) => nextPoint.x = val;
                const setZ = (val) => nextPoint.z = val;

                if (type === 'LENGTH') {
                    const L = val1;
                    if (direction === 'UP') isKarusel ? moveZ(L) : moveX(L);
                    else if (direction === 'DOWN') isKarusel ? moveZ(-L) : moveX(-L);
                    else if (direction === 'RIGHT') isKarusel ? moveX(L) : moveZ(L);
                    else if (direction === 'LEFT') isKarusel ? moveX(-L) : moveZ(-L);
                    else {
                        const d = L / Math.sqrt(2);
                        if (direction === 'UR') { isKarusel ? (moveZ(d), moveX(d)) : (moveX(d), moveZ(d)); }
                        else if (direction === 'UL') { isKarusel ? (moveZ(d), moveX(-d)) : (moveX(d), moveZ(-d)); }
                        else if (direction === 'DR') { isKarusel ? (moveZ(-d), moveX(d)) : (moveX(-d), moveZ(d)); }
                        else if (direction === 'DL') { isKarusel ? (moveZ(-d), moveX(-d)) : (moveX(-d), moveZ(-d)); }
                    }
                } else {
                    const targetVert = val1;
                    const targetHoriz = val2;

                    if (direction === 'UP' || direction === 'DOWN') isKarusel ? setZ(targetVert) : setX(targetVert);
                    else if (direction === 'LEFT' || direction === 'RIGHT') isKarusel ? setX(targetVert) : setZ(targetVert); 
                    else {
                        if (isKarusel) { setZ(targetVert); setX(targetHoriz); }
                        else { setX(targetVert); setZ(targetHoriz); }
                    }
                }

                setStockPoints([...stockPoints, nextPoint]);
                showToast("Bod přidán");
            };

            const toggleStockDrawing = () => {
                if (isDrawingStock) {
                    setIsDrawingStock(false);
                    updateMachiningStart(stockPoints); 
                    showToast("Kreslení polotovaru ukončeno");
                } else {
                    if (stockPoints.length > 0 && !confirm("Smazat stávající polotovar?")) return;
                    setStockPoints([]);
                    setIsDrawingStock(true);
                    setStockModalOpen(false);
                    showToast("Klikáním definujte tvar polotovaru");
                }
            };

            return (
                <div className="flex flex-col h-screen w-screen overflow-hidden">
                    <div className="flex-1 relative flex flex-col md:flex-row overflow-hidden">
                        <div className="flex-1 relative order-1 md:order-2">
                            <Canvas 
                                points={points} 
                                stockPoints={stockPoints}
                                isDrawingStock={isDrawingStock}
                                machineType={machineType}
                                viewBox={viewBox} 
                                setViewBox={setViewBox} 
                                onCanvasClick={isDrawingStock ? handleDrawStockClick : ()=>{}}
                                showOffset={showOffset}
                                offsetValue={settings.offsetValue}
                                finishAllowance={settings.finishAllowance}
                                diameterMode={diameterMode}
                                onCenter={handleCenter}
                            />
                        </div>
                        <div className="bg-white border-t md:border-t-0 md:border-r border-gray-200 p-2 z-30 shrink-0 order-2 md:order-1 flex flex-row md:flex-col justify-center md:justify-start gap-1 overflow-x-auto md:overflow-x-visible md:overflow-y-auto w-full md:w-20">
                            <ToolbarButton icon={Icons.Menu} label="Menu" onClick={() => setSidebarOpen(true)} />
                            
                            {isDrawingStock ? (
                                <ToolbarButton 
                                    icon={Icons.CheckCircle} 
                                    label="Hotovo" 
                                    onClick={toggleStockDrawing} 
                                    active={true} 
                                    color="text-green-600"
                                />
                            ) : (
                                <>
                                    <ToolbarButton 
                                        icon={Icons.Box} 
                                        label="Polotovar" 
                                        onClick={() => setStockModalOpen(true)} 
                                        active={stockPoints.length > 0} 
                                    />
                                    <ToolbarButton 
                                        icon={Icons.Layers} 
                                        label="Korekce" 
                                        onClick={() => setOffsetModalOpen(true)} 
                                        active={showOffset} 
                                    />
                                    <ToolbarButton 
                                        icon={Icons.Tool} 
                                        label="Obrábění" 
                                        onClick={() => setMachiningModalOpen(true)} 
                                        active={false} 
                                    />
                                </>
                            )}
                        </div>
                    </div>

                    <Sidebar 
                        isOpen={sidebarOpen} 
                        onClose={() => setSidebarOpen(false)}
                        settings={settings}
                        setSettings={setSettings}
                        onLoadFromDrawing={handleLoadFromDrawing}
                        onLoadDemo={handleLoadDemo}
                        onImportDxf={handleImportDxf}
                        onImportJson={handleImportJson}
                        onExportJson={handleExportJson}
                        onGenerateGCode={() => {
                            setGCode(generateGCode(points, settings));
                            showToast("G-Kód vygenerován");
                        }}
                        onClear={handleClear}
                        machineType={machineType}
                        setMachineType={setMachineType}
                        gCodeOutput={gCode}
                        diameterMode={diameterMode}
                        setDiameterMode={setDiameterMode}
                    />
                    
                    <OffsetModal 
                        isOpen={offsetModalOpen}
                        onClose={() => setOffsetModalOpen(false)}
                        toolRadius={settings.offsetValue}
                        finishAllowance={settings.finishAllowance}
                        onConfirm={(r, a) => {
                            setSettings({...settings, offsetValue: r, finishAllowance: a});
                            setShowOffset(true);
                            setOffsetModalOpen(false);
                            showToast(`Korekce R${r}mm + ${a}mm aktivní`);
                        }}
                        onDisable={() => {
                            setShowOffset(false);
                            setOffsetModalOpen(false);
                            showToast("Korekce vypnuta");
                        }}
                    />

                    <StockModal 
                        isOpen={stockModalOpen}
                        onClose={() => setStockModalOpen(false)}
                        onGenerate={handleGenerateStock}
                        onDrawMode={toggleStockDrawing}
                        onClear={() => {
                            setStockPoints([]);
                            setStockModalOpen(false);
                            showToast("Polotovar smazán");
                        }}
                        lastStockPoint={stockPoints[stockPoints.length-1]}
                        onAddSegment={handleAddStockSegment}
                        machineType={machineType}
                    />

                    <MachiningModal 
                        isOpen={machiningModalOpen}
                        onClose={() => setMachiningModalOpen(false)}
                        settings={machiningSettings}
                        onSave={(newSettings) => {
                            setMachiningSettings(newSettings);
                            setMachiningModalOpen(false);
                            showToast("Technologie uložena");
                        }}
                        machineType={machineType}
                    />

                    {toast && <Toast message={toast} onClose={() => setToast(null)} />}
                    {confirmState && <ConfirmDialog message={confirmState.message} onConfirm={confirmState.onConfirm} onCancel={confirmState.onCancel} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
