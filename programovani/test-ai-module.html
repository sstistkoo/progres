<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Modul - Testov√°n√≠</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            min-height: 100vh;
            color: #e2e8f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            color: #38bdf8;
            margin-bottom: 30px;
            font-size: 28px;
        }
        
        .card {
            background: rgba(30, 41, 59, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid rgba(71, 85, 105, 0.5);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .card-title {
            font-size: 14px;
            color: #94a3b8;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .card-title .icon { font-size: 18px; }
        
        /* Tabs pro providery */
        .provider-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .provider-tab {
            padding: 12px 20px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .provider-tab:hover {
            background: rgba(71, 85, 105, 0.7);
            border-color: #64748b;
        }
        
        .provider-tab.active {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-color: transparent;
            color: white;
        }
        
        .provider-tab .emoji { font-size: 18px; }
        
        /* Model select */
        .model-section {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-size: 12px;
            color: #94a3b8;
            margin-bottom: 6px;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid #475569;
            border-radius: 10px;
            color: #e2e8f0;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        select option {
            background: #1e293b;
            padding: 10px;
        }
        
        .model-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px 16px;
            font-size: 12px;
            color: #93c5fd;
            white-space: nowrap;
        }
        
        .model-info .rpm {
            font-size: 20px;
            font-weight: bold;
            color: #60a5fa;
        }
        
        /* API Keys */
        .keys-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .keys-grid::-webkit-scrollbar {
            width: 6px;
        }
        
        .keys-grid::-webkit-scrollbar-track {
            background: rgba(51, 65, 85, 0.3);
            border-radius: 3px;
        }
        
        .keys-grid::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }
        
        .key-input-group {
            position: relative;
        }
        
        .key-input-group input {
            padding-right: 40px;
        }
        
        .key-status {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 16px;
        }
        
        .key-status.ok { color: #22c55e; }
        .key-status.demo { color: #f59e0b; }
        .key-status.none { color: #64748b; }
        
        /* Buttons */
        .btn-row {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .btn-secondary {
            background: rgba(71, 85, 105, 0.5);
            color: #e2e8f0;
            border: 1px solid #475569;
        }
        .btn-secondary:hover { background: rgba(71, 85, 105, 0.8); }
        
        .btn-success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        
        .btn-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        /* Chat area */
        .chat-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .system-prompt {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
        }
        
        .system-prompt textarea {
            background: transparent;
            border: none;
            resize: vertical;
            min-height: 60px;
        }
        
        .prompt-area textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        /* Token counter */
        .token-counter {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            font-size: 11px;
            color: #64748b;
        }
        
        .token-cost {
            color: #fbbf24;
        }
        
        /* Image upload */
        .image-upload-section {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
        }
        
        .image-upload-section label {
            color: #c4b5fd;
        }
        
        .image-upload-area {
            border: 2px dashed #475569;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: rgba(15, 23, 42, 0.5);
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .image-upload-area:hover {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }
        
        .image-upload-area.dragover {
            border-color: #a78bfa;
            background: rgba(139, 92, 246, 0.2);
        }
        
        .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
        }
        
        .upload-placeholder .upload-icon {
            font-size: 32px;
        }
        
        .image-preview {
            position: relative;
            display: inline-block;
        }
        
        .image-preview img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .remove-image {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #ef4444;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .remove-image:hover {
            background: #dc2626;
        }
        
        .image-info {
            margin-top: 8px;
            font-size: 11px;
            color: #a78bfa;
        }
        
        /* Response section */
        .response-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #334155;
        }
        
        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .response-header label {
            margin: 0;
            font-size: 13px;
            color: #94a3b8;
        }
        
        .response-actions {
            display: flex;
            gap: 6px;
        }
        
        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            background: rgba(51, 65, 85, 0.5);
            border: 1px solid #475569;
            border-radius: 6px;
            color: #e2e8f0;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-small:hover {
            background: rgba(71, 85, 105, 0.8);
        }
        
        .response-footer {
            margin-top: 10px;
            font-size: 11px;
            color: #64748b;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Chat history */
        .chat-history {
            max-height: 400px;
            overflow-y: auto;
            padding: 12px 0;
        }
        
        .history-empty {
            text-align: center;
            color: #64748b;
            padding: 20px;
            font-style: italic;
        }
        
        .history-item {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border-left: 3px solid #3b82f6;
        }
        
        .history-item .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #64748b;
            margin-bottom: 8px;
        }
        
        .history-item .history-prompt {
            color: #93c5fd;
            font-size: 13px;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #334155;
        }
        
        .history-item .history-response {
            color: #e2e8f0;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 150px;
            overflow-y: auto;
        }
        
        .history-item .history-actions {
            margin-top: 8px;
            display: flex;
            gap: 6px;
        }
        
        /* Output */
        #output {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }
        
        #output.loading {
            color: #64748b;
            font-style: italic;
        }
        
        #output.error {
            color: #f87171;
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
        }
        
        /* Chat bubliny */
        .chat-container {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid #334155;
            border-radius: 12px;
            padding: 15px;
            min-height: 300px;
            max-height: 500px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .chat-message {
            display: flex;
            margin-bottom: 12px;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.user {
            justify-content: flex-end;
        }
        
        .chat-message.assistant {
            justify-content: flex-start;
        }
        
        .chat-bubble {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        
        .chat-message.user .chat-bubble {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .chat-message.assistant .chat-bubble {
            background: rgba(51, 65, 85, 0.8);
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
        }
        
        .chat-message.assistant .chat-bubble.error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            color: #f87171;
        }
        
        .chat-message.assistant .chat-bubble.loading {
            color: #94a3b8;
            font-style: italic;
        }
        
        .chat-input-area {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        
        .chat-input-area textarea {
            flex: 1;
            min-height: 50px;
            max-height: 150px;
            resize: none;
        }
        
        .chat-input-area button {
            height: 50px;
            padding: 0 20px;
        }
        
        .btn-upload {
            height: 50px;
            width: 50px;
            padding: 0;
            background: rgba(51, 65, 85, 0.8);
            border: 1px solid #475569;
            border-radius: 10px;
            color: #e2e8f0;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .btn-upload:hover {
            background: rgba(71, 85, 105, 0.9);
            transform: scale(1.05);
        }
        
        .file-preview-bar {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 8px 12px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .file-preview-item {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
        }
        
        .file-preview-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 6px;
        }
        
        .file-preview-item .file-icon {
            font-size: 24px;
        }
        
        .file-preview-item .file-name {
            flex: 1;
            font-size: 13px;
            color: #93c5fd;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .remove-file-btn {
            background: rgba(239, 68, 68, 0.2);
            border: none;
            color: #f87171;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .remove-file-btn:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        
        .chat-message .attachment-preview {
            margin-top: 8px;
            max-width: 200px;
        }
        
        .chat-message .attachment-preview img {
            max-width: 100%;
            border-radius: 8px;
        }
        
        .chat-message .attachment-file {
            background: rgba(0,0,0,0.2);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .chat-empty {
            text-align: center;
            color: #64748b;
            padding: 40px;
            font-style: italic;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            font-size: 12px;
            color: #94a3b8;
        }
        
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 500;
        }
        
        .status-badge.ready { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .status-badge.loading { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .status-badge.error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .status-badge.success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        
        /* Responsive */
        @media (max-width: 600px) {
            .provider-tabs { flex-direction: column; }
            .provider-tab { justify-content: center; }
            .model-section { grid-template-columns: 1fr; }
            .keys-grid { grid-template-columns: 1fr; }
            .model-card { grid-template-columns: 1fr; gap: 8px; }
        }
        
        /* Animations */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading-dots {
            display: inline-flex;
            gap: 4px;
        }
        
        .loading-dots span {
            width: 8px;
            height: 8px;
            background: #60a5fa;
            border-radius: 50%;
            animation: pulse 1.4s infinite;
        }
        
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        /* Collapsible */
        .collapsible-header {
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .collapsible-header .arrow {
            transition: transform 0.2s;
        }
        
        .collapsible-header.open .arrow {
            transform: rotate(180deg);
        }
        
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .collapsible-content.open {
            max-height: 800px;
        }
        
        /* Mini collapsible sections */
        .collapsible-section {
            margin: 12px 0;
        }
        
        .collapsible-header-mini {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(51, 65, 85, 0.3);
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            color: #94a3b8;
            transition: all 0.2s;
        }
        
        .collapsible-header-mini:hover {
            background: rgba(51, 65, 85, 0.5);
            color: #e2e8f0;
        }
        
        .collapsible-content-mini {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease;
        }
        
        .collapsible-content-mini.open {
            max-height: 300px;
            padding-top: 12px;
        }
        
        .collapsible-content-mini textarea {
            margin-top: 0;
        }
        
        .collapsible-content-mini .btn-row {
            margin-top: 0;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }
        
        .modal-content.modal-wide {
            max-width: 1000px;
        }
        
        #testResults, #modelsResults {
            flex: 1;
            overflow-y: auto;
            max-height: 50vh;
        }
        
        .models-results {
            padding: 0 24px 24px;
        }
        
        .model-card {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 12px;
            align-items: center;
            transition: all 0.2s;
        }
        
        .model-card:hover {
            background: rgba(30, 41, 59, 0.8);
        }
        
        .model-card.available {
            border-left: 3px solid #22c55e;
        }
        
        .model-card.missing {
            border-left: 3px solid #ef4444;
            opacity: 0.7;
        }
        
        .model-card.new {
            border-left: 3px solid #3b82f6;
            background: rgba(59, 130, 246, 0.1);
        }
        
        .model-card .model-name {
            font-weight: 500;
            color: #f1f5f9;
        }
        
        .model-card .model-id {
            font-size: 11px;
            color: #64748b;
            font-family: monospace;
        }
        
        .model-card .model-badges {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
        }
        
        .badge.free {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }
        
        .badge.paid {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }
        
        .badge.vision {
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
        }
        
        .badge.new-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
        }
        
        .badge.missing-badge {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        
        .model-card .model-context {
            font-size: 11px;
            color: #94a3b8;
            text-align: right;
        }
        
        .model-card .add-btn {
            padding: 4px 10px;
            font-size: 11px;
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            color: #60a5fa;
            border-radius: 6px;
            cursor: pointer;
        }
        
        .model-card .add-btn:hover {
            background: rgba(59, 130, 246, 0.4);
        }
        
        /* Compare models */
        .compare-results {
            padding: 0 24px 24px;
        }
        
        .compare-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 16px;
        }
        
        .compare-card {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 12px;
            padding: 16px;
            border-left: 3px solid #3b82f6;
        }
        
        .compare-card.loading {
            border-left-color: #fbbf24;
        }
        
        .compare-card.success {
            border-left-color: #22c55e;
        }
        
        .compare-card.error {
            border-left-color: #ef4444;
        }
        
        .compare-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid #334155;
        }
        
        .compare-card-title {
            font-weight: 600;
            color: #f1f5f9;
        }
        
        .compare-card-meta {
            font-size: 11px;
            color: #64748b;
        }
        
        .compare-card-response {
            color: #e2e8f0;
            font-size: 13px;
            line-height: 1.6;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .compare-card-response.loading-text {
            color: #fbbf24;
            font-style: italic;
        }
        
        .compare-card-response.error-text {
            color: #f87171;
        }
        
        .compare-model-select {
            margin-bottom: 16px;
            padding: 16px;
            background: rgba(30, 41, 59, 0.5);
            border-radius: 10px;
        }
        
        .compare-model-select label {
            display: block;
            margin-bottom: 8px;
            color: #94a3b8;
            font-size: 13px;
        }
        
        .compare-checkboxes {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .compare-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(51, 65, 85, 0.5);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 12px;
        }
        
        .compare-checkbox:hover {
            background: rgba(71, 85, 105, 0.8);
        }
        
        .compare-checkbox.selected {
            background: rgba(59, 130, 246, 0.3);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }
        
        .compare-checkbox input {
            display: none;
        }
        
        /* Mini Console */
        #miniConsole {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: #0d1117;
            border-top: 2px solid #30363d;
            z-index: 9999;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        
        .console-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 12px;
            background: #161b22;
            border-bottom: 1px solid #30363d;
            color: #8b949e;
            font-size: 13px;
        }
        
        #consoleOutput {
            height: calc(100% - 32px);
            overflow-y: auto;
            padding: 8px 12px;
        }
        
        .console-log { color: #c9d1d9; }
        .console-error { color: #f85149; }
        .console-warn { color: #d29922; }
        .console-info { color: #58a6ff; }
        
        .console-entry {
            padding: 3px 0;
            border-bottom: 1px solid #21262d;
            word-break: break-all;
        }
        
        #consoleToggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #238636;
            border: none;
            font-size: 24px;
            cursor: pointer;
            z-index: 9998;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        #consoleToggle:hover {
            background: #2ea043;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid #334155;
            position: sticky;
            top: 0;
            background: #1e293b;
            z-index: 10;
        }
        
        .modal-header h2 {
            font-size: 20px;
            color: #f1f5f9;
            margin: 0;
        }
        
        .modal-close {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #f87171;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-close:hover {
            background: rgba(239, 68, 68, 0.4);
        }
        
        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            padding: 16px 24px;
            border-top: 1px solid #334155;
            background: #1e293b;
            border-radius: 0 0 20px 20px;
        }
        
        /* Test Summary */
        .test-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            padding: 20px 24px;
            background: rgba(15, 23, 42, 0.5);
        }
        
        .summary-card {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        
        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .summary-card .label {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .summary-card.success .value { color: #4ade80; }
        .summary-card.error .value { color: #f87171; }
        .summary-card.speed .value { color: #60a5fa; }
        
        /* Provider Section */
        .provider-section {
            padding: 16px 24px;
            border-bottom: 1px solid #1e293b;
        }
        
        .provider-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }
        
        .provider-header h3 {
            font-size: 16px;
            color: #e2e8f0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .provider-stats {
            font-size: 12px;
            color: #94a3b8;
        }
        
        /* Model Result */
        .model-result {
            background: rgba(15, 23, 42, 0.6);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 12px;
            align-items: center;
        }
        
        .model-result.success {
            border-left: 3px solid #22c55e;
        }
        
        .model-result.error {
            border-left: 3px solid #ef4444;
        }
        
        .model-result .model-name {
            font-weight: 500;
            color: #f1f5f9;
            margin-bottom: 2px;
        }
        
        .model-result .model-id {
            font-size: 11px;
            color: #64748b;
            font-family: monospace;
        }
        
        .model-result .result-info {
            text-align: right;
        }
        
        .model-result .result-status {
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .model-result .result-status.success { color: #4ade80; }
        .model-result .result-status.error { color: #f87171; }
        
        .model-result .result-details {
            font-size: 11px;
            color: #94a3b8;
        }
        
        .model-result .error-msg {
            font-size: 11px;
            color: #fbbf24;
            margin-top: 4px;
            grid-column: 1 / -1;
        }
        
        /* Testing animation */
        .testing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #60a5fa;
            font-size: 13px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid #334155;
            border-top-color: #60a5fa;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ü§ñ AI Modul - Testov√°n√≠</h1>
    
    <!-- Nastaven√≠ (collapsible) - Provider + Model + API Keys -->
    <div class="card">
        <div class="collapsible-header" onclick="toggleSection('settingsSection')">
            <div class="card-title" style="margin: 0;">
                <span class="icon">‚öôÔ∏è</span> Nastaven√≠ 
                <span style="font-size: 12px; color: #64748b; font-weight: normal;" id="currentSettingsInfo">
                    (gemini / gemini-2.5-flash-lite)
                </span>
            </div>
            <span class="arrow" id="settingsSectionArrow">‚ñ∂</span>
        </div>
        <div class="collapsible-content" id="settingsSection">
            <div style="padding-top: 16px;">
                <!-- Provider tabs -->
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 13px;">Poskytovatel:</label>
                    <div class="provider-tabs" id="providerTabs">
                        <div class="provider-tab active" data-provider="gemini">
                            <span class="emoji">ü§ñ</span> Gemini
                        </div>
                        <div class="provider-tab" data-provider="groq">
                            <span class="emoji">‚ö°</span> Groq
                        </div>
                        <div class="provider-tab" data-provider="openrouter">
                            <span class="emoji">üåê</span> OpenRouter
                        </div>
                        <div class="provider-tab" data-provider="mistral">
                            <span class="emoji">üî•</span> Mistral
                        </div>
                        <div class="provider-tab" data-provider="cohere">
                            <span class="emoji">üß†</span> Cohere
                        </div>
                        <div class="provider-tab" data-provider="huggingface" title="‚ö†Ô∏è Z file:// nefunguje - pot≈ôeba HTTP server">
                            <span class="emoji">ü§ó</span> HuggingFace
                        </div>
                    </div>
                </div>
                
                <!-- Model selection -->
                <div class="model-section">
                    <div>
                        <label>Model:</label>
                        <select id="modelSelect"></select>
                    </div>
                    <div class="model-info">
                        <div>Limit:</div>
                        <div><span class="rpm" id="modelRpm">15</span> req/min</div>
                    </div>
                </div>
                
                <!-- API Keys -->
                <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #334155;">
                    <label style="display: block; margin-bottom: 8px; color: #94a3b8; font-size: 13px;">API Kl√≠ƒçe:</label>
                    <div class="keys-grid">
                        <div class="key-input-group">
                            <label>ü§ñ Gemini</label>
                            <input type="password" id="keyGemini" placeholder="AIza...">
                            <span class="key-status" id="statusGemini">‚óè</span>
                        </div>
                        <div class="key-input-group">
                            <label>‚ö° Groq</label>
                            <input type="password" id="keyGroq" placeholder="gsk_...">
                            <span class="key-status" id="statusGroq">‚óè</span>
                        </div>
                        <div class="key-input-group">
                            <label>üåê OpenRouter</label>
                            <input type="password" id="keyOpenrouter" placeholder="sk-or-...">
                            <span class="key-status" id="statusOpenrouter">‚óè</span>
                        </div>
                        <div class="key-input-group">
                            <label>üî• Mistral</label>
                            <input type="password" id="keyMistral" placeholder="...">
                            <span class="key-status" id="statusMistral">‚óè</span>
                        </div>
                        <div class="key-input-group">
                            <label>üß† Cohere</label>
                            <input type="password" id="keyCohere" placeholder="...">
                            <span class="key-status" id="statusCohere">‚óè</span>
                        </div>
                        <div class="key-input-group">
                            <label>ü§ó HuggingFace</label>
                            <input type="password" id="keyHuggingface" placeholder="hf_...">
                            <span class="key-status" id="statusHuggingface">‚óè</span>
                        </div>
                    </div>
                    <div class="btn-row" style="margin-top: 12px;">
                        <button class="btn-success" onclick="saveKeys()">üíæ Ulo≈æit</button>
                        <button class="btn-secondary" onclick="exportSettings()">üì• Export</button>
                        <button class="btn-secondary" onclick="importSettings()">üì§ Import</button>
                        <button class="btn-danger" onclick="clearKeys()">üóëÔ∏è Smazat</button>
                    </div>
                    <div style="margin-top: 8px; font-size: 11px; color: #64748b;">
                        ‚úÖ = vlastn√≠ kl√≠ƒç | ‚ö†Ô∏è = demo kl√≠ƒç | ‚óã = ≈æ√°dn√Ω kl√≠ƒç
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Chat - dotaz i odpovƒõƒè spolu -->
    <div class="card">
        <div class="card-title"><span class="icon">üí¨</span> Chat</div>
        
        <div class="chat-container">
            <!-- System prompt - rozbalovac√≠ -->
            <div class="collapsible-section">
                <div class="collapsible-header-mini" onclick="toggleSection('systemSection')">
                    <span>‚öôÔ∏è System prompt (voliteln√Ω)</span>
                    <span class="arrow" id="systemSectionArrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content-mini" id="systemSection">
                    <textarea id="systemPrompt" placeholder="Nap≈ô: Jsi pomocn√Ω asistent pro CNC programov√°n√≠..."></textarea>
                </div>
            </div>
            
            <div class="prompt-area">
                <label>üí¨ Chat:</label>
                
                <!-- Chat kontejner -->
                <div class="chat-container" id="chatContainer">
                    <div class="chat-empty" id="chatEmpty">Zaƒçni konverzaci...</div>
                </div>
                
                <!-- N√°hled souboru/obr√°zku -->
                <div class="file-preview-bar" id="filePreviewBar" style="display: none;">
                    <div class="file-preview-item">
                        <img id="previewThumb" src="" alt="" style="display: none;">
                        <span class="file-icon" id="fileIcon">üìÑ</span>
                        <span class="file-name" id="fileName"></span>
                        <button class="remove-file-btn" onclick="removeFile()">√ó</button>
                    </div>
                </div>
                
                <!-- Status bar -->
                <div class="status-bar">
                    <div>
                        <span id="currentProvider">gemini</span> / 
                        <span id="currentModel">-</span>
                    </div>
                    <div class="status-badge ready" id="statusBadge">
                        ‚óè P≈ôipraven
                    </div>
                </div>
                
                <!-- Input area -->
                <div class="chat-input-area">
                    <input type="file" id="fileInput" accept="image/*,.pdf,.txt,.md,.json,.csv" onchange="handleFileSelect(event)" style="display: none;">
                    <button class="btn-upload" onclick="document.getElementById('fileInput').click()" title="Nahr√°t soubor nebo obr√°zek">üìé</button>
                    <textarea id="userPrompt" placeholder="Napi≈° zpr√°vu..." oninput="updateTokenCount()"></textarea>
                    <button class="btn-primary" id="btnSend" onclick="sendRequest()">üì§</button>
                </div>
                <div class="token-counter">
                    <span id="tokenCount">~0 token≈Ø</span>
                    <span class="token-cost" id="tokenCost"></span>
                </div>
            </div>
            
            <!-- Skryt√° sekce pro kompatibilitu -->
            <div class="image-upload-section" id="imageUploadSection" style="display: none;">
                <label>üëÅÔ∏è Obr√°zek pro Vision model:</label>
                <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                    <input type="file" id="imageInput" accept="image/*" onchange="handleImageUpload(event)" style="display: none;">
                    <div class="upload-placeholder" id="uploadPlaceholder">
                        <span class="upload-icon">üì∑</span>
                        <span>Klikni nebo p≈ôet√°hni obr√°zek</span>
                    </div>
                    <div class="image-preview" id="imagePreview" style="display: none;">
                        <img id="previewImg" src="" alt="Preview">
                        <button class="remove-image" onclick="removeImage(event)">√ó</button>
                    </div>
                </div>
                <div class="image-info" id="imageInfo"></div>
            </div>
            
            <!-- Dal≈°√≠ akce -->
            <div class="btn-row">
                <button class="btn-secondary" onclick="sendStream()">
                    üì° Stream
                </button>
                <button class="btn-secondary" onclick="clearChat()">
                    üßπ Vyƒçistit chat
                </button>
                <button class="btn-secondary" onclick="copyResponse()" title="Kop√≠rovat posledn√≠ odpovƒõƒè">
                    üìã Kop√≠rovat
                </button>
            </div>
            
            <!-- Pokroƒçil√© akce - rozbalovac√≠ -->
            <div class="collapsible-section">
                <div class="collapsible-header-mini" onclick="toggleSection('advancedSection')">
                    <span>üîß Pokroƒçil√© akce</span>
                    <span class="arrow" id="advancedSectionArrow">‚ñ∂</span>
                </div>
                <div class="collapsible-content-mini" id="advancedSection">
                    <div class="btn-row">
                        <button class="btn-secondary" onclick="testFallback()">
                            üéØ Fallback test
                        </button>
                        <button class="btn-secondary" onclick="testAllModels()">
                            üß™ Test v≈°ech model≈Ø
                        </button>
                        <button class="btn-secondary" onclick="fetchAvailableModels()">
                            üîç Zjistit dostupn√© modely
                        </button>
                        <button class="btn-secondary" onclick="retryLastRequest()">
                            üîÑ Retry
                        </button>
                        <button class="btn-secondary" onclick="compareModels()">
                            ‚öñÔ∏è Porovnat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Historie chatu -->
    <div class="card">
        <div class="collapsible-header" onclick="toggleHistory()">
            <div class="card-title" style="margin: 0;"><span class="icon">üìú</span> Historie chatu</div>
            <span class="arrow" id="historyArrow">‚ñº</span>
        </div>
        <div class="collapsible-content" id="historyContent">
            <div id="chatHistory" class="chat-history">
                <div class="history-empty">Zat√≠m ≈æ√°dn√° historie...</div>
            </div>
            <div class="btn-row" style="padding-top: 12px;">
                <button class="btn-danger" onclick="clearHistory()">üóëÔ∏è Smazat historii</button>
                <button class="btn-secondary" onclick="exportHistory()">üì• Export</button>
            </div>
        </div>
    </div>
</div>

<!-- Test Results Modal -->
<div id="testModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>üß™ V√Ωsledky testov√°n√≠ AI model≈Ø</h2>
            <button class="modal-close" onclick="closeTestModal()">√ó</button>
        </div>
        <div id="testSummary" class="test-summary"></div>
        <div id="testResults"></div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="copyTestReport()">üìã Zkop√≠rovat Report</button>
            <button class="btn-primary" onclick="closeTestModal()">Zav≈ô√≠t</button>
        </div>
    </div>
</div>

<!-- Available Models Modal -->
<div id="modelsModal" class="modal" style="display: none;">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h2>üîç Dostupn√© AI modely</h2>
            <button class="modal-close" onclick="closeModelsModal()">√ó</button>
        </div>
        <div id="modelsSummary" class="test-summary"></div>
        <div id="modelsResults" class="models-results"></div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="updateLocalModels()">üîÑ Aktualizovat lok√°ln√≠ seznam</button>
            <button class="btn-secondary" onclick="copyModelsReport()">üìã Zkop√≠rovat</button>
            <button class="btn-primary" onclick="closeModelsModal()">Zav≈ô√≠t</button>
        </div>
    </div>
</div>

<!-- Compare Models Modal -->
<div id="compareModal" class="modal" style="display: none;">
    <div class="modal-content modal-wide">
        <div class="modal-header">
            <h2>‚öñÔ∏è Porovn√°n√≠ model≈Ø</h2>
            <button class="modal-close" onclick="closeCompareModal()">√ó</button>
        </div>
        <div id="compareSummary" class="test-summary"></div>
        <div id="compareResults" class="compare-results"></div>
        <div class="modal-footer">
            <button class="btn-secondary" onclick="copyCompareReport()">üìã Zkop√≠rovat report</button>
            <button class="btn-primary" onclick="closeCompareModal()">Zav≈ô√≠t</button>
        </div>
    </div>
</div>

<!-- Hidden import input -->
<input type="file" id="importInput" accept=".json" style="display: none;" onchange="handleImport(event)">

<!-- Mini Console -->
<div id="miniConsole" style="display: none;">
    <div class="console-header">
        <span>üñ•Ô∏è Konzole</span>
        <div>
            <button onclick="clearConsole()" style="background:none;border:none;color:#94a3b8;cursor:pointer;">üóëÔ∏è</button>
            <button onclick="toggleConsole()" style="background:none;border:none;color:#94a3b8;cursor:pointer;">‚úï</button>
        </div>
    </div>
    <div id="consoleOutput"></div>
</div>

<button id="consoleToggle" onclick="toggleConsole()" title="Zobrazit konzoli">üñ•Ô∏è</button>


<!-- AI Module v2.0 -->
<script src="ai-module.js"></script>

<script>
// ============================================================
// UI LOGIKA
// ============================================================
// MINI KONZOLE
// ============================================================

let consoleVisible = false;

function toggleConsole() {
    const miniConsole = document.getElementById('miniConsole');
    const toggle = document.getElementById('consoleToggle');
    consoleVisible = !consoleVisible;
    miniConsole.style.display = consoleVisible ? 'block' : 'none';
    toggle.textContent = consoleVisible ? '‚úï' : 'üñ•Ô∏è';
    toggle.style.background = consoleVisible ? '#f85149' : '#238636';
}

function clearConsole() {
    document.getElementById('consoleOutput').innerHTML = '';
}

function logToConsole(type, ...args) {
    const output = document.getElementById('consoleOutput');
    if (!output) return;
    
    const entry = document.createElement('div');
    entry.className = 'console-entry console-' + type;
    
    const time = new Date().toLocaleTimeString('cs-CZ');
    const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : type === 'info' ? '‚ÑπÔ∏è' : 'üìù';
    
    let text = args.map(arg => {
        if (typeof arg === 'object') {
            try {
                return JSON.stringify(arg, null, 2);
            } catch (e) {
                return String(arg);
            }
        }
        return String(arg);
    }).join(' ');
    
    entry.innerHTML = `<span style="color:#6e7681">[${time}]</span> ${prefix} ${text}`;
    output.appendChild(entry);
    output.scrollTop = output.scrollHeight;
}

// Zachytit glob√°ln√≠ chyby
window.onerror = function(msg, url, line, col, error) {
    logToConsole('error', `${msg} (≈ô√°dek ${line})`);
};

window.onunhandledrejection = function(event) {
    logToConsole('error', 'Promise rejected:', event.reason);
};

// ============================================================
// PROVIDER MANAGEMENT
// ============================================================

let currentProvider = 'gemini';

// Init
document.addEventListener('DOMContentLoaded', () => {
    loadKeys();
    updateKeyStatuses();
    updateModels();
    setupProviderTabs();
    loadHistory();
    setupImageDragDrop();
    updateTokenCount();
    
    // Nastav v√Ωchoz√≠ system prompt pro ƒçe≈°tinu
    const systemPrompt = document.getElementById('systemPrompt');
    if (systemPrompt) {
        systemPrompt.value = 'Odpov√≠dej v≈ædy ƒçesky. Jsi p≈ô√°telsk√Ω a n√°pomocn√Ω asistent.';
        systemPrompt.addEventListener('input', updateTokenCount);
    }
    
    updateTokenCount();
});

// Provider tabs
function setupProviderTabs() {
    const tabs = document.querySelectorAll('.provider-tab');
    if (!tabs.length) return;
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            currentProvider = tab.dataset.provider;
            const providerEl = document.getElementById('currentProvider');
            if (providerEl) providerEl.textContent = currentProvider;
            updateModels();
            
            // Upozornƒõn√≠ pro HuggingFace na file://
            showProviderWarning(currentProvider);
        });
    });
}

function showProviderWarning(provider) {
    // Odstranit p≈ôedchoz√≠ upozornƒõn√≠
    const existingWarning = document.getElementById('providerWarning');
    if (existingWarning) existingWarning.remove();
    
    if (provider === 'huggingface' && window.location.protocol === 'file:') {
        const warning = document.createElement('div');
        warning.id = 'providerWarning';
        warning.style.cssText = 'background: rgba(251, 191, 36, 0.2); border: 1px solid #fbbf24; border-radius: 8px; padding: 10px 14px; margin-top: 12px; font-size: 12px; color: #fbbf24;';
        warning.innerHTML = '‚ö†Ô∏è <strong>HuggingFace</strong> nefunguje z lok√°ln√≠ho disku (file://). Spus≈• p≈ôes HTTP server: <code style="background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px;">python -m http.server</code>';
        
        const modelSection = document.querySelector('.model-section');
        if (modelSection) {
            modelSection.parentNode.insertBefore(warning, modelSection.nextSibling);
        }
    }
}

// Update models for selected provider
function updateModels() {
    const select = document.getElementById('modelSelect');
    if (!select) return;
    
    const models = AI.getModels(currentProvider);
    
    select.innerHTML = '';
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.value;
        option.textContent = `${model.name} (${model.rpm} RPM)`;
        select.appendChild(option);
    });
    
    updateModelInfo();
    
    select.onchange = updateModelInfo;
}

function updateModelInfo() {
    const select = document.getElementById('modelSelect');
    if (!select || !select.value) return;
    
    const model = select.value;
    const limit = AI.getModelLimit(model);
    
    const rpmEl = document.getElementById('modelRpm');
    const modelEl = document.getElementById('currentModel');
    
    if (rpmEl) {
        if (AI.supportsVision(model)) {
            rpmEl.innerHTML = limit + ' <span style="font-size:12px">üëÅÔ∏è</span>';
        } else {
            rpmEl.textContent = limit;
        }
    }
    
    if (modelEl) {
        modelEl.textContent = model.split('/').pop();
    }
    
    // Aktualizovat info v hlaviƒçce Nastaven√≠
    const settingsInfo = document.getElementById('currentSettingsInfo');
    if (settingsInfo) {
        const shortModel = model.split('/').pop().substring(0, 25);
        settingsInfo.textContent = `(${currentProvider} / ${shortModel})`;
    }
    
    // Zobrazit/skr√Ωt upload obr√°zku
    checkVisionModel();
}

// Keys management
function loadKeys() {
    const keys = JSON.parse(localStorage.getItem('aiModuleKeys') || '{}');
    
    const geminiInput = document.getElementById('keyGemini');
    const groqInput = document.getElementById('keyGroq');
    const openrouterInput = document.getElementById('keyOpenrouter');
    const mistralInput = document.getElementById('keyMistral');
    const cohereInput = document.getElementById('keyCohere');
    const huggingfaceInput = document.getElementById('keyHuggingface');
    
    if (geminiInput) geminiInput.value = keys.gemini || '';
    if (groqInput) groqInput.value = keys.groq || '';
    if (openrouterInput) openrouterInput.value = keys.openrouter || '';
    if (mistralInput) mistralInput.value = keys.mistral || '';
    if (cohereInput) cohereInput.value = keys.cohere || '';
    if (huggingfaceInput) huggingfaceInput.value = keys.huggingface || '';
    
    Object.entries(keys).forEach(([provider, key]) => {
        if (key) AI.setKey(provider, key);
    });
}

function saveKeys() {
    const keys = {
        gemini: document.getElementById('keyGemini')?.value.trim() || '',
        groq: document.getElementById('keyGroq')?.value.trim() || '',
        openrouter: document.getElementById('keyOpenrouter')?.value.trim() || '',
        mistral: document.getElementById('keyMistral')?.value.trim() || '',
        cohere: document.getElementById('keyCohere')?.value.trim() || '',
        huggingface: document.getElementById('keyHuggingface')?.value.trim() || ''
    };
    
    localStorage.setItem('aiModuleKeys', JSON.stringify(keys));
    
    Object.entries(keys).forEach(([provider, key]) => {
        AI.setKey(provider, key);
    });
    
    updateKeyStatuses();
    alert('‚úÖ Kl√≠ƒçe ulo≈æeny!');
}

function clearKeys() {
    if (!confirm('Opravdu smazat v≈°echny kl√≠ƒçe?')) return;
    
    localStorage.removeItem('aiModuleKeys');
    ['keyGemini', 'keyGroq', 'keyOpenrouter', 'keyMistral', 'keyCohere', 'keyHuggingface'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
    ['gemini', 'groq', 'openrouter', 'mistral', 'cohere', 'huggingface'].forEach(p => AI.setKey(p, ''));
    updateKeyStatuses();
}

// ============================================================
// EXPORT / IMPORT NASTAVEN√ç
// ============================================================

function exportSettings() {
    const settings = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        keys: JSON.parse(localStorage.getItem('aiModuleKeys') || '{}'),
        history: JSON.parse(localStorage.getItem('aiChatHistory') || '[]'),
        preferences: {
            lastProvider: currentProvider,
            lastModel: document.getElementById('modelSelect')?.value
        }
    };
    
    const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-module-backup-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
    
    alert('‚úÖ Nastaven√≠ exportov√°no!');
}

function importSettings() {
    document.getElementById('importInput').click();
}

function handleImport(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const settings = JSON.parse(e.target.result);
            
            // Validace
            if (!settings.version || !settings.keys) {
                throw new Error('Neplatn√Ω form√°t souboru');
            }
            
            // Import kl√≠ƒç≈Ø
            if (settings.keys) {
                localStorage.setItem('aiModuleKeys', JSON.stringify(settings.keys));
                loadKeys();
            }
            
            // Import historie (volitelnƒõ)
            if (settings.history && settings.history.length > 0) {
                if (confirm(`Importovat tak√© historii chatu (${settings.history.length} polo≈æek)?`)) {
                    const existingHistory = JSON.parse(localStorage.getItem('aiChatHistory') || '[]');
                    const merged = [...existingHistory, ...settings.history];
                    // Deduplikace podle id
                    const unique = merged.filter((item, index, self) => 
                        index === self.findIndex(t => t.id === item.id)
                    );
                    localStorage.setItem('aiChatHistory', JSON.stringify(unique));
                    loadHistory();
                }
            }
            
            updateKeyStatuses();
            alert('‚úÖ Nastaven√≠ importov√°no!');
            
        } catch (err) {
            alert('‚ùå Chyba p≈ôi importu: ' + err.message);
        }
    };
    reader.readAsText(file);
    
    // Reset input
    event.target.value = '';
}

// ============================================================
// RETRY POSLEDN√ç DOTAZ
// ============================================================

let lastRequest = {
    prompt: null,
    system: null,
    provider: null,
    model: null
};

function saveLastRequest(prompt, system, provider, model) {
    lastRequest = { prompt, system, provider, model };
}

async function retryLastRequest() {
    if (!lastRequest.prompt) {
        alert('≈Ω√°dn√Ω p≈ôedchoz√≠ dotaz k opakov√°n√≠');
        return;
    }
    
    // Obnovit hodnoty
    const promptEl = document.getElementById('userPrompt');
    const systemEl = document.getElementById('systemPrompt');
    
    if (promptEl) promptEl.value = lastRequest.prompt;
    if (systemEl) systemEl.value = lastRequest.system || '';
    
    // Odeslat
    await sendRequest();
}

// ============================================================
// POROVN√ÅN√ç MODEL≈Æ
// ============================================================

let compareResults = [];
let selectedModelsForCompare = [];

function compareModels() {
    const prompt = document.getElementById('userPrompt')?.value.trim();
    
    if (!prompt) {
        alert('Zadej dotaz pro porovn√°n√≠!');
        return;
    }
    
    const modal = document.getElementById('compareModal');
    const summaryEl = document.getElementById('compareSummary');
    const resultsEl = document.getElementById('compareResults');
    
    if (!modal) return;
    
    modal.style.display = 'flex';
    
    // Vytvo≈ôit v√Ωbƒõr model≈Ø
    summaryEl.innerHTML = '';
    resultsEl.innerHTML = renderModelSelector();
    
    // Inicializovat vybran√© modely (prvn√≠ z ka≈æd√©ho providera s kl√≠ƒçem)
    selectedModelsForCompare = [];
    const providers = ['gemini', 'groq', 'openrouter', 'mistral', 'cohere', 'huggingface'];
    
    providers.forEach(provider => {
        if (AI.getKey(provider)) {
            const models = AI.ALL_MODELS[provider];
            if (models && models.length > 0) {
                selectedModelsForCompare.push({
                    provider: provider,
                    model: models[0].value,
                    name: models[0].name
                });
            }
        }
    });
    
    updateModelSelector();
}

function renderModelSelector() {
    const providerEmojis = { 
        gemini: 'ü§ñ', groq: '‚ö°', openrouter: 'üåê', 
        mistral: 'üî•', cohere: 'üß†', huggingface: 'ü§ó' 
    };
    
    let html = `
        <div class="compare-model-select">
            <label>Vyber modely pro porovn√°n√≠ (klikni pro v√Ωbƒõr/zru≈°en√≠):</label>
            <div class="compare-checkboxes" id="modelCheckboxes">
    `;
    
    const providers = ['gemini', 'groq', 'openrouter', 'mistral', 'cohere', 'huggingface'];
    
    providers.forEach(provider => {
        const key = AI.getKey(provider);
        const models = AI.ALL_MODELS[provider] || [];
        
        if (!key || models.length === 0) return;
        
        models.forEach(model => {
            const id = `compare_${provider}_${model.value.replace(/[^a-zA-Z0-9]/g, '_')}`;
            html += `
                <label class="compare-checkbox" data-provider="${provider}" data-model="${model.value}" data-name="${model.name}" onclick="toggleModelForCompare(this)">
                    ${providerEmojis[provider]} ${model.name.replace(/[ü§ñ‚ö°üåêüî•üß†ü§óüíªüí¨üëÅÔ∏èü¶ôüî¨ü™∂üß™]/g, '').trim()}
                </label>
            `;
        });
    });
    
    html += `
            </div>
            <div style="margin-top: 12px;">
                <button class="btn-primary" onclick="startComparison()">üöÄ Spustit porovn√°n√≠</button>
                <button class="btn-secondary" onclick="selectAllModels()">Vybrat v≈°e</button>
                <button class="btn-secondary" onclick="deselectAllModels()">Zru≈°it v√Ωbƒõr</button>
            </div>
        </div>
        <div class="compare-grid" id="compareGrid"></div>
    `;
    
    return html;
}

function toggleModelForCompare(el) {
    const provider = el.dataset.provider;
    const model = el.dataset.model;
    const name = el.dataset.name;
    
    const index = selectedModelsForCompare.findIndex(m => m.provider === provider && m.model === model);
    
    if (index >= 0) {
        selectedModelsForCompare.splice(index, 1);
        el.classList.remove('selected');
    } else {
        selectedModelsForCompare.push({ provider, model, name });
        el.classList.add('selected');
    }
}

function updateModelSelector() {
    document.querySelectorAll('.compare-checkbox').forEach(el => {
        const provider = el.dataset.provider;
        const model = el.dataset.model;
        const isSelected = selectedModelsForCompare.some(m => m.provider === provider && m.model === model);
        el.classList.toggle('selected', isSelected);
    });
}

function selectAllModels() {
    selectedModelsForCompare = [];
    document.querySelectorAll('.compare-checkbox').forEach(el => {
        selectedModelsForCompare.push({
            provider: el.dataset.provider,
            model: el.dataset.model,
            name: el.dataset.name
        });
        el.classList.add('selected');
    });
}

function deselectAllModels() {
    selectedModelsForCompare = [];
    document.querySelectorAll('.compare-checkbox').forEach(el => {
        el.classList.remove('selected');
    });
}

async function startComparison() {
    if (selectedModelsForCompare.length === 0) {
        alert('Vyber alespo≈à jeden model!');
        return;
    }
    
    const prompt = document.getElementById('userPrompt')?.value.trim();
    const system = document.getElementById('systemPrompt')?.value.trim();
    
    if (!prompt) {
        alert('Zadej dotaz!');
        return;
    }
    
    const grid = document.getElementById('compareGrid');
    const summaryEl = document.getElementById('compareSummary');
    
    compareResults = [];
    
    // P≈ôipravit karty
    grid.innerHTML = selectedModelsForCompare.map((m, i) => `
        <div class="compare-card loading" id="compareCard${i}">
            <div class="compare-card-header">
                <div class="compare-card-title">${m.name}</div>
                <div class="compare-card-meta">${m.provider}</div>
            </div>
            <div class="compare-card-response loading-text">‚è≥ ƒåek√°m na odpovƒõƒè...</div>
        </div>
    `).join('');
    
    // Spustit v≈°echny paralelnƒõ
    const promises = selectedModelsForCompare.map(async (m, i) => {
        const startTime = performance.now();
        
        try {
            const response = await AI.ask(prompt, {
                provider: m.provider,
                model: m.model,
                system: system || undefined
            });
            
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
            
            compareResults.push({
                provider: m.provider,
                model: m.model,
                name: m.name,
                success: true,
                response: response,
                time: elapsed,
                chars: response.length
            });
            
            updateCompareCard(i, true, response, elapsed);
            
        } catch (error) {
            const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
            
            compareResults.push({
                provider: m.provider,
                model: m.model,
                name: m.name,
                success: false,
                error: error.message,
                time: elapsed
            });
            
            updateCompareCard(i, false, error.message, elapsed);
        }
    });
    
    await Promise.all(promises);
    
    // Aktualizovat souhrn
    const success = compareResults.filter(r => r.success).length;
    const failed = compareResults.filter(r => !r.success).length;
    const avgTime = success > 0 
        ? (compareResults.filter(r => r.success).reduce((sum, r) => sum + parseFloat(r.time), 0) / success).toFixed(2)
        : 0;
    const fastest = success > 0
        ? compareResults.filter(r => r.success).sort((a, b) => parseFloat(a.time) - parseFloat(b.time))[0]
        : null;
    
    summaryEl.innerHTML = `
        <div class="summary-card">
            <div class="value">${selectedModelsForCompare.length}</div>
            <div class="label">üì¶ Testov√°no</div>
        </div>
        <div class="summary-card success">
            <div class="value">${success}</div>
            <div class="label">‚úÖ √öspƒõch</div>
        </div>
        <div class="summary-card error">
            <div class="value">${failed}</div>
            <div class="label">‚ùå Chyba</div>
        </div>
        <div class="summary-card">
            <div class="value">${avgTime}s</div>
            <div class="label">‚ö° Pr≈Ømƒõr</div>
        </div>
        ${fastest ? `
        <div class="summary-card" style="--card-color: #22c55e;">
            <div class="value" style="color: #22c55e; font-size: 14px;">${fastest.name.substring(0, 15)}</div>
            <div class="label">üèÜ Nejrychlej≈°√≠</div>
        </div>
        ` : ''}
    `;
}

function updateCompareCard(index, success, content, time) {
    const card = document.getElementById(`compareCard${index}`);
    if (!card) return;
    
    card.classList.remove('loading');
    card.classList.add(success ? 'success' : 'error');
    
    const responseEl = card.querySelector('.compare-card-response');
    responseEl.classList.remove('loading-text');
    
    if (success) {
        responseEl.textContent = content;
    } else {
        responseEl.classList.add('error-text');
        responseEl.textContent = '‚ùå ' + content;
    }
    
    const metaEl = card.querySelector('.compare-card-meta');
    metaEl.textContent += ` ‚Ä¢ ${time}s`;
    if (success) {
        metaEl.textContent += ` ‚Ä¢ ${content.length} znak≈Ø`;
    }
}

function closeCompareModal() {
    const modal = document.getElementById('compareModal');
    if (modal) modal.style.display = 'none';
}

function copyCompareReport() {
    const prompt = document.getElementById('userPrompt')?.value.trim();
    
    let report = '‚öñÔ∏è POROVN√ÅN√ç AI MODEL≈Æ\n';
    report += '========================\n\n';
    report += `üìù Dotaz: ${prompt}\n\n`;
    
    const success = compareResults.filter(r => r.success);
    const failed = compareResults.filter(r => !r.success);
    
    report += `üìä V√Ωsledky: ‚úÖ ${success.length} OK | ‚ùå ${failed.length} chyb\n\n`;
    
    if (success.length > 0) {
        // Se≈ôadit podle ƒçasu
        const sorted = [...success].sort((a, b) => parseFloat(a.time) - parseFloat(b.time));
        
        report += 'üèÜ PO≈òAD√ç (podle rychlosti):\n';
        report += '-'.repeat(40) + '\n';
        
        sorted.forEach((r, i) => {
            report += `${i + 1}. ${r.name} (${r.provider}) - ${r.time}s\n`;
            report += `   Odpovƒõƒè: ${r.response.substring(0, 100)}${r.response.length > 100 ? '...' : ''}\n\n`;
        });
    }
    
    if (failed.length > 0) {
        report += '\n‚ùå CHYBY:\n';
        failed.forEach(r => {
            report += `- ${r.name}: ${r.error}\n`;
        });
    }
    
    copyToClipboard(report).then(success => {
        if (success) {
            alert('üìã Report zkop√≠rov√°n!');
        } else {
            const win = window.open('', '_blank', 'width=600,height=400');
            win.document.write('<pre style="white-space: pre-wrap; font-family: monospace;">' + report.replace(/</g, '&lt;') + '</pre>');
            win.document.title = 'Compare Report';
        }
    });
}

function updateKeyStatuses() {
    ['gemini', 'groq', 'openrouter', 'mistral', 'cohere', 'huggingface'].forEach(provider => {
        const statusId = 'status' + provider.charAt(0).toUpperCase() + provider.slice(1);
        const status = document.getElementById(statusId);
        if (!status) return;
        
        const hasCustom = AI.config.keys[provider] && AI.config.keys[provider].length > 10;
        const hasDemo = AI.DEMO_KEYS[provider] && AI.DEMO_KEYS[provider].length > 10;
        
        if (hasCustom) {
            status.textContent = '‚úÖ';
            status.className = 'key-status ok';
            status.title = 'Vlastn√≠ kl√≠ƒç';
        } else if (hasDemo) {
            status.textContent = '‚ö†Ô∏è';
            status.className = 'key-status demo';
            status.title = 'Demo kl√≠ƒç';
        } else {
            status.textContent = '‚óã';
            status.className = 'key-status none';
            status.title = '≈Ω√°dn√Ω kl√≠ƒç';
        }
    });
}

function toggleKeys() {
    const content = document.getElementById('keysContent');
    if (!content) return;
    
    const header = content.previousElementSibling;
    content.classList.toggle('open');
    if (header) header.classList.toggle('open');
}

// Status helpers
function setStatus(type, text) {
    const badge = document.getElementById('statusBadge');
    if (!badge) return;
    
    badge.className = 'status-badge ' + type;
    
    if (type === 'loading') {
        badge.innerHTML = '<div class="loading-dots"><span></span><span></span><span></span></div> ' + text;
    } else {
        badge.innerHTML = '‚óè ' + text;
    }
}

// Glob√°ln√≠ promƒõnn√° pro posledn√≠ odpovƒõƒè
let lastResponse = '';

// P≈ôid√° zpr√°vu do chatu
function addChatMessage(text, isUser = false, isError = false, isLoading = false, attachment = null) {
    const container = document.getElementById('chatContainer');
    const empty = document.getElementById('chatEmpty');
    if (!container) return;
    
    // Skryj placeholder
    if (empty) empty.style.display = 'none';
    
    const msgDiv = document.createElement('div');
    msgDiv.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
    
    const bubble = document.createElement('div');
    bubble.className = 'chat-bubble';
    if (isError) bubble.classList.add('error');
    if (isLoading) bubble.classList.add('loading');
    
    // P≈ôidej text
    if (text) {
        bubble.textContent = text;
    }
    
    // P≈ôidej p≈ô√≠lohu (obr√°zek nebo soubor)
    if (attachment) {
        const attachDiv = document.createElement('div');
        attachDiv.className = 'attachment-preview';
        
        if (attachment.type === 'image' && attachment.dataUrl) {
            const img = document.createElement('img');
            img.src = attachment.dataUrl;
            img.alt = attachment.name || 'Obr√°zek';
            attachDiv.appendChild(img);
        } else {
            const fileDiv = document.createElement('div');
            fileDiv.className = 'attachment-file';
            fileDiv.innerHTML = `üìé ${attachment.name}`;
            attachDiv.appendChild(fileDiv);
        }
        
        bubble.appendChild(attachDiv);
    }
    
    msgDiv.appendChild(bubble);
    container.appendChild(msgDiv);
    
    // Scroll dol≈Ø
    container.scrollTop = container.scrollHeight;
    
    return bubble; // Vr√°t√≠ bublinu pro pozdƒõj≈°√≠ update
}

// Aktualizuje posledn√≠ AI bublinu
function updateLastAssistantBubble(text, isError = false) {
    const container = document.getElementById('chatContainer');
    if (!container) return;
    
    const messages = container.querySelectorAll('.chat-message.assistant');
    if (messages.length === 0) return;
    
    const lastMsg = messages[messages.length - 1];
    const bubble = lastMsg.querySelector('.chat-bubble');
    if (bubble) {
        bubble.textContent = text;
        bubble.classList.remove('loading', 'error');
        if (isError) bubble.classList.add('error');
    }
    
    container.scrollTop = container.scrollHeight;
}

// Vyƒçist√≠ chat
function clearChat() {
    const container = document.getElementById('chatContainer');
    const empty = document.getElementById('chatEmpty');
    if (container) {
        container.innerHTML = '';
        if (empty) {
            container.appendChild(empty);
            empty.style.display = 'block';
        } else {
            container.innerHTML = '<div class="chat-empty" id="chatEmpty">Zaƒçni konverzaci...</div>';
        }
    }
    lastResponse = '';
}

// Star√Ω setOutput pro kompatibilitu (p≈ôesmƒõruje do chatu)
function setOutput(text, isError = false, isLoading = false) {
    // Pro kompatibilitu - pokud existuje #output, pou≈æij ho
    const output = document.getElementById('output');
    if (output) {
        output.textContent = text;
        output.className = isError ? 'error' : (isLoading ? 'loading' : '');
    }
}

// Send request
async function sendRequest() {
    const promptInput = document.getElementById('userPrompt');
    let prompt = promptInput?.value.trim();
    const system = document.getElementById('systemPrompt')?.value.trim();
    const model = document.getElementById('modelSelect')?.value;
    
    // Pokud nen√≠ prompt ale je soubor, pou≈æij v√Ωchoz√≠ prompt
    if (!prompt && !uploadedFile.base64 && !uploadedFile.content) {
        alert('Zadej dotaz nebo nahraj soubor!');
        return;
    }
    
    // P≈ôiprav attachment info pro zobrazen√≠ v chatu
    let attachment = null;
    if (uploadedFile.base64 || uploadedFile.content) {
        attachment = {
            type: uploadedFile.type,
            name: uploadedFile.name,
            dataUrl: uploadedFile.dataUrl
        };
    }
    
    // Pokud je textov√Ω soubor, p≈ôidej obsah do promptu
    if (uploadedFile.type === 'text' && uploadedFile.content) {
        const fileContent = uploadedFile.content.substring(0, 10000); // Max 10k znak≈Ø
        prompt = prompt 
            ? `${prompt}\n\nObsah souboru "${uploadedFile.name}":\n\`\`\`\n${fileContent}\n\`\`\``
            : `Analyzuj tento soubor "${uploadedFile.name}":\n\`\`\`\n${fileContent}\n\`\`\``;
    }
    
    // Pokud je obr√°zek bez textu, p≈ôidej v√Ωchoz√≠ prompt
    if (uploadedFile.type === 'image' && !prompt) {
        prompt = 'Co vid√≠≈° na tomto obr√°zku? Popi≈° ho.';
    }
    
    // Ulo≈æ image data p≈ôed vyƒçi≈°tƒõn√≠m
    const imageData = uploadedFile.type === 'image' ? {
        base64: uploadedFile.base64,
        mimeType: uploadedFile.mimeType
    } : null;
    
    // P≈ôidej u≈æivatelovu zpr√°vu do chatu (s p≈ô√≠lohou)
    addChatMessage(promptInput?.value.trim() || prompt, true, false, false, attachment);
    
    // Vyƒçisti input a soubor
    if (promptInput) promptInput.value = '';
    removeFile();
    updateTokenCount();
    
    // Ulo≈æit pro retry
    saveLastRequest(prompt, system, currentProvider, model);
    
    const btn = document.getElementById('btnSend');
    if (btn) btn.disabled = true;
    
    setStatus('loading', 'Odes√≠l√°m...');
    
    // P≈ôidej loading zpr√°vu od asistenta
    addChatMessage('P≈ôem√Ω≈°l√≠m...', false, false, true);
    
    const startTime = performance.now();
    
    try {
        // P≈ôipravit options
        const options = {
            provider: currentProvider,
            model: model,
            system: system || undefined
        };
        
        // P≈ôidat obr√°zek pokud byl nahr√°n a model podporuje vision
        if (imageData && AI.supportsVision(model)) {
            options.imageBase64 = imageData.base64;
            options.imageMimeType = imageData.mimeType;
        }
        
        const response = await AI.ask(prompt, options);
        
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
        
        // Aktualizuj loading zpr√°vu na skuteƒçnou odpovƒõƒè
        updateLastAssistantBubble(response);
        lastResponse = response;
        
        setStatus('success', `Hotovo (${elapsed}s)`);
        
        // P≈ôidat do historie
        addToHistory(prompt, response, currentProvider, model, elapsed);
        
    } catch (error) {
        updateLastAssistantBubble('‚ùå Chyba: ' + error.message, true);
        setStatus('error', 'Chyba');
    }
    
    if (btn) btn.disabled = false;
}

// Stream
async function sendStream() {
    const promptInput = document.getElementById('userPrompt');
    const prompt = promptInput?.value.trim();
    const system = document.getElementById('systemPrompt')?.value.trim();
    const model = document.getElementById('modelSelect')?.value;
    
    if (!prompt) {
        alert('Zadej dotaz!');
        return;
    }
    
    // P≈ôidej u≈æivatelovu zpr√°vu do chatu
    addChatMessage(prompt, true);
    
    // Vyƒçisti input
    if (promptInput) promptInput.value = '';
    updateTokenCount();
    
    setStatus('loading', 'Streamuji...');
    
    // P≈ôidej pr√°zdnou bublinu pro stream
    const bubble = addChatMessage('', false, false, true);
    
    const startTime = performance.now();
    let fullResponse = '';
    
    try {
        for await (const chunk of AI.askStream(prompt, {
            provider: currentProvider,
            model: model,
            system: system || undefined
        })) {
            fullResponse += chunk;
            if (bubble) {
                bubble.textContent = fullResponse;
                bubble.classList.remove('loading');
            }
            // Scroll chat dol≈Ø
            const container = document.getElementById('chatContainer');
            if (container) container.scrollTop = container.scrollHeight;
        }
        
        lastResponse = fullResponse;
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
        setStatus('success', `Stream hotov (${elapsed}s)`);
        
        // P≈ôidat do historie
        addToHistory(prompt, fullResponse, currentProvider, model, elapsed);
        
    } catch (error) {
        if (bubble) {
            bubble.textContent = '‚ùå Chyba: ' + error.message;
            bubble.classList.add('error');
            bubble.classList.remove('loading');
        }
        setStatus('error', 'Chyba');
    }
}

// Fallback test
async function testFallback() {
    const prompt = document.getElementById('userPrompt')?.value.trim();
    const system = document.getElementById('systemPrompt')?.value.trim();
    
    if (!prompt) {
        alert('Zadej dotaz!');
        return;
    }
    
    setStatus('loading', 'Zkou≈°√≠m providery...');
    setOutput('üîÑ Testuji fallback p≈ôes v≈°echny providery...\n\n', false, true);
    
    const output = document.getElementById('output');
    const startTime = performance.now();
    
    try {
        const response = await AI.askWithFallback(prompt, {
            system: system || undefined
        });
        
        const elapsed = ((performance.now() - startTime) / 1000).toFixed(2);
        if (output) {
            output.textContent += response;
            output.className = '';
        }
        setStatus('success', `Fallback OK (${elapsed}s)`);
        
    } catch (error) {
        if (output) {
            output.textContent += '‚ùå V≈°ichni selhali: ' + error.message;
            output.className = 'error';
        }
        setStatus('error', 'V≈°e selhalo');
    }
}

// Clear
function clearOutput() {
    clearChat();
    setStatus('ready', 'P≈ôipraven');
}

// Copy response
function copyResponse() {
    if (!lastResponse) {
        return;
    }
    
    copyToClipboard(lastResponse).then(success => {
        if (success) {
            // Vizu√°ln√≠ feedback
            const btn = event?.target;
            if (btn) {
                const originalText = btn.textContent;
                btn.textContent = '‚úÖ Zkop√≠rov√°no';
                setTimeout(() => btn.textContent = originalText, 1000);
            }
        }
    });
}

// ============================================================
// HISTORIE CHATU
// ============================================================

let chatHistory = [];

function loadHistory() {
    const saved = localStorage.getItem('aiChatHistory');
    if (saved) {
        chatHistory = JSON.parse(saved);
        renderHistory();
    }
}

function saveHistory() {
    // Omezit na posledn√≠ch 50 zpr√°v
    if (chatHistory.length > 50) {
        chatHistory = chatHistory.slice(-50);
    }
    localStorage.setItem('aiChatHistory', JSON.stringify(chatHistory));
}

function addToHistory(prompt, response, provider, model, time) {
    chatHistory.push({
        id: Date.now(),
        prompt,
        response,
        provider,
        model,
        time,
        timestamp: new Date().toISOString()
    });
    saveHistory();
    renderHistory();
}

function renderHistory() {
    const container = document.getElementById('chatHistory');
    if (!container) return;
    
    if (chatHistory.length === 0) {
        container.innerHTML = '<div class="history-empty">Zat√≠m ≈æ√°dn√° historie...</div>';
        return;
    }
    
    container.innerHTML = chatHistory.slice().reverse().map(item => {
        const date = new Date(item.timestamp);
        const timeStr = date.toLocaleString('cs-CZ');
        const shortResponse = item.response.length > 200 
            ? item.response.substring(0, 200) + '...' 
            : item.response;
        
        return `
            <div class="history-item">
                <div class="history-meta">
                    <span>${item.provider}/${item.model.split('/').pop()}</span>
                    <span>${timeStr} ‚Ä¢ ${item.time}s</span>
                </div>
                <div class="history-prompt">üí¨ ${escapeHtml(item.prompt)}</div>
                <div class="history-response">${escapeHtml(shortResponse)}</div>
                <div class="history-actions">
                    <button class="btn-small" onclick="reusePrompt('${escapeAttr(item.prompt)}')">üîÑ Znovu</button>
                    <button class="btn-small" onclick="copyHistoryItem('${escapeAttr(item.response)}')">üìã Kop√≠rovat</button>
                    <button class="btn-small" onclick="deleteHistoryItem(${item.id})">üóëÔ∏è</button>
                </div>
            </div>
        `;
    }).join('');
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function escapeAttr(text) {
    return text.replace(/'/g, "\\'").replace(/\n/g, '\\n').substring(0, 500);
}

function reusePrompt(prompt) {
    const textarea = document.getElementById('userPrompt');
    if (textarea) {
        textarea.value = prompt.replace(/\\n/g, '\n');
        textarea.focus();
    }
}

function copyHistoryItem(text) {
    copyToClipboard(text.replace(/\\n/g, '\n'));
}

function deleteHistoryItem(id) {
    chatHistory = chatHistory.filter(item => item.id !== id);
    saveHistory();
    renderHistory();
}

function clearHistory() {
    if (!confirm('Opravdu smazat celou historii?')) return;
    chatHistory = [];
    localStorage.removeItem('aiChatHistory');
    renderHistory();
}

function exportHistory() {
    if (chatHistory.length === 0) {
        alert('Historie je pr√°zdn√°');
        return;
    }
    
    let text = '# AI Chat Historie\n\n';
    chatHistory.forEach(item => {
        const date = new Date(item.timestamp).toLocaleString('cs-CZ');
        text += `## ${date}\n`;
        text += `**Model:** ${item.provider}/${item.model}\n`;
        text += `**ƒåas:** ${item.time}s\n\n`;
        text += `**Dotaz:**\n${item.prompt}\n\n`;
        text += `**Odpovƒõƒè:**\n${item.response}\n\n`;
        text += '---\n\n';
    });
    
    const blob = new Blob([text], { type: 'text/markdown' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `ai-chat-history-${new Date().toISOString().split('T')[0]}.md`;
    a.click();
    URL.revokeObjectURL(url);
}

function toggleHistory() {
    const content = document.getElementById('historyContent');
    const arrow = document.getElementById('historyArrow');
    if (content) {
        content.classList.toggle('open');
    }
    if (arrow) {
        arrow.style.transform = content?.classList.contains('open') ? 'rotate(180deg)' : '';
    }
}

function toggleSection(sectionId) {
    const content = document.getElementById(sectionId);
    const arrow = document.getElementById(sectionId + 'Arrow');
    
    if (content) {
        content.classList.toggle('open');
    }
    if (arrow) {
        arrow.textContent = content?.classList.contains('open') ? '‚ñº' : '‚ñ∂';
    }
}

// ============================================================
// POƒå√çTADLO TOKEN≈Æ
// ============================================================

function estimateTokens(text) {
    if (!text) return 0;
    // P≈ôibli≈æn√Ω odhad: 1 token ‚âà 4 znaky pro angliƒçtinu, 2-3 pro ƒçe≈°tinu
    const words = text.split(/\s+/).filter(w => w.length > 0);
    const chars = text.length;
    // Kombinovan√Ω odhad
    return Math.ceil((chars / 3.5 + words.length) / 2);
}

function updateTokenCount() {
    const prompt = document.getElementById('userPrompt')?.value || '';
    const system = document.getElementById('systemPrompt')?.value || '';
    
    const promptTokens = estimateTokens(prompt);
    const systemTokens = estimateTokens(system);
    const totalTokens = promptTokens + systemTokens;
    
    const tokenCountEl = document.getElementById('tokenCount');
    const tokenCostEl = document.getElementById('tokenCost');
    
    if (tokenCountEl) {
        let label = `~${totalTokens} token≈Ø`;
        if (systemTokens > 0) {
            label += ` (prompt: ${promptTokens}, system: ${systemTokens})`;
        }
        tokenCountEl.textContent = label;
    }
    
    // Odhad ceny (pro placen√© modely)
    if (tokenCostEl) {
        // Vƒõt≈°ina free model≈Ø, tak≈æe nezobrazujeme cenu
        tokenCostEl.textContent = '';
    }
}

// ============================================================
// UPLOAD OBR√ÅZK≈Æ (Vision modely)
// ============================================================

let uploadedImage = {
    base64: null,
    mimeType: null,
    name: null,
    size: null
};

function checkVisionModel() {
    const model = document.getElementById('modelSelect')?.value;
    const section = document.getElementById('imageUploadSection');
    
    if (!section) return;
    
    const isVision = AI.supportsVision(model);
    section.style.display = isVision ? 'block' : 'none';
    
    // Pokud p≈ôepneme na ne-vision model, vyƒçistit obr√°zek
    if (!isVision && uploadedImage.base64) {
        removeImage();
    }
}

function handleImageUpload(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    
    // Kontrola typu
    if (!file.type.startsWith('image/')) {
        alert('Pros√≠m vyber obr√°zek (JPG, PNG, GIF, WebP)');
        return;
    }
    
    // Kontrola velikosti (max 20MB)
    if (file.size > 20 * 1024 * 1024) {
        alert('Obr√°zek je p≈ô√≠li≈° velk√Ω (max 20MB)');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const base64Full = e.target.result;
        // Odstranit prefix "data:image/...;base64,"
        const base64 = base64Full.split(',')[1];
        
        uploadedImage = {
            base64: base64,
            mimeType: file.type,
            name: file.name,
            size: file.size
        };
        
        showImagePreview(base64Full, file);
    };
    reader.readAsDataURL(file);
}

function showImagePreview(dataUrl, file) {
    const placeholder = document.getElementById('uploadPlaceholder');
    const preview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    const imageInfo = document.getElementById('imageInfo');
    
    if (placeholder) placeholder.style.display = 'none';
    if (preview) preview.style.display = 'inline-block';
    if (previewImg) previewImg.src = dataUrl;
    
    if (imageInfo) {
        const sizeKB = (file.size / 1024).toFixed(1);
        imageInfo.textContent = `üìé ${file.name} (${sizeKB} KB)`;
    }
}

function removeImage(event) {
    if (event) {
        event.stopPropagation();
    }
    
    uploadedImage = {
        base64: null,
        mimeType: null,
        name: null,
        size: null
    };
    
    const placeholder = document.getElementById('uploadPlaceholder');
    const preview = document.getElementById('imagePreview');
    const imageInfo = document.getElementById('imageInfo');
    const imageInput = document.getElementById('imageInput');
    
    if (placeholder) placeholder.style.display = 'flex';
    if (preview) preview.style.display = 'none';
    if (imageInfo) imageInfo.textContent = '';
    if (imageInput) imageInput.value = '';
}

// Drag & drop
function setupImageDragDrop() {
    const area = document.getElementById('imageUploadArea');
    if (!area) return;
    
    area.addEventListener('dragover', (e) => {
        e.preventDefault();
        area.classList.add('dragover');
    });
    
    area.addEventListener('dragleave', () => {
        area.classList.remove('dragover');
    });
    
    area.addEventListener('drop', (e) => {
        e.preventDefault();
        area.classList.remove('dragover');
        
        const file = e.dataTransfer.files?.[0];
        if (file) {
            // Simulovat input change
            const input = document.getElementById('imageInput');
            const dt = new DataTransfer();
            dt.items.add(file);
            input.files = dt.files;
            handleImageUpload({ target: input });
        }
    });
}

// ============================================================
// NOV√ù FILE UPLOAD PRO CHAT
// ============================================================

let uploadedFile = {
    base64: null,
    mimeType: null,
    name: null,
    size: null,
    type: null, // 'image' nebo 'text'
    content: null // pro textov√© soubory
};

function handleFileSelect(event) {
    const file = event.target.files?.[0];
    if (!file) return;
    
    // Kontrola velikosti (max 20MB)
    if (file.size > 20 * 1024 * 1024) {
        alert('Soubor je p≈ô√≠li≈° velk√Ω (max 20MB)');
        return;
    }
    
    const isImage = file.type.startsWith('image/');
    const isText = file.type.startsWith('text/') || 
                   file.name.endsWith('.json') || 
                   file.name.endsWith('.md') ||
                   file.name.endsWith('.csv');
    
    if (isImage) {
        // Zpracuj jako obr√°zek
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64Full = e.target.result;
            const base64 = base64Full.split(',')[1];
            
            uploadedFile = {
                base64: base64,
                mimeType: file.type,
                name: file.name,
                size: file.size,
                type: 'image',
                content: null,
                dataUrl: base64Full
            };
            
            // Tak√© nastav uploadedImage pro kompatibilitu
            uploadedImage = {
                base64: base64,
                mimeType: file.type,
                name: file.name,
                size: file.size
            };
            
            showFilePreview(file, base64Full);
        };
        reader.readAsDataURL(file);
    } else if (isText || file.type === 'application/pdf') {
        // Zpracuj jako text
        const reader = new FileReader();
        reader.onload = (e) => {
            uploadedFile = {
                base64: null,
                mimeType: file.type,
                name: file.name,
                size: file.size,
                type: 'text',
                content: e.target.result
            };
            
            showFilePreview(file, null);
        };
        reader.readAsText(file);
    } else {
        alert('Nepodporovan√Ω typ souboru. Podporovan√©: obr√°zky, TXT, MD, JSON, CSV');
        return;
    }
}

function showFilePreview(file, dataUrl) {
    const bar = document.getElementById('filePreviewBar');
    const thumb = document.getElementById('previewThumb');
    const icon = document.getElementById('fileIcon');
    const name = document.getElementById('fileName');
    
    if (!bar) return;
    
    bar.style.display = 'flex';
    
    const sizeKB = (file.size / 1024).toFixed(1);
    name.textContent = `${file.name} (${sizeKB} KB)`;
    
    if (dataUrl && file.type.startsWith('image/')) {
        thumb.src = dataUrl;
        thumb.style.display = 'block';
        icon.style.display = 'none';
    } else {
        thumb.style.display = 'none';
        icon.style.display = 'inline';
        
        // Ikona podle typu
        if (file.name.endsWith('.pdf')) icon.textContent = 'üìï';
        else if (file.name.endsWith('.json')) icon.textContent = 'üìã';
        else if (file.name.endsWith('.csv')) icon.textContent = 'üìä';
        else if (file.name.endsWith('.md')) icon.textContent = 'üìù';
        else icon.textContent = 'üìÑ';
    }
}

function removeFile() {
    uploadedFile = {
        base64: null,
        mimeType: null,
        name: null,
        size: null,
        type: null,
        content: null
    };
    
    uploadedImage = {
        base64: null,
        mimeType: null,
        name: null,
        size: null
    };
    
    const bar = document.getElementById('filePreviewBar');
    const input = document.getElementById('fileInput');
    
    if (bar) bar.style.display = 'none';
    if (input) input.value = '';
}

// ============================================================
// TESTOV√ÅN√ç MODEL≈Æ
// ============================================================

let testResults = [];

async function testAllModels() {
    const modal = document.getElementById('testModal');
    const summaryEl = document.getElementById('testSummary');
    const resultsEl = document.getElementById('testResults');
    
    if (!modal || !summaryEl || !resultsEl) return;
    
    // Zobrazit modal
    modal.style.display = 'flex';
    
    // Reset
    testResults = [];
    summaryEl.innerHTML = `
        <div class="summary-card">
            <div class="testing-indicator">
                <div class="spinner"></div>
                Testov√°n√≠ prob√≠h√°...
            </div>
        </div>
    `;
    resultsEl.innerHTML = '';
    
    const providers = ['gemini', 'groq', 'openrouter', 'mistral', 'cohere', 'huggingface'];
    const providerEmojis = {
        gemini: 'ü§ñ',
        groq: '‚ö°',
        openrouter: 'üåê',
        mistral: 'üî•',
        cohere: 'üß†',
        huggingface: 'ü§ó'
    };
    
    const testPrompt = "Odpovƒõz pouze ƒç√≠slem: 6 * 7 = ?";
    
    // Testovat ka≈æd√©ho providera
    for (const provider of providers) {
        const models = AI.getModels(provider);
        const key = AI.getKey(provider);
        
        if (!key) continue;
        
        // Vytvo≈ôit sekci pro providera
        const sectionId = `section-${provider}`;
        resultsEl.innerHTML += `
            <div class="provider-section" id="${sectionId}">
                <div class="provider-header">
                    <h3>${providerEmojis[provider]} ${provider.charAt(0).toUpperCase() + provider.slice(1)}</h3>
                    <span class="provider-stats" id="stats-${provider}">Testov√°n√≠...</span>
                </div>
                <div id="models-${provider}"></div>
            </div>
        `;
        
        const modelsContainer = document.getElementById(`models-${provider}`);
        let providerSuccess = 0;
        let providerError = 0;
        
        // Testovat ka≈æd√Ω model
        for (const model of models) {
            const startTime = performance.now();
            let result = {
                provider,
                model: model.value,
                name: model.name,
                success: false,
                time: 0,
                response: '',
                error: ''
            };
            
            try {
                const response = await AI.ask(testPrompt, {
                    provider,
                    model: model.value,
                    maxTokens: 50
                });
                
                result.success = true;
                result.time = Math.round(performance.now() - startTime);
                result.response = response.trim().substring(0, 50);
                providerSuccess++;
                
            } catch (error) {
                result.success = false;
                result.time = Math.round(performance.now() - startTime);
                result.error = parseErrorMessage(error.message);
                providerError++;
            }
            
            testResults.push(result);
            
            // Zobrazit v√Ωsledek modelu
            if (modelsContainer) {
                modelsContainer.innerHTML += createModelResultHTML(result);
            }
            
            // Aktualizovat statistiky providera
            const statsEl = document.getElementById(`stats-${provider}`);
            if (statsEl) {
                statsEl.innerHTML = `‚úÖ ${providerSuccess} / ‚ùå ${providerError}`;
            }
        }
    }
    
    // Zobrazit souhrn
    updateTestSummary();
}

function parseErrorMessage(msg) {
    if (msg.includes('429') || msg.includes('quota') || msg.includes('RESOURCE_EXHAUSTED')) {
        return 'üìä P≈ôekroƒçena kv√≥ta API. Model nen√≠ dostupn√Ω v bezplatn√© verzi nebo je vyƒçerp√°n denn√≠ limit.';
    }
    if (msg.includes('404') || msg.includes('not found')) {
        return '‚ùì Model nebyl nalezen. Mo≈æn√° byl odstranƒõn nebo p≈ôejmenov√°n.';
    }
    if (msg.includes('401') || msg.includes('unauthorized') || msg.includes('invalid') || msg.includes('User not found')) {
        return 'üîë Neplatn√Ω API kl√≠ƒç. Demo kl√≠ƒç expiroval - pot≈ôebuje≈° vlastn√≠ kl√≠ƒç.';
    }
    if (msg.includes('timeout') || msg.includes('Timeout')) {
        return '‚è±Ô∏è Vypr≈°el ƒçasov√Ω limit po≈æadavku.';
    }
    return msg.substring(0, 100);
}

function createModelResultHTML(result) {
    const statusClass = result.success ? 'success' : 'error';
    const statusText = result.success ? '‚úÖ Funguje' : '‚ùå Chyba';
    
    let detailsHTML = '';
    if (result.success) {
        detailsHTML = `‚ö° ${result.time}ms üí¨ "${result.response}"`;
    }
    
    let errorHTML = '';
    if (!result.success && result.error) {
        errorHTML = `<div class="error-msg">‚ö†Ô∏è ${result.error}</div>`;
    }
    
    return `
        <div class="model-result ${statusClass}">
            <div>
                <div class="model-name">${result.name.replace(/[‚ö°üß†üí¨üíªüëÅÔ∏èü§ñü¶ôüî•]/g, '').trim()}</div>
                <div class="model-id">${result.model}</div>
            </div>
            <div class="result-info">
                <div class="result-status ${statusClass}">${statusText}</div>
                <div class="result-details">${detailsHTML}</div>
            </div>
            ${errorHTML}
        </div>
    `;
}

function updateTestSummary() {
    const summaryEl = document.getElementById('testSummary');
    if (!summaryEl) return;
    
    const successCount = testResults.filter(r => r.success).length;
    const errorCount = testResults.filter(r => !r.success).length;
    const avgTime = testResults.filter(r => r.success).length > 0
        ? Math.round(testResults.filter(r => r.success).reduce((sum, r) => sum + r.time, 0) / successCount)
        : 0;
    
    summaryEl.innerHTML = `
        <div class="summary-card">
            <div class="value">${testResults.length}</div>
            <div class="label">üìä Celkem test≈Ø</div>
        </div>
        <div class="summary-card success">
            <div class="value">${successCount}</div>
            <div class="label">‚úÖ Funguje</div>
        </div>
        <div class="summary-card error">
            <div class="value">${errorCount}</div>
            <div class="label">‚ùå Chyba</div>
        </div>
        <div class="summary-card speed">
            <div class="value">${avgTime}ms</div>
            <div class="label">‚ö° Pr≈Ømƒõrn√° odezva</div>
        </div>
    `;
}

function closeTestModal() {
    const modal = document.getElementById('testModal');
    if (modal) modal.style.display = 'none';
}

// Pomocn√° funkce pro kop√≠rov√°n√≠ do schr√°nky (s fallback)
function copyToClipboard(text) {
    return new Promise((resolve) => {
        // Pokus 1: Fallback pomoc√≠ textarea (funguje v≈ædy)
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.cssText = 'position:fixed;left:-9999px;top:-9999px;opacity:0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();
        textarea.setSelectionRange(0, 99999); // Pro mobiln√≠ za≈ô√≠zen√≠
        
        try {
            const success = document.execCommand('copy');
            document.body.removeChild(textarea);
            if (success) {
                resolve(true);
                return;
            }
        } catch (err) {
            document.body.removeChild(textarea);
        }
        
        // Pokus 2: Modern Clipboard API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(text)
                .then(() => resolve(true))
                .catch(() => resolve(false));
        } else {
            resolve(false);
        }
    });
}

function copyTestReport() {
    let report = 'üß™ V√ùSLEDKY TESTOV√ÅN√ç AI MODEL≈Æ\n';
    report += '================================\n\n';
    
    const successCount = testResults.filter(r => r.success).length;
    const errorCount = testResults.filter(r => !r.success).length;
    const avgTime = successCount > 0
        ? Math.round(testResults.filter(r => r.success).reduce((sum, r) => sum + r.time, 0) / successCount)
        : 0;
    
    report += `üìä Souhrn: ‚úÖ ${successCount} funguje | ‚ùå ${errorCount} chyb | ‚ö° ${avgTime}ms pr≈Ømƒõr\n\n`;
    
    const providers = [...new Set(testResults.map(r => r.provider))];
    
    for (const provider of providers) {
        const providerResults = testResults.filter(r => r.provider === provider);
        const pSuccess = providerResults.filter(r => r.success).length;
        const pError = providerResults.filter(r => !r.success).length;
        
        report += `${provider.toUpperCase()} (‚úÖ ${pSuccess} / ‚ùå ${pError})\n`;
        report += '-'.repeat(30) + '\n';
        
        for (const r of providerResults) {
            if (r.success) {
                report += `‚úÖ ${r.model} - ${r.time}ms - "${r.response}"\n`;
            } else {
                report += `‚ùå ${r.model} - ${r.error}\n`;
            }
        }
        report += '\n';
    }
    
    copyToClipboard(report).then(success => {
        if (success) {
            alert('üìã Report zkop√≠rov√°n do schr√°nky!');
        } else {
            // Zobrazit v nov√©m oknƒõ pro ruƒçn√≠ kop√≠rov√°n√≠
            const win = window.open('', '_blank', 'width=600,height=400');
            win.document.write('<pre style="white-space: pre-wrap; font-family: monospace;">' + report.replace(/</g, '&lt;') + '</pre>');
            win.document.title = 'AI Test Report - zkop√≠ruj ruƒçnƒõ';
            alert('Schr√°nka nen√≠ dostupn√°. Report otev≈ôen v nov√©m oknƒõ - zkop√≠ruj ruƒçnƒõ (Ctrl+A, Ctrl+C).');
        }
    });
}

// ============================================================
// ZJI≈†TƒöN√ç DOSTUPN√ùCH MODEL≈Æ Z API
// ============================================================

let fetchedModels = {
    gemini: [],
    groq: [],
    openrouter: [],
    mistral: [],
    cohere: [],
    huggingface: []
};

async function fetchAvailableModels() {
    const modal = document.getElementById('modelsModal');
    const summaryEl = document.getElementById('modelsSummary');
    const resultsEl = document.getElementById('modelsResults');
    
    if (!modal) return;
    
    modal.style.display = 'flex';
    
    summaryEl.innerHTML = `
        <div class="summary-card">
            <div class="testing-indicator">
                <div class="spinner"></div>
                Naƒç√≠t√°m modely z API...
            </div>
        </div>
    `;
    resultsEl.innerHTML = '';
    
    // Reset
    fetchedModels = { gemini: [], groq: [], openrouter: [], mistral: [], cohere: [], huggingface: [] };
    
    // Paralelnƒõ naƒç√≠st ze v≈°ech provider≈Ø
    const results = await Promise.allSettled([
        fetchGeminiModels(),
        fetchGroqModels(),
        fetchOpenRouterModels(),
        fetchMistralModels(),
        fetchCohereModels(),
        fetchHuggingFaceModels()
    ]);
    
    // Zobrazit v√Ωsledky
    renderModelsResults();
}

async function fetchGeminiModels() {
    const key = AI.getKey('gemini');
    if (!key) return;
    
    try {
        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
        if (!response.ok) throw new Error('API error');
        
        const data = await response.json();
        
        fetchedModels.gemini = (data.models || [])
            .filter(m => m.name.includes('gemini') && m.supportedGenerationMethods?.includes('generateContent'))
            .map(m => ({
                id: m.name.replace('models/', ''),
                name: m.displayName || m.name,
                context: m.inputTokenLimit || 0,
                free: true, // Gemini m√° free tier
                description: m.description || ''
            }));
    } catch (e) {
        console.warn('Gemini models fetch failed:', e);
    }
}

async function fetchGroqModels() {
    const key = AI.getKey('groq');
    if (!key) return;
    
    try {
        const response = await fetch('https://api.groq.com/openai/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        if (!response.ok) throw new Error('API error');
        
        const data = await response.json();
        
        fetchedModels.groq = (data.data || []).map(m => ({
            id: m.id,
            name: m.id,
            context: m.context_window || 0,
            free: true, // Groq je free
            owned_by: m.owned_by || ''
        }));
    } catch (e) {
        console.warn('Groq models fetch failed:', e);
    }
}

async function fetchOpenRouterModels() {
    const key = AI.getKey('openrouter');
    if (!key) return;
    
    try {
        const response = await fetch('https://openrouter.ai/api/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        if (!response.ok) throw new Error('API error');
        
        const data = await response.json();
        
        // Filtrovat pouze free modely (pricing.prompt === "0" nebo obsahuje :free)
        fetchedModels.openrouter = (data.data || [])
            .filter(m => m.pricing?.prompt === '0' || m.id.includes(':free'))
            .map(m => ({
                id: m.id,
                name: m.name || m.id,
                context: m.context_length || 0,
                free: true,
                pricing: m.pricing
            }));
        
        console.info(`üåê OpenRouter: Nalezeno ${fetchedModels.openrouter.length} free model≈Ø`);
    } catch (e) {
        console.warn('OpenRouter models fetch failed:', e);
    }
}

async function fetchMistralModels() {
    const key = AI.getKey('mistral');
    if (!key) return;
    
    try {
        const response = await fetch('https://api.mistral.ai/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        if (!response.ok) throw new Error('API error');
        
        const data = await response.json();
        
        fetchedModels.mistral = (data.data || []).map(m => ({
            id: m.id,
            name: m.id,
            context: m.max_context_length || 0,
            free: false // Mistral je placen√Ω (ale m√° free tier s limity)
        }));
    } catch (e) {
        console.warn('Mistral models fetch failed:', e);
    }
}

async function fetchCohereModels() {
    const key = AI.getKey('cohere');
    if (!key) return;
    
    try {
        const response = await fetch('https://api.cohere.com/v1/models', {
            headers: { 'Authorization': `Bearer ${key}` }
        });
        if (!response.ok) throw new Error('API error');
        
        const data = await response.json();
        
        fetchedModels.cohere = (data.models || [])
            .filter(m => m.endpoints?.includes('chat'))
            .map(m => ({
                id: m.name,
                name: m.name,
                context: m.context_length || 0,
                free: true // Cohere m√° free tier
            }));
    } catch (e) {
        console.warn('Cohere models fetch failed:', e);
    }
}

async function fetchHuggingFaceModels() {
    const key = AI.getKey('huggingface');
    if (!key) return;
    
    // HuggingFace nem√° jednoduch√Ω endpoint pro seznam model≈Ø
    // Pou≈æijeme p≈ôedefinovan√Ω seznam popul√°rn√≠ch model≈Ø
    // a ovƒõ≈ô√≠me jejich dostupnost
    
    const popularModels = [
        'meta-llama/Llama-3.3-70B-Instruct',
        'meta-llama/Llama-3.1-70B-Instruct',
        'meta-llama/Llama-3.1-8B-Instruct',
        'Qwen/Qwen2.5-72B-Instruct',
        'Qwen/Qwen2.5-32B-Instruct',
        'mistralai/Mistral-7B-Instruct-v0.3',
        'mistralai/Mixtral-8x7B-Instruct-v0.1',
        'microsoft/Phi-3-mini-4k-instruct',
        'google/gemma-2-9b-it',
        'google/gemma-2-27b-it',
        'HuggingFaceH4/zephyr-7b-beta',
        'tiiuae/falcon-7b-instruct'
    ];
    
    fetchedModels.huggingface = popularModels.map(id => ({
        id: id,
        name: id.split('/').pop(),
        context: 0,
        free: true // HF Inference API je free (s limity)
    }));
}

function renderModelsResults() {
    const summaryEl = document.getElementById('modelsSummary');
    const resultsEl = document.getElementById('modelsResults');
    
    // Spoƒç√≠tat statistiky
    let totalFetched = 0;
    let totalFree = 0;
    let newModels = 0;
    let missingModels = 0;
    
    const providerEmojis = { gemini: 'ü§ñ', groq: '‚ö°', openrouter: 'üåê', mistral: 'üî•', cohere: 'üß†', huggingface: 'ü§ó' };
    
    let html = '';
    
    for (const [provider, models] of Object.entries(fetchedModels)) {
        const localModels = AI.ALL_MODELS[provider] || [];
        const localIds = localModels.map(m => m.value);
        
        // Naj√≠t nov√© modely (v API ale ne v lok√°ln√≠m seznamu)
        const newInApi = models.filter(m => !localIds.includes(m.id));
        
        // Naj√≠t chybƒõj√≠c√≠ modely (v lok√°ln√≠m seznamu ale ne v API)
        const fetchedIds = models.map(m => m.id);
        const missing = localModels.filter(m => !fetchedIds.includes(m.value));
        
        totalFetched += models.length;
        totalFree += models.filter(m => m.free).length;
        newModels += newInApi.length;
        missingModels += missing.length;
        
        html += `
            <div class="provider-section">
                <div class="provider-header">
                    <h3>${providerEmojis[provider]} ${provider.charAt(0).toUpperCase() + provider.slice(1)}</h3>
                    <span class="provider-stats">
                        üì¶ ${models.length} model≈Ø | 
                        üÜï ${newInApi.length} nov√Ωch |
                        ${missing.length > 0 ? `‚ö†Ô∏è ${missing.length} chyb√≠` : '‚úÖ v≈°e OK'}
                    </span>
                </div>
        `;
        
        // Zobrazit chybƒõj√≠c√≠ modely
        if (missing.length > 0) {
            html += `<div style="margin-bottom: 12px; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 8px;">
                <div style="font-size: 12px; color: #f87171; margin-bottom: 8px;">‚ö†Ô∏è Tyto modely nejsou dostupn√© v API:</div>`;
            for (const m of missing) {
                html += `
                    <div class="model-card missing">
                        <div>
                            <div class="model-name">${m.name}</div>
                            <div class="model-id">${m.value}</div>
                        </div>
                        <div class="model-badges">
                            <span class="badge missing-badge">ODSTRANƒöN?</span>
                        </div>
                        <div></div>
                    </div>
                `;
            }
            html += '</div>';
        }
        
        // Zobrazit nov√© modely
        if (newInApi.length > 0) {
            html += `<div style="margin-bottom: 12px;">
                <div style="font-size: 12px; color: #60a5fa; margin-bottom: 8px;">üÜï Nov√© modely k dispozici:</div>`;
            for (const m of newInApi.slice(0, 20)) { // Max 20
                html += `
                    <div class="model-card new">
                        <div>
                            <div class="model-name">${m.name}</div>
                            <div class="model-id">${m.id}</div>
                        </div>
                        <div class="model-badges">
                            ${m.free ? '<span class="badge free">FREE</span>' : '<span class="badge paid">PAID</span>'}
                            <span class="badge new-badge">NOV√ù</span>
                        </div>
                        <div class="model-context">${formatContext(m.context)}</div>
                    </div>
                `;
            }
            if (newInApi.length > 20) {
                html += `<div style="color: #64748b; font-size: 12px; padding: 8px;">... a ${newInApi.length - 20} dal≈°√≠ch</div>`;
            }
            html += '</div>';
        }
        
        // Zobrazit aktu√°ln√≠ lok√°ln√≠ modely
        html += `<div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">üìã Aktu√°ln√≠ lok√°ln√≠ konfigurace:</div>`;
        for (const m of localModels) {
            const inApi = fetchedIds.includes(m.value);
            const apiModel = models.find(am => am.id === m.value);
            html += `
                <div class="model-card ${inApi ? 'available' : 'missing'}">
                    <div>
                        <div class="model-name">${m.name}</div>
                        <div class="model-id">${m.value}</div>
                    </div>
                    <div class="model-badges">
                        ${inApi ? '<span class="badge free">‚úÖ OK</span>' : '<span class="badge missing-badge">‚ùå CHYB√ç</span>'}
                        ${AI.supportsVision(m.value) ? '<span class="badge vision">üëÅÔ∏è VISION</span>' : ''}
                    </div>
                    <div class="model-context">${m.rpm} RPM</div>
                </div>
            `;
        }
        
        html += '</div>';
    }
    
    // Souhrn
    summaryEl.innerHTML = `
        <div class="summary-card">
            <div class="value">${totalFetched}</div>
            <div class="label">üì¶ Celkem v API</div>
        </div>
        <div class="summary-card success">
            <div class="value">${totalFree}</div>
            <div class="label">üÜì Free modely</div>
        </div>
        <div class="summary-card" style="--card-color: #60a5fa;">
            <div class="value" style="color: #60a5fa;">${newModels}</div>
            <div class="label">üÜï Nov√©</div>
        </div>
        <div class="summary-card error">
            <div class="value">${missingModels}</div>
            <div class="label">‚ö†Ô∏è Chyb√≠</div>
        </div>
    `;
    
    resultsEl.innerHTML = html;
}

function formatContext(tokens) {
    if (!tokens) return '';
    if (tokens >= 1000000) return `${(tokens / 1000000).toFixed(1)}M ctx`;
    if (tokens >= 1000) return `${(tokens / 1000).toFixed(0)}K ctx`;
    return `${tokens} ctx`;
}

function closeModelsModal() {
    const modal = document.getElementById('modelsModal');
    if (modal) modal.style.display = 'none';
}

function updateLocalModels() {
    // Tato funkce by mohla aktualizovat ALL_MODELS
    // Pro teƒè jen uk√°≈æeme alert s instrukcemi
    let code = '// Aktualizovan√© modely:\n\n';
    
    for (const [provider, models] of Object.entries(fetchedModels)) {
        if (models.length === 0) continue;
        
        const freeModels = models.filter(m => m.free).slice(0, 10);
        
        code += `${provider}: [\n`;
        for (const m of freeModels) {
            code += `    { value: "${m.id}", name: "${m.name}", rpm: 30 },\n`;
        }
        code += `],\n\n`;
    }
    
    copyToClipboard(code).then(success => {
        if (success) {
            alert('üìã K√≥d pro aktualizaci model≈Ø zkop√≠rov√°n do schr√°nky!\n\nVlo≈æ ho do ALL_MODELS v k√≥du.');
        } else {
            const win = window.open('', '_blank', 'width=600,height=400');
            win.document.write('<pre style="white-space: pre-wrap; font-family: monospace;">' + code.replace(/</g, '&lt;') + '</pre>');
            win.document.title = 'Models Code';
            alert('K√≥d otev≈ôen v nov√©m oknƒõ - zkop√≠ruj ruƒçnƒõ.');
        }
    });
}

function copyModelsReport() {
    let report = 'üîç DOSTUPN√â AI MODELY\n';
    report += '======================\n\n';
    
    for (const [provider, models] of Object.entries(fetchedModels)) {
        const localModels = AI.ALL_MODELS[provider] || [];
        const localIds = localModels.map(m => m.value);
        const fetchedIds = models.map(m => m.id);
        
        const newInApi = models.filter(m => !localIds.includes(m.id));
        const missing = localModels.filter(m => !fetchedIds.includes(m.value));
        
        report += `${provider.toUpperCase()} (${models.length} model≈Ø)\n`;
        report += '-'.repeat(40) + '\n';
        
        if (missing.length > 0) {
            report += `‚ö†Ô∏è CHYBƒöJ√çC√ç: ${missing.map(m => m.value).join(', ')}\n`;
        }
        
        if (newInApi.length > 0) {
            report += `üÜï NOV√â FREE:\n`;
            for (const m of newInApi.filter(m => m.free).slice(0, 10)) {
                report += `   ${m.id}\n`;
            }
        }
        
        report += '\n';
    }
    
    copyToClipboard(report).then(success => {
        if (success) {
            alert('üìã Report zkop√≠rov√°n!');
        } else {
            const win = window.open('', '_blank', 'width=600,height=400');
            win.document.write('<pre style="white-space: pre-wrap; font-family: monospace;">' + report.replace(/</g, '&lt;') + '</pre>');
            win.document.title = 'Models Report';
        }
    });
}
</script>

</body>
</html>
