<!DOCTYPE html>
<html lang="cs">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="theme-color" content="#0a0a0b" />
    <meta name="description" content="Mobilní HTML editor s GitHub integrací" />
    <link
      rel="manifest"
      href="data:application/json;base64,eyJuYW1lIjoiSFRNTCBTdHVkaW8iLCJzaG9ydF9uYW1lIjoiSFRNTCBTdHVkaW8iLCJzdGFydF91cmwiOiIuIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzBhMGEwYiIsInRoZW1lX2NvbG9yIjoiIzAwZDRhYSIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUIyYVdWM1FtOTRQU0l3SURBZ01qUWdNalFpSUdacGJHdzlJaU13TUdRMFlXRWlJSGh0Ykc1elBTSm9kSFJ3T2k4dmQzZDNMbmN6TG05eVp5OHlNREF3TDNOMlp5SStQSEJoZEdnZ1pEMGlUVEV5SURKak5TNDFNalFnTUNBeE1DQTBMalEzTmlBeE1DQXhNSFl4TWlJdlBqeHdZWFJvSUdROUlrMHhNaUE0YkMwMElEUWdOQ0EwSURRZ05FZ3hNbFkzTGpVaUx6NDhMM04yWno0PSIsInNpemVzIjoiMTkyeDE5MiIsInR5cGUiOiJpbWFnZS9zdmcreG1sIn1dfQ=="
    />
    <title>HTML Studio</title>
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-primary: #0a0a0b;
        --bg-secondary: #111113;
        --bg-tertiary: #1a1a1d;
        --bg-elevated: #222225;
        --accent: #00d4aa;
        --accent-dim: #00a88a;
        --accent-glow: rgba(0, 212, 170, 0.15);
        --text-primary: #e8e8ea;
        --text-secondary: #8a8a8f;
        --text-muted: #5a5a5f;
        --border: #2a2a2d;
        --border-light: #3a3a3d;
        --error: #ff6b6b;
        --warning: #ffa94d;
        --success: #51cf66;
        --safe-bottom: env(safe-area-inset-bottom, 0px);
        --safe-top: env(safe-area-inset-top, 0px);
      }

      /* Light Theme */
      .light-theme {
        --bg-primary: #ffffff;
        --bg-secondary: #f5f5f7;
        --bg-tertiary: #e8e8ea;
        --bg-elevated: #ffffff;
        --accent: #007aff;
        --accent-dim: #0056b3;
        --accent-glow: rgba(0, 122, 255, 0.1);
        --text-primary: #1a1a1d;
        --text-secondary: #6a6a6f;
        --text-muted: #9a9a9f;
        --border: #d1d1d6;
        --border-light: #e5e5ea;
        --error: #ff3b30;
        --warning: #ff9500;
        --success: #34c759;
      }

      .light-theme .code-input,
      .light-theme .line-numbers {
        background: #fafafa;
      }

      .light-theme .preview-frame {
        background: white;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }

      html,
      body {
        height: 100%;
        overflow: hidden;
      }

      body {
        font-family: "Space Grotesk", sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        touch-action: manipulation;
      }

      /* App Container */
      .app {
        display: flex;
        flex-direction: column;
        height: 100%;
        padding-top: var(--safe-top);
        padding-bottom: var(--safe-bottom);
      }

      /* Header */
      .header {
        height: 56px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        flex-shrink: 0;
        z-index: 100;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .nav-btn {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .nav-btn:active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .nav-btn svg {
        width: 22px;
        height: 22px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .logo-icon {
        width: 32px;
        height: 32px;
        background: linear-gradient(
          135deg,
          var(--accent) 0%,
          var(--accent-dim) 100%
        );
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: "JetBrains Mono", monospace;
        font-weight: 700;
        font-size: 12px;
        color: var(--bg-primary);
      }

      .logo-text {
        font-weight: 600;
        font-size: 16px;
      }

      .logo-text span {
        color: var(--accent);
      }

      .header-actions {
        display: flex;
        gap: 4px;
      }

      /* Skrýt některá tlačítka na mobilu */
      .hide-mobile {
        display: flex;
      }

      @media (max-width: 500px) {
        .hide-mobile {
          display: none !important;
        }

        .nav-btn {
          width: 36px;
          height: 36px;
        }

        .nav-btn svg {
          width: 20px;
          height: 20px;
        }

        .logo-text {
          display: none;
        }

        .header {
          padding: 0 8px;
        }

        .header-actions {
          gap: 2px;
        }
      }

      /* Více menu */
      .more-menu {
        position: fixed;
        top: 56px;
        right: 8px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 8px;
        z-index: 200;
        display: none;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        min-width: 180px;
      }

      .more-menu.active {
        display: block;
      }

      .more-menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        border: none;
        background: transparent;
        width: 100%;
        text-align: left;
      }

      .more-menu-item:active {
        background: var(--bg-tertiary);
      }

      .more-menu-item svg {
        width: 20px;
        height: 20px;
        color: var(--text-muted);
      }

      /* Main Content Area */
      .main-content {
        flex: 1;
        display: flex;
        flex-direction: row;
        overflow: hidden;
        position: relative;
      }

      /* View Panels */
      .view-panel {
        display: none;
        flex-direction: column;
        flex: 1;
        overflow: hidden;
      }

      .view-panel.active {
        display: flex;
      }

      /* Tools Panel - Sidebar */
      .tools-panel {
        display: none;
        flex-direction: row;
        width: 45%;
        min-width: 200px;
        max-width: 80%;
        background: var(--bg-secondary);
        overflow: hidden;
      }

      @media (max-width: 600px) {
        .tools-panel {
          width: 65%;
          min-width: 220px;
        }
      }

      .tools-panel.active {
        display: flex;
      }

      .tools-resize {
        width: 6px;
        background: var(--border);
        cursor: col-resize;
        flex-shrink: 0;
        touch-action: none;
      }

      .tools-resize:active,
      .tools-resize.active {
        background: var(--accent);
      }

      .tools-inner {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-left: 1px solid var(--border);
      }

      .tools-header {
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        background: var(--bg-tertiary);
        border-bottom: 1px solid var(--border);
        flex-shrink: 0;
      }

      .tools-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
      }

      .tools-close {
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        border-radius: 6px;
        color: var(--text-secondary);
      }

      .tools-close:active {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      .tools-close svg {
        width: 18px;
        height: 18px;
      }

      .tools-content {
        flex: 1;
        overflow-y: auto;
        padding: 12px;
        -webkit-overflow-scrolling: touch;
      }

      /* Collapsible Section */
      .collapse-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
        margin-bottom: 8px;
      }

      .collapse-header:active {
        background: var(--bg-elevated);
      }

      .collapse-title {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .collapse-title svg {
        width: 16px;
        height: 16px;
        color: var(--accent);
      }

      .collapse-arrow {
        width: 20px;
        height: 20px;
        color: var(--text-muted);
        transition: transform 0.2s ease;
      }

      .collapse-header.open .collapse-arrow {
        transform: rotate(180deg);
      }

      .collapse-body {
        display: none;
        padding: 0 0 12px 0;
      }

      .collapse-header.open + .collapse-body,
      .collapse-body.open {
        display: block;
      }

      .files-count {
        font-size: 10px;
        font-weight: 500;
        background: var(--accent);
        color: var(--bg-primary);
        padding: 2px 6px;
        border-radius: 10px;
        margin-left: 4px;
      }

      /* Files List */
      .files-section {
        margin-top: 12px;
      }

      .files-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      /* File Tabs */
      .file-tabs {
        height: 44px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 4px;
        gap: 4px;
        flex-shrink: 0;
        position: relative;
      }

      .file-tabs-scroll {
        display: flex;
        align-items: center;
        gap: 4px;
        overflow-x: auto;
        flex: 1;
        padding: 0 4px;
        scroll-behavior: smooth;
        -webkit-overflow-scrolling: touch;
      }

      .file-tabs-scroll::-webkit-scrollbar {
        height: 3px;
      }

      .file-tabs-scroll::-webkit-scrollbar-track {
        background: var(--bg-tertiary);
      }

      .file-tabs-scroll::-webkit-scrollbar-thumb {
        background: var(--border);
        border-radius: 3px;
      }

      .tabs-nav-btn {
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-muted);
        cursor: pointer;
        flex-shrink: 0;
      }

      .tabs-nav-btn:active {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      .tabs-nav-btn svg {
        width: 14px;
        height: 14px;
      }

      .file-tab {
        padding: 8px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
        flex-shrink: 0;
      }

      .file-tab.active {
        background: var(--accent-glow);
        border-color: var(--accent);
        color: var(--accent);
      }

      .file-tab .close-tab {
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 4px;
        font-size: 14px;
      }

      .file-tab .close-tab:active {
        background: var(--error);
        color: white;
      }

      .file-tab .unsaved {
        width: 8px;
        height: 8px;
        background: var(--warning);
        border-radius: 50%;
      }

      .add-tab-btn {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: 1px dashed var(--border);
        border-radius: 8px;
        color: var(--text-muted);
        font-size: 20px;
        flex-shrink: 0;
      }

      .add-tab-btn:active {
        border-color: var(--accent);
        color: var(--accent);
      }

      /* Code Editor */
      .code-editor {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Search Bar */
      .search-bar {
        display: none;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
        flex-direction: column;
        gap: 8px;
      }

      .search-bar.active {
        display: flex;
      }

      .search-row {
        display: flex;
        gap: 8px;
      }

      .search-input {
        flex: 1;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        color: var(--text-primary);
        outline: none;
      }

      .search-input:focus {
        border-color: var(--accent);
      }

      .search-actions {
        display: flex;
        gap: 6px;
      }

      .search-btn {
        padding: 10px 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-secondary);
        font-size: 13px;
        font-weight: 500;
      }

      .search-btn:active {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      .search-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--bg-primary);
      }

      .search-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .search-results {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Code Area */
      .code-area {
        flex: 1;
        position: relative;
        overflow: hidden;
        display: flex;
      }

      .line-numbers {
        width: 48px;
        padding: 16px 8px;
        background: var(--bg-secondary);
        border-right: 1px solid var(--border);
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-muted);
        text-align: right;
        overflow: hidden;
        user-select: none;
        flex-shrink: 0;
      }

      .line-numbers div {
        height: 22.4px; /* 14px * 1.6 line-height */
      }

      .code-input-wrapper {
        flex: 1;
        overflow: auto;
        position: relative;
      }

      /* Syntax Highlighting */
      .syntax-highlight {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        padding: 16px;
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-wrap: break-word;
        pointer-events: none;
        color: var(--text-primary);
        overflow: hidden;
      }

      .syntax-highlight .tag {
        color: #ff79c6;
      }
      .syntax-highlight .attr-name {
        color: #50fa7b;
      }
      .syntax-highlight .attr-value {
        color: #f1fa8c;
      }
      .syntax-highlight .comment {
        color: #6272a4;
        font-style: italic;
      }
      .syntax-highlight .string {
        color: #f1fa8c;
      }
      .syntax-highlight .number {
        color: #bd93f9;
      }
      .syntax-highlight .keyword {
        color: #ff79c6;
      }
      .syntax-highlight .function {
        color: #50fa7b;
      }
      .syntax-highlight .property {
        color: #66d9ef;
      }
      .syntax-highlight .selector {
        color: #ff79c6;
      }
      .syntax-highlight .value {
        color: #f1fa8c;
      }
      .syntax-highlight .unit {
        color: #ff79c6;
      }
      .syntax-highlight .operator {
        color: #ff79c6;
      }
      .syntax-highlight .punctuation {
        color: var(--text-muted);
      }
      .syntax-highlight .doctype {
        color: #6272a4;
      }

      /* Bracket matching */
      .syntax-highlight .bracket-match {
        background: rgba(255, 121, 198, 0.3);
        border-radius: 2px;
        outline: 1px solid #ff79c6;
      }

      .code-input {
        width: 100%;
        height: 100%;
        min-height: 100%;
        padding: 16px;
        background: transparent;
        border: none;
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        line-height: 1.6;
        color: transparent;
        caret-color: var(--accent);
        resize: none;
        outline: none;
        tab-size: 2;
        -webkit-overflow-scrolling: touch;
        position: relative;
        z-index: 1;
      }

      .code-input::placeholder {
        color: var(--text-muted);
      }

      /* Syntax off mode - shows normal text */
      .syntax-off .code-input {
        color: var(--text-primary);
        background: var(--bg-primary);
      }

      .syntax-off .syntax-highlight {
        display: none;
      }

      /* Deploy panels */
      .deploy-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin: 16px 0;
      }

      @media (max-width: 500px) {
        .deploy-options {
          grid-template-columns: 1fr;
        }
      }

      .deploy-option {
        padding: 16px;
        background: var(--bg-tertiary);
        border: 2px solid var(--border);
        border-radius: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
      }

      .deploy-option:hover {
        border-color: var(--accent);
        background: var(--accent-glow);
      }

      .deploy-option.selected {
        border-color: var(--accent);
        background: var(--accent-glow);
      }

      .deploy-option-icon {
        font-size: 32px;
        margin-bottom: 8px;
      }

      .deploy-option-name {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .deploy-option-desc {
        font-size: 11px;
        color: var(--text-muted);
      }

      .deploy-steps {
        margin: 16px 0;
      }

      .deploy-step {
        display: flex;
        gap: 12px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border);
      }

      .deploy-step:last-child {
        border-bottom: none;
      }

      .deploy-step-num {
        width: 28px;
        height: 28px;
        background: var(--accent);
        color: var(--bg-primary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        flex-shrink: 0;
      }

      .deploy-step-content {
        flex: 1;
      }

      .deploy-step-title {
        font-weight: 500;
        margin-bottom: 4px;
      }

      .deploy-step-desc {
        font-size: 12px;
        color: var(--text-secondary);
      }

      .deploy-step-code {
        background: var(--bg-primary);
        padding: 8px 12px;
        border-radius: 6px;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .deploy-step-code button {
        padding: 4px 8px;
        background: var(--accent);
        border: none;
        border-radius: 4px;
        color: var(--bg-primary);
        font-size: 10px;
        cursor: pointer;
      }

      .domain-info-section {
        background: var(--bg-tertiary);
        border-radius: 12px;
        padding: 16px;
        margin: 12px 0;
      }

      .domain-info-title {
        font-weight: 600;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .domain-provider {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 10px;
        background: var(--bg-secondary);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .domain-provider-logo {
        width: 24px;
        height: 24px;
      }

      .domain-provider-name {
        font-weight: 500;
      }

      .domain-provider-price {
        margin-left: auto;
        color: var(--accent);
        font-size: 12px;
      }

      /* Split View */
      .split-view {
        display: none;
        flex: 1;
        overflow: hidden;
      }

      .split-view.active {
        display: flex;
      }

      .split-view .split-code {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        border-right: 3px solid var(--border);
      }

      .split-view .split-preview {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .split-view .split-preview iframe {
        flex: 1;
        border: none;
        background: white;
      }

      .split-divider {
        width: 6px;
        background: var(--border);
        cursor: col-resize;
        flex-shrink: 0;
      }

      .split-divider:hover,
      .split-divider:active {
        background: var(--accent);
      }

      /* Autosave indicator */
      .autosave-indicator {
        position: fixed;
        bottom: 70px;
        right: 16px;
        padding: 6px 12px;
        background: var(--success);
        color: white;
        border-radius: 20px;
        font-size: 11px;
        opacity: 0;
        transition: opacity 0.3s;
        z-index: 100;
      }

      .autosave-indicator.show {
        opacity: 1;
      }

      /* Minimap */
      .minimap {
        position: absolute;
        right: 0;
        top: 0;
        width: 80px;
        height: 100%;
        background: var(--bg-secondary);
        border-left: 1px solid var(--border);
        overflow: hidden;
        opacity: 0.8;
        display: none;
      }

      .minimap.active {
        display: block;
      }

      .minimap-content {
        transform: scale(0.15);
        transform-origin: top left;
        width: 666%;
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-muted);
        white-space: pre;
        pointer-events: none;
      }

      .minimap-viewport {
        position: absolute;
        left: 0;
        right: 0;
        background: var(--accent-glow);
        border: 1px solid var(--accent);
        pointer-events: none;
      }

      @media (max-width: 768px) {
        .minimap {
          display: none !important;
        }
      }

      /* Autocomplete */
      .autocomplete-popup {
        position: fixed;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        min-width: 180px;
      }

      .autocomplete-popup.active {
        display: block;
      }

      .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 13px;
        font-family: "JetBrains Mono", monospace;
      }

      .autocomplete-item:hover,
      .autocomplete-item.selected {
        background: var(--accent-glow);
      }

      .autocomplete-item .tag {
        color: var(--accent);
      }

      .autocomplete-item .attr {
        color: var(--warning);
      }

      .autocomplete-item .value {
        color: var(--text-muted);
        font-size: 11px;
        margin-left: auto;
      }

      /* Drag & Drop Overlay */
      .drop-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 212, 170, 0.1);
        border: 3px dashed var(--accent);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        pointer-events: none;
      }

      .drop-overlay.active {
        display: flex;
      }

      .drop-overlay-content {
        background: var(--bg-elevated);
        padding: 32px 48px;
        border-radius: 16px;
        text-align: center;
      }

      .drop-overlay-content svg {
        width: 48px;
        height: 48px;
        stroke: var(--accent);
        margin-bottom: 16px;
      }

      .drop-overlay-content h3 {
        font-size: 18px;
        margin-bottom: 8px;
      }

      .drop-overlay-content p {
        color: var(--text-muted);
        font-size: 13px;
      }

      /* Theme Toggle */
      .theme-toggle {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin: 8px 16px;
      }

      .theme-toggle-label {
        flex: 1;
        font-size: 14px;
      }

      .theme-toggle-btns {
        display: flex;
        gap: 4px;
      }

      .theme-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
      }

      .theme-btn.active {
        background: var(--accent);
        color: var(--bg-primary);
      }

      /* CSS Grid/Flex Editor */
      .css-editor-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
        padding: 16px;
      }

      @media (max-width: 600px) {
        .css-editor-container {
          grid-template-columns: 1fr;
        }
      }

      .css-editor-preview {
        background: var(--bg-tertiary);
        border-radius: 12px;
        padding: 16px;
        min-height: 200px;
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .css-editor-preview.grid-mode {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
      }

      .css-editor-item {
        background: var(--accent-glow);
        border: 2px dashed var(--accent);
        border-radius: 8px;
        padding: 16px;
        text-align: center;
        font-size: 12px;
        color: var(--text-muted);
        min-width: 60px;
        min-height: 40px;
      }

      .css-editor-controls {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .css-control-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .css-control-label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .css-control-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .css-control-btn {
        padding: 6px 12px;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg-secondary);
        color: var(--text-secondary);
        font-size: 11px;
        cursor: pointer;
      }

      .css-control-btn:active,
      .css-control-btn.active {
        background: var(--accent);
        color: var(--bg-primary);
        border-color: var(--accent);
      }

      /* Share Modal */
      .share-url-container {
        display: flex;
        gap: 8px;
        margin: 16px 0;
      }

      .share-url-input {
        flex: 1;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 12px;
        font-family: "JetBrains Mono", monospace;
      }

      .share-copy-btn {
        padding: 12px 16px;
        background: var(--accent);
        border: none;
        border-radius: 8px;
        color: var(--bg-primary);
        font-weight: 600;
        cursor: pointer;
      }

      .share-qr {
        text-align: center;
        margin: 16px 0;
      }

      .share-qr canvas {
        border-radius: 8px;
        background: white;
        padding: 8px;
      }

      /* Preview Panel */
      .preview-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .preview-header {
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
      }

      .preview-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .preview-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--success);
      }

      .preview-actions {
        display: flex;
        gap: 4px;
      }

      .preview-frame {
        flex: 1;
        border: none;
        background: white;
      }

      /* Console Panel */
      .console-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .console-header {
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 12px;
        background: var(--bg-secondary);
        border-bottom: 1px solid var(--border);
      }

      .console-title {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .console-badge {
        padding: 2px 8px;
        background: var(--error);
        color: white;
        border-radius: 10px;
        font-size: 10px;
        font-weight: 600;
      }

      .console-badge.warn {
        background: var(--warning);
        color: var(--bg-primary);
      }

      .console-badge.hidden {
        display: none;
      }

      .console-content {
        flex: 1;
        overflow-y: auto;
        padding: 8px 0;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        -webkit-overflow-scrolling: touch;
      }

      .console-entry {
        padding: 8px 12px;
        display: flex;
        align-items: flex-start;
        gap: 8px;
        border-bottom: 1px solid var(--border);
      }

      .console-entry.log {
        color: var(--text-primary);
      }
      .console-entry.info {
        color: var(--attr);
      }
      .console-entry.warn {
        color: var(--warning);
        background: rgba(255, 169, 77, 0.1);
      }
      .console-entry.error {
        color: var(--error);
        background: rgba(255, 107, 107, 0.1);
      }
      .console-entry.command {
        color: var(--accent);
      }
      .console-entry.result {
        color: var(--text-secondary);
        padding-left: 24px;
      }

      .console-message {
        flex: 1;
        word-break: break-all;
        white-space: pre-wrap;
      }

      .console-time {
        color: var(--text-muted);
        font-size: 10px;
        flex-shrink: 0;
      }

      .console-input-wrapper {
        display: flex;
        align-items: center;
        padding: 10px 12px;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        gap: 8px;
      }

      .console-prompt {
        color: var(--accent);
        font-family: "JetBrains Mono", monospace;
        font-size: 16px;
      }

      .console-input {
        flex: 1;
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-family: "JetBrains Mono", monospace;
        font-size: 14px;
        color: var(--text-primary);
        outline: none;
      }

      .console-input:focus {
        border-color: var(--accent);
      }

      .console-empty {
        display: flex;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-muted);
        font-size: 13px;
      }

      /* Bottom Navigation */
      .bottom-nav {
        height: 64px;
        background: var(--bg-secondary);
        border-top: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-around;
        padding: 0 8px;
        flex-shrink: 0;
      }

      .bottom-nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
        padding: 8px;
        background: transparent;
        border: none;
        border-radius: 12px;
        color: var(--text-muted);
        font-size: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .bottom-nav-item svg {
        width: 24px;
        height: 24px;
      }

      .bottom-nav-item.active {
        color: var(--accent);
      }

      .bottom-nav-item:active {
        background: var(--bg-tertiary);
      }

      /* Bottom Sheet */
      .bottom-sheet-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.6);
        z-index: 200;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .bottom-sheet-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .bottom-sheet {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-secondary);
        border-radius: 20px 20px 0 0;
        max-height: 80vh;
        z-index: 201;
        transform: translateY(100%);
        transition: transform 0.3s ease;
        display: flex;
        flex-direction: column;
        padding-bottom: var(--safe-bottom);
      }

      .bottom-sheet-overlay.active .bottom-sheet {
        transform: translateY(0);
      }

      .bottom-sheet-handle {
        width: 40px;
        height: 4px;
        background: var(--border-light);
        border-radius: 2px;
        margin: 12px auto;
      }

      .bottom-sheet-header {
        padding: 0 20px 16px;
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .bottom-sheet-title {
        font-size: 18px;
        font-weight: 600;
      }

      .bottom-sheet-close {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--bg-tertiary);
        border: none;
        border-radius: 50%;
        color: var(--text-secondary);
      }

      .bottom-sheet-close svg {
        width: 20px;
        height: 20px;
      }

      .bottom-sheet-content {
        flex: 1;
        overflow-y: auto;
        padding: 16px 20px;
        -webkit-overflow-scrolling: touch;
      }

      /* Section Title */
      .section-title {
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 10px;
        margin-top: 16px;
      }

      .section-title:first-child {
        margin-top: 0;
      }

      /* Template List */
      .template-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .template-item {
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        cursor: pointer;
      }

      .template-item:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .template-name {
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 2px;
      }

      .template-desc {
        font-size: 12px;
        color: var(--text-secondary);
      }

      /* Snippet Grid */
      .snippet-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .snippet-btn {
        padding: 14px 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        color: var(--text-secondary);
        text-align: center;
      }

      .snippet-btn:active {
        background: var(--bg-elevated);
        color: var(--accent);
        border-color: var(--accent);
      }

      /* Compact versions for sidebar */
      .tools-panel .template-item {
        padding: 10px;
      }

      .tools-panel .template-name {
        font-size: 13px;
      }

      .tools-panel .template-desc {
        font-size: 11px;
      }

      .tools-panel .snippet-btn {
        padding: 10px 6px;
        font-size: 11px;
      }

      .tools-panel .collapse-header {
        padding: 10px;
      }

      .tools-panel .collapse-title {
        font-size: 12px;
      }

      .tools-panel .file-item {
        padding: 8px 10px;
      }

      .tools-panel .file-name {
        font-size: 11px;
      }

      /* Prompts */
      .prompts-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 10px;
      }

      .prompt-item {
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
      }

      .prompt-item:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .prompt-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 4px;
      }

      .prompt-name {
        font-size: 12px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .prompt-actions {
        display: flex;
        gap: 4px;
      }

      .prompt-action-btn {
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        border-radius: 4px;
        color: var(--text-muted);
      }

      .prompt-action-btn:active {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      .prompt-action-btn.delete:active {
        background: var(--error);
        color: white;
      }

      .prompt-action-btn svg {
        width: 14px;
        height: 14px;
      }

      .prompt-text {
        font-size: 11px;
        color: var(--text-secondary);
        line-height: 1.4;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .add-prompt-btn {
        width: 100%;
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px dashed var(--border);
        border-radius: 8px;
        color: var(--text-muted);
        font-size: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        cursor: pointer;
      }

      .add-prompt-btn:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
        color: var(--accent);
      }

      .add-prompt-btn svg {
        width: 16px;
        height: 16px;
      }

      .prompts-empty {
        text-align: center;
        padding: 16px;
        color: var(--text-muted);
        font-size: 11px;
      }

      /* Action List */
      .action-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .action-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
      }

      .action-item:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .action-item svg {
        width: 18px;
        height: 18px;
        color: var(--accent);
        flex-shrink: 0;
      }

      .tools-panel .action-item {
        padding: 10px;
        font-size: 12px;
      }

      .tools-panel .action-item svg {
        width: 16px;
        height: 16px;
      }

      /* Settings */
      .settings-section {
        margin-bottom: 20px;
      }

      .settings-title {
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--text-muted);
        margin-bottom: 12px;
      }

      .settings-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        margin-bottom: 8px;
      }

      .settings-label {
        font-size: 14px;
      }

      .settings-select {
        padding: 8px 12px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-primary);
        font-size: 14px;
        font-family: "Space Grotesk", sans-serif;
      }

      .settings-toggle {
        position: relative;
        width: 50px;
        height: 28px;
      }

      .settings-toggle input {
        opacity: 0;
        width: 0;
        height: 0;
      }

      .toggle-slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 28px;
        transition: 0.3s;
      }

      .toggle-slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 2px;
        bottom: 2px;
        background: var(--text-muted);
        border-radius: 50%;
        transition: 0.3s;
      }

      .settings-toggle input:checked + .toggle-slider {
        background: var(--accent);
        border-color: var(--accent);
      }

      .settings-toggle input:checked + .toggle-slider:before {
        background: white;
        transform: translateX(22px);
      }

      /* GitHub */
      .github-user {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
      }

      .github-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
      }

      .github-username {
        font-size: 13px;
        font-weight: 500;
      }

      .github-browser {
        max-height: 50vh;
        overflow-y: auto;
      }

      .github-branch-bar {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .github-branch-bar select {
        padding: 6px 10px;
        font-size: 12px;
      }

      .github-conflict-warning {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid var(--error);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
      }

      .github-conflict-warning h4 {
        color: var(--error);
        font-size: 14px;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .github-conflict-warning p {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .github-conflict-actions {
        display: flex;
        gap: 8px;
        margin-top: 8px;
      }

      .github-pull-info {
        background: var(--bg-tertiary);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 12px;
        font-size: 12px;
      }

      .github-pull-info .status {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
      }

      .github-pull-info .status.ok {
        color: var(--success);
      }

      .github-pull-info .status.warning {
        color: var(--warning);
      }

      .github-path {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 10px 0;
        font-size: 12px;
        color: var(--text-secondary);
        flex-wrap: wrap;
      }

      .github-path-item {
        color: var(--accent);
        cursor: pointer;
      }

      .github-path-item:hover {
        text-decoration: underline;
      }

      .github-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .github-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
      }

      .github-item:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .github-item svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
      }

      .github-item.folder svg {
        color: var(--warning);
      }

      .github-item.file svg {
        color: var(--accent);
      }

      .github-item-name {
        flex: 1;
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .github-item-size {
        font-size: 11px;
        color: var(--text-muted);
      }

      .github-item-stars {
        display: flex;
        align-items: center;
        gap: 3px;
        font-size: 11px;
        color: var(--warning);
      }

      .github-repo-actions {
        display: flex;
        gap: 6px;
        margin-left: auto;
      }

      .github-small-btn {
        padding: 4px 8px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 10px;
        cursor: pointer;
        white-space: nowrap;
      }

      .github-small-btn:hover {
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      .github-readme-preview {
        background: var(--bg-primary);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 16px;
        margin: 12px 0;
        max-height: 300px;
        overflow-y: auto;
        font-size: 13px;
        line-height: 1.6;
      }

      .github-readme-preview h1,
      .github-readme-preview h2,
      .github-readme-preview h3 {
        margin: 16px 0 8px 0;
        color: var(--text-primary);
      }

      .github-readme-preview h1 {
        font-size: 1.5em;
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
      }
      .github-readme-preview h2 {
        font-size: 1.3em;
      }
      .github-readme-preview h3 {
        font-size: 1.1em;
      }

      .github-readme-preview p {
        margin: 8px 0;
      }

      .github-readme-preview code {
        background: var(--bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 0.9em;
      }

      .github-readme-preview pre {
        background: var(--bg-tertiary);
        padding: 12px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 12px 0;
      }

      .github-readme-preview pre code {
        background: none;
        padding: 0;
      }

      .github-readme-preview ul,
      .github-readme-preview ol {
        margin: 8px 0;
        padding-left: 24px;
      }

      .github-readme-preview a {
        color: var(--accent);
      }

      .github-readme-preview img {
        max-width: 100%;
        border-radius: 8px;
      }

      .github-readme-preview blockquote {
        border-left: 3px solid var(--accent);
        padding-left: 12px;
        margin: 12px 0;
        color: var(--text-secondary);
      }

      .clone-url-container {
        display: flex;
        gap: 8px;
        margin: 12px 0;
      }

      .clone-url-input {
        flex: 1;
        padding: 10px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
      }

      .clone-url-tabs {
        display: flex;
        gap: 4px;
        margin-bottom: 12px;
      }

      .clone-url-tab {
        padding: 6px 12px;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 12px;
        cursor: pointer;
      }

      .clone-url-tab.active {
        background: var(--accent);
        color: var(--bg-primary);
        border-color: var(--accent);
      }

      .gitignore-templates {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 12px 0;
      }

      @media (max-width: 500px) {
        .gitignore-templates {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      .gitignore-template-btn {
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 12px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
      }

      .gitignore-template-btn:hover {
        border-color: var(--accent);
        background: var(--accent-glow);
      }

      .gitignore-template-btn.selected {
        border-color: var(--accent);
        background: var(--accent-glow);
      }

      .github-item-actions {
        display: flex;
        gap: 4px;
      }

      .github-folder-btn {
        padding: 4px 8px;
        background: var(--accent);
        border: none;
        border-radius: 6px;
        color: var(--bg-primary);
        font-size: 10px;
        font-weight: 500;
        cursor: pointer;
        white-space: nowrap;
      }

      .github-folder-btn:active {
        opacity: 0.8;
      }

      /* Loading Progress */
      .loading-progress {
        padding: 20px 0;
      }

      .loading-bar {
        height: 8px;
        background: var(--bg-tertiary);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 12px;
      }

      .loading-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent), #764ba2);
        border-radius: 4px;
        width: 0%;
        transition: width 0.3s ease;
        animation: loadingPulse 1.5s ease-in-out infinite;
      }

      @keyframes loadingPulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      .loading-status {
        font-size: 14px;
        color: var(--text-primary);
        margin-bottom: 4px;
      }

      .loading-details {
        font-size: 12px;
        color: var(--text-muted);
        min-height: 18px;
      }

      /* Vylepšený file list */

      .files-empty {
        text-align: center;
        padding: 20px;
        color: var(--text-muted);
        font-size: 12px;
      }

      .files-summary {
        font-size: 11px;
        color: var(--text-muted);
        padding: 8px 0;
        border-top: 1px solid var(--border);
        margin-top: 8px;
        display: flex;
        justify-content: space-between;
      }

      /* Stromová struktura složek */
      .folder-item {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 4px;
        cursor: pointer;
        font-size: 13px;
      }

      .folder-item:active {
        background: var(--bg-elevated);
      }

      .folder-arrow {
        width: 14px;
        height: 14px;
        color: var(--text-muted);
        flex-shrink: 0;
        transition: transform 0.15s ease;
      }

      .folder-arrow.expanded {
        transform: rotate(90deg);
      }

      .folder-icon {
        width: 16px;
        height: 16px;
        color: var(--warning);
        flex-shrink: 0;
      }

      .folder-name {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
      }

      .folder-count {
        font-size: 10px;
        color: var(--text-muted);
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 10px;
      }

      .folder-content {
        margin-left: 8px;
        border-left: 1px solid var(--border);
        padding-left: 4px;
      }

      /* File item ve stromu */
      .file-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 4px;
        cursor: pointer;
      }

      .file-item.active {
        background: var(--accent-glow);
        border-color: var(--accent);
      }

      .file-item:active {
        background: var(--bg-elevated);
      }

      .file-info {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
      }

      .file-icon {
        width: 16px;
        height: 16px;
        color: var(--accent);
        flex-shrink: 0;
      }

      .file-name {
        font-size: 13px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .file-unsaved {
        width: 6px;
        height: 6px;
        background: var(--warning);
        border-radius: 50%;
        flex-shrink: 0;
      }

      .file-size {
        font-size: 10px;
        color: var(--text-muted);
        margin-left: auto;
        white-space: nowrap;
      }

      .file-close {
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: var(--text-muted);
        font-size: 14px;
        cursor: pointer;
        border-radius: 4px;
        flex-shrink: 0;
        margin-left: 4px;
      }

      .file-close:active {
        background: var(--error);
        color: white;
      }

      .github-loading {
        text-align: center;
        padding: 20px;
        color: var(--text-muted);
      }

      .github-empty {
        text-align: center;
        padding: 20px;
        color: var(--text-muted);
        font-size: 12px;
      }

      /* GitHub Help */
      .github-help {
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }

      .github-help-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        cursor: pointer;
        font-size: 13px;
        color: var(--text-secondary);
      }

      .github-help-title:active {
        background: var(--bg-tertiary);
      }

      .github-help-title svg {
        transition: transform 0.2s ease;
      }

      .github-help.open .github-help-title svg {
        transform: rotate(180deg);
      }

      .github-help-content {
        display: none;
        padding: 0 12px 12px;
        font-size: 12px;
        color: var(--text-secondary);
        line-height: 1.6;
      }

      .github-help.open .github-help-content {
        display: block;
      }

      .github-help-content ol {
        margin: 0;
        padding-left: 20px;
      }

      .github-help-content li {
        margin-bottom: 8px;
      }

      .github-help-content a {
        color: var(--accent);
      }

      .github-help-content strong {
        color: var(--text-primary);
      }

      .github-help-content code {
        background: var(--bg-tertiary);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
      }

      .github-help-note {
        margin-top: 10px;
        padding: 10px;
        background: var(--bg-tertiary);
        border-radius: 6px;
        font-size: 11px;
      }

      /* Repo Manager */
      .repo-stats {
        display: flex;
        gap: 12px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 12px;
        font-size: 12px;
      }

      .repo-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        flex: 1;
      }

      .repo-stat-value {
        font-size: 20px;
        font-weight: 600;
        color: var(--accent);
      }

      .repo-stat-label {
        color: var(--text-muted);
        font-size: 10px;
        text-transform: uppercase;
      }

      .repo-manager-list {
        flex: 1;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 50vh;
        -webkit-overflow-scrolling: touch;
      }

      .repo-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 12px;
      }

      .repo-card-header {
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 8px;
      }

      .repo-card-name {
        font-size: 14px;
        font-weight: 500;
        color: var(--accent);
        word-break: break-all;
      }

      .repo-card-badges {
        display: flex;
        gap: 4px;
        flex-shrink: 0;
      }

      .repo-badge {
        padding: 2px 6px;
        background: var(--bg-elevated);
        border-radius: 4px;
        font-size: 10px;
        color: var(--text-muted);
      }

      .repo-badge.private {
        background: var(--warning);
        color: var(--bg-primary);
      }

      .repo-card-desc {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .repo-card-meta {
        display: flex;
        gap: 12px;
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 10px;
      }

      .repo-card-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .repo-card-actions {
        display: flex;
        gap: 6px;
      }

      .repo-action-btn {
        flex: 1;
        padding: 8px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        cursor: pointer;
      }

      .repo-action-btn:active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .repo-action-btn.danger {
        color: var(--error);
      }

      .repo-action-btn.danger:active {
        background: var(--error);
        color: white;
      }

      .repo-action-btn svg {
        width: 14px;
        height: 14px;
      }

      /* Commit List */
      .commit-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .commit-item {
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
      }

      .commit-item:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .commit-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
      }

      .commit-sha {
        font-family: "JetBrains Mono", monospace;
        font-size: 11px;
        color: var(--accent);
        background: var(--bg-elevated);
        padding: 2px 6px;
        border-radius: 4px;
      }

      .commit-date {
        font-size: 11px;
        color: var(--text-muted);
      }

      .commit-message {
        font-size: 13px;
        color: var(--text-primary);
        margin-bottom: 6px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .commit-author {
        font-size: 11px;
        color: var(--text-secondary);
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .commit-author img {
        width: 16px;
        height: 16px;
        border-radius: 50%;
      }

      .commit-files {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        flex-wrap: wrap;
      }

      .commit-file-btn {
        padding: 6px 10px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 11px;
        color: var(--text-secondary);
        cursor: pointer;
      }

      .commit-file-btn:active {
        background: var(--accent);
        color: var(--bg-primary);
      }

      /* Diff View */
      .diff-container {
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        line-height: 1.5;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        overflow: hidden;
      }

      .diff-stats {
        display: flex;
        gap: 16px;
        padding: 12px;
        background: var(--bg-elevated);
        border-bottom: 1px solid var(--border);
        font-size: 12px;
      }

      .diff-stat {
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .diff-stat.added {
        color: var(--success);
      }
      .diff-stat.removed {
        color: var(--error);
      }
      .diff-stat.size {
        color: var(--text-secondary);
      }

      .diff-content {
        max-height: 400px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .diff-line {
        padding: 2px 12px;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .diff-line.added {
        background: rgba(81, 207, 102, 0.15);
        color: var(--success);
      }

      .diff-line.removed {
        background: rgba(255, 107, 107, 0.15);
        color: var(--error);
      }

      .diff-line.context {
        color: var(--text-muted);
      }

      .diff-line-number {
        display: inline-block;
        width: 30px;
        color: var(--text-muted);
        user-select: none;
      }

      /* Pages Status */
      .pages-status {
        padding: 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      .pages-status-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 12px;
      }

      .pages-status-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      .pages-status-icon.active {
        background: rgba(81, 207, 102, 0.2);
      }

      .pages-status-icon.inactive {
        background: rgba(255, 107, 107, 0.2);
      }

      .pages-status-title {
        font-size: 14px;
        font-weight: 500;
      }

      .pages-status-subtitle {
        font-size: 12px;
        color: var(--text-muted);
      }

      .pages-url {
        display: block;
        padding: 12px;
        background: var(--bg-elevated);
        border-radius: 8px;
        color: var(--accent);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        text-decoration: none;
        margin-bottom: 12px;
        word-break: break-all;
      }

      .pages-url:active {
        background: var(--accent);
        color: var(--bg-primary);
      }

      .pages-actions {
        display: flex;
        gap: 8px;
      }

      .pages-btn {
        flex: 1;
        padding: 10px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        text-align: center;
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--bg-elevated);
        color: var(--text-primary);
      }

      .pages-btn:active {
        background: var(--bg-tertiary);
      }

      .pages-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--bg-primary);
      }

      .pages-btn.danger {
        background: var(--error);
        border-color: var(--error);
        color: white;
      }

      /* Gist List */
      .gist-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .gist-item {
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
      }

      .gist-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 6px;
      }

      .gist-filename {
        font-family: "JetBrains Mono", monospace;
        font-size: 13px;
        color: var(--accent);
      }

      .gist-badge {
        font-size: 10px;
        padding: 2px 6px;
        border-radius: 4px;
        background: var(--bg-elevated);
        color: var(--text-muted);
      }

      .gist-badge.public {
        background: rgba(81, 207, 102, 0.2);
        color: var(--success);
      }

      .gist-desc {
        font-size: 12px;
        color: var(--text-secondary);
        margin-bottom: 8px;
      }

      .gist-meta {
        font-size: 11px;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .gist-actions {
        display: flex;
        gap: 6px;
      }

      .gist-action-btn {
        flex: 1;
        padding: 8px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-secondary);
        font-size: 11px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
        cursor: pointer;
      }

      .gist-action-btn:active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .gist-action-btn.danger:active {
        background: var(--error);
        color: white;
      }

      /* Context Menu */
      .context-menu {
        position: fixed;
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px;
        z-index: 500;
        min-width: 160px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        display: none;
      }

      .context-menu.active {
        display: block;
      }

      .context-menu-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 12px;
        border-radius: 6px;
        font-size: 13px;
        color: var(--text-primary);
        cursor: pointer;
      }

      .context-menu-item:active {
        background: var(--bg-tertiary);
      }

      .context-menu-item svg {
        width: 16px;
        height: 16px;
        color: var(--accent);
      }

      .context-menu-divider {
        height: 1px;
        background: var(--border);
        margin: 6px 0;
      }

      /* Responsive Preview */
      .responsive-buttons {
        display: flex;
        align-items: center;
        gap: 4px;
      }

      .responsive-btn {
        width: 36px;
        height: 36px;
        border: none;
        background: transparent;
        color: var(--text-muted);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .responsive-btn svg {
        width: 18px;
        height: 18px;
      }

      .responsive-btn.active {
        background: var(--accent);
        color: var(--bg-primary);
      }

      .responsive-btn:not(.active):active {
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .preview-size-label {
        font-size: 11px;
        color: var(--text-muted);
        margin-left: 8px;
        font-family: "JetBrains Mono", monospace;
      }

      .preview-source {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: var(--accent-glow);
        border: 1px solid var(--accent);
        border-radius: 6px;
        font-size: 11px;
        color: var(--accent);
        cursor: pointer;
        max-width: 150px;
        overflow: hidden;
      }

      .preview-source:active {
        background: var(--accent);
        color: var(--bg-primary);
      }

      .preview-source svg {
        width: 12px;
        height: 12px;
        flex-shrink: 0;
      }

      .preview-source span {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      @media (max-width: 500px) {
        .preview-source {
          display: none;
        }
      }

      .github-pages-link {
        display: flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        background: linear-gradient(135deg, #2ea44f, #22863a);
        border: none;
        border-radius: 6px;
        font-size: 11px;
        color: white;
        text-decoration: none;
        cursor: pointer;
      }

      .github-pages-link:active {
        opacity: 0.8;
      }

      .github-pages-link svg {
        width: 14px;
        height: 14px;
        flex-shrink: 0;
      }

      .github-pages-link span {
        white-space: nowrap;
      }

      @media (max-width: 600px) {
        .github-pages-link span {
          display: none;
        }
        .github-pages-link {
          padding: 6px;
        }
      }

      .preview-wrapper {
        flex: 1;
        display: flex;
        flex-direction: column;
        background: var(--bg-tertiary);
        overflow: hidden;
        padding: 0;
      }

      .preview-wrapper .preview-frame {
        flex: 1;
        width: 100%;
        height: 100%;
      }

      .preview-wrapper.tablet {
        align-items: center;
        overflow: auto;
      }

      .preview-wrapper.tablet .preview-frame {
        flex: none;
        width: 768px;
        max-width: 768px;
        height: 100%;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
      }

      .preview-wrapper.mobile {
        align-items: center;
        overflow: auto;
      }

      .preview-wrapper.mobile .preview-frame {
        flex: none;
        width: 375px;
        max-width: 375px;
        height: 100%;
        border-left: 1px solid var(--border);
        border-right: 1px solid var(--border);
      }

      /* Validation Modal */
      .validation-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 50vh;
        overflow-y: auto;
      }

      .validation-item {
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 12px;
      }

      .validation-item.error {
        border-left: 3px solid var(--error);
      }

      .validation-item.warning {
        border-left: 3px solid var(--warning);
      }

      .validation-item.success {
        border-left: 3px solid var(--success);
      }

      .validation-line {
        font-family: "JetBrains Mono", monospace;
        color: var(--text-muted);
        font-size: 10px;
        margin-bottom: 4px;
      }

      .validation-message {
        color: var(--text-primary);
      }

      /* Keyboard Shortcuts */
      .shortcuts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .shortcut-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 12px;
      }

      .shortcut-item.clickable {
        cursor: pointer;
      }

      .shortcut-item.clickable:active {
        background: var(--accent);
        border-color: var(--accent);
      }

      .shortcut-item.clickable:active .shortcut-key {
        background: rgba(0, 0, 0, 0.2);
        color: white;
      }

      .shortcut-key {
        font-family: "JetBrains Mono", monospace;
        background: var(--bg-elevated);
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 10px;
        color: var(--text-muted);
      }

      /* Live Server */
      .server-status {
        padding: 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        text-align: center;
      }

      .server-status-icon {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 12px;
        font-size: 28px;
      }

      .server-status-icon.online {
        background: rgba(81, 207, 102, 0.2);
      }

      .server-status-icon.offline {
        background: rgba(255, 107, 107, 0.2);
      }

      .server-url {
        display: block;
        padding: 12px;
        background: var(--bg-elevated);
        border-radius: 8px;
        color: var(--accent);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        text-decoration: none;
        margin: 12px 0;
        word-break: break-all;
      }

      .server-qr {
        margin: 12px 0;
        padding: 12px;
        background: white;
        border-radius: 8px;
        display: inline-block;
      }

      .server-qr canvas {
        display: block;
      }

      /* AI Button */
      .ai-btn {
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 100%
        ) !important;
        border: none !important;
      }

      .ai-btn svg {
        color: white;
      }

      /* AI Chat Panel */
      .ai-panel {
        position: fixed;
        top: 0;
        right: -100%;
        width: 100%;
        max-width: 400px;
        height: 100%;
        background: var(--bg-secondary);
        z-index: 400;
        display: flex;
        flex-direction: column;
        transition: right 0.3s ease;
      }

      .ai-panel.active {
        right: 0;
      }

      .ai-panel-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        border-bottom: 1px solid var(--border);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .ai-panel-title {
        font-size: 16px;
        font-weight: 600;
        color: white;
      }

      .ai-panel-close {
        width: 32px;
        height: 32px;
        border: none;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .ai-messages {
        flex: 1;
        overflow-y: auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .ai-message {
        padding: 12px;
        border-radius: 12px;
        font-size: 13px;
        line-height: 1.5;
        max-width: 90%;
      }

      .ai-message.user {
        background: var(--accent);
        color: var(--bg-primary);
        align-self: flex-end;
        border-bottom-right-radius: 4px;
      }

      .ai-message.assistant {
        background: var(--bg-tertiary);
        color: var(--text-primary);
        align-self: flex-start;
        border-bottom-left-radius: 4px;
      }

      .ai-message.system {
        background: var(--bg-elevated);
        color: var(--text-muted);
        align-self: center;
        font-size: 12px;
        text-align: center;
      }

      .ai-message pre {
        background: var(--bg-primary);
        padding: 8px;
        border-radius: 6px;
        overflow-x: auto;
        margin: 8px 0;
        font-size: 11px;
      }

      .ai-quick-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        background: var(--bg-tertiary);
      }

      .ai-quick-btn {
        padding: 8px 12px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 20px;
        font-size: 12px;
        color: var(--text-secondary);
        cursor: pointer;
        white-space: nowrap;
      }

      .ai-quick-btn:active {
        background: var(--accent);
        color: var(--bg-primary);
        border-color: var(--accent);
      }

      .ai-input-area {
        display: flex;
        gap: 8px;
        padding: 12px 16px;
        border-top: 1px solid var(--border);
        background: var(--bg-secondary);
      }

      .ai-input {
        flex: 1;
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 12px;
        color: var(--text-primary);
        font-size: 14px;
        resize: none;
        min-height: 44px;
        max-height: 120px;
      }

      .ai-send-btn {
        width: 44px;
        height: 44px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        border-radius: 12px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .ai-send-btn:disabled {
        opacity: 0.5;
      }

      .ai-send-btn svg {
        width: 20px;
        height: 20px;
      }

      .ai-typing {
        display: flex;
        gap: 4px;
        padding: 12px;
      }

      .ai-typing span {
        width: 8px;
        height: 8px;
        background: var(--text-muted);
        border-radius: 50%;
        animation: aiTyping 1.4s infinite ease-in-out;
      }

      .ai-typing span:nth-child(1) {
        animation-delay: 0s;
      }
      .ai-typing span:nth-child(2) {
        animation-delay: 0.2s;
      }
      .ai-typing span:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes aiTyping {
        0%,
        80%,
        100% {
          transform: scale(0.6);
          opacity: 0.5;
        }
        40% {
          transform: scale(1);
          opacity: 1;
        }
      }

      /* Components Panel */
      .components-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .component-card {
        padding: 16px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 12px;
        text-align: center;
        cursor: pointer;
      }

      .component-card:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .component-icon {
        font-size: 28px;
        margin-bottom: 8px;
      }

      .component-name {
        font-size: 12px;
        color: var(--text-primary);
        font-weight: 500;
      }

      .component-desc {
        font-size: 10px;
        color: var(--text-muted);
        margin-top: 4px;
      }

      /* AI Overlay */
      .ai-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 399;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
      }

      .ai-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      /* Templates Grid */
      .templates-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        max-height: 60vh;
        overflow-y: auto;
      }

      .template-card {
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
      }

      .template-card:active {
        border-color: var(--accent);
      }

      .template-preview {
        height: 100px;
        background: linear-gradient(
          135deg,
          var(--bg-elevated) 0%,
          var(--bg-tertiary) 100%
        );
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 36px;
      }

      .template-info {
        padding: 10px;
      }

      .template-name {
        font-size: 13px;
        font-weight: 500;
        color: var(--text-primary);
      }

      .template-desc {
        font-size: 11px;
        color: var(--text-muted);
        margin-top: 2px;
      }

      /* Unsplash Search */
      .unsplash-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
        max-height: 50vh;
        overflow-y: auto;
      }

      .unsplash-img {
        width: 100%;
        aspect-ratio: 4/3;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
      }

      .unsplash-img:active {
        border-color: var(--accent);
      }

      /* Color Schemes */
      .color-schemes {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
      }

      .color-scheme {
        padding: 12px;
        border-radius: 10px;
        cursor: pointer;
        text-align: center;
        border: 2px solid transparent;
      }

      .color-scheme:active {
        border-color: white;
      }

      .color-scheme-preview {
        display: flex;
        gap: 4px;
        justify-content: center;
        margin-bottom: 8px;
      }

      .color-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
      }

      .color-scheme-name {
        font-size: 11px;
        color: white;
        font-weight: 500;
      }

      /* Visual Editor Panel */
      .visual-editor {
        position: fixed;
        bottom: -100%;
        left: 0;
        right: 0;
        background: var(--bg-secondary);
        border-top-left-radius: 20px;
        border-top-right-radius: 20px;
        z-index: 350;
        transition: bottom 0.3s ease;
        max-height: 70vh;
      }

      .visual-editor.active {
        bottom: 0;
      }

      .visual-editor-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 16px;
        border-bottom: 1px solid var(--border);
      }

      .visual-editor-title {
        font-size: 14px;
        font-weight: 600;
      }

      .visual-editor-content {
        padding: 16px;
        max-height: 50vh;
        overflow-y: auto;
      }

      .visual-field {
        margin-bottom: 16px;
      }

      .visual-field-label {
        font-size: 12px;
        color: var(--text-muted);
        margin-bottom: 6px;
        display: block;
      }

      .visual-field-row {
        display: flex;
        gap: 8px;
      }

      .visual-input {
        flex: 1;
        padding: 10px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 13px;
      }

      .visual-color-input {
        width: 44px;
        height: 44px;
        padding: 4px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        cursor: pointer;
      }

      .visual-btn-row {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }

      .visual-btn {
        flex: 1;
        padding: 12px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .visual-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--bg-primary);
      }

      .visual-btn.danger {
        background: var(--error);
        border-color: var(--error);
        color: white;
      }

      /* SEO Panel */
      .seo-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        margin-bottom: 8px;
      }

      .seo-icon {
        font-size: 18px;
      }

      .seo-info {
        flex: 1;
      }

      .seo-label {
        font-size: 13px;
        color: var(--text-primary);
      }

      .seo-value {
        font-size: 11px;
        color: var(--text-muted);
      }

      .seo-status {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
      }

      .seo-status.good {
        background: rgba(81, 207, 102, 0.2);
      }
      .seo-status.warn {
        background: rgba(255, 169, 77, 0.2);
      }
      .seo-status.bad {
        background: rgba(255, 107, 107, 0.2);
      }

      /* Device Preview */
      .device-selector {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .device-btn {
        padding: 8px 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 11px;
        color: var(--text-secondary);
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .device-btn.active {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--bg-primary);
      }

      .device-frame {
        background: #1a1a1a;
        border-radius: 20px;
        padding: 10px;
        margin: 0 auto;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      }

      .device-frame iframe {
        border-radius: 12px;
        background: white;
      }

      /* Publish Panel */
      .publish-status {
        text-align: center;
        padding: 20px;
      }

      .publish-icon {
        font-size: 48px;
        margin-bottom: 12px;
      }

      .publish-url {
        display: block;
        padding: 12px;
        background: var(--bg-tertiary);
        border-radius: 8px;
        color: var(--accent);
        font-family: "JetBrains Mono", monospace;
        font-size: 12px;
        text-decoration: none;
        margin: 12px 0;
        word-break: break-all;
      }

      /* Image Upload */
      .image-upload-area {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        margin-bottom: 12px;
      }

      .image-upload-area:active {
        border-color: var(--accent);
        background: var(--accent-glow);
      }

      .image-upload-icon {
        font-size: 36px;
        margin-bottom: 8px;
      }

      .image-upload-text {
        font-size: 13px;
        color: var(--text-secondary);
      }

      .image-preview {
        max-width: 100%;
        max-height: 200px;
        border-radius: 8px;
        margin-bottom: 12px;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .ai-error-notification {
        background: rgba(255, 107, 107, 0.1) !important;
        border: 1px solid var(--error);
      }

      /* History List */
      .history-list {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      .history-item {
        padding: 12px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      .history-item:active {
        background: var(--bg-elevated);
        border-color: var(--accent);
      }

      .history-item.current {
        border-color: var(--accent);
        background: var(--accent-glow);
      }

      .history-label {
        font-size: 13px;
      }

      .history-time {
        font-size: 11px;
        color: var(--text-muted);
      }

      /* Modal */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 300;
        padding: 20px;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
      }

      .modal-overlay.active {
        opacity: 1;
        visibility: visible;
      }

      .modal {
        background: var(--bg-secondary);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 24px;
        width: 100%;
        max-width: 360px;
        transform: scale(0.95);
        transition: transform 0.2s ease;
      }

      .modal-overlay.active .modal {
        transform: scale(1);
      }

      .modal-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .modal-desc {
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: 20px;
      }

      .modal-input {
        width: 100%;
        padding: 14px;
        background: var(--bg-tertiary);
        border: 1px solid var(--border);
        border-radius: 10px;
        font-family: "Space Grotesk", sans-serif;
        font-size: 16px;
        color: var(--text-primary);
        margin-bottom: 20px;
        outline: none;
      }

      .modal-input:focus {
        border-color: var(--accent);
      }

      textarea.modal-input {
        min-height: 100px;
        resize: vertical;
        font-family: "JetBrains Mono", monospace;
        line-height: 1.5;
      }

      .modal-actions {
        display: flex;
        gap: 10px;
      }

      .modal-btn {
        flex: 1;
        padding: 14px;
        border-radius: 10px;
        font-family: "Space Grotesk", sans-serif;
        font-size: 15px;
        font-weight: 500;
        cursor: pointer;
        border: 1px solid var(--border);
        background: var(--bg-tertiary);
        color: var(--text-primary);
      }

      .modal-btn:active {
        background: var(--bg-elevated);
      }

      .modal-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: var(--bg-primary);
      }

      .modal-btn.primary:active {
        background: var(--accent-dim);
      }

      /* Toast */
      .toast {
        position: fixed;
        bottom: 80px;
        left: 50%;
        transform: translateX(-50%) translateY(20px);
        padding: 14px 24px;
        background: var(--bg-elevated);
        border: 1px solid var(--border);
        border-radius: 12px;
        font-size: 14px;
        z-index: 400;
        opacity: 0;
        transition: all 0.3s ease;
        white-space: nowrap;
      }

      .toast.active {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.success {
        border-left: 3px solid var(--success);
      }
      .toast.error {
        border-left: 3px solid var(--error);
      }

      /* Quick Actions FAB */
      .fab {
        position: fixed;
        right: 16px;
        bottom: 80px;
        width: 56px;
        height: 56px;
        background: var(--accent);
        border: none;
        border-radius: 16px;
        color: var(--bg-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 20px rgba(0, 212, 170, 0.3);
        z-index: 50;
      }

      .fab:active {
        transform: scale(0.95);
      }

      .fab svg {
        width: 28px;
        height: 28px;
      }

      .fab.hidden {
        display: none;
      }

      /* Scrollbar */
      ::-webkit-scrollbar {
        width: 4px;
        height: 4px;
      }

      ::-webkit-scrollbar-track {
        background: transparent;
      }

      ::-webkit-scrollbar-thumb {
        background: var(--border-light);
        border-radius: 2px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <!-- Header -->
      <header class="header">
        <div class="header-left">
          <button class="nav-btn" onclick="history.back()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <polyline points="15 18 9 12 15 6" />
            </svg>
          </button>
          <div class="logo">
            <div class="logo-icon">&lt;/&gt;</div>
            <div class="logo-text">HTML <span>Studio</span></div>
          </div>
        </div>
        <div class="header-actions">
          <button
            class="nav-btn ai-btn"
            onclick="openAIChat()"
            title="AI Asistent"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path
                d="M12 2a2 2 0 0 1 2 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 0 1 7 7h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v1a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-1H2a1 1 0 0 1-1-1v-3a1 1 0 0 1 1-1h1a7 7 0 0 1 7-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 0 1 2-2M7.5 13A1.5 1.5 0 0 0 6 14.5 1.5 1.5 0 0 0 7.5 16 1.5 1.5 0 0 0 9 14.5 1.5 1.5 0 0 0 7.5 13m9 0a1.5 1.5 0 0 0-1.5 1.5 1.5 1.5 0 0 0 1.5 1.5 1.5 1.5 0 0 0 1.5-1.5 1.5 1.5 0 0 0-1.5-1.5"
              />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="openComponentsPanel()"
            title="Komponenty"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="7" height="7" />
              <rect x="14" y="3" width="7" height="7" />
              <rect x="14" y="14" width="7" height="7" />
              <rect x="3" y="14" width="7" height="7" />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="openTemplates()"
            title="Šablony"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" />
              <line x1="3" y1="9" x2="21" y2="9" />
              <line x1="9" y1="21" x2="9" y2="9" />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="openUnsplash()"
            title="Obrázky"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
              <circle cx="8.5" cy="8.5" r="1.5" />
              <polyline points="21 15 16 10 5 21" />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="openShortcuts()"
            title="Rychlé akce"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <rect x="2" y="4" width="20" height="16" rx="2" />
              <path
                d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M6 16h8"
              />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="openLiveServer()"
            title="Živý server"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="2" />
              <path
                d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49m11.31-2.82a10 10 0 0 1 0 14.14m-14.14 0a10 10 0 0 1 0-14.14"
              />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="formatCode()"
            title="Formátovat kód"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="21" y1="10" x2="3" y2="10" />
              <line x1="21" y1="6" x2="7" y2="6" />
              <line x1="21" y1="14" x2="7" y2="14" />
              <line x1="21" y1="18" x2="3" y2="18" />
            </svg>
          </button>
          <button
            class="nav-btn hide-mobile"
            onclick="toggleSearch()"
            id="searchToggle"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="11" cy="11" r="8" />
              <line x1="21" y1="21" x2="16.65" y2="16.65" />
            </svg>
          </button>
          <button class="nav-btn hide-mobile" onclick="openSettings()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="3" />
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
              />
            </svg>
          </button>
          <button
            class="nav-btn"
            onclick="toggleMoreMenu()"
            id="moreBtn"
            title="Více"
          >
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <circle cx="12" cy="12" r="1" />
              <circle cx="19" cy="12" r="1" />
              <circle cx="5" cy="12" r="1" />
            </svg>
          </button>
        </div>
      </header>

      <!-- Více menu (dropdown) -->
      <div class="more-menu" id="moreMenu">
        <button
          class="more-menu-item"
          onclick="toggleSplitView();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <line x1="12" y1="3" x2="12" y2="21" />
          </svg>
          Split view
        </button>
        <button class="more-menu-item" onclick="exportAsZip();closeMoreMenu();">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" y1="15" x2="12" y2="3" />
          </svg>
          Export ZIP
        </button>
        <button
          class="more-menu-item"
          onclick="takeScreenshot();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <circle cx="8.5" cy="8.5" r="1.5" />
            <path d="M21 15l-5-5L5 21" />
          </svg>
          Screenshot stránky
        </button>
        <button class="more-menu-item" onclick="shareAsLink();closeMoreMenu();">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="18" cy="5" r="3" />
            <circle cx="6" cy="12" r="3" />
            <circle cx="18" cy="19" r="3" />
            <line x1="8.59" y1="13.51" x2="15.42" y2="17.49" />
            <line x1="15.41" y1="6.51" x2="8.59" y2="10.49" />
          </svg>
          Sdílet odkaz
        </button>
        <button
          class="more-menu-item"
          onclick="openCSSEditor();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
            <line x1="10" y1="6.5" x2="14" y2="6.5" />
            <line x1="6.5" y1="10" x2="6.5" y2="14" />
          </svg>
          CSS Grid/Flex editor
        </button>
        <button
          class="more-menu-item"
          onclick="openGitignoreModal();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path
              d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
            />
            <polyline points="14 2 14 8 20 8" />
            <line x1="9" y1="15" x2="15" y2="15" />
          </svg>
          Vytvořit .gitignore
        </button>
        <button
          class="more-menu-item"
          onclick="openDeployModal();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <path d="M22 12h-4l-3 9L9 3l-3 9H2" />
          </svg>
          🚀 Deploy projekt
        </button>
        <button
          class="more-menu-item"
          onclick="openShortcuts();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="2" y="4" width="20" height="16" rx="2" />
            <path
              d="M6 8h.01M10 8h.01M14 8h.01M18 8h.01M8 12h.01M12 12h.01M16 12h.01M6 16h8"
            />
          </svg>
          Rychlé akce
        </button>
        <button
          class="more-menu-item"
          onclick="openComponentsPanel();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="7" height="7" />
            <rect x="14" y="3" width="7" height="7" />
            <rect x="14" y="14" width="7" height="7" />
            <rect x="3" y="14" width="7" height="7" />
          </svg>
          Komponenty
        </button>
        <button
          class="more-menu-item"
          onclick="openTemplates();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" />
            <line x1="3" y1="9" x2="21" y2="9" />
            <line x1="9" y1="21" x2="9" y2="9" />
          </svg>
          Šablony
        </button>
        <button
          class="more-menu-item"
          onclick="openUnsplash();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            <circle cx="8.5" cy="8.5" r="1.5" />
            <polyline points="21 15 16 10 5 21" />
          </svg>
          Obrázky
        </button>
        <button
          class="more-menu-item"
          onclick="openLiveServer();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="2" />
            <path d="M16.24 7.76a6 6 0 0 1 0 8.49m-8.48-.01a6 6 0 0 1 0-8.49" />
          </svg>
          Živý server
        </button>
        <button class="more-menu-item" onclick="formatCode();closeMoreMenu();">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="21" y1="10" x2="3" y2="10" />
            <line x1="21" y1="6" x2="7" y2="6" />
            <line x1="21" y1="14" x2="7" y2="14" />
            <line x1="21" y1="18" x2="3" y2="18" />
          </svg>
          Formátovat kód
        </button>
        <button
          class="more-menu-item"
          onclick="toggleSearch();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="11" cy="11" r="8" />
            <line x1="21" y1="21" x2="16.65" y2="16.65" />
          </svg>
          Hledat
        </button>
        <button
          class="more-menu-item"
          onclick="openSettings();closeMoreMenu();"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <circle cx="12" cy="12" r="3" />
            <path
              d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33"
            />
          </svg>
          Nastavení
        </button>
      </div>

      <!-- Main Content -->
      <main class="main-content">
        <!-- Code View -->
        <div class="view-panel active" id="codeView">
          <div class="file-tabs" id="fileTabs"></div>
          <div class="code-editor">
            <div class="search-bar" id="searchBar">
              <div class="search-row">
                <input
                  type="text"
                  class="search-input"
                  id="searchInput"
                  placeholder="Hledat..."
                />
              </div>
              <div class="search-row">
                <input
                  type="text"
                  class="search-input"
                  id="replaceInput"
                  placeholder="Nahradit..."
                />
              </div>
              <div class="search-info">
                <span class="search-results" id="searchResults"></span>
                <div class="search-actions">
                  <button class="search-btn" onclick="findPrev()">◀</button>
                  <button class="search-btn" onclick="findNext()">▶</button>
                  <button class="search-btn" onclick="replaceOne()">
                    Nahradit
                  </button>
                  <button class="search-btn primary" onclick="replaceAll()">
                    Vše
                  </button>
                </div>
              </div>
            </div>
            <div class="code-area">
              <div class="line-numbers" id="lineNumbers"></div>
              <div class="code-input-wrapper" id="codeWrapper">
                <div class="syntax-highlight" id="syntaxHighlight"></div>
                <textarea
                  class="code-input"
                  id="codeInput"
                  spellcheck="false"
                  placeholder="Začněte psát HTML kód..."
                ></textarea>
              </div>
              <div class="minimap" id="minimap">
                <div class="minimap-content" id="minimapContent"></div>
                <div class="minimap-viewport" id="minimapViewport"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Split View -->
        <div class="view-panel" id="splitView">
          <div class="split-view active">
            <div class="split-code">
              <div class="file-tabs" id="fileTabsSplit"></div>
              <div class="code-area">
                <div class="line-numbers" id="lineNumbersSplit"></div>
                <div class="code-input-wrapper">
                  <textarea
                    class="code-input"
                    id="codeInputSplit"
                    spellcheck="false"
                  ></textarea>
                </div>
              </div>
            </div>
            <div class="split-divider" id="splitDivider"></div>
            <div class="split-preview">
              <div class="preview-header height-36">
                <span class="font-size-12 color-muted">Náhled</span>
                <button class="nav-btn btn-28" onclick="refreshSplitPreview()">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    class="svg-14"
                  >
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                  </svg>
                </button>
              </div>
              <iframe class="preview-frame" id="splitPreviewFrame"></iframe>
            </div>
          </div>
        </div>

        <!-- Preview View -->
        <div class="view-panel" id="previewView">
          <div class="preview-container">
            <div class="preview-header">
              <div class="responsive-buttons">
                <button
                  class="responsive-btn active"
                  onclick="setPreviewSize('full')"
                  data-size="full"
                  title="100%"
                >
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="2" y="3" width="20" height="14" rx="2" />
                    <line x1="8" y1="21" x2="16" y2="21" />
                    <line x1="12" y1="17" x2="12" y2="21" />
                  </svg>
                </button>
                <button
                  class="responsive-btn"
                  onclick="setPreviewSize('tablet')"
                  data-size="tablet"
                  title="768px"
                >
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="4" y="2" width="16" height="20" rx="2" />
                    <line x1="12" y1="18" x2="12" y2="18" />
                  </svg>
                </button>
                <button
                  class="responsive-btn"
                  onclick="setPreviewSize('mobile')"
                  data-size="mobile"
                  title="375px"
                >
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <rect x="6" y="2" width="12" height="20" rx="2" />
                    <line x1="12" y1="18" x2="12" y2="18" />
                  </svg>
                </button>
                <span class="preview-size-label" id="previewSizeLabel"
                  >100%</span
                >
              </div>
              <div
                class="preview-source"
                id="previewSource"
                onclick="switchToPreviewSource()"
                title="Klikni pro přepnutí na tento soubor"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                  />
                  <polyline points="14 2 14 8 20 8" />
                </svg>
                <span id="previewSourceName">index.html</span>
              </div>
              <a
                class="github-pages-link d-none"
                id="githubPagesLink"
                href="#"
                target="_blank"
                title="Otevřít na GitHub Pages"
              >
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path
                    d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"
                  />
                </svg>
                <span>GitHub Pages</span>
              </a>
              <div class="preview-actions">
                <button
                  class="nav-btn"
                  onclick="validateHTML()"
                  title="Validovat"
                >
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" />
                    <polyline points="22 4 12 14.01 9 11.01" />
                  </svg>
                </button>
                <button
                  class="nav-btn"
                  onclick="minifyCode()"
                  title="Minifikovat"
                >
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="4 14 10 14 10 20" />
                    <polyline points="20 10 14 10 14 4" />
                    <line x1="14" y1="10" x2="21" y2="3" />
                    <line x1="3" y1="21" x2="10" y2="14" />
                  </svg>
                </button>
                <button class="nav-btn" onclick="refreshPreview()">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <polyline points="23 4 23 10 17 10" />
                    <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                  </svg>
                </button>
                <button class="nav-btn" onclick="openInNewTab()">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"
                    />
                    <polyline points="15 3 21 3 21 9" />
                    <line x1="10" y1="14" x2="21" y2="3" />
                  </svg>
                </button>
              </div>
            </div>
            <div class="preview-wrapper" id="previewWrapper">
              <iframe class="preview-frame" id="previewFrame"></iframe>
            </div>
          </div>
        </div>

        <!-- Console View -->
        <div class="view-panel" id="consoleView">
          <div class="console-container">
            <div class="console-header">
              <div class="console-title">
                <svg
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="4 17 10 11 4 5" />
                  <line x1="12" y1="19" x2="20" y2="19" />
                </svg>
                Konzole
                <span class="console-badge hidden" id="errorBadge">0</span>
                <span class="console-badge warn hidden" id="warnBadge">0</span>
              </div>
              <button class="nav-btn" onclick="clearConsole()">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <path d="M3 6h18" />
                  <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
                </svg>
              </button>
            </div>
            <div class="console-content" id="consoleContent">
              <div class="console-empty">Konzole je prázdná</div>
            </div>
            <div class="console-input-wrapper">
              <span class="console-prompt">&gt;</span>
              <input
                type="text"
                class="console-input"
                id="consoleInput"
                placeholder="JavaScript..."
                onkeydown="handleConsoleInput(event)"
              />
            </div>
          </div>
        </div>

        <!-- Tools View -->
        <div class="view-panel" id="toolsView">
          <div
            class="bottom-sheet-content"
            style="height: 100%; overflow: auto; padding: 16px"
          >
            <!-- Šablony & Snippety - rozbalovací -->
            <div class="collapse-header" onclick="toggleCollapse(this)">
              <div class="collapse-title">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <line x1="3" y1="9" x2="21" y2="9" />
                  <line x1="9" y1="21" x2="9" y2="9" />
                </svg>
                Šablony & Snippety
              </div>
              <svg
                class="collapse-arrow"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <polyline points="6 9 12 15 18 9" />
              </svg>
            </div>
            <div class="collapse-body">
              <div class="section-title" style="margin-top: 0">Šablony</div>
              <div class="template-list">
                <div class="template-item" onclick="loadTemplate('blank')">
                  <div class="template-name">Prázdná stránka</div>
                  <div class="template-desc">Základní HTML5 struktura</div>
                </div>
                <div class="template-item" onclick="loadTemplate('landing')">
                  <div class="template-name">Landing Page</div>
                  <div class="template-desc">Hero sekce + CTA</div>
                </div>
                <div class="template-item" onclick="loadTemplate('form')">
                  <div class="template-name">Formulář</div>
                  <div class="template-desc">Kontaktní formulář</div>
                </div>
                <div class="template-item" onclick="loadTemplate('grid')">
                  <div class="template-name">Grid Layout</div>
                  <div class="template-desc">CSS Grid galerie</div>
                </div>
                <div class="template-item" onclick="loadTemplate('dashboard')">
                  <div class="template-name">Dashboard</div>
                  <div class="template-desc">Admin rozhraní</div>
                </div>
              </div>

              <div class="section-title">Snippety</div>
              <div class="snippet-grid">
                <button class="snippet-btn" onclick="insertSnippet('div')">
                  &lt;div&gt;
                </button>
                <button class="snippet-btn" onclick="insertSnippet('flex')">
                  flexbox
                </button>
                <button class="snippet-btn" onclick="insertSnippet('grid')">
                  grid
                </button>
                <button class="snippet-btn" onclick="insertSnippet('btn')">
                  button
                </button>
                <button class="snippet-btn" onclick="insertSnippet('input')">
                  input
                </button>
                <button class="snippet-btn" onclick="insertSnippet('img')">
                  img
                </button>
                <button class="snippet-btn" onclick="insertSnippet('link')">
                  link
                </button>
                <button class="snippet-btn" onclick="insertSnippet('table')">
                  table
                </button>
              </div>
            </div>

            <!-- Otevřené soubory - sbalitelné -->
            <div class="files-section">
              <div class="collapse-header open" onclick="toggleCollapse(this)">
                <div class="collapse-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    />
                    <polyline points="14 2 14 8 20 8" />
                  </svg>
                  Otevřené soubory
                  <span class="files-count" id="filesCountMain"></span>
                </div>
                <svg
                  class="collapse-arrow"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </div>
              <div class="collapse-body open">
                <div class="files-list" id="filesListMain"></div>
              </div>
            </div>

            <!-- Historie -->
            <div class="section-title">Historie změn</div>
            <div class="history-list" id="historyList"></div>
          </div>
        </div>

        <!-- Tools Sidebar Panel -->
        <aside class="tools-panel" id="toolsPanel">
          <div class="tools-resize" id="toolsResize"></div>
          <div class="tools-inner">
            <div class="tools-header">
              <span class="tools-title">Panel</span>
              <button class="tools-close" onclick="toggleTools()">
                <svg
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <line x1="18" y1="6" x2="6" y2="18" />
                  <line x1="6" y1="6" x2="18" y2="18" />
                </svg>
              </button>
            </div>
            <div class="tools-content">
              <!-- Soubory - sbalitelné -->
              <div
                class="collapse-header open"
                onclick="toggleCollapse(this)"
                style="margin-top: 0"
              >
                <div class="collapse-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                    />
                    <polyline points="14 2 14 8 20 8" />
                  </svg>
                  Otevřené soubory
                  <span class="files-count" id="filesCount"></span>
                </div>
                <svg
                  class="collapse-arrow"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </div>
              <div class="collapse-body open">
                <div class="files-list" id="filesList"></div>
              </div>

              <!-- Akce - rozbalovací -->
              <div
                class="collapse-header"
                onclick="toggleCollapse(this)"
                style="margin-top: 12px"
              >
                <div class="collapse-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <circle cx="12" cy="12" r="10" />
                    <polygon points="10 8 16 12 10 16 10 8" />
                  </svg>
                  Akce
                </div>
                <svg
                  class="collapse-arrow"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </div>
              <div class="collapse-body">
                <div class="action-list margin-top-8">
                  <div class="action-item" onclick="addNewTab()">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                      />
                      <polyline points="14 2 14 8 20 8" />
                      <line x1="12" y1="18" x2="12" y2="12" />
                      <line x1="9" y1="15" x2="15" y2="15" />
                    </svg>
                    Nový soubor
                  </div>
                  <div class="action-item" onclick="saveToLocal()">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                      />
                      <polyline points="17 21 17 13 7 13 7 21" />
                      <polyline points="7 3 7 8 15 8" />
                    </svg>
                    Uložit
                  </div>
                  <div class="action-item" onclick="downloadFile()">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="7 10 12 15 17 10" />
                      <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Stáhnout
                  </div>
                  <div class="action-item" onclick="openImportModal()">
                    <svg
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                    >
                      <path
                        d="M21 12a9 9 0 0 1-9 9m9-9a9 9 0 0 0-9-9m9 9H3m9 9a9 9 0 0 1-9-9m9 9c-1.66 0-3-4.03-3-9s1.34-9 3-9m0 18c1.66 0 3-4.03 3-9s-1.34-9-3-9"
                      />
                    </svg>
                    Import z URL
                  </div>
                </div>
              </div>

              <!-- Prompty - rozbalovací -->
              <div
                class="collapse-header"
                onclick="toggleCollapse(this)"
                style="margin-top: 8px"
              >
                <div class="collapse-title">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
                    />
                  </svg>
                  Prompty
                </div>
                <svg
                  class="collapse-arrow"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </div>
              <div class="collapse-body">
                <div class="prompts-list" id="promptsList"></div>
                <button class="add-prompt-btn" onclick="openAddPromptModal()">
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <line x1="12" y1="5" x2="12" y2="19" />
                    <line x1="5" y1="12" x2="19" y2="12" />
                  </svg>
                  Přidat prompt
                </button>
              </div>

              <!-- GitHub - rozbalovací -->
              <div
                class="collapse-header"
                onclick="toggleCollapse(this)"
                style="margin-top: 8px"
              >
                <div class="collapse-title">
                  <svg viewBox="0 0 24 24" fill="currentColor">
                    <path
                      d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12z"
                    />
                  </svg>
                  GitHub
                </div>
                <svg
                  class="collapse-arrow"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polyline points="6 9 12 15 18 9" />
                </svg>
              </div>
              <div class="collapse-body">
                <div id="githubContent">
                  <div class="github-not-connected" id="githubNotConnected">
                    <p
                      style="
                        font-size: 11px;
                        color: var(--text-muted);
                        margin-bottom: 10px;
                      "
                    >
                      Připoj GitHub token v nastavení
                    </p>
                    <button class="add-prompt-btn" onclick="openSettings()">
                      <svg
                        viewBox="0 0 24 24"
                        fill="none"
                        stroke="currentColor"
                        stroke-width="2"
                      >
                        <circle cx="12" cy="12" r="3" />
                        <path
                          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                        />
                      </svg>
                      Nastavení
                    </button>
                  </div>
                  <div
                    class="github-connected"
                    id="githubConnected"
                    style="display: none"
                  >
                    <div class="github-user" id="githubUser"></div>
                    <div class="action-list margin-top-8">
                      <div class="action-item" onclick="openGithubBrowser()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path
                            d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"
                          />
                        </svg>
                        Procházet soubory
                      </div>
                      <div class="action-item" onclick="openRepoManager()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <circle cx="12" cy="12" r="10" />
                          <line x1="2" y1="12" x2="22" y2="12" />
                          <path
                            d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                          />
                        </svg>
                        Správa repozitářů
                      </div>
                      <div class="action-item" onclick="openGithubPages()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <circle cx="12" cy="12" r="10" />
                          <line x1="2" y1="12" x2="22" y2="12" />
                          <path
                            d="M12 2a9.96 9.96 0 0 1 4 8 9.96 9.96 0 0 1-4 8 9.96 9.96 0 0 1-4-8 9.96 9.96 0 0 1 4-8z"
                          />
                        </svg>
                        GitHub Pages
                      </div>
                      <div class="action-item" onclick="openCommitHistory()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <circle cx="12" cy="12" r="3" />
                          <line x1="12" y1="3" x2="12" y2="9" />
                          <line x1="12" y1="15" x2="12" y2="21" />
                        </svg>
                        Historie commitů
                      </div>
                      <div class="action-item" onclick="openDiffView()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <line x1="18" y1="6" x2="6" y2="18" />
                          <polyline points="6 6 6 18 18 18" />
                        </svg>
                        Porovnat změny
                      </div>
                      <div class="action-item" onclick="openGistManager()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path
                            d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"
                          />
                          <polyline points="14 2 14 8 20 8" />
                          <line x1="16" y1="13" x2="8" y2="13" />
                          <line x1="16" y1="17" x2="8" y2="17" />
                        </svg>
                        Gists
                      </div>
                      <div class="action-item" onclick="openForkModal()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <circle cx="12" cy="18" r="3" />
                          <circle cx="6" cy="6" r="3" />
                          <circle cx="18" cy="6" r="3" />
                          <path d="M18 9v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V9" />
                          <line x1="12" y1="12" x2="12" y2="15" />
                        </svg>
                        Fork cizího repo
                      </div>
                      <div class="action-item" onclick="saveToGithub()">
                        <svg
                          viewBox="0 0 24 24"
                          fill="none"
                          stroke="currentColor"
                          stroke-width="2"
                        >
                          <path
                            d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"
                          />
                          <polyline points="17 21 17 13 7 13 7 21" />
                          <polyline points="7 3 7 8 15 8" />
                        </svg>
                        Uložit na GitHub
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </aside>
        <!-- Autosave Indicator -->
        <div class="autosave-indicator" id="autosaveIndicator">
          💾 Automaticky uloženo
        </div>

        <!-- Drop Overlay -->
        <div class="drop-overlay" id="dropOverlay">
          <div class="drop-overlay-content">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
              <polyline points="17 8 12 3 7 8" />
              <line x1="12" y1="3" x2="12" y2="15" />
            </svg>
            <h3>Přetáhněte soubory sem</h3>
            <p>HTML, CSS, JS, TXT, JSON, MD</p>
          </div>
        </div>

        <!-- Autocomplete Popup -->
        <div class="autocomplete-popup" id="autocompletePopup"></div>
      </main>

      <!-- Bottom Navigation -->
      <nav class="bottom-nav">
        <button
          class="bottom-nav-item active"
          onclick="switchView('code')"
          data-view="code"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="16 18 22 12 16 6" />
            <polyline points="8 6 2 12 8 18" />
          </svg>
          Kód
        </button>
        <button
          class="bottom-nav-item"
          onclick="switchView('preview')"
          data-view="preview"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
            <line x1="8" y1="21" x2="16" y2="21" />
            <line x1="12" y1="17" x2="12" y2="21" />
          </svg>
          Náhled
        </button>
        <button
          class="bottom-nav-item"
          onclick="switchView('console')"
          data-view="console"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <polyline points="4 17 10 11 4 5" />
            <line x1="12" y1="19" x2="20" y2="19" />
          </svg>
          Konzole
        </button>
        <button
          class="bottom-nav-item"
          onclick="switchView('tools')"
          data-view="tools"
        >
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
            <line x1="3" y1="9" x2="21" y2="9" />
            <line x1="9" y1="21" x2="9" y2="9" />
          </svg>
          Nástroje
        </button>
      </nav>
    </div>

    <!-- CSS Grid/Flex Editor Modal -->
    <div class="modal-overlay" id="cssEditorModal">
      <div
        class="modal"
        style="max-width: 700px; max-height: 90vh; overflow: auto"
      >
        <div class="modal-title">🎨 CSS Grid/Flex Editor</div>
        <div class="css-editor-container">
          <div>
            <div class="css-control-group">
              <span class="css-control-label">Layout typ</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn active"
                  onclick="setCSSLayout('flex')"
                  id="cssLayoutFlex"
                >
                  Flexbox
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSLayout('grid')"
                  id="cssLayoutGrid"
                >
                  Grid
                </button>
              </div>
            </div>
            <div class="css-control-group" id="flexControls">
              <span class="css-control-label">flex-direction</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('flexDirection','row')"
                >
                  row
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('flexDirection','column')"
                >
                  column
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('flexDirection','row-reverse')"
                >
                  row-reverse
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('flexDirection','column-reverse')"
                >
                  col-reverse
                </button>
              </div>
              <span class="css-control-label">justify-content</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('justifyContent','flex-start')"
                >
                  start
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyContent','center')"
                >
                  center
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyContent','flex-end')"
                >
                  end
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyContent','space-between')"
                >
                  between
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyContent','space-around')"
                >
                  around
                </button>
              </div>
              <span class="css-control-label">align-items</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('alignItems','flex-start')"
                >
                  start
                </button>
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('alignItems','center')"
                >
                  center
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('alignItems','flex-end')"
                >
                  end
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('alignItems','stretch')"
                >
                  stretch
                </button>
              </div>
              <span class="css-control-label">flex-wrap</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('flexWrap','nowrap')"
                >
                  nowrap
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('flexWrap','wrap')"
                >
                  wrap
                </button>
              </div>
              <span class="css-control-label">gap</span>
              <div class="css-control-row">
                <button class="css-control-btn" onclick="setCSSProp('gap','0')">
                  0
                </button>
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('gap','8px')"
                >
                  8px
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gap','16px')"
                >
                  16px
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gap','24px')"
                >
                  24px
                </button>
              </div>
            </div>
            <div
              class="css-control-group"
              id="gridControls"
              style="display: none"
            >
              <span class="css-control-label">grid-template-columns</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gridTemplateColumns','1fr')"
                >
                  1 sloupec
                </button>
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('gridTemplateColumns','1fr 1fr')"
                >
                  2 sloupce
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gridTemplateColumns','1fr 1fr 1fr')"
                >
                  3 sloupce
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gridTemplateColumns','repeat(4, 1fr)')"
                >
                  4 sloupce
                </button>
              </div>
              <span class="css-control-label">gap</span>
              <div class="css-control-row">
                <button class="css-control-btn" onclick="setCSSProp('gap','0')">
                  0
                </button>
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('gap','8px')"
                >
                  8px
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gap','16px')"
                >
                  16px
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('gap','24px')"
                >
                  24px
                </button>
              </div>
              <span class="css-control-label">justify-items</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyItems','start')"
                >
                  start
                </button>
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('justifyItems','center')"
                >
                  center
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyItems','end')"
                >
                  end
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('justifyItems','stretch')"
                >
                  stretch
                </button>
              </div>
              <span class="css-control-label">align-items</span>
              <div class="css-control-row">
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('alignItems','start')"
                >
                  start
                </button>
                <button
                  class="css-control-btn active"
                  onclick="setCSSProp('alignItems','center')"
                >
                  center
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('alignItems','end')"
                >
                  end
                </button>
                <button
                  class="css-control-btn"
                  onclick="setCSSProp('alignItems','stretch')"
                >
                  stretch
                </button>
              </div>
            </div>
            <div class="css-control-group margin-top-12">
              <span class="css-control-label">Počet položek</span>
              <div class="css-control-row">
                <button class="css-control-btn" onclick="setCSSItems(3)">
                  3
                </button>
                <button class="css-control-btn active" onclick="setCSSItems(5)">
                  5
                </button>
                <button class="css-control-btn" onclick="setCSSItems(8)">
                  8
                </button>
                <button class="css-control-btn" onclick="setCSSItems(12)">
                  12
                </button>
              </div>
            </div>
          </div>
          <div class="css-editor-preview" id="cssEditorPreview">
            <div class="css-editor-item">1</div>
            <div class="css-editor-item">2</div>
            <div class="css-editor-item">3</div>
            <div class="css-editor-item">4</div>
            <div class="css-editor-item">5</div>
          </div>
        </div>
        <div
          style="
            padding: 0 16px 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin: 16px;
            overflow-x: auto;
          "
        >
          <pre
            id="cssEditorCode"
            style="margin: 0; padding: 12px 0; color: var(--accent)"
          ></pre>
        </div>
        <div class="modal-actions margin-top-16">
          <button class="modal-btn" onclick="closeCSSEditor()">Zavřít</button>
          <button class="modal-btn primary" onclick="insertCSSCode()">
            Vložit do kódu
          </button>
        </div>
      </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
      <div class="modal custom-maxwidth-500">
        <div class="modal-title">🔗 Sdílet projekt</div>
        <p
          style="
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
          "
        >
          Odkaz obsahuje celý kód zakódovaný v URL. Kdokoliv s odkazem může
          projekt otevřít.
        </p>
        <div class="share-url-container">
          <input
            type="text"
            class="share-url-input"
            id="shareUrlInput"
            readonly
          />
          <button class="share-copy-btn" onclick="copyShareUrl()">
            📋 Kopírovat
          </button>
        </div>
        <div
          style="font-size: 11px; color: var(--text-muted); margin-bottom: 16px"
          id="shareUrlSize"
        ></div>
        <div class="share-qr" id="shareQR"></div>
        <div class="modal-actions margin-top-16">
          <button class="modal-btn" onclick="closeShareModal()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Settings Bottom Sheet -->
    <div
      class="bottom-sheet-overlay"
      id="settingsSheet"
      onclick="closeSettings()"
    >
      <div class="bottom-sheet" onclick="event.stopPropagation()">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
          <div class="bottom-sheet-title">Nastavení</div>
          <button class="bottom-sheet-close" onclick="closeSettings()">
            <svg
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
            >
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>
        <div class="bottom-sheet-content">
          <div class="settings-section">
            <div class="settings-title">🤖 AI Asistent</div>
            <div
              class="settings-item"
              style="flex-direction: column; align-items: stretch; gap: 10px"
            >
              <span class="settings-label">Provider</span>
              <select
                class="settings-select"
                id="aiProvider"
                onchange="onProviderChange()"
                style="width: 100%"
              >
                <option value="gemini">⚡ Google Gemini</option>
                <option value="groq">🚀 Groq (nejrychlejší)</option>
                <option value="openrouter">🌐 OpenRouter</option>
                <option value="mistral">🔥 Mistral AI</option>
                <option value="cohere">🧠 Cohere</option>
                <option value="huggingface">🤗 Hugging Face</option>
              </select>
            </div>
            <div
              class="settings-item"
              style="flex-direction: column; align-items: stretch; gap: 10px"
            >
              <span class="settings-label">Model</span>
              <select
                class="settings-select"
                id="aiModel"
                onchange="saveAISettings()"
                style="width: 100%"
              ></select>
            </div>
            <div
              class="settings-item"
              style="flex-direction: column; align-items: stretch; gap: 10px"
            >
              <span class="settings-label">Vlastní API Klíč (volitelné)</span>
              <input
                type="password"
                class="modal-input"
                id="aiApiKey"
                placeholder="Použít demo klíč"
                style="margin: 0"
                onchange="saveAISettings()"
              />
              <div class="success-message">
                ✓ Demo klíče jsou zabudované - funguje hned!
              </div>
            </div>
            <div
              id="demoKeyWarning"
              style="
                display: none;
                font-size: 11px;
                color: var(--warning);
                padding: 8px;
                background: rgba(255, 169, 77, 0.1);
                border-radius: 8px;
                margin-top: 8px;
              "
            >
              ⚠️ Používáš demo klíč - má omezení. Pro plné využití si vytvoř
              vlastní.
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">🎨 Téma</div>
            <div class="theme-toggle">
              <span class="theme-toggle-label">Barevné schéma</span>
              <div class="theme-toggle-btns">
                <button
                  class="theme-btn active"
                  id="themeDark"
                  onclick="setTheme('dark')"
                >
                  🌙 Tmavé
                </button>
                <button
                  class="theme-btn"
                  id="themeLight"
                  onclick="setTheme('light')"
                >
                  ☀️ Světlé
                </button>
              </div>
            </div>
            <div class="settings-item">
              <span class="settings-label">Minimap</span>
              <label class="settings-toggle">
                <input
                  type="checkbox"
                  id="minimapToggle"
                  onchange="toggleMinimap()"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-item">
              <span class="settings-label">Syntax highlighting</span>
              <label class="settings-toggle">
                <input
                  type="checkbox"
                  id="syntaxToggle"
                  onchange="toggleSyntaxHighlight()"
                  checked
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">Editor</div>
            <div class="settings-item">
              <span class="settings-label">Velikost písma</span>
              <select
                class="settings-select"
                id="fontSizeSelect"
                onchange="changeFontSize(this.value)"
              >
                <option value="12">12px</option>
                <option value="14" selected>14px</option>
                <option value="16">16px</option>
                <option value="18">18px</option>
                <option value="20">20px</option>
              </select>
            </div>
            <div class="settings-item">
              <span class="settings-label">Zalamování řádků</span>
              <label class="settings-toggle">
                <input
                  type="checkbox"
                  id="wordWrapToggle"
                  onchange="toggleWordWrap(this.checked)"
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
            <div class="settings-item">
              <span class="settings-label">Automatické zavírání tagů</span>
              <label class="settings-toggle">
                <input
                  type="checkbox"
                  id="autoCloseToggle"
                  onchange="toggleAutoClose(this.checked)"
                  checked
                />
                <span class="toggle-slider"></span>
              </label>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">GitHub</div>
            <div
              class="settings-item"
              style="flex-direction: column; align-items: stretch; gap: 10px"
            >
              <span class="settings-label">Personal Access Token</span>
              <input
                type="password"
                class="modal-input"
                id="githubToken"
                placeholder="ghp_xxxxxxxxxxxx"
                style="margin: 0"
              />
              <button class="modal-btn primary" onclick="saveGithubToken()">
                Uložit token
              </button>

              <div class="github-help">
                <div
                  class="github-help-title"
                  onclick="this.parentElement.classList.toggle('open')"
                >
                  <span>📖 Jak získat token?</span>
                  <svg
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    style="width: 16px; height: 16px"
                  >
                    <polyline points="6 9 12 15 18 9" />
                  </svg>
                </div>
                <div class="github-help-content">
                  <ol>
                    <li>
                      Otevři
                      <a
                        href="https://github.com/settings/tokens"
                        target="_blank"
                        >github.com/settings/tokens</a
                      >
                    </li>
                    <li>
                      Klikni na <strong>"Generate new token"</strong> →
                      <strong>"Classic"</strong>
                    </li>
                    <li>Zadej název (např. "HTML Studio")</li>
                    <li>
                      Vyber expiraci (doporučeno 90 dní nebo "No expiration")
                    </li>
                    <li>
                      Zaškrtni oprávnění <strong>"repo"</strong> (celá sekce)
                    </li>
                    <li>Klikni <strong>"Generate token"</strong></li>
                    <li>Zkopíruj token (začíná <code>ghp_</code>)</li>
                    <li>Vlož ho sem a ulož</li>
                  </ol>
                  <div class="github-help-note">
                    ⚠️ Token se zobrazí jen jednou! Ulož si ho bezpečně.
                  </div>
                  <div class="github-help-note">
                    🔒 Token je uložen pouze v tomto prohlížeči (localStorage).
                  </div>
                </div>
              </div>
            </div>
            <div
              class="settings-item"
              id="githubDisconnectItem"
              style="display: none"
            >
              <span class="settings-label">Odpojit GitHub</span>
              <button
                class="modal-btn"
                onclick="disconnectGithub()"
                style="
                  background: var(--error);
                  border-color: var(--error);
                  color: white;
                "
              >
                Odpojit
              </button>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">Data</div>
            <div class="action-item" onclick="exportAllData()">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                <polyline points="17 8 12 3 7 8" />
                <line x1="12" y1="3" x2="12" y2="15" />
              </svg>
              Exportovat vše
            </div>
            <div
              class="action-item"
              onclick="clearAllData()"
              style="color: var(--error)"
            >
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                style="color: var(--error)"
              >
                <polyline points="3 6 5 6 21 6" />
                <path
                  d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                />
              </svg>
              Smazat všechna data
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <div class="modal-overlay" id="newTabModal">
      <div class="modal max-width-500">
        <div class="modal-title">Nový soubor</div>
        <input
          type="text"
          class="modal-input"
          id="newTabName"
          placeholder="nazev.html"
        />
        <div class="modal-actions margin-top-12">
          <button class="modal-btn" onclick="closeNewTabModal()">Zrušit</button>
          <button class="modal-btn primary" onclick="confirmNewTab()">
            Vytvořit
          </button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="saveModal">
      <div class="modal max-width-400">
        <div class="modal-title">Stáhnout soubor</div>
        <input
          type="text"
          class="modal-input"
          id="fileName"
          placeholder="index.html"
        />
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeSaveModal()">Zrušit</button>
          <button class="modal-btn primary" onclick="confirmDownload()">
            Stáhnout
          </button>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="importModal">
      <div class="modal">
        <div class="modal-title">Import z URL</div>
        <div class="modal-desc">Zadejte URL webové stránky</div>
        <input
          type="text"
          class="modal-input"
          id="importUrl"
          placeholder="https://example.com"
        />
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeImportModal()">Zrušit</button>
          <button class="modal-btn primary" onclick="importFromUrl()">
            Importovat
          </button>
        </div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- AI Overlay -->
    <div class="ai-overlay" id="aiOverlay" onclick="closeAIChat()"></div>

    <!-- AI Chat Panel -->
    <div class="ai-panel" id="aiPanel">
      <div class="ai-panel-header">
        <div class="ai-panel-title">🤖 AI Asistent</div>
        <button class="ai-panel-close" onclick="closeAIChat()">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
      <div class="ai-messages" id="aiMessages">
        <div class="ai-message system">
          Napiš co chceš vytvořit nebo upravit. AI vygeneruje HTML kód.
        </div>
      </div>
      <div class="ai-quick-actions">
        <button
          class="ai-quick-btn"
          onclick="aiQuickAction('Vytvoř landing page')"
        >
          🏠 Landing page
        </button>
        <button class="ai-quick-btn" onclick="aiQuickAction('Přidej navigaci')">
          📍 Navigace
        </button>
        <button class="ai-quick-btn" onclick="aiQuickAction('Přidej footer')">
          📋 Footer
        </button>
        <button class="ai-quick-btn" onclick="aiQuickAction('Vylepši design')">
          ✨ Vylepši
        </button>
        <button class="ai-quick-btn" onclick="aiQuickAction('Oprav chyby')">
          🔧 Oprav
        </button>
        <button class="ai-quick-btn" onclick="aiQuickAction('Přidej animace')">
          🎬 Animace
        </button>
      </div>
      <div class="ai-input-area">
        <textarea
          class="ai-input"
          id="aiInput"
          placeholder="Napiš co chceš..."
          rows="1"
          onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault();sendAIMessage();}"
        ></textarea>
        <button class="ai-send-btn" onclick="sendAIMessage()" id="aiSendBtn">
          <svg
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="22" y1="2" x2="11" y2="13" />
            <polygon points="22 2 15 22 11 13 2 9 22 2" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Components Modal -->
    <div class="modal-overlay" id="componentsModal">
      <div class="modal max-width-500">
        <div class="modal-title">🧱 Komponenty</div>
        <div class="modal-desc">
          Klikni pro vložení. AI přizpůsobí komponentu tvé stránce.
        </div>
        <div class="components-grid">
          <div class="component-card" onclick="insertComponent('header')">
            <div class="component-icon">📍</div>
            <div class="component-name">Header</div>
            <div class="component-desc">Navigace s logem</div>
          </div>
          <div class="component-card" onclick="insertComponent('hero')">
            <div class="component-icon">🦸</div>
            <div class="component-name">Hero sekce</div>
            <div class="component-desc">Hlavní banner</div>
          </div>
          <div class="component-card" onclick="insertComponent('features')">
            <div class="component-icon">⭐</div>
            <div class="component-name">Features</div>
            <div class="component-desc">3 sloupce výhod</div>
          </div>
          <div class="component-card" onclick="insertComponent('cards')">
            <div class="component-icon">🃏</div>
            <div class="component-name">Karty</div>
            <div class="component-desc">Grid produktů</div>
          </div>
          <div class="component-card" onclick="insertComponent('gallery')">
            <div class="component-icon">🖼️</div>
            <div class="component-name">Galerie</div>
            <div class="component-desc">Mřížka obrázků</div>
          </div>
          <div class="component-card" onclick="insertComponent('testimonials')">
            <div class="component-icon">💬</div>
            <div class="component-name">Reference</div>
            <div class="component-desc">Recenze zákazníků</div>
          </div>
          <div class="component-card" onclick="insertComponent('pricing')">
            <div class="component-icon">💰</div>
            <div class="component-name">Ceník</div>
            <div class="component-desc">Tabulka cen</div>
          </div>
          <div class="component-card" onclick="insertComponent('contact')">
            <div class="component-icon">📧</div>
            <div class="component-name">Kontakt</div>
            <div class="component-desc">Formulář</div>
          </div>
          <div class="component-card" onclick="insertComponent('cta')">
            <div class="component-icon">🎯</div>
            <div class="component-name">CTA</div>
            <div class="component-desc">Výzva k akci</div>
          </div>
          <div class="component-card" onclick="insertComponent('footer')">
            <div class="component-icon">📋</div>
            <div class="component-name">Footer</div>
            <div class="component-desc">Patička stránky</div>
          </div>
          <div class="component-card" onclick="insertComponent('faq')">
            <div class="component-icon">❓</div>
            <div class="component-name">FAQ</div>
            <div class="component-desc">Časté otázky</div>
          </div>
          <div class="component-card" onclick="insertComponent('stats')">
            <div class="component-icon">📊</div>
            <div class="component-name">Statistiky</div>
            <div class="component-desc">Čísla a fakta</div>
          </div>
        </div>
        <div class="modal-actions margin-top-16">
          <button class="modal-btn" onclick="closeComponentsPanel()">
            Zavřít
          </button>
        </div>
      </div>
    </div>

    <!-- Templates Modal -->
    <div class="modal-overlay" id="templatesModal">
      <div class="modal max-width-500">
        <div class="modal-title">📄 Hotové šablony</div>
        <div class="modal-desc">Kompletní stránky připravené k úpravě</div>
        <div class="templates-grid">
          <div class="template-card" onclick="loadTemplate('landing')">
            <div class="template-preview">🏠</div>
            <div class="template-info">
              <div class="template-name">Landing Page</div>
              <div class="template-desc">Produkt / Služba</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('portfolio')">
            <div class="template-preview">👤</div>
            <div class="template-info">
              <div class="template-name">Portfolio</div>
              <div class="template-desc">Osobní prezentace</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('restaurant')">
            <div class="template-preview">🍽️</div>
            <div class="template-info">
              <div class="template-name">Restaurace</div>
              <div class="template-desc">Jídelní lístek</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('business')">
            <div class="template-preview">🏢</div>
            <div class="template-info">
              <div class="template-name">Firma</div>
              <div class="template-desc">Firemní web</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('blog')">
            <div class="template-preview">📝</div>
            <div class="template-info">
              <div class="template-name">Blog</div>
              <div class="template-desc">Články a novinky</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('eshop')">
            <div class="template-preview">🛒</div>
            <div class="template-info">
              <div class="template-name">E-shop</div>
              <div class="template-desc">Produkty</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('event')">
            <div class="template-preview">🎉</div>
            <div class="template-info">
              <div class="template-name">Událost</div>
              <div class="template-desc">Svatba / Akce</div>
            </div>
          </div>
          <div class="template-card" onclick="loadTemplate('app')">
            <div class="template-preview">📱</div>
            <div class="template-info">
              <div class="template-name">Aplikace</div>
              <div class="template-desc">Prezentace appky</div>
            </div>
          </div>
        </div>
        <div class="modal-actions margin-top-16">
          <button class="modal-btn" onclick="closeTemplates()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Unsplash Modal -->
    <div class="modal-overlay" id="unsplashModal">
      <div class="modal max-width-500">
        <div class="modal-title">🖼️ Obrázky z Unsplash</div>
        <div class="flex-gap-8-mb-12">
            <input
              type="text"
              class="modal-input flex-1 no-margin"
              id="unsplashQuery"
              placeholder="Hledat obrázky..."
            />
            <button class="modal-btn primary" onclick="searchUnsplash()">
              Hledat
            </button>
          </div>
        </div>
        <div class="unsplash-grid" id="unsplashGrid">
          <div
            style="
              grid-column: 1/-1;
              text-align: center;
              color: var(--text-muted);
              padding: 20px;
            "
          >
            Zadej hledaný výraz (anglicky funguje lépe)
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeUnsplash()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Color Schemes Modal -->
    <div class="modal-overlay" id="colorSchemesModal">
      <div class="modal custom-maxwidth-400">
        <div class="modal-title">🎨 Barevné schéma</div>
        <div class="modal-desc">Změní barvy celé stránky</div>
        <div class="color-schemes">
          <div
            class="color-scheme"
            style="background: linear-gradient(135deg, #1a1a2e, #16213e)"
            onclick="applyColorScheme('dark')"
          >
            <div class="color-scheme-preview">
              <div class="color-dot bg-0f0f23"></div>
              <div class="color-dot bg-00d4aa"></div>
              <div class="color-dot" style="background: #ffffff"></div>
            </div>
            <div class="color-scheme-name">Tmavé</div>
          </div>
          <div
            class="color-scheme"
            style="background: linear-gradient(135deg, #f5f5f5, #e0e0e0)"
            onclick="applyColorScheme('light')"
          >
            <div class="color-scheme-preview">
              <div class="color-dot bg-white"></div>
              <div class="color-dot bg-2196f3"></div>
              <div class="color-dot bg-333333"></div>
            </div>
            <div class="color-scheme-name color-333">Světlé</div>
          </div>
          <div
            class="color-scheme bg-purple-gradient"
            onclick="applyColorScheme('purple')"
          >
            <div class="color-scheme-preview">
              <div class="color-dot bg-667eea"></div>
              <div class="color-dot bg-764ba2"></div>
              <div class="color-dot bg-white"></div>
            </div>
            <div class="color-scheme-name">Fialové</div>
          </div>
          <div
            class="color-scheme"
            style="background: linear-gradient(135deg, #11998e, #38ef7d)"
            onclick="applyColorScheme('green')"
          >
            <div class="color-scheme-preview">
              <div class="color-dot" style="background: #11998e"></div>
              <div class="color-dot" style="background: #38ef7d"></div>
              <div class="color-dot" style="background: #ffffff"></div>
            </div>
            <div class="color-scheme-name">Zelené</div>
          </div>
          <div
            class="color-scheme"
            style="background: linear-gradient(135deg, #ee0979, #ff6a00)"
            onclick="applyColorScheme('orange')"
          >
            <div class="color-scheme-preview">
              <div class="color-dot" style="background: #ee0979"></div>
              <div class="color-dot" style="background: #ff6a00"></div>
              <div class="color-dot" style="background: #ffffff"></div>
            </div>
            <div class="color-scheme-name">Oranžové</div>
          </div>
          <div
            class="color-scheme"
            style="background: linear-gradient(135deg, #2193b0, #6dd5ed)"
            onclick="applyColorScheme('blue')"
          >
            <div class="color-scheme-preview">
              <div class="color-dot" style="background: #2193b0"></div>
              <div class="color-dot" style="background: #6dd5ed"></div>
              <div class="color-dot" style="background: #ffffff"></div>
            </div>
            <div class="color-scheme-name">Modré</div>
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 16px">
          <button class="modal-btn" onclick="closeColorSchemes()">
            Zavřít
          </button>
        </div>
      </div>
    </div>

    <!-- SEO Modal -->
    <div class="modal-overlay" id="seoModal">
      <div class="modal" style="max-width: 450px">
        <div class="modal-title">🔍 SEO Kontrola</div>
        <div id="seoResults" style="max-height: 50vh; overflow-y: auto">
          <div class="github-loading">Analyzuji...</div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeSEO()">Zavřít</button>
          <button class="modal-btn primary" onclick="fixSEOWithAI()">
            🤖 Opravit pomocí AI
          </button>
        </div>
      </div>
    </div>

    <!-- Device Preview Modal -->
    <div class="modal-overlay" id="devicesModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-title">📱 Test na zařízeních</div>
        <div class="device-selector">
          <button
            class="device-btn active"
            onclick="setDevice('iphone14', 390, 844)"
          >
            📱 iPhone 14
          </button>
          <button class="device-btn" onclick="setDevice('iphone-se', 375, 667)">
            📱 iPhone SE
          </button>
          <button class="device-btn" onclick="setDevice('pixel', 412, 915)">
            📱 Pixel 7
          </button>
          <button class="device-btn" onclick="setDevice('samsung', 360, 800)">
            📱 Samsung
          </button>
          <button class="device-btn" onclick="setDevice('ipad', 768, 1024)">
            📱 iPad
          </button>
        </div>
        <div style="text-align: center; overflow: auto; max-height: 50vh">
          <div class="device-frame" id="deviceFrame" style="width: 390px">
            <iframe
              id="devicePreview"
              style="width: 100%; height: 500px; border: none"
            ></iframe>
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeDevices()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Publish Modal -->
    <div class="modal-overlay" id="publishModal">
      <div class="modal max-width-400">
        <div class="modal-title">🚀 Publikovat stránku</div>
        <div class="publish-status" id="publishStatus">
          <div class="publish-icon">🌐</div>
          <div style="font-size: 14px; margin-bottom: 8px">
            Publikuj na GitHub Pages
          </div>
          <div
            style="
              font-size: 12px;
              color: var(--text-muted);
              margin-bottom: 16px;
            "
          >
            Stránka bude dostupná na internetu zdarma
          </div>
        </div>
        <div style="margin-bottom: 12px">
          <label
            style="
              font-size: 12px;
              color: var(--text-muted);
              display: block;
              margin-bottom: 4px;
            "
            >Název repozitáře</label
          >
          <input
            type="text"
            class="modal-input"
            id="publishRepoName"
            placeholder="moje-stranka"
            style="margin: 0"
          />
        </div>
        <div id="publishResult" style="display: none"></div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closePublish()">Zavřít</button>
          <button class="modal-btn primary" onclick="publishToGitHub()">
            🚀 Publikovat
          </button>
        </div>
      </div>
    </div>

    <!-- Screenshot to HTML Modal -->
    <div class="modal-overlay" id="screenshotModal">
      <div class="modal" style="max-width: 450px">
        <div class="modal-title">📷 AI z obrázku</div>
        <div class="modal-desc">
          Nahraj screenshot stránky a AI vytvoří podobnou
        </div>
        <div
          class="image-upload-area"
          onclick="document.getElementById('screenshotInput').click()"
        >
          <div class="image-upload-icon">📤</div>
          <div class="image-upload-text">Klikni pro nahrání obrázku</div>
          <input
            type="file"
            id="screenshotInput"
            accept="image/*"
            style="display: none"
            onchange="handleScreenshot(this)"
          />
        </div>
        <img
          id="screenshotPreview"
          class="image-preview"
          style="display: none"
        />
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeScreenshot()">Zrušit</button>
          <button
            class="modal-btn primary"
            id="generateFromScreenshot"
            onclick="generateFromScreenshot()"
            style="display: none"
          >
            🤖 Vygenerovat
          </button>
        </div>
      </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
      <div class="context-menu-item" onclick="wrapWithTag('div')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
        </svg>
        Obalit &lt;div&gt;
      </div>
      <div class="context-menu-item" onclick="wrapWithTag('span')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
        Obalit &lt;span&gt;
      </div>
      <div class="context-menu-item" onclick="wrapWithTag('p')">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="3" y1="6" x2="21" y2="6" />
          <line x1="3" y1="12" x2="15" y2="12" />
          <line x1="3" y1="18" x2="18" y2="18" />
        </svg>
        Obalit &lt;p&gt;
      </div>
      <div class="context-menu-item" onclick="wrapWithCustomTag()">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <polyline points="16 18 22 12 16 6" />
          <polyline points="8 6 2 12 8 18" />
        </svg>
        Vlastní tag...
      </div>
      <div class="context-menu-divider"></div>
      <div class="context-menu-item" onclick="commentSelection()">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <path
            d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
          />
        </svg>
        Zakomentovat
      </div>
      <div class="context-menu-item" onclick="duplicateSelection()">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <rect x="9" y="9" width="13" height="13" rx="2" ry="2" />
          <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" />
        </svg>
        Duplikovat
      </div>
      <div class="context-menu-item" onclick="deleteSelection()">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          style="color: var(--error)"
        >
          <polyline points="3 6 5 6 21 6" />
          <path
            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
          />
        </svg>
        Smazat
      </div>
    </div>

    <!-- Add Prompt Modal -->
    <div class="modal-overlay" id="promptModal">
      <div class="modal">
        <div class="modal-title" id="promptModalTitle">Přidat prompt</div>
        <input
          type="text"
          class="modal-input"
          id="promptName"
          placeholder="Název promptu"
        />
        <textarea
          class="modal-input"
          id="promptText"
          placeholder="Text promptu..."
          style="
            min-height: 120px;
            resize: vertical;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
          "
        ></textarea>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closePromptModal()">Zrušit</button>
          <button class="modal-btn primary" onclick="savePrompt()">
            Uložit
          </button>
        </div>
      </div>
    </div>

    <!-- GitHub Browser Modal -->
    <div class="modal-overlay" id="githubBrowserModal">
      <div
        class="modal"
        style="
          max-width: 500px;
          max-height: 80vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div class="modal-title">GitHub</div>
        <div
          class="github-branch-bar"
          id="githubBranchBar"
          style="display: none"
        >
          <span style="font-size: 12px; color: var(--text-muted)">Větev:</span>
          <select
            class="settings-select"
            id="githubBranchSelect"
            onchange="switchBranch(this.value)"
            style="flex: 1; margin: 0"
          ></select>
          <button
            class="modal-btn"
            onclick="openNewBranchModal()"
            style="padding: 6px 10px; font-size: 11px"
          >
            + Nová
          </button>
        </div>
        <div class="github-path" id="githubPath"></div>
        <div class="github-browser" id="githubBrowser">
          <div class="github-loading">Načítám...</div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeGithubBrowser()">
            Zavřít
          </button>
        </div>
      </div>
    </div>

    <!-- Deploy Modal -->
    <div class="modal-overlay" id="deployModal">
      <div
        class="modal"
        style="max-width: 600px; max-height: 85vh; overflow: auto"
      >
        <div class="modal-title">🚀 Deploy projekt</div>
        <p
          style="
            font-size: 13px;
            color: var(--text-secondary);
            margin-bottom: 16px;
          "
        >
          Vyber platformu pro nasazení tvého projektu:
        </p>

        <div class="deploy-options">
          <div
            class="deploy-option"
            onclick="selectDeployPlatform('vercel')"
            id="deployVercel"
          >
            <div class="deploy-option-icon">▲</div>
            <div class="deploy-option-name">Vercel</div>
            <div class="deploy-option-desc">Nejlepší pro React, Next.js</div>
          </div>
          <div
            class="deploy-option"
            onclick="selectDeployPlatform('netlify')"
            id="deployNetlify"
          >
            <div class="deploy-option-icon">◆</div>
            <div class="deploy-option-name">Netlify</div>
            <div class="deploy-option-desc">Skvělé pro statické weby</div>
          </div>
          <div
            class="deploy-option"
            onclick="selectDeployPlatform('github')"
            id="deployGithub"
          >
            <div class="deploy-option-icon">🐙</div>
            <div class="deploy-option-name">GitHub Pages</div>
            <div class="deploy-option-desc">Zdarma, přímo z repo</div>
          </div>
          <div
            class="deploy-option"
            onclick="selectDeployPlatform('surge')"
            id="deploySurge"
          >
            <div class="deploy-option-icon">⚡</div>
            <div class="deploy-option-name">Surge.sh</div>
            <div class="deploy-option-desc">Rychlý CLI deploy</div>
          </div>
        </div>

        <div id="deployInstructions"></div>

        <div class="modal-actions">
          <button class="modal-btn" onclick="closeDeployModal()">Zavřít</button>
          <button class="modal-btn" onclick="openDomainModal()">
            🌐 Vlastní doména
          </button>
        </div>
      </div>
    </div>

    <!-- Domain Info Modal -->
    <div class="modal-overlay" id="domainModal">
      <div
        class="modal"
        style="max-width: 600px; max-height: 85vh; overflow: auto"
      >
        <div class="modal-title">🌐 Vlastní doména</div>

        <div class="domain-info-section">
          <div class="domain-info-title">📝 1. Kup doménu</div>
          <p
            style="
              font-size: 12px;
              color: var(--text-secondary);
              margin-bottom: 12px;
            "
          >
            Doménu si můžeš koupit u těchto registrátorů:
          </p>
          <div class="domain-provider">
            <span class="domain-provider-logo">🌍</span>
            <span class="domain-provider-name">Namecheap</span>
            <span class="domain-provider-price">od $8/rok</span>
          </div>
          <div class="domain-provider">
            <span class="domain-provider-logo">🔵</span>
            <span class="domain-provider-name">Cloudflare</span>
            <span class="domain-provider-price">bez marže</span>
          </div>
          <div class="domain-provider">
            <span class="domain-provider-logo">🟢</span>
            <span class="domain-provider-name">Google Domains</span>
            <span class="domain-provider-price">od $12/rok</span>
          </div>
          <div class="domain-provider">
            <span class="domain-provider-logo">🇨🇿</span>
            <span class="domain-provider-name">WEDOS (.cz)</span>
            <span class="domain-provider-price">od 150 Kč/rok</span>
          </div>
        </div>

        <div class="domain-info-section">
          <div class="domain-info-title">⚙️ 2. Nastav DNS</div>
          <p
            style="
              font-size: 12px;
              color: var(--text-secondary);
              margin-bottom: 12px;
            "
          >
            V DNS nastavení domény přidej tyto záznamy:
          </p>

          <div style="margin-bottom: 12px">
            <strong style="font-size: 12px">Pro Vercel:</strong>
            <div class="deploy-step-code">
              <span>A → 76.76.21.21</span>
              <button onclick="copyToClipboard('76.76.21.21')">📋</button>
            </div>
            <div class="deploy-step-code" style="margin-top: 4px">
              <span>CNAME www → cname.vercel-dns.com</span>
              <button onclick="copyToClipboard('cname.vercel-dns.com')">
                📋
              </button>
            </div>
          </div>

          <div style="margin-bottom: 12px">
            <strong style="font-size: 12px">Pro Netlify:</strong>
            <div class="deploy-step-code">
              <span>A → 75.2.60.5</span>
              <button onclick="copyToClipboard('75.2.60.5')">📋</button>
            </div>
            <div class="deploy-step-code" style="margin-top: 4px">
              <span>CNAME www → [tvuj-web].netlify.app</span>
            </div>
          </div>

          <div>
            <strong style="font-size: 12px">Pro GitHub Pages:</strong>
            <div class="deploy-step-code">
              <span>A → 185.199.108.153</span>
              <button onclick="copyToClipboard('185.199.108.153')">📋</button>
            </div>
            <div class="deploy-step-code" style="margin-top: 4px">
              <span>CNAME www → [user].github.io</span>
            </div>
          </div>
        </div>

        <div class="domain-info-section">
          <div class="domain-info-title">🔒 3. Aktivuj HTTPS</div>
          <p style="font-size: 12px; color: var(--text-secondary)">
            Vercel, Netlify i GitHub Pages automaticky poskytují
            <strong>bezplatný SSL certifikát</strong>. Po připojení domény se
            HTTPS aktivuje během několika minut.
          </p>
        </div>

        <div class="domain-info-section">
          <div class="domain-info-title">⏱️ 4. Počkej na propagaci</div>
          <p style="font-size: 12px; color: var(--text-secondary)">
            DNS změny se projeví do <strong>24-48 hodin</strong> (většinou
            rychleji). Můžeš zkontrolovat stav na
            <a
              href="https://dnschecker.org"
              target="_blank"
              style="color: var(--accent)"
              >dnschecker.org</a
            >
          </p>
        </div>

        <div class="modal-actions">
          <button class="modal-btn" onclick="closeDomainModal()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Clone URL Modal -->
    <div class="modal-overlay" id="cloneUrlModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-title">📋 Clone URL</div>
        <div class="clone-url-tabs">
          <button class="clone-url-tab active" onclick="setCloneType('https')">
            HTTPS
          </button>
          <button class="clone-url-tab" onclick="setCloneType('ssh')">
            SSH
          </button>
          <button class="clone-url-tab" onclick="setCloneType('cli')">
            GitHub CLI
          </button>
        </div>
        <div class="clone-url-container">
          <input
            type="text"
            class="clone-url-input"
            id="cloneUrlInput"
            readonly
          />
          <button class="modal-btn primary" onclick="copyCloneUrl()">📋</button>
        </div>
        <div
          style="font-size: 11px; color: var(--text-muted)"
          id="cloneUrlHelp"
        >
          Použij tento příkaz v terminálu pro klonování repozitáře
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeCloneUrlModal()">
            Zavřít
          </button>
        </div>
      </div>
    </div>

    <!-- README Preview Modal -->
    <div class="modal-overlay" id="readmeModal">
      <div
        class="modal"
        style="
          max-width: 700px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div class="modal-title">📖 README</div>
        <div class="github-readme-preview" id="readmeContent">
          <div class="github-loading">Načítám README...</div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeReadmeModal()">Zavřít</button>
          <button class="modal-btn primary" onclick="loadReadmeToEditor()">
            Otevřít v editoru
          </button>
        </div>
      </div>
    </div>

    <!-- Gitignore Modal -->
    <div class="modal-overlay" id="gitignoreModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-title">📝 Vytvořit .gitignore</div>
        <p
          style="
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
          "
        >
          Vyber šablonu nebo kombinuj více:
        </p>
        <div class="gitignore-templates" id="gitignoreTemplates">
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('node')"
            data-template="node"
          >
            Node.js
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('python')"
            data-template="python"
          >
            Python
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('java')"
            data-template="java"
          >
            Java
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('web')"
            data-template="web"
          >
            Web/HTML
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('macos')"
            data-template="macos"
          >
            macOS
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('windows')"
            data-template="windows"
          >
            Windows
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('linux')"
            data-template="linux"
          >
            Linux
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('vscode')"
            data-template="vscode"
          >
            VS Code
          </button>
          <button
            class="gitignore-template-btn"
            onclick="toggleGitignoreTemplate('jetbrains')"
            data-template="jetbrains"
          >
            JetBrains
          </button>
        </div>
        <div style="margin-top: 12px">
          <div
            style="
              font-size: 12px;
              color: var(--text-muted);
              margin-bottom: 6px;
            "
          >
            Náhled:
          </div>
          <textarea
            class="modal-input"
            id="gitignorePreview"
            style="
              height: 150px;
              font-family: 'JetBrains Mono', monospace;
              font-size: 11px;
            "
            readonly
          ></textarea>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeGitignoreModal()">
            Zrušit
          </button>
          <button class="modal-btn primary" onclick="createGitignoreFile()">
            Vytvořit soubor
          </button>
        </div>
      </div>
    </div>

    <!-- New Branch Modal -->
    <div class="modal-overlay" id="newBranchModal">
      <div class="modal">
        <div class="modal-title">🌿 Nová větev</div>
        <input
          type="text"
          class="modal-input"
          id="newBranchName"
          placeholder="Název větve (např. feature/novy-design)"
        />
        <div
          style="font-size: 12px; color: var(--text-muted); margin-bottom: 12px"
        >
          Nová větev bude vytvořena z aktuální větve:
          <strong id="newBranchFrom"></strong>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeNewBranchModal()">
            Zrušit
          </button>
          <button class="modal-btn primary" onclick="createNewBranch()">
            Vytvořit
          </button>
        </div>
      </div>
    </div>

    <!-- GitHub Commit Modal -->
    <div class="modal-overlay" id="githubCommitModal">
      <div class="modal">
        <div class="modal-title">Uložit na GitHub</div>
        <div id="githubPullStatus"></div>
        <div id="githubConflictWarning"></div>
        <div class="modal-desc" id="githubCommitInfo"></div>
        <input
          type="text"
          class="modal-input"
          id="githubCommitRepo"
          placeholder="Repozitář (user/repo)"
        />
        <input
          type="text"
          class="modal-input"
          id="githubCommitPath"
          placeholder="Cesta k souboru (např. index.html)"
        />
        <div
          style="
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
          "
        >
          <span
            style="
              font-size: 12px;
              color: var(--text-muted);
              white-space: nowrap;
            "
            >Větev:</span
          >
          <select
            class="settings-select"
            id="githubCommitBranch"
            style="flex: 1; margin: 0"
          >
            <option value="main">main</option>
          </select>
        </div>
        <input
          type="text"
          class="modal-input"
          id="githubCommitMessage"
          placeholder="Commit message"
        />
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeGithubCommit()">
            Zrušit
          </button>
          <button
            class="modal-btn"
            onclick="pullFromGithub()"
            id="githubPullBtn"
            style="display: none"
          >
            ⬇️ Pull
          </button>
          <button
            class="modal-btn primary"
            onclick="commitToGithub()"
            id="githubCommitBtn"
          >
            Uložit
          </button>
        </div>
      </div>
    </div>

    <!-- Repo Manager Modal -->
    <div class="modal-overlay" id="repoManagerModal">
      <div
        class="modal"
        style="
          max-width: 500px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
          "
        >
          <div class="modal-title" style="margin: 0">Správa repozitářů</div>
          <button
            class="modal-btn primary"
            onclick="openCreateRepoModal()"
            style="padding: 8px 12px; font-size: 12px"
          >
            + Nový repo
          </button>
        </div>
        <div class="repo-stats" id="repoStats"></div>
        <div class="repo-manager-list" id="repoManagerList">
          <div class="github-loading">Načítám...</div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeRepoManager()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Create Repo Modal -->
    <div class="modal-overlay" id="createRepoModal">
      <div class="modal">
        <div class="modal-title">Vytvořit repozitář</div>
        <input
          type="text"
          class="modal-input"
          id="newRepoName"
          placeholder="Název repozitáře"
        />
        <textarea
          class="modal-input"
          id="newRepoDesc"
          placeholder="Popis (volitelné)"
          style="min-height: 60px; resize: vertical"
        ></textarea>
        <div class="settings-item" style="margin-bottom: 12px; padding: 12px">
          <span class="settings-label">Soukromý repozitář</span>
          <label class="settings-toggle">
            <input type="checkbox" id="newRepoPrivate" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="settings-item" style="margin-bottom: 12px; padding: 12px">
          <span class="settings-label">Inicializovat s README</span>
          <label class="settings-toggle">
            <input type="checkbox" id="newRepoReadme" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeCreateRepoModal()">
            Zrušit
          </button>
          <button class="modal-btn primary" onclick="createNewRepo()">
            Vytvořit
          </button>
        </div>
      </div>
    </div>

    <!-- Delete Repo Modal -->
    <div class="modal-overlay" id="deleteRepoModal">
      <div class="modal">
        <div class="modal-title" style="color: var(--error)">
          ⚠️ Smazat repozitář
        </div>
        <div class="modal-desc">
          Tato akce je <strong>nevratná</strong>! Budou smazány všechny soubory,
          issues, wiki a nastavení.
        </div>
        <div
          style="
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 12px;
          "
        >
          <div
            style="
              font-size: 12px;
              color: var(--text-muted);
              margin-bottom: 4px;
            "
          >
            Repozitář ke smazání:
          </div>
          <div
            style="
              font-family: 'JetBrains Mono', monospace;
              color: var(--error);
            "
            id="deleteRepoName"
          ></div>
        </div>
        <div style="font-size: 13px; margin-bottom: 8px">
          Doplň poslední <strong>2 písmena</strong> názvu repozitáře:
        </div>
        <input
          type="text"
          class="modal-input"
          id="deleteRepoConfirm"
          placeholder=""
        />
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeDeleteRepoModal()">
            Zrušit
          </button>
          <button
            class="modal-btn"
            onclick="confirmDeleteRepo()"
            style="
              background: var(--error);
              border-color: var(--error);
              color: white;
            "
          >
            Smazat
          </button>
        </div>
      </div>
    </div>

    <!-- GitHub Pages Modal -->
    <div class="modal-overlay" id="githubPagesModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-title">🌐 GitHub Pages</div>
        <div style="margin-bottom: 12px">
          <label style="font-size: 13px; display: block; margin-bottom: 6px"
            >Repozitář:</label
          >
          <input
            type="text"
            class="modal-input"
            id="pagesRepo"
            placeholder="user/repo"
            style="margin: 0"
          />
        </div>
        <div id="pagesStatus" style="margin-bottom: 12px">
          <div class="github-loading">Vyber repozitář</div>
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeGithubPages()">Zavřít</button>
          <button class="modal-btn" onclick="checkPagesStatus()">
            Zkontrolovat
          </button>
        </div>
      </div>
    </div>

    <!-- Commit History Modal -->
    <div class="modal-overlay" id="commitHistoryModal">
      <div
        class="modal"
        style="
          max-width: 500px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div class="modal-title">📜 Historie commitů</div>
        <div style="margin-bottom: 12px">
          <input
            type="text"
            class="modal-input"
            id="historyRepo"
            placeholder="user/repo"
            style="margin: 0"
          />
        </div>
        <div
          class="commit-list"
          id="commitList"
          style="flex: 1; overflow-y: auto; max-height: 50vh"
        >
          <div class="github-loading">Zadej repozitář a stiskni Načíst</div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeCommitHistory()">
            Zavřít
          </button>
          <button class="modal-btn primary" onclick="loadCommitHistory()">
            Načíst
          </button>
        </div>
      </div>
    </div>

    <!-- Diff View Modal -->
    <div class="modal-overlay" id="diffViewModal">
      <div
        class="modal"
        style="
          max-width: 600px;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div class="modal-title">📊 Porovnat změny</div>
        <div id="diffInfo" style="margin-bottom: 12px"></div>
        <div
          class="diff-container"
          id="diffContainer"
          style="flex: 1; overflow-y: auto; max-height: 60vh"
        >
          <div class="github-empty">
            Není co porovnat. Otevři soubor z GitHubu.
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeDiffView()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Gist Manager Modal -->
    <div class="modal-overlay" id="gistManagerModal">
      <div
        class="modal"
        style="
          max-width: 500px;
          max-height: 85vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          style="
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
          "
        >
          <div class="modal-title" style="margin: 0">📝 Gists</div>
          <button
            class="modal-btn primary"
            onclick="openCreateGistModal()"
            style="padding: 8px 12px; font-size: 12px"
          >
            + Nový Gist
          </button>
        </div>
        <div
          class="gist-list"
          id="gistList"
          style="flex: 1; overflow-y: auto; max-height: 50vh"
        >
          <div class="github-loading">Načítám...</div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeGistManager()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Create Gist Modal -->
    <div class="modal-overlay" id="createGistModal">
      <div class="modal">
        <div class="modal-title">Vytvořit Gist</div>
        <input
          type="text"
          class="modal-input"
          id="gistFilename"
          placeholder="Název souboru (např. index.html)"
        />
        <input
          type="text"
          class="modal-input"
          id="gistDescription"
          placeholder="Popis (volitelné)"
        />
        <div class="settings-item" style="margin-bottom: 12px; padding: 12px">
          <span class="settings-label">Veřejný Gist</span>
          <label class="settings-toggle">
            <input type="checkbox" id="gistPublic" checked />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div
          style="font-size: 11px; color: var(--text-muted); margin-bottom: 12px"
        >
          Aktuální soubor bude nahrán jako Gist.
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeCreateGistModal()">
            Zrušit
          </button>
          <button class="modal-btn primary" onclick="createGist()">
            Vytvořit
          </button>
        </div>
      </div>
    </div>

    <!-- Repo Settings Modal -->
    <div class="modal-overlay" id="repoSettingsModal">
      <div class="modal">
        <div class="modal-title">⚙️ Nastavení repozitáře</div>
        <input type="hidden" id="repoSettingsFullName" />
        <div style="margin-bottom: 12px">
          <label
            style="
              font-size: 12px;
              color: var(--text-muted);
              display: block;
              margin-bottom: 4px;
            "
            >Název</label
          >
          <input
            type="text"
            class="modal-input"
            id="repoSettingsName"
            placeholder="Název repozitáře"
            style="margin: 0"
          />
        </div>
        <div style="margin-bottom: 12px">
          <label
            style="
              font-size: 12px;
              color: var(--text-muted);
              display: block;
              margin-bottom: 4px;
            "
            >Popis</label
          >
          <textarea
            class="modal-input"
            id="repoSettingsDesc"
            placeholder="Popis (volitelné)"
            style="min-height: 60px; resize: vertical; margin: 0"
          ></textarea>
        </div>
        <div class="settings-item" style="margin-bottom: 12px; padding: 12px">
          <span class="settings-label">Soukromý repozitář</span>
          <label class="settings-toggle">
            <input type="checkbox" id="repoSettingsPrivate" />
            <span class="toggle-slider"></span>
          </label>
        </div>
        <div style="margin-bottom: 12px">
          <label
            style="
              font-size: 12px;
              color: var(--text-muted);
              display: block;
              margin-bottom: 4px;
            "
            >Topics (oddělené čárkou)</label
          >
          <input
            type="text"
            class="modal-input"
            id="repoSettingsTopics"
            placeholder="html, css, javascript"
            style="margin: 0"
          />
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeRepoSettings()">
            Zrušit
          </button>
          <button class="modal-btn primary" onclick="saveRepoSettings()">
            Uložit
          </button>
        </div>
      </div>
    </div>

    <!-- Fork Modal -->
    <div class="modal-overlay" id="forkModal">
      <div class="modal">
        <div class="modal-title">🍴 Fork repozitáře</div>
        <div style="margin-bottom: 12px">
          <label
            style="
              font-size: 12px;
              color: var(--text-muted);
              display: block;
              margin-bottom: 4px;
            "
            >Repozitář (owner/repo)</label
          >
          <input
            type="text"
            class="modal-input"
            id="forkRepoName"
            placeholder="např. facebook/react"
            style="margin: 0"
          />
        </div>
        <div
          style="
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg-tertiary);
            border-radius: 8px;
          "
        >
          Fork vytvoří kopii cizího repozitáře do tvého účtu. Můžeš pak
          upravovat kód a případně vytvořit Pull Request.
        </div>
        <div class="modal-actions">
          <button class="modal-btn" onclick="closeForkModal()">Zrušit</button>
          <button class="modal-btn primary" onclick="forkRepo()">
            Forknout
          </button>
        </div>
      </div>
    </div>

    <!-- Loading Modal -->
    <div class="modal-overlay" id="loadingModal" style="z-index: 1001">
      <div class="modal" style="max-width: 400px; text-align: center">
        <div class="modal-title" id="loadingTitle">📥 Načítám...</div>
        <div class="loading-progress">
          <div class="loading-bar">
            <div class="loading-bar-fill" id="loadingBarFill"></div>
          </div>
          <div class="loading-status" id="loadingStatus">Připravuji...</div>
          <div class="loading-details" id="loadingDetails"></div>
        </div>
        <div class="modal-actions" style="margin-top: 16px">
          <button
            class="modal-btn"
            onclick="cancelLoading()"
            style="background: var(--error)"
          >
            ✕ Zrušit
          </button>
        </div>
      </div>
    </div>

    <!-- Validation Modal -->
    <div class="modal-overlay" id="validationModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-title">✓ Validace HTML</div>
        <div class="validation-list" id="validationList">
          <div class="github-loading">Validuji...</div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeValidation()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Shortcuts Modal -->
    <div class="modal-overlay" id="shortcutsModal">
      <div class="modal" style="max-width: 500px">
        <div class="modal-title">⚡ Rychlé akce</div>
        <div class="shortcuts-grid" id="shortcutsList">
          <div class="shortcut-item clickable" onclick="runShortcut('save')">
            <span>💾 Uložit</span>
            <span class="shortcut-key">Ctrl+S</span>
          </div>
          <div
            class="shortcut-item clickable"
            onclick="runShortcut('download')"
          >
            <span>⬇️ Stáhnout</span>
            <span class="shortcut-key">Ctrl+⇧+S</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('newFile')">
            <span>📄 Nový soubor</span>
            <span class="shortcut-key">Ctrl+N</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('search')">
            <span>🔍 Hledat</span>
            <span class="shortcut-key">Ctrl+F</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('format')">
            <span>📝 Formátovat</span>
            <span class="shortcut-key">Ctrl+⇧+F</span>
          </div>
          <div
            class="shortcut-item clickable"
            onclick="runShortcut('validate')"
          >
            <span>✓ Validovat</span>
            <span class="shortcut-key">Ctrl+⇧+V</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('minify')">
            <span>📦 Minifikovat</span>
            <span class="shortcut-key">Ctrl+⇧+M</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('preview')">
            <span>👁️ Náhled</span>
            <span class="shortcut-key">Ctrl+P</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('console')">
            <span>🖥️ Konzole</span>
            <span class="shortcut-key">Ctrl+`</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('undo')">
            <span>↩️ Zpět</span>
            <span class="shortcut-key">Ctrl+Z</span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('redo')">
            <span>↪️ Vpřed</span>
            <span class="shortcut-key">Ctrl+Y</span>
          </div>
          <div
            class="shortcut-item clickable"
            onclick="runShortcut('closeTab')"
          >
            <span>✖️ Zavřít tab</span>
            <span class="shortcut-key">Ctrl+W</span>
          </div>
          <div
            class="shortcut-item clickable"
            onclick="runShortcut('colorScheme')"
          >
            <span>🎨 Barevné schéma</span>
            <span class="shortcut-key"></span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('publish')">
            <span>🚀 Publikovat</span>
            <span class="shortcut-key"></span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('seo')">
            <span>🔍 SEO kontrola</span>
            <span class="shortcut-key"></span>
          </div>
          <div class="shortcut-item clickable" onclick="runShortcut('devices')">
            <span>📱 Test zařízení</span>
            <span class="shortcut-key"></span>
          </div>
          <div
            class="shortcut-item clickable"
            onclick="runShortcut('screenshot')"
          >
            <span>📷 AI ze screenu</span>
            <span class="shortcut-key"></span>
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeShortcuts()">Zavřít</button>
        </div>
      </div>
    </div>

    <!-- Live Server Modal -->
    <div class="modal-overlay" id="liveServerModal">
      <div class="modal" style="max-width: 400px">
        <div class="modal-title">🌐 Živý server</div>
        <div class="server-status" id="serverStatus">
          <div class="server-status-icon offline">📡</div>
          <div style="font-size: 14px; font-weight: 500; margin-bottom: 4px">
            Server vypnutý
          </div>
          <div style="font-size: 12px; color: var(--text-muted)">
            Spusť server pro sdílení náhledu
          </div>
        </div>
        <div id="serverInfo" style="display: none">
          <div class="server-url" id="serverUrl"></div>
          <div style="text-align: center">
            <div class="server-qr" id="serverQR"></div>
          </div>
          <div
            style="
              font-size: 11px;
              color: var(--text-muted);
              text-align: center;
            "
          >
            Naskenuj QR kód nebo otevři URL na jiném zařízení
          </div>
        </div>
        <div class="modal-actions" style="margin-top: 12px">
          <button class="modal-btn" onclick="closeLiveServer()">Zavřít</button>
          <button
            class="modal-btn primary"
            id="serverToggleBtn"
            onclick="toggleLiveServer()"
          >
            Spustit server
          </button>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // AI MODULE v1.0 - Gemini, Groq, OpenRouter, Mistral, Cohere, HuggingFace
      // Dokumentace: viz ai-module.js
      // ============================================

      const AI = {
        // ============== DEMO KLÍČE (rozdělené pro GitHub) ==============
        DEMO_KEYS: {
          gemini: "AIzaSyCXuMvhO_senLS" + "oA_idEuBk_EwnMmIPIhg",
          groq: "gsk_0uZbn9KqiBa3Zsl11ACX" + "WGdyb3FYZddvc6oPIn9HTvJpGgoBbYrJ",
          openrouter:
            "sk-or-v1-bff66ee4a0845f88" +
            "428b75d91a35aea63e355a52dc31e6427fcc1f9536c2a8a3",
          mistral: "Tvwm0qcQk71vsUDw" + "VfAAAY5GPKdbvlHj",
          cohere: "PeJo8cQwftoZI1Dob0qK" + "1lN445FlOjrfFA3piEuh",
          huggingface: "hf_UhezIpnumnYWSacKLtja" + "VPfXMxbFemUyMv",
        },

        // ============== KONFIGURACE ==============
        config: {
          keys: {
            gemini: "",
            groq: "",
            openrouter: "",
            mistral: "",
            cohere: "",
            huggingface: "",
          },

          models: {
            gemini: "gemini-2.5-flash-lite",
            groq: "llama-3.3-70b-versatile",
            openrouter: "mistralai/mistral-small-3.1-24b-instruct:free",
            mistral: "mistral-small-latest",
            cohere: "command-a-03-2025",
            huggingface: "mistralai/Mistral-7B-Instruct-v0.3",
          },

          defaultProvider: "gemini",
          timeout: 90000,
          maxRetries: 3,
        },

        // ============== VŠECHNY MODELY ==============
        ALL_MODELS: {
          gemini: [
            {
              value: "gemini-2.5-flash-lite",
              name: "⚡ Gemini 2.5 Flash-Lite",
              rpm: 15,
            },
            { value: "gemini-2.5-flash", name: "⚡ Gemini 2.5 Flash", rpm: 10 },
          ],
          groq: [
            {
              value: "openai/gpt-oss-120b",
              name: "🧠 GPT OSS 120B (~500 tok/s)",
              rpm: 30,
            },
            {
              value: "llama-3.3-70b-versatile",
              name: "💬 Llama 3.3 70B (chat)",
              rpm: 30,
            },
            {
              value: "openai/gpt-oss-20b",
              name: "⚡ GPT OSS 20B (~1000 tok/s)",
              rpm: 30,
            },
            {
              value: "llama-3.1-8b-instant",
              name: "⚡ Llama 3.1 8B (nejrychlejší)",
              rpm: 30,
            },
            {
              value: "meta-llama/llama-4-scout-17b-16e-instruct",
              name: "👁️ Llama 4 Scout (Vision)",
              rpm: 30,
            },
            {
              value: "meta-llama/llama-4-maverick-17b-128e-instruct",
              name: "👁️ Llama 4 Maverick (Vision)",
              rpm: 30,
            },
          ],
          openrouter: [
            {
              value: "mistralai/mistral-small-3.1-24b-instruct:free",
              name: "🔥 Mistral Small 3.1 :free",
              rpm: 20,
            },
          ],
          mistral: [
            {
              value: "codestral-latest",
              name: "💻 Codestral (kódování)",
              rpm: 30,
            },
            {
              value: "mistral-small-latest",
              name: "⚡ Mistral Small (rychlý)",
              rpm: 30,
            },
          ],
          cohere: [
            {
              value: "command-a-03-2025",
              name: "🧠 Command A (nejnovější)",
              rpm: 20,
            },
            {
              value: "command-r-plus-08-2024",
              name: "💬 Command R+ (chat)",
              rpm: 20,
            },
            {
              value: "command-r-08-2024",
              name: "⚡ Command R (rychlý)",
              rpm: 20,
            },
          ],
          huggingface: [
            {
              value: "mistralai/Mistral-7B-Instruct-v0.3",
              name: "🔥 Mistral 7B",
              rpm: 10,
            },
            {
              value: "microsoft/Phi-3-mini-4k-instruct",
              name: "🔬 Phi-3 Mini",
              rpm: 10,
            },
            { value: "google/gemma-2-2b-it", name: "🤖 Gemma 2 2B", rpm: 10 },
            {
              value: "HuggingFaceH4/zephyr-7b-beta",
              name: "💨 Zephyr 7B",
              rpm: 10,
            },
            {
              value: "tiiuae/falcon-7b-instruct",
              name: "🦅 Falcon 7B",
              rpm: 10,
            },
          ],
        },

        // Modely s podporou vision (Groq)
        VISION_MODELS: [
          "meta-llama/llama-4-maverick-17b-128e-instruct",
          "meta-llama/llama-4-scout-17b-16e-instruct",
        ],

        // ============== HELPER FUNKCE ==============

        async fetchWithTimeout(url, options, timeoutMs) {
          const timeout = timeoutMs || this.config.timeout || 30000;

          // Použít Promise.race místo AbortController (kompatibilita)
          const fetchPromise = fetch(url, options);

          const timeoutPromise = new Promise((_, reject) => {
            setTimeout(
              () =>
                reject(new Error("Timeout - požadavek trval příliš dlouho")),
              timeout
            );
          });

          return Promise.race([fetchPromise, timeoutPromise]);
        },

        // Retry s exponenciálním backoff
        async retryWithBackoff(apiCall, maxRetries = null) {
          const retries = maxRetries || this.config.maxRetries;

          for (let attempt = 0; attempt < retries; attempt++) {
            try {
              return await apiCall();
            } catch (err) {
              const isRateLimit =
                err.message?.includes("429") ||
                err.message?.includes("quota") ||
                err.message?.includes("RESOURCE_EXHAUSTED");

              if (isRateLimit && attempt < retries - 1) {
                const retryMatch = err.message?.match(/retry in ([\d.]+)s/i);
                let delayMs;

                if (retryMatch) {
                  delayMs = Math.ceil(parseFloat(retryMatch[1]) * 1000);
                } else {
                  delayMs = Math.pow(2, attempt + 1) * 1000;
                }

                console.log(`⏳ Rate limit, čekám ${delayMs / 1000}s...`);
                await new Promise((resolve) => setTimeout(resolve, delayMs));
                continue;
              }

              throw err;
            }
          }
        },

        // Parsování AI odpovědi (JSON cleaning)
        parseResponse(aiResponseText) {
          try {
            let cleanedJson = aiResponseText
              .replace(/```json\s*/gi, "")
              .replace(/```\s*/g, "");

            const firstBrace = cleanedJson.indexOf("{");
            const lastBrace = cleanedJson.lastIndexOf("}");

            if (
              firstBrace !== -1 &&
              lastBrace !== -1 &&
              lastBrace > firstBrace
            ) {
              cleanedJson = cleanedJson.substring(firstBrace, lastBrace + 1);
            }

            const openBraces = (cleanedJson.match(/\{/g) || []).length;
            const closeBraces = (cleanedJson.match(/\}/g) || []).length;
            const openBrackets = (cleanedJson.match(/\[/g) || []).length;
            const closeBrackets = (cleanedJson.match(/\]/g) || []).length;

            if (openBrackets > closeBrackets) {
              cleanedJson += "]".repeat(openBrackets - closeBrackets);
            }
            if (openBraces > closeBraces) {
              cleanedJson += "}".repeat(openBraces - closeBraces);
            }

            cleanedJson = cleanedJson.replace(/(\d+\.\d{6})\d{4,}/g, "$1");
            cleanedJson = cleanedJson.replace(/,\s*([}\]])/g, "$1");

            return JSON.parse(cleanedJson);
          } catch (e) {
            console.error("❌ Parse error:", e.message);
            return null;
          }
        },

        // ============== NASTAVENÍ ==============

        getKey(provider) {
          const customKey = this.config.keys[provider];
          if (customKey && customKey.length > 10) {
            return customKey;
          }

          const demoKey = this.DEMO_KEYS[provider];
          if (demoKey && demoKey.length > 10) {
            return demoKey;
          }

          return null;
        },

        isUsingDemoKey(provider) {
          const customKey = this.config.keys[provider];
          return !(customKey && customKey.length > 10);
        },

        setKey(provider, key) {
          if (this.config.keys.hasOwnProperty(provider)) {
            this.config.keys[provider] = key;
            return true;
          }
          return false;
        },

        setModel(provider, model) {
          if (this.config.models.hasOwnProperty(provider)) {
            this.config.models[provider] = model;
            return true;
          }
          return false;
        },

        setDefaultProvider(provider) {
          if (this.config.keys.hasOwnProperty(provider)) {
            this.config.defaultProvider = provider;
            return true;
          }
          return false;
        },

        getAvailableProviders() {
          return [
            "gemini",
            "groq",
            "openrouter",
            "mistral",
            "cohere",
            "huggingface",
          ].filter((provider) => this.getKey(provider) !== null);
        },

        // ============== GEMINI ==============

        async askGemini(prompt, options = {}) {
          const key = options.key || this.getKey("gemini");
          if (!key) throw new Error("Gemini API klíč není nastaven");

          const model = options.model || this.config.models.gemini;
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;

          const body = {
            contents: [
              {
                parts: [{ text: prompt }],
              },
            ],
            generationConfig: {
              temperature: options.temperature ?? 0.7,
              maxOutputTokens: options.maxTokens ?? 4096,
            },
          };

          if (options.system) {
            body.systemInstruction = {
              parts: [{ text: options.system }],
            };
          }

          const response = await this.retryWithBackoff(async () => {
            const resp = await this.fetchWithTimeout(url, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(body),
            });

            if (!resp.ok) {
              const error = await resp.json().catch(() => ({}));
              throw new Error(error.error?.message || `HTTP ${resp.status}`);
            }

            return resp.json();
          });

          const text =
            response.candidates?.[0]?.content?.parts?.[0]?.text || "";

          if (options.parseJson) {
            return this.parseResponse(text);
          }

          return text;
        },

        // ============== GROQ ==============

        async askGroq(prompt, options = {}) {
          const key = options.key || this.getKey("groq");
          if (!key) throw new Error("Groq API klíč není nastaven");

          const model = options.model || this.config.models.groq;
          const url = "https://api.groq.com/openai/v1/chat/completions";

          let messages = [];

          if (options.system) {
            messages.push({ role: "system", content: options.system });
          }

          const isVisionModel = this.VISION_MODELS.includes(model);
          const hasImage = options.imageBase64 && options.imageMimeType;

          if (isVisionModel && hasImage) {
            messages.push({
              role: "user",
              content: [
                { type: "text", text: prompt },
                {
                  type: "image_url",
                  image_url: {
                    url: `data:${options.imageMimeType};base64,${options.imageBase64}`,
                  },
                },
              ],
            });
          } else {
            messages.push({ role: "user", content: prompt });
          }

          const response = await this.fetchWithTimeout(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              temperature: options.temperature ?? 0.7,
              max_tokens: options.maxTokens ?? 4096,
            }),
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error?.message || `HTTP ${response.status}`);
          }

          const data = await response.json();
          let text = data.choices?.[0]?.message?.content || "";

          if (!text && data.choices?.[0]?.message?.reasoning) {
            text = data.choices[0].message.reasoning;
          }

          if (options.parseJson) {
            return this.parseResponse(text);
          }

          return text;
        },

        // ============== OPENROUTER ==============

        async askOpenRouter(prompt, options = {}) {
          const key = options.key || this.getKey("openrouter");
          if (!key) throw new Error("OpenRouter API klíč není nastaven");

          const model = options.model || this.config.models.openrouter;
          const url = "https://openrouter.ai/api/v1/chat/completions";

          console.info("🌐 OpenRouter request:", model);

          const messages = [];

          if (options.system) {
            messages.push({ role: "system", content: options.system });
          }
          messages.push({ role: "user", content: prompt });

          const response = await this.fetchWithTimeout(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${key}`,
              "Content-Type": "application/json",
              "HTTP-Referer": window.location.href,
              "X-Title": "AI Module Test",
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              temperature: options.temperature ?? 0.7,
              max_tokens: options.maxTokens ?? 1024,
            }),
          });

          const data = await response.json().catch(() => ({}));

          console.info("🌐 OpenRouter response:", response.status, data);

          if (!response.ok) {
            // Detailní error handling
            const errMsg =
              data.error?.message ||
              data.error?.code ||
              JSON.stringify(data.error) ||
              `HTTP ${response.status}`;
            console.error("🌐 OpenRouter error:", errMsg);
            throw new Error(errMsg);
          }

          const text = data.choices?.[0]?.message?.content || "";

          if (options.parseJson) {
            return this.parseResponse(text);
          }

          return text;
        },

        // ============== MISTRAL ==============

        async askMistral(prompt, options = {}) {
          const key = options.key || this.getKey("mistral");
          if (!key) throw new Error("Mistral API klíč není nastaven");

          const model = options.model || this.config.models.mistral;
          const url = "https://api.mistral.ai/v1/chat/completions";

          const messages = [];

          if (options.system) {
            messages.push({ role: "system", content: options.system });
          }
          messages.push({ role: "user", content: prompt });

          const response = await this.fetchWithTimeout(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              temperature: options.temperature ?? 0.7,
              max_tokens: options.maxTokens ?? 4096,
            }),
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error?.message || `HTTP ${response.status}`);
          }

          const data = await response.json();
          const text = data.choices?.[0]?.message?.content || "";

          if (options.parseJson) {
            return this.parseResponse(text);
          }

          return text;
        },

        // ============== COHERE ==============

        async askCohere(prompt, options = {}) {
          const key = options.key || this.getKey("cohere");
          if (!key) throw new Error("Cohere API klíč není nastaven");

          const model =
            options.model ||
            this.config.models.cohere ||
            "command-r-plus-08-2024";
          const url = "https://api.cohere.com/v2/chat";

          const messages = [];

          if (options.system) {
            messages.push({ role: "system", content: options.system });
          }
          messages.push({ role: "user", content: prompt });

          const response = await this.fetchWithTimeout(url, {
            method: "POST",
            headers: {
              Authorization: `Bearer ${key}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              model: model,
              messages: messages,
              temperature: options.temperature ?? 0.7,
              max_tokens: options.maxTokens ?? 4096,
            }),
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.message || `HTTP ${response.status}`);
          }

          const data = await response.json();
          const text = data.message?.content?.[0]?.text || "";

          if (options.parseJson) {
            return this.parseResponse(text);
          }

          return text;
        },

        // ============== HUGGING FACE ==============

        // CORS proxy pro HuggingFace (nutné pro file://)
        CORS_PROXIES: [
          "https://corsproxy.io/?url=",
          "https://api.codetabs.com/v1/proxy?quest=",
        ],

        async askHuggingFace(prompt, options = {}) {
          const key = options.key || this.getKey("huggingface");
          if (!key) throw new Error("HuggingFace API klíč není nastaven");

          const model =
            options.model ||
            this.config.models.huggingface ||
            "mistralai/Mistral-7B-Instruct-v0.3";
          const originalUrl = `https://api-inference.huggingface.co/models/${model}/v1/chat/completions`;

          const messages = [];

          if (options.system) {
            messages.push({ role: "system", content: options.system });
          }
          messages.push({ role: "user", content: prompt });

          const body = JSON.stringify({
            model: model,
            messages: messages,
            temperature: options.temperature ?? 0.7,
            max_tokens: options.maxTokens ?? 1024,
            stream: false,
          });

          const headers = {
            Authorization: `Bearer ${key}`,
            "Content-Type": "application/json",
          };

          // Detekce jestli jsme na file:// nebo localhost
          const isLocalFile = window.location.protocol === "file:";

          if (!isLocalFile) {
            // Přímý request pokud jsme na HTTP/HTTPS
            return this.doHuggingFaceRequest(
              originalUrl,
              headers,
              body,
              options
            );
          }

          // Pro file:// zkusit CORS proxy
          for (const proxyBase of this.CORS_PROXIES) {
            try {
              const proxyUrl = proxyBase + encodeURIComponent(originalUrl);
              return await this.doHuggingFaceRequest(
                proxyUrl,
                headers,
                body,
                options
              );
            } catch (e) {
              console.warn(`CORS proxy ${proxyBase} selhalo:`, e.message);
              continue;
            }
          }

          // Všechny proxy selhaly
          throw new Error(
            "HuggingFace: CORS blokuje přístup z file://. Spusť: python -m http.server"
          );
        },

        async doHuggingFaceRequest(url, headers, body, options) {
          try {
            const response = await this.fetchWithTimeout(url, {
              method: "POST",
              headers: headers,
              body: body,
            });

            if (!response.ok) {
              const error = await response.json().catch(() => ({}));
              if (error.error?.includes("loading")) {
                throw new Error("Model se načítá, zkus za 30s...");
              }
              throw new Error(error.error || `HTTP ${response.status}`);
            }

            const data = await response.json();
            const text = data.choices?.[0]?.message?.content || "";
            return options.parseJson ? this.parseResponse(text) : text;
          } catch (e) {
            if (e.message === "Failed to fetch") {
              throw new Error(
                "CORS blokuje přístup. Spusť: python -m http.server"
              );
            }
            throw e;
          }
        },

        // ============== UNIVERZÁLNÍ METODY ==============

        async ask(prompt, options = {}) {
          const provider = options.provider || this.config.defaultProvider;

          switch (provider) {
            case "gemini":
              return this.askGemini(prompt, options);
            case "groq":
              return this.askGroq(prompt, options);
            case "openrouter":
              return this.askOpenRouter(prompt, options);
            case "mistral":
              return this.askMistral(prompt, options);
            case "cohere":
              return this.askCohere(prompt, options);
            case "huggingface":
              return this.askHuggingFace(prompt, options);
            default:
              throw new Error(`Neznámý poskytovatel: ${provider}`);
          }
        },

        async askWithFallback(prompt, options = {}) {
          const providers = options.providers || this.getAvailableProviders();

          if (providers.length === 0) {
            throw new Error("Žádný dostupný poskytovatel - nastav API klíče");
          }

          for (const provider of providers) {
            try {
              console.log(`🔄 Zkouším ${provider}...`);
              return await this.ask(prompt, { ...options, provider });
            } catch (error) {
              console.warn(`⚠️ ${provider} selhal:`, error.message);
              continue;
            }
          }

          throw new Error("Všichni poskytovatelé selhali");
        },

        // ============== STREAMING (Gemini) ==============

        async *streamGemini(prompt, options = {}) {
          const key = options.key || this.getKey("gemini");
          if (!key) throw new Error("Gemini API klíč není nastaven");

          const model = options.model || this.config.models.gemini;
          const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:streamGenerateContent?key=${key}&alt=sse`;

          const body = {
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: {
              temperature: options.temperature ?? 0.7,
              maxOutputTokens: options.maxTokens ?? 4096,
            },
          };

          if (options.system) {
            body.systemInstruction = { parts: [{ text: options.system }] };
          }

          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });

          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.error?.message || `HTTP ${response.status}`);
          }

          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let buffer = "";

          while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop() || "";

            for (const line of lines) {
              if (line.startsWith("data: ")) {
                try {
                  const data = JSON.parse(line.slice(6));
                  const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                  if (text) yield text;
                } catch (e) {}
              }
            }
          }
        },

        async *askStream(prompt, options = {}) {
          const provider = options.provider || this.config.defaultProvider;

          if (provider === "gemini") {
            yield* this.streamGemini(prompt, options);
          } else {
            const response = await this.ask(prompt, options);
            yield response;
          }
        },

        // ============== UTILITY ==============

        getModels(provider) {
          return this.ALL_MODELS[provider] || [];
        },

        getAllModels() {
          return this.ALL_MODELS;
        },

        getModelLimit(model) {
          for (const provider of Object.keys(this.ALL_MODELS)) {
            const found = this.ALL_MODELS[provider].find(
              (m) => m.value === model
            );
            if (found) return found.rpm;
          }
          return 15;
        },

        supportsVision(model) {
          return this.VISION_MODELS.includes(model);
        },

        getProviderForModel(model) {
          for (const [provider, models] of Object.entries(this.ALL_MODELS)) {
            if (models.some((m) => m.value === model)) {
              return provider;
            }
          }
          return null;
        },

        getProviderInfo(provider) {
          const info = {
            gemini: {
              name: "Google Gemini",
              endpoint: "generativelanguage.googleapis.com",
              keyUrl: "https://aistudio.google.com/app/apikey",
            },
            groq: {
              name: "Groq",
              endpoint: "api.groq.com",
              keyUrl: "https://console.groq.com/keys",
            },
            openrouter: {
              name: "OpenRouter",
              endpoint: "openrouter.ai",
              keyUrl: "https://openrouter.ai/keys",
            },
            mistral: {
              name: "Mistral AI",
              endpoint: "api.mistral.ai",
              keyUrl: "https://console.mistral.ai/api-keys/",
            },
            cohere: {
              name: "Cohere",
              endpoint: "api.cohere.com",
              keyUrl: "https://dashboard.cohere.com/api-keys",
            },
            huggingface: {
              name: "Hugging Face",
              endpoint: "api-inference.huggingface.co",
              keyUrl: "https://huggingface.co/settings/tokens",
            },
          };

          const providerInfo = info[provider];
          if (!providerInfo) return null;

          providerInfo.models = this.ALL_MODELS[provider] || [];

          return providerInfo;
        },
      };

      // Expose globally
      window.AI = AI;

      // ============================================
      // STATE
      // ============================================
      let files = [];
      let activeFileId = null;
      let fileIdCounter = 0;
      let consoleErrors = 0;
      let consoleWarns = 0;
      let searchMatches = [];
      let currentMatchIndex = -1;
      let commandHistory = [];
      let commandHistoryIndex = -1;

      const codeInput = document.getElementById("codeInput");
      const previewFrame = document.getElementById("previewFrame");
      const fileTabs = document.getElementById("fileTabs");
      const lineNumbers = document.getElementById("lineNumbers");
      const codeWrapper = document.getElementById("codeWrapper");
      const splitPreviewFrame = document.getElementById("splitPreviewFrame");
      const codeInputSplit = document.getElementById("codeInputSplit");
      const lineNumbersSplit = document.getElementById("lineNumbersSplit");
      const searchBar = document.getElementById("searchBar");
      const searchInput = document.getElementById("searchInput");
      const replaceInput = document.getElementById("replaceInput");
      const searchResults = document.getElementById("searchResults");
      const consoleContent = document.getElementById("consoleContent");
      const consoleInputEl = document.getElementById("consoleInput");
      const historyList = document.getElementById("historyList");
      const errorBadge = document.getElementById("errorBadge");
      const warnBadge = document.getElementById("warnBadge");

      // Templates
      const templates = {
        blank: `<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Moje stránka</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; padding: 1rem; }
  </style>
</head>
<body>
  <h1>Ahoj světe!</h1>
</body>
</html>`,
        landing: `<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Landing</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
    .hero { text-align: center; color: white; padding: 2rem; }
    h1 { font-size: 2rem; margin-bottom: 1rem; }
    .btn { display: inline-block; padding: 1rem 2rem; background: white; color: #764ba2; text-decoration: none; border-radius: 50px; font-weight: 600; }
  </style>
</head>
<body>
  <div class="hero">
    <h1>Vítejte</h1>
    <a href="#" class="btn">Začít</a>
  </div>
</body>
</html>`,
        form: `<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Formulář</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #f5f5f5; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 1rem; }
    .card { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
    h2 { margin-bottom: 1.5rem; }
    input, textarea { width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; margin-bottom: 1rem; font-size: 1rem; }
    button { width: 100%; padding: 1rem; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 1rem; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Kontakt</h2>
    <form>
      <input type="text" placeholder="Jméno">
      <input type="email" placeholder="Email">
      <textarea placeholder="Zpráva"></textarea>
      <button type="submit">Odeslat</button>
    </form>
  </div>
</body>
</html>`,
        grid: `<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Grid</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #1a1a2e; color: white; padding: 1rem; }
    h1 { text-align: center; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
    .card { background: #16213e; border-radius: 12px; overflow: hidden; }
    .card-img { height: 100px; background: linear-gradient(45deg, #e94560, #0f3460); }
    .card-body { padding: 1rem; }
  </style>
</head>
<body>
  <h1>Galerie</h1>
  <div class="grid">
    <div class="card"><div class="card-img"></div><div class="card-body"><h3>Karta 1</h3></div></div>
    <div class="card"><div class="card-img"></div><div class="card-body"><h3>Karta 2</h3></div></div>
    <div class="card"><div class="card-img"></div><div class="card-body"><h3>Karta 3</h3></div></div>
  </div>
</body>
</html>`,
        dashboard: `<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; background: #0f172a; color: #e2e8f0; padding: 1rem; }
    h1 { margin-bottom: 1rem; font-size: 1.5rem; }
    .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .stat { background: #1e293b; padding: 1rem; border-radius: 12px; }
    .stat-label { font-size: 0.75rem; color: #94a3b8; }
    .stat-value { font-size: 1.5rem; font-weight: 700; color: #38bdf8; }
  </style>
</head>
<body>
  <h1>Dashboard</h1>
  <div class="stats">
    <div class="stat"><div class="stat-label">Uživatelé</div><div class="stat-value">1,234</div></div>
    <div class="stat"><div class="stat-label">Aktivní</div><div class="stat-value">456</div></div>
    <div class="stat"><div class="stat-label">Tržby</div><div class="stat-value">89k</div></div>
    <div class="stat"><div class="stat-label">Konverze</div><div class="stat-value">12%</div></div>
  </div>
</body>
</html>`,
      };

      const snippets = {
        div: '<div class="">\n  \n</div>',
        flex: '<div style="display:flex;gap:1rem;align-items:center;">\n  \n</div>',
        grid: '<div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">\n  \n</div>',
        btn: '<button style="padding:0.75rem 1.5rem;background:#3b82f6;color:white;border:none;border-radius:6px;">Tlačítko</button>',
        input:
          '<input type="text" placeholder="Text..." style="padding:0.75rem;border:1px solid #ccc;border-radius:6px;">',
        img: '<img src="https://placehold.co/300x200" alt="" style="max-width:100%;border-radius:8px;">',
        link: '<a href="#" style="color:#3b82f6;">Odkaz</a>',
        table:
          '<table style="width:100%;border-collapse:collapse;">\n  <tr><th style="border:1px solid #ddd;padding:8px;">A</th><th style="border:1px solid #ddd;padding:8px;">B</th></tr>\n  <tr><td style="border:1px solid #ddd;padding:8px;">1</td><td style="border:1px solid #ddd;padding:8px;">2</td></tr>\n</table>',
      };

      // ============================================
      // VIEW SWITCHING
      // ============================================
      let currentView = "code";
      let toolsOpen = false;

      function switchView(view) {
        // Pokud klikneme na tools, toggleujeme sidebar
        if (view === "tools") {
          toggleTools();
          return;
        }

        // Přepnout hlavní pohled
        currentView = view;
        document
          .querySelectorAll(".view-panel")
          .forEach((p) => p.classList.remove("active"));
        document.querySelectorAll(".bottom-nav-item").forEach((b) => {
          if (b.dataset.view !== "tools") b.classList.remove("active");
        });

        document.getElementById(view + "View").classList.add("active");
        document.querySelector(`[data-view="${view}"]`).classList.add("active");

        if (view === "preview") {
          updatePreview();
        }

        // Aktualizuj files list pokud je potřeba
        renderFilesList();
      }

      function toggleTools() {
        toolsOpen = !toolsOpen;
        const toolsPanel = document.getElementById("toolsPanel");
        const toolsBtn = document.querySelector('[data-view="tools"]');

        if (toolsOpen) {
          toolsPanel.classList.add("active");
          toolsBtn.classList.add("active");
          renderFilesList();
          renderPrompts();
          checkGithubConnection();
        } else {
          toolsPanel.classList.remove("active");
          toolsBtn.classList.remove("active");
        }
      }

      function toggleCollapse(header) {
        header.classList.toggle("open");
      }

      // Stav rozbalených složek
      let expandedFolders = new Set();

      function toggleFolder(path) {
        if (expandedFolders.has(path)) {
          expandedFolders.delete(path);
        } else {
          expandedFolders.add(path);
        }
        renderFilesList();
      }

      function buildFileTree(files) {
        const tree = { files: [], folders: {} };

        for (const file of files) {
          const folderPath = file.folderPath || "";

          if (!folderPath) {
            // Soubor v kořenu
            tree.files.push(file);
          } else {
            // Soubor ve složce
            const parts = folderPath.split("/");
            let current = tree;
            let currentPath = "";

            for (const part of parts) {
              currentPath = currentPath ? currentPath + "/" + part : part;
              if (!current.folders[part]) {
                current.folders[part] = {
                  files: [],
                  folders: {},
                  path: currentPath,
                  name: part,
                };
              }
              current = current.folders[part];
            }
            current.files.push(file);
          }
        }

        return tree;
      }

      function renderTreeFolder(folder, depth = 0) {
        const isExpanded = expandedFolders.has(folder.path);
        const indent = depth * 16;
        const fileCount = countFilesInFolder(folder);

        let html = `
                <div class="folder-item" style="padding-left:${indent}px;" onclick="toggleFolder('${
          folder.path
        }')">
                    <svg class="folder-arrow ${
                      isExpanded ? "expanded" : ""
                    }" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    <svg class="folder-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
                    </svg>
                    <span class="folder-name">${folder.name}</span>
                    <span class="folder-count">${fileCount}</span>
                </div>
            `;

        if (isExpanded) {
          html += '<div class="folder-content">';

          // Podsložky
          for (const subName of Object.keys(folder.folders).sort()) {
            html += renderTreeFolder(folder.folders[subName], depth + 1);
          }

          // Soubory ve složce
          for (const file of folder.files.sort((a, b) =>
            a.name.localeCompare(b.name)
          )) {
            html += renderTreeFile(file, depth + 1);
          }

          html += "</div>";
        }

        return html;
      }

      function renderTreeFile(file, depth = 0) {
        const indent = depth * 16;
        const size = file.content ? formatFileSize(file.content.length) : "";
        const isActive = file.id === activeFileId;
        const githubIcon = file.githubRepo ? "⬇" : "";

        return `
                <div class="file-item ${
                  isActive ? "active" : ""
                }" style="padding-left:${indent}px;" onclick="switchFile(${
          file.id
        })">
                    <div class="file-info">
                        <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <span class="file-name">${file.name}</span>
                        ${
                          file.unsaved
                            ? '<span class="file-unsaved"></span>'
                            : ""
                        }
                        <span class="file-size">${size} ${githubIcon}</span>
                    </div>
                    <button class="file-close" onclick="event.stopPropagation(); closeFile(${
                      file.id
                    })">×</button>
                </div>
            `;
      }

      function countFilesInFolder(folder) {
        let count = folder.files.length;
        for (const sub of Object.values(folder.folders)) {
          count += countFilesInFolder(sub);
        }
        return count;
      }

      function renderFilesList() {
        let html = "";

        if (files.length === 0) {
          html = '<div class="files-empty">Žádné otevřené soubory</div>';
        } else {
          const tree = buildFileTree(files);

          // Složky první
          for (const folderName of Object.keys(tree.folders).sort()) {
            html += renderTreeFolder(tree.folders[folderName], 0);
          }

          // Soubory v kořenu
          for (const file of tree.files.sort((a, b) =>
            a.name.localeCompare(b.name)
          )) {
            html += renderTreeFile(file, 0);
          }

          // Souhrn
          const totalSize = files.reduce(
            (sum, f) => sum + (f.content?.length || 0),
            0
          );
          const unsavedCount = files.filter((f) => f.unsaved).length;
          html += `
                    <div class="files-summary">
                        <span>${files.length} souborů (${formatFileSize(
            totalSize
          )})</span>
                        ${
                          unsavedCount > 0
                            ? `<span style="color:var(--warning);">${unsavedCount} neuložené</span>`
                            : ""
                        }
                    </div>
                `;
        }

        // Aktualizuj sidebar
        const filesList = document.getElementById("filesList");
        if (filesList) filesList.innerHTML = html;

        // Aktualizuj main tools view
        const filesListMain = document.getElementById("filesListMain");
        if (filesListMain) filesListMain.innerHTML = html;

        // Aktualizuj počty souborů v záhlaví
        const count = files.length;
        const filesCount = document.getElementById("filesCount");
        if (filesCount) filesCount.textContent = count > 0 ? count : "";

        const filesCountMain = document.getElementById("filesCountMain");
        if (filesCountMain) filesCountMain.textContent = count > 0 ? count : "";
      }

      // Tools panel resize
      const toolsResize = document.getElementById("toolsResize");
      const toolsPanel = document.getElementById("toolsPanel");
      let isResizingTools = false;

      toolsResize.addEventListener("mousedown", startToolsResize);
      toolsResize.addEventListener("touchstart", startToolsResize, {
        passive: false,
      });

      function startToolsResize(e) {
        isResizingTools = true;
        toolsResize.classList.add("active");
        e.preventDefault();
      }

      document.addEventListener("mousemove", handleToolsResize);
      document.addEventListener("touchmove", handleToolsResize, {
        passive: false,
      });

      function handleToolsResize(e) {
        if (!isResizingTools) return;

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const containerWidth =
          document.querySelector(".main-content").offsetWidth;
        const newWidth = containerWidth - clientX;
        const minWidth = 120;
        const maxWidth = containerWidth * 0.7;

        if (newWidth >= minWidth && newWidth <= maxWidth) {
          toolsPanel.style.width = newWidth + "px";
        }
      }

      document.addEventListener("mouseup", stopToolsResize);
      document.addEventListener("touchend", stopToolsResize);

      function stopToolsResize() {
        isResizingTools = false;
        toolsResize.classList.remove("active");
      }

      // ============================================
      // FILES
      // ============================================
      function createFile(name = "index.html", content = "") {
        const id = ++fileIdCounter;
        const file = {
          id,
          name,
          content: content || templates.blank,
          unsaved: false,
          history: [],
          historyIndex: -1,
        };
        files.push(file);
        return file;
      }

      function renderTabs() {
        const tabsHtml =
          files
            .map(
              (file) => `
                <button class="file-tab ${
                  file.id === activeFileId ? "active" : ""
                }" onclick="switchFile(${file.id})">
                    ${file.unsaved ? '<span class="unsaved"></span>' : ""}
                    ${file.name}
                    <span class="close-tab" onclick="event.stopPropagation();closeFile(${
                      file.id
                    })">×</span>
                </button>
            `
            )
            .join("") +
          '<button class="add-tab-btn" onclick="addNewTab()">+</button>';

        fileTabs.innerHTML = `
                <button class="tabs-nav-btn" onclick="scrollTabs(-1)" title="Doleva">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                </button>
                <div class="file-tabs-scroll" id="fileTabsScroll">${tabsHtml}</div>
                <button class="tabs-nav-btn" onclick="scrollTabs(1)" title="Doprava">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                </button>
            `;

        // Aktualizuj i seznam souborů v tools panelu
        renderFilesList();
      }

      function scrollTabs(direction) {
        const scroll = document.getElementById("fileTabsScroll");
        if (scroll) {
          scroll.scrollBy({ left: direction * 150, behavior: "smooth" });
        }
      }

      function switchFile(id) {
        if (activeFileId) {
          const curr = files.find((f) => f.id === activeFileId);
          if (curr) curr.content = codeInput.value;
        }
        activeFileId = id;
        const file = files.find((f) => f.id === id);
        if (file) {
          codeInput.value = file.content;
          updatePreview();
          renderTabs();
          renderHistory();
          updateLineNumbers(codeInput, lineNumbers);
          updateSyntaxHighlight();
          // Sync split view
          if (splitViewActive && codeInputSplit) {
            codeInputSplit.value = file.content;
            updateLineNumbers(codeInputSplit, lineNumbersSplit);
            updateSplitPreview();
          }
        }
      }

      function addNewTab() {
        document.getElementById("newTabModal").classList.add("active");
        document.getElementById("newTabName").value = `soubor${
          files.length + 1
        }.html`;
      }

      function closeNewTabModal() {
        document.getElementById("newTabModal").classList.remove("active");
      }

      function confirmNewTab() {
        const name = document.getElementById("newTabName").value || "novy.html";
        const file = createFile(name);
        activeFileId = file.id;
        codeInput.value = file.content;
        renderTabs();
        updatePreview();
        addToHistory("Nový soubor");
        closeNewTabModal();
        switchView("code");
      }

      function closeFile(id) {
        const idx = files.findIndex((f) => f.id === id);
        if (idx === -1) return;
        if (files[idx].unsaved && !confirm("Neuložené změny. Zavřít?")) return;
        files.splice(idx, 1);
        if (files.length === 0) {
          const f = createFile();
          activeFileId = f.id;
        } else if (activeFileId === id) {
          activeFileId = files[Math.min(idx, files.length - 1)].id;
        }
        codeInput.value = files.find((f) => f.id === activeFileId).content;
        renderTabs();
        updatePreview();
      }

      // ============================================
      // EDITOR
      // ============================================
      function updatePreview() {
        // Získej aktuální soubor
        const currentFile = files.find((f) => f.id === activeFileId);
        if (!currentFile) {
          const doc = previewFrame.contentDocument;
          doc.open();
          doc.write("");
          doc.close();
          return;
        }

        // Zjisti jestli je to HTML soubor
        const isHtml = currentFile.name.match(/\.(html?|htm)$/i);

        let htmlContent = "";

        if (isHtml) {
          // Použij aktuální HTML soubor
          htmlContent = codeInput.value;
        } else {
          // Není HTML - najdi hlavní HTML soubor pro preview
          const mainHtml = findMainHtmlFile();
          if (mainHtml) {
            htmlContent = mainHtml.content;
          } else {
            // Žádný HTML soubor - zobraz pouze aktuální kód
            const doc = previewFrame.contentDocument;
            doc.open();
            doc.write(
              `<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:monospace;padding:20px;background:#1a1a2e;color:#eee;white-space:pre-wrap;}</style></head><body>${escapeHtml(
                codeInput.value
              )}</body></html>`
            );
            doc.close();
            return;
          }
        }

        // Zpracuj HTML - nahraď externí CSS a JS za obsah souborů
        htmlContent = processHtmlWithFiles(htmlContent);

        const doc = previewFrame.contentDocument;
        doc.open();
        doc.write(htmlContent);
        doc.close();
        setupConsoleCapture();
        updatePreviewSourceLabel();
      }

      function findMainHtmlFile() {
        // Priorita: index.html > index.htm > první .html soubor
        let indexHtml = files.find(
          (f) => f.name.toLowerCase() === "index.html"
        );
        if (indexHtml) return indexHtml;

        indexHtml = files.find((f) => f.name.toLowerCase() === "index.htm");
        if (indexHtml) return indexHtml;

        // Hledej jakýkoliv HTML soubor
        return files.find((f) => f.name.match(/\.(html?|htm)$/i));
      }

      function processHtmlWithFiles(html) {
        // Nahraď <link href="..."> za inline CSS
        html = html.replace(
          /<link[^>]+href=["']([^"']+\.css)["'][^>]*>/gi,
          (match, href) => {
            const cssFile = findFileByPath(href);
            if (cssFile) {
              return (
                "<style>/* " +
                href +
                " */\n" +
                cssFile.content +
                "<" +
                "/style>"
              );
            }
            return match; // Ponechej původní pokud soubor nenalezen
          }
        );

        // Nahraď <script src="..."> za inline JS
        html = html.replace(
          /<script[^>]+src=["']([^"']+\.js)["'][^>]*><\/script>/gi,
          (match, src) => {
            const jsFile = findFileByPath(src);
            if (jsFile) {
              return (
                "<script>/* " +
                src +
                " */\n" +
                jsFile.content +
                "<" +
                "/script>"
              );
            }
            return match; // Ponechej původní pokud soubor nenalezen
          }
        );

        return html;
      }

      function findFileByPath(path) {
        // Odstraň ./ na začátku
        path = path.replace(/^\.\//, "");

        // Hledej podle názvu souboru (bez cesty)
        const fileName = path.split("/").pop();

        // Nejdřív zkus přesnou shodu s cestou
        let file = files.find((f) => {
          const fullPath = f.folderPath ? f.folderPath + "/" + f.name : f.name;
          return fullPath === path || f.name === path;
        });

        if (file) return file;

        // Zkus jen název souboru
        file = files.find((f) => f.name === fileName);

        return file;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function getPreviewHtmlFile() {
        // Vrátí HTML soubor pro preview - index.html nebo aktuální pokud je HTML
        const currentFile = files.find((f) => f.id === activeFileId);

        if (currentFile && currentFile.name.match(/\.(html?|htm)$/i)) {
          return currentFile;
        }

        return findMainHtmlFile();
      }

      function refreshPreview() {
        updatePreview();
        showToast("Náhled aktualizován", "success");
      }

      function updatePreviewSourceLabel() {
        const htmlFile = getPreviewHtmlFile();
        const sourceEl = document.getElementById("previewSourceName");
        if (sourceEl && htmlFile) {
          sourceEl.textContent = htmlFile.name;
        } else if (sourceEl) {
          sourceEl.textContent = "Žádný HTML";
        }

        // Aktualizuj GitHub Pages odkaz
        updateGithubPagesLink();
      }

      function updateGithubPagesLink() {
        const linkEl = document.getElementById("githubPagesLink");
        if (!linkEl) return;

        // Najdi soubor z GitHubu
        const githubFile = files.find((f) => f.githubRepo);

        if (githubFile && githubFile.githubRepo) {
          // Vytvoř GitHub Pages URL
          const repoParts = githubFile.githubRepo.split("/");
          const username = repoParts[0];
          const repoName = repoParts[1];

          // Standardní GitHub Pages URL
          let pagesUrl = "https://" + username + ".github.io/" + repoName + "/";

          // Pokud je soubor v podsložce, přidej cestu
          if (githubFile.githubPath && githubFile.githubPath.includes("/")) {
            const pathParts = githubFile.githubPath.split("/");
            pathParts.pop(); // Odeber název souboru
            if (pathParts.length > 0) {
              pagesUrl += pathParts.join("/") + "/";
            }
          }

          linkEl.href = pagesUrl;
          linkEl.style.display = "flex";
          linkEl.title = "Otevřít na GitHub Pages: " + pagesUrl;
        } else {
          linkEl.style.display = "none";
        }
      }

      function switchToPreviewSource() {
        const htmlFile = getPreviewHtmlFile();
        if (htmlFile && htmlFile.id !== activeFileId) {
          switchFile(htmlFile.id);
          showToast("Přepnuto na " + htmlFile.name, "success");
        }
      }

      function markUnsaved() {
        const file = files.find((f) => f.id === activeFileId);
        if (file) {
          file.unsaved = true;
          file.content = codeInput.value;
          renderTabs();
        }
      }

      function loadTemplate(name) {
        codeInput.value = templates[name] || templates.blank;
        updatePreview();
        markUnsaved();
        addToHistory("Šablona: " + name);
        // Přepnout na kód pokud nejsme v code view
        if (currentView !== "code") {
          switchView("code");
        }
        showToast("Šablona načtena", "success");
      }

      function insertSnippet(name) {
        const snippet = snippets[name];
        const start = codeInput.selectionStart;
        codeInput.value =
          codeInput.value.substring(0, start) +
          snippet +
          codeInput.value.substring(codeInput.selectionEnd);
        codeInput.selectionStart = codeInput.selectionEnd =
          start + snippet.length;
        updatePreview();
        markUnsaved();
        addToHistory("Snippet: " + name);
        // Přepnout na kód pokud nejsme v code view
        if (currentView !== "code") {
          switchView("code");
        }
        codeInput.focus();
      }

      // ============================================
      // SEARCH
      // ============================================
      function toggleSearch() {
        searchBar.classList.toggle("active");
        if (searchBar.classList.contains("active")) {
          searchInput.focus();
        }
      }

      function performSearch() {
        const query = searchInput.value;
        searchMatches = [];
        currentMatchIndex = -1;
        if (!query) {
          searchResults.textContent = "";
          return;
        }
        const content = codeInput.value;
        let idx = 0;
        while ((idx = content.indexOf(query, idx)) !== -1) {
          searchMatches.push(idx);
          idx += query.length;
        }
        if (searchMatches.length > 0) {
          currentMatchIndex = 0;
          highlightMatch();
        }
        searchResults.textContent =
          searchMatches.length > 0
            ? `${currentMatchIndex + 1}/${searchMatches.length}`
            : "Nenalezeno";
      }

      function highlightMatch() {
        if (currentMatchIndex >= 0 && searchMatches.length > 0) {
          const pos = searchMatches[currentMatchIndex];
          codeInput.focus();
          codeInput.setSelectionRange(pos, pos + searchInput.value.length);
          searchResults.textContent = `${currentMatchIndex + 1}/${
            searchMatches.length
          }`;
        }
      }

      function findNext() {
        if (searchMatches.length === 0) {
          performSearch();
          return;
        }
        currentMatchIndex = (currentMatchIndex + 1) % searchMatches.length;
        highlightMatch();
      }

      function findPrev() {
        if (searchMatches.length === 0) {
          performSearch();
          return;
        }
        currentMatchIndex =
          (currentMatchIndex - 1 + searchMatches.length) % searchMatches.length;
        highlightMatch();
      }

      function replaceOne() {
        if (currentMatchIndex < 0) return;
        const pos = searchMatches[currentMatchIndex];
        codeInput.value =
          codeInput.value.substring(0, pos) +
          replaceInput.value +
          codeInput.value.substring(pos + searchInput.value.length);
        updatePreview();
        markUnsaved();
        performSearch();
      }

      function replaceAll() {
        const count = searchMatches.length;
        codeInput.value = codeInput.value
          .split(searchInput.value)
          .join(replaceInput.value);
        updatePreview();
        markUnsaved();
        performSearch();
        showToast(`Nahrazeno ${count}x`, "success");
      }

      searchInput.addEventListener("input", performSearch);

      // ============================================
      // HISTORY
      // ============================================
      function addToHistory(label) {
        const file = files.find((f) => f.id === activeFileId);
        if (!file) return;
        const time = new Date().toLocaleTimeString("cs-CZ", {
          hour: "2-digit",
          minute: "2-digit",
        });
        if (file.historyIndex < file.history.length - 1)
          file.history = file.history.slice(0, file.historyIndex + 1);
        file.history.push({ content: codeInput.value, label, time });
        if (file.history.length > 30) file.history.shift();
        file.historyIndex = file.history.length - 1;
        renderHistory();
      }

      function renderHistory() {
        const file = files.find((f) => f.id === activeFileId);
        if (!file) return;
        const html = file.history
          .slice()
          .reverse()
          .map((item, i) => {
            const idx = file.history.length - 1 - i;
            return `<div class="history-item ${
              idx === file.historyIndex ? "current" : ""
            }" onclick="restoreHistory(${idx})">
                    <span class="history-label">${item.label}</span>
                    <span class="history-time">${item.time}</span>
                </div>`;
          })
          .join("");
        historyList.innerHTML = html;
      }

      function restoreHistory(idx) {
        const file = files.find((f) => f.id === activeFileId);
        if (!file || idx < 0 || idx >= file.history.length) return;
        file.historyIndex = idx;
        codeInput.value = file.history[idx].content;
        file.content = codeInput.value;
        updatePreview();
        renderHistory();
        markUnsaved();
      }

      function undo() {
        const file = files.find((f) => f.id === activeFileId);
        if (!file || file.historyIndex <= 0) {
          showToast("Nelze vrátit zpět", "error");
          return;
        }
        restoreHistory(file.historyIndex - 1);
        showToast("Vráceno zpět", "success");
      }

      function redo() {
        const file = files.find((f) => f.id === activeFileId);
        if (!file || file.historyIndex >= file.history.length - 1) {
          showToast("Nelze opakovat", "error");
          return;
        }
        restoreHistory(file.historyIndex + 1);
        showToast("Opakováno", "success");
      }

      // ============================================
      // CONSOLE
      // ============================================
      // Poslední chyba pro AI
      let lastError = null;
      let errorDebounce = null;

      function addConsoleEntry(type, message) {
        const empty = consoleContent.querySelector(".console-empty");
        if (empty) empty.remove();
        const time = new Date().toLocaleTimeString("cs-CZ", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        if (type === "error") {
          consoleErrors++;
          updateBadges();

          // Uložit chybu pro AI
          lastError = message;

          // Debounce - počkej 500ms jestli nepřijdou další chyby
          clearTimeout(errorDebounce);
          errorDebounce = setTimeout(() => {
            showErrorNotification(message);
          }, 500);
        }
        if (type === "warn") {
          consoleWarns++;
          updateBadges();
        }
        const entry = document.createElement("div");
        entry.className = `console-entry ${type}`;
        entry.innerHTML = `<span class="console-message">${escapeHtml(
          String(message)
        )}</span><span class="console-time">${time}</span>`;
        consoleContent.appendChild(entry);
        consoleContent.scrollTop = consoleContent.scrollHeight;
      }

      function showErrorNotification(errorMsg) {
        // Přidej chybu do AI chatu
        const messagesEl = document.getElementById("aiMessages");

        // Odstraň předchozí error notifikace
        const oldErrors = messagesEl.querySelectorAll(".ai-error-notification");
        oldErrors.forEach((el) => el.remove());

        const errorEl = document.createElement("div");
        errorEl.className = "ai-message system ai-error-notification";
        errorEl.innerHTML = `
                <div style="color:var(--error);margin-bottom:8px;">❌ Chyba v kódu:</div>
                <div style="font-family:'JetBrains Mono',monospace;font-size:11px;background:var(--bg-primary);padding:8px;border-radius:6px;margin-bottom:10px;">${escapeHtml(
                  errorMsg
                )}</div>
                <button onclick="fixErrorWithAI()" style="width:100%;padding:10px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:8px;color:white;font-size:13px;font-weight:500;cursor:pointer;">🤖 Opravit pomocí AI</button>
            `;
        messagesEl.appendChild(errorEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;

        // Zobraz toast s tlačítkem
        showErrorToast(errorMsg);
      }

      function showErrorToast(errorMsg) {
        // Speciální toast pro chyby
        const existingToast = document.getElementById("errorToast");
        if (existingToast) existingToast.remove();

        const toast = document.createElement("div");
        toast.id = "errorToast";
        toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 16px;
                right: 16px;
                background: var(--bg-elevated);
                border: 1px solid var(--error);
                border-radius: 12px;
                padding: 12px;
                z-index: 500;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                animation: slideUp 0.3s ease;
            `;
        toast.innerHTML = `
                <div style="display:flex;align-items:flex-start;gap:10px;">
                    <div style="font-size:20px;">❌</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-size:12px;font-weight:500;color:var(--error);margin-bottom:4px;">Chyba v kódu</div>
                        <div style="font-size:11px;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHtml(
                          errorMsg.substring(0, 50)
                        )}${errorMsg.length > 50 ? "..." : ""}</div>
                    </div>
                    <button onclick="fixErrorWithAI();this.parentElement.parentElement.remove();" style="padding:8px 16px;background:linear-gradient(135deg,#667eea,#764ba2);border:none;border-radius:8px;color:white;font-size:12px;font-weight:500;cursor:pointer;white-space:nowrap;">🤖 Opravit</button>
                    <button onclick="this.parentElement.parentElement.remove();" style="padding:8px;background:transparent;border:none;color:var(--text-muted);cursor:pointer;font-size:16px;">✕</button>
                </div>
            `;
        document.body.appendChild(toast);

        // Auto-hide po 10s
        setTimeout(() => {
          if (document.getElementById("errorToast")) {
            toast.remove();
          }
        }, 10000);
      }

      async function fixErrorWithAI() {
        if (!lastError) {
          showToast("Žádná chyba k opravě", "error");
          return;
        }

        if (!aiSettings.apiKey) {
          showToast("Nastav API klíč v nastavení", "error");
          return;
        }

        // Zavři error toast
        const errorToast = document.getElementById("errorToast");
        if (errorToast) errorToast.remove();

        // Otevři AI chat pokud není
        openAIChat();

        // Přidej zprávu
        addAIMessage("user", `Oprav tuto chybu: ${lastError}`);
        showAITyping();
        document.getElementById("aiSendBtn").disabled = true;

        const systemPrompt = `Jsi expert na opravu HTML/CSS/JavaScript chyb.

Aktuální HTML kód:
\`\`\`html
${codeInput.value}
\`\`\`

CHYBA: ${lastError}

INSTRUKCE:
- Najdi a oprav chybu v kódu
- Vysvětli krátce co bylo špatně
- Vrať CELÝ opravený HTML kód
- Odpověz formátem:

PROBLÉM: [co bylo špatně]
ŘEŠENÍ: [co jsi opravil]

\`\`\`html
[opravený kód]
\`\`\``;

        try {
          const response = await callAI(
            systemPrompt,
            `Oprav chybu: ${lastError}`
          );
          hideAITyping();

          // Extrahuj HTML z odpovědi
          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);
          if (htmlMatch) {
            const newHtml = htmlMatch[1].trim();
            codeInput.value = newHtml;
            updatePreview();
            markUnsaved();
            addToHistory("AI oprava chyby");

            // Extrahuj vysvětlení
            const problemMatch = response.match(/PROBLÉM:\s*([^\n]+)/);
            const solutionMatch = response.match(/ŘEŠENÍ:\s*([^\n]+)/);

            let explanation = "✅ Chyba opravena!";
            if (problemMatch)
              explanation += `\n\n**Problém:** ${problemMatch[1]}`;
            if (solutionMatch)
              explanation += `\n**Řešení:** ${solutionMatch[1]}`;

            addAIMessage("assistant", explanation);

            // Vyčisti chyby
            lastError = null;
            clearConsole();
            showToast("Chyba opravena!", "success");
          } else {
            addAIMessage("assistant", response);
          }
        } catch (e) {
          hideAITyping();
          addAIMessage("assistant", "❌ Chyba: " + e.message);
        }

        document.getElementById("aiSendBtn").disabled = false;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function updateBadges() {
        errorBadge.textContent = consoleErrors;
        errorBadge.classList.toggle("hidden", consoleErrors === 0);
        warnBadge.textContent = consoleWarns;
        warnBadge.classList.toggle("hidden", consoleWarns === 0);
      }

      function clearConsole() {
        consoleContent.innerHTML =
          '<div class="console-empty">Konzole je prázdná</div>';
        consoleErrors = 0;
        consoleWarns = 0;
        updateBadges();
      }

      function handleConsoleInput(e) {
        if (e.key === "Enter") {
          const cmd = consoleInputEl.value.trim();
          if (!cmd) return;
          commandHistory.push(cmd);
          commandHistoryIndex = commandHistory.length;
          addConsoleEntry("command", "> " + cmd);
          consoleInputEl.value = "";
          try {
            const result = previewFrame.contentWindow.eval(cmd);
            if (result !== undefined)
              addConsoleEntry("result", formatResult(result));
          } catch (err) {
            addConsoleEntry("error", err.message);
          }
        } else if (e.key === "ArrowUp" && commandHistoryIndex > 0) {
          commandHistoryIndex--;
          consoleInputEl.value = commandHistory[commandHistoryIndex];
        } else if (
          e.key === "ArrowDown" &&
          commandHistoryIndex < commandHistory.length - 1
        ) {
          commandHistoryIndex++;
          consoleInputEl.value = commandHistory[commandHistoryIndex];
        }
      }

      function formatResult(r) {
        if (r === null) return "null";
        if (r === undefined) return "undefined";
        if (typeof r === "object")
          try {
            return JSON.stringify(r, null, 2);
          } catch {
            return String(r);
          }
        return String(r);
      }

      function setupConsoleCapture() {
        previewFrame.onload = function () {
          try {
            const win = previewFrame.contentWindow;
            const orig = {
              log: win.console.log,
              info: win.console.info,
              warn: win.console.warn,
              error: win.console.error,
            };
            win.console.log = (...args) => {
              addConsoleEntry("log", args.map(formatResult).join(" "));
              orig.log.apply(win.console, args);
            };
            win.console.info = (...args) => {
              addConsoleEntry("info", args.map(formatResult).join(" "));
              orig.info.apply(win.console, args);
            };
            win.console.warn = (...args) => {
              addConsoleEntry("warn", args.map(formatResult).join(" "));
              orig.warn.apply(win.console, args);
            };
            win.console.error = (...args) => {
              addConsoleEntry("error", args.map(formatResult).join(" "));
              orig.error.apply(win.console, args);
            };

            // Zachycení JavaScript chyb
            win.onerror = (msg, src, line, col, error) => {
              let errorMsg = msg;
              if (line) errorMsg += ` (řádek ${line}`;
              if (col) errorMsg += `, sloupec ${col}`;
              if (line) errorMsg += ")";
              if (error && error.stack) {
                // Přidej stack trace pro lepší diagnostiku
                const stack = error.stack.split("\n").slice(0, 3).join(" → ");
                errorMsg += "\n" + stack;
              }
              addConsoleEntry("error", errorMsg);
              return true; // Potlač výchozí error dialog
            };

            // Zachycení unhandled promise rejections
            win.onunhandledrejection = (event) => {
              const reason = event.reason;
              let errorMsg = "Unhandled Promise Rejection: ";
              if (reason instanceof Error) {
                errorMsg += reason.message;
              } else {
                errorMsg += String(reason);
              }
              addConsoleEntry("error", errorMsg);
            };
          } catch {}
        };
      }

      // ============================================
      // PROMPTS
      // ============================================
      let prompts = [];
      let editingPromptId = null;

      function loadPrompts() {
        const saved = localStorage.getItem("htmlStudio_prompts");
        if (saved) {
          try {
            prompts = JSON.parse(saved);
          } catch {
            prompts = [];
          }
        }
        renderPrompts();
      }

      function savePromptsToStorage() {
        localStorage.setItem("htmlStudio_prompts", JSON.stringify(prompts));
      }

      function renderPrompts() {
        const list = document.getElementById("promptsList");
        if (!list) return;

        if (prompts.length === 0) {
          list.innerHTML = '<div class="prompts-empty">Žádné prompty</div>';
          return;
        }

        list.innerHTML = prompts
          .map(
            (p, i) => `
                <div class="prompt-item" onclick="copyPrompt(${i})">
                    <div class="prompt-header">
                        <span class="prompt-name">${escapeHtml(p.name)}</span>
                        <div class="prompt-actions">
                            <button class="prompt-action-btn" onclick="event.stopPropagation(); editPrompt(${i})" title="Upravit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                            <button class="prompt-action-btn delete" onclick="event.stopPropagation(); deletePrompt(${i})" title="Smazat">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="prompt-text">${escapeHtml(p.text)}</div>
                </div>
            `
          )
          .join("");
      }

      function openAddPromptModal() {
        editingPromptId = null;
        document.getElementById("promptModalTitle").textContent =
          "Přidat prompt";
        document.getElementById("promptName").value = "";
        document.getElementById("promptText").value = "";
        document.getElementById("promptModal").classList.add("active");
      }

      function closePromptModal() {
        document.getElementById("promptModal").classList.remove("active");
        editingPromptId = null;
      }

      function savePrompt() {
        const name = document.getElementById("promptName").value.trim();
        const text = document.getElementById("promptText").value.trim();

        if (!name || !text) {
          showToast("Vyplň název i text", "error");
          return;
        }

        if (editingPromptId !== null) {
          prompts[editingPromptId] = { name, text };
          showToast("Prompt upraven", "success");
        } else {
          prompts.push({ name, text });
          showToast("Prompt přidán", "success");
        }

        savePromptsToStorage();
        renderPrompts();
        closePromptModal();
      }

      function editPrompt(index) {
        const p = prompts[index];
        if (!p) return;

        editingPromptId = index;
        document.getElementById("promptModalTitle").textContent =
          "Upravit prompt";
        document.getElementById("promptName").value = p.name;
        document.getElementById("promptText").value = p.text;
        document.getElementById("promptModal").classList.add("active");
      }

      function deletePrompt(index) {
        if (confirm("Smazat tento prompt?")) {
          prompts.splice(index, 1);
          savePromptsToStorage();
          renderPrompts();
          showToast("Prompt smazán", "success");
        }
      }

      function copyPrompt(index) {
        const p = prompts[index];
        if (!p) return;

        navigator.clipboard
          .writeText(p.text)
          .then(() => {
            showToast("Prompt zkopírován", "success");
          })
          .catch(() => {
            // Fallback pro starší prohlížeče
            const textarea = document.createElement("textarea");
            textarea.value = p.text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            showToast("Prompt zkopírován", "success");
          });
      }

      // ============================================
      // SAVE / DOWNLOAD / IMPORT
      // ============================================
      function saveToLocal() {
        const file = files.find((f) => f.id === activeFileId);
        if (file) {
          file.unsaved = false;
          file.content = codeInput.value;
          renderTabs();
        }
        localStorage.setItem("htmlStudio_files", JSON.stringify(files));
        localStorage.setItem("htmlStudio_activeId", activeFileId);
        showToast("Uloženo", "success");
      }

      function downloadFile() {
        const file = files.find((f) => f.id === activeFileId);
        document.getElementById("fileName").value = file
          ? file.name
          : "index.html";
        document.getElementById("saveModal").classList.add("active");
      }

      function closeSaveModal() {
        document.getElementById("saveModal").classList.remove("active");
      }

      function confirmDownload() {
        const name = document.getElementById("fileName").value || "index.html";
        const blob = new Blob([codeInput.value], { type: "text/html" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = name;
        a.click();
        closeSaveModal();
        showToast("Staženo", "success");
      }

      function openImportModal() {
        document.getElementById("importModal").classList.add("active");
      }

      function closeImportModal() {
        document.getElementById("importModal").classList.remove("active");
      }

      async function importFromUrl() {
        const url = document.getElementById("importUrl").value.trim();
        if (!url) {
          showToast("Zadejte URL", "error");
          return;
        }
        try {
          showToast("Načítám...", "success");
          const res = await fetch(
            `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`
          );
          if (!res.ok) throw new Error("Nelze načíst");
          const html = await res.text();
          const name = new URL(url).hostname.replace("www.", "") + ".html";
          const file = createFile(name, html);
          activeFileId = file.id;
          codeInput.value = file.content;
          renderTabs();
          updatePreview();
          addToHistory("Import z URL");
          closeImportModal();
          switchView("code");
          showToast("Importováno", "success");
        } catch (err) {
          showToast("Chyba: " + err.message, "error");
        }
      }

      function openInNewTab() {
        const win = window.open();
        win.document.write(codeInput.value);
        win.document.close();
      }

      // ============================================
      // GITHUB
      // ============================================
      let githubToken = "";
      let githubUser = null;
      let githubCurrentRepo = "";
      let githubCurrentPath = "";
      let githubCurrentBranch = "main";
      let githubBranches = [];
      let githubFileSha = null;
      let githubFileLastSha = {}; // Ukládá SHA při načtení pro detekci konfliktů

      function loadGithubToken() {
        githubToken = localStorage.getItem("htmlStudio_githubToken") || "";
        if (githubToken) {
          document.getElementById("githubToken").value = "••••••••••••••••";
          checkGithubConnection();
        }
      }

      function saveGithubToken() {
        const tokenInput = document.getElementById("githubToken");
        const token = tokenInput.value.trim();
        if (!token || token === "••••••••••••••••") {
          showToast("Zadej platný token", "error");
          return;
        }
        githubToken = token;
        localStorage.setItem("htmlStudio_githubToken", token);
        tokenInput.value = "••••••••••••••••";
        checkGithubConnection();

        const disconnectItem = document.getElementById("githubDisconnectItem");
        if (disconnectItem) disconnectItem.style.display = "flex";

        showToast("Token uložen", "success");
      }

      async function checkGithubConnection() {
        if (!githubToken) {
          updateGithubUI(false);
          return;
        }

        try {
          const res = await fetch("https://api.github.com/user", {
            headers: { Authorization: `token ${githubToken}` },
          });
          if (res.ok) {
            githubUser = await res.json();
            updateGithubUI(true);
          } else {
            githubUser = null;
            updateGithubUI(false);
            if (res.status === 401) {
              showToast("Neplatný GitHub token", "error");
            }
          }
        } catch (e) {
          updateGithubUI(false);
        }
      }

      function updateGithubUI(connected) {
        const notConnected = document.getElementById("githubNotConnected");
        const connectedEl = document.getElementById("githubConnected");
        const userEl = document.getElementById("githubUser");
        const disconnectItem = document.getElementById("githubDisconnectItem");

        if (connected && githubUser) {
          notConnected.style.display = "none";
          connectedEl.style.display = "block";
          userEl.innerHTML = `
                    <img src="${githubUser.avatar_url}" class="github-avatar" alt="">
                    <span class="github-username">${githubUser.login}</span>
                `;
          if (disconnectItem) disconnectItem.style.display = "flex";
        } else {
          notConnected.style.display = "block";
          connectedEl.style.display = "none";
          if (disconnectItem) disconnectItem.style.display = "none";
        }
      }

      function disconnectGithub() {
        if (confirm("Opravdu odpojit GitHub? Token bude smazán.")) {
          localStorage.removeItem("htmlStudio_githubToken");
          githubToken = "";
          githubUser = null;
          document.getElementById("githubToken").value = "";
          updateGithubUI(false);
          showToast("GitHub odpojen", "success");
        }
      }

      // Repo Manager
      let repoToDelete = null;

      async function openRepoManager() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }
        document.getElementById("repoManagerModal").classList.add("active");
        loadRepoManager();
      }

      function closeRepoManager() {
        document.getElementById("repoManagerModal").classList.remove("active");
      }

      async function loadRepoManager() {
        const list = document.getElementById("repoManagerList");
        const stats = document.getElementById("repoStats");

        list.innerHTML =
          '<div class="github-loading">Načítám repozitáře...</div>';
        stats.innerHTML = "";

        try {
          const res = await fetch(
            "https://api.github.com/user/repos?sort=updated&per_page=100",
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );
          const repos = await res.json();

          // Stats
          const publicCount = repos.filter((r) => !r.private).length;
          const privateCount = repos.filter((r) => r.private).length;
          const totalSize = repos.reduce((acc, r) => acc + (r.size || 0), 0);

          stats.innerHTML = `
                    <div class="repo-stat">
                        <span class="repo-stat-value">${repos.length}</span>
                        <span class="repo-stat-label">Celkem</span>
                    </div>
                    <div class="repo-stat">
                        <span class="repo-stat-value">${publicCount}</span>
                        <span class="repo-stat-label">Veřejné</span>
                    </div>
                    <div class="repo-stat">
                        <span class="repo-stat-value">${privateCount}</span>
                        <span class="repo-stat-label">Soukromé</span>
                    </div>
                    <div class="repo-stat">
                        <span class="repo-stat-value">${formatFileSize(
                          totalSize * 1024
                        )}</span>
                        <span class="repo-stat-label">Velikost</span>
                    </div>
                `;

          if (repos.length === 0) {
            list.innerHTML =
              '<div class="github-empty">Žádné repozitáře. Vytvoř první!</div>';
            return;
          }

          list.innerHTML = repos
            .map((repo) => {
              const updated = new Date(repo.updated_at).toLocaleDateString(
                "cs-CZ"
              );
              const safeDesc = (repo.description || "")
                .replace(/'/g, "\\'")
                .replace(/"/g, "&quot;");
              return `
                        <div class="repo-card">
                            <div class="repo-card-header">
                                <span class="repo-card-name">${repo.name}</span>
                                <div class="repo-card-badges">
                                    ${
                                      repo.private
                                        ? '<span class="repo-badge private">🔒 Soukromé</span>'
                                        : '<span class="repo-badge">Veřejné</span>'
                                    }
                                </div>
                            </div>
                            ${
                              repo.description
                                ? `<div class="repo-card-desc">${escapeHtml(
                                    repo.description
                                  )}</div>`
                                : ""
                            }
                            <div class="repo-card-meta">
                                <span>📅 ${updated}</span>
                                <span>⭐ ${repo.stargazers_count}</span>
                                <span>📦 ${formatFileSize(
                                  repo.size * 1024
                                )}</span>
                            </div>
                            <div class="repo-card-actions">
                                <button class="repo-action-btn" onclick="loadGithubContents('${
                                  repo.full_name
                                }', ''); closeRepoManager();">
                                    📁
                                </button>
                                <button class="repo-action-btn" onclick="openRepoSettings('${
                                  repo.full_name
                                }', '${repo.name}', '${safeDesc}', ${
                repo.private
              })">
                                    ⚙️
                                </button>
                                <button class="repo-action-btn" onclick="window.open('${
                                  repo.html_url
                                }', '_blank')">
                                    🔗
                                </button>
                                <button class="repo-action-btn danger" onclick="openDeleteRepoModal('${
                                  repo.full_name
                                }', '${repo.name}')">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join("");
        } catch (e) {
          list.innerHTML = '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      function openCreateRepoModal() {
        document.getElementById("newRepoName").value = "";
        document.getElementById("newRepoDesc").value = "";
        document.getElementById("newRepoPrivate").checked = false;
        document.getElementById("newRepoReadme").checked = true;
        document.getElementById("createRepoModal").classList.add("active");
      }

      function closeCreateRepoModal() {
        document.getElementById("createRepoModal").classList.remove("active");
      }

      async function createNewRepo() {
        const name = document.getElementById("newRepoName").value.trim();
        const description = document.getElementById("newRepoDesc").value.trim();
        const isPrivate = document.getElementById("newRepoPrivate").checked;
        const autoInit = document.getElementById("newRepoReadme").checked;

        if (!name) {
          showToast("Zadej název repozitáře", "error");
          return;
        }

        // Validate repo name
        if (!/^[a-zA-Z0-9._-]+$/.test(name)) {
          showToast("Název může obsahovat pouze a-z, 0-9, -, _, .", "error");
          return;
        }

        try {
          showToast("Vytvářím repozitář...", "success");

          const res = await fetch("https://api.github.com/user/repos", {
            method: "POST",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: name,
              description: description,
              private: isPrivate,
              auto_init: autoInit,
            }),
          });

          if (res.ok) {
            const repo = await res.json();
            closeCreateRepoModal();
            loadRepoManager();
            showToast(`Repozitář "${name}" vytvořen!`, "success");
          } else {
            const err = await res.json();
            if (err.errors && err.errors[0]) {
              showToast("Chyba: " + err.errors[0].message, "error");
            } else {
              showToast("Chyba: " + (err.message || "Nelze vytvořit"), "error");
            }
          }
        } catch (e) {
          showToast("Chyba při vytváření", "error");
        }
      }

      function openDeleteRepoModal(fullName, name) {
        repoToDelete = fullName;
        document.getElementById("deleteRepoName").textContent = fullName;
        // Předvyplnit název bez posledních 2 písmen
        const prefilled = name.length > 2 ? name.slice(0, -2) : "";
        document.getElementById("deleteRepoConfirm").value = prefilled;
        document.getElementById("deleteRepoConfirm").placeholder = name;
        document.getElementById("deleteRepoModal").classList.add("active");
      }

      function closeDeleteRepoModal() {
        document.getElementById("deleteRepoModal").classList.remove("active");
        repoToDelete = null;
      }

      async function confirmDeleteRepo() {
        const confirm = document
          .getElementById("deleteRepoConfirm")
          .value.trim();
        const repoName = repoToDelete.split("/")[1];

        if (confirm !== repoName) {
          showToast("Název nesouhlasí", "error");
          return;
        }

        try {
          showToast("Mažu repozitář...", "success");

          const res = await fetch(
            `https://api.github.com/repos/${repoToDelete}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `token ${githubToken}`,
              },
            }
          );

          if (res.ok || res.status === 204) {
            closeDeleteRepoModal();
            loadRepoManager();
            showToast("Repozitář smazán", "success");
          } else {
            const err = await res.json();
            showToast("Chyba: " + (err.message || "Nelze smazat"), "error");
          }
        } catch (e) {
          showToast("Chyba při mazání", "error");
        }
      }

      // ============================================
      // GITHUB PAGES
      // ============================================
      function openGithubPages() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }
        const file = files.find((f) => f.id === activeFileId);
        document.getElementById("pagesRepo").value = file?.githubRepo || "";
        document.getElementById("pagesStatus").innerHTML =
          '<div class="github-empty">Zadej repozitář a klikni Zkontrolovat</div>';
        document.getElementById("githubPagesModal").classList.add("active");

        if (file?.githubRepo) {
          checkPagesStatus();
        }
      }

      function closeGithubPages() {
        document.getElementById("githubPagesModal").classList.remove("active");
      }

      async function checkPagesStatus() {
        const repo = document.getElementById("pagesRepo").value.trim();
        if (!repo) {
          showToast("Zadej repozitář", "error");
          return;
        }

        const statusEl = document.getElementById("pagesStatus");
        statusEl.innerHTML = '<div class="github-loading">Načítám...</div>';

        try {
          const res = await fetch(
            `https://api.github.com/repos/${repo}/pages`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (res.ok) {
            const pages = await res.json();
            const url =
              pages.html_url ||
              `https://${repo.split("/")[0]}.github.io/${repo.split("/")[1]}/`;
            statusEl.innerHTML = `
                        <div class="pages-status">
                            <div class="pages-status-header">
                                <div class="pages-status-icon active">✓</div>
                                <div>
                                    <div class="pages-status-title">Pages aktivní</div>
                                    <div class="pages-status-subtitle">Zdroj: ${
                                      pages.source?.branch || "main"
                                    } / ${pages.source?.path || "/"}</div>
                                </div>
                            </div>
                            <a href="${url}" target="_blank" class="pages-url">${url}</a>
                            <div class="pages-actions">
                                <button class="pages-btn" onclick="window.open('${url}', '_blank')">Otevřít stránku</button>
                                <button class="pages-btn danger" onclick="disablePages('${repo}')">Vypnout</button>
                            </div>
                        </div>
                    `;
          } else if (res.status === 404) {
            statusEl.innerHTML = `
                        <div class="pages-status">
                            <div class="pages-status-header">
                                <div class="pages-status-icon inactive">✗</div>
                                <div>
                                    <div class="pages-status-title">Pages neaktivní</div>
                                    <div class="pages-status-subtitle">GitHub Pages není zapnutý</div>
                                </div>
                            </div>
                            <div class="pages-actions">
                                <button class="pages-btn primary" onclick="enablePages('${repo}')">Zapnout Pages</button>
                            </div>
                        </div>
                    `;
          } else {
            statusEl.innerHTML =
              '<div class="github-empty">Nelze načíst stav Pages</div>';
          }
        } catch (e) {
          statusEl.innerHTML =
            '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      async function enablePages(repo) {
        try {
          showToast("Zapínám Pages...", "success");
          const res = await fetch(
            `https://api.github.com/repos/${repo}/pages`,
            {
              method: "POST",
              headers: {
                Authorization: `token ${githubToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                source: { branch: "main", path: "/" },
              }),
            }
          );

          if (res.ok || res.status === 201) {
            showToast("Pages zapnuty!", "success");
            setTimeout(() => checkPagesStatus(), 1000);
          } else {
            const err = await res.json();
            showToast("Chyba: " + (err.message || "Nelze zapnout"), "error");
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      async function disablePages(repo) {
        if (!confirm("Opravdu vypnout GitHub Pages?")) return;

        try {
          showToast("Vypínám Pages...", "success");
          const res = await fetch(
            `https://api.github.com/repos/${repo}/pages`,
            {
              method: "DELETE",
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (res.ok || res.status === 204) {
            showToast("Pages vypnuty", "success");
            checkPagesStatus();
          } else {
            showToast("Nelze vypnout Pages", "error");
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      // ============================================
      // COMMIT HISTORY
      // ============================================
      function openCommitHistory() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }
        const file = files.find((f) => f.id === activeFileId);
        document.getElementById("historyRepo").value = file?.githubRepo || "";
        document.getElementById("commitList").innerHTML =
          '<div class="github-empty">Zadej repozitář a klikni Načíst</div>';
        document.getElementById("commitHistoryModal").classList.add("active");

        if (file?.githubRepo) {
          loadCommitHistory();
        }
      }

      function closeCommitHistory() {
        document
          .getElementById("commitHistoryModal")
          .classList.remove("active");
      }

      async function loadCommitHistory() {
        const repo = document.getElementById("historyRepo").value.trim();
        if (!repo) {
          showToast("Zadej repozitář", "error");
          return;
        }

        const listEl = document.getElementById("commitList");
        listEl.innerHTML =
          '<div class="github-loading">Načítám commity...</div>';

        try {
          const res = await fetch(
            `https://api.github.com/repos/${repo}/commits?per_page=20`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (!res.ok) {
            listEl.innerHTML =
              '<div class="github-empty">Nelze načíst historii</div>';
            return;
          }

          const commits = await res.json();

          if (commits.length === 0) {
            listEl.innerHTML = '<div class="github-empty">Žádné commity</div>';
            return;
          }

          listEl.innerHTML = commits
            .map((commit) => {
              const date = new Date(commit.commit.author.date).toLocaleString(
                "cs-CZ"
              );
              const sha = commit.sha.substring(0, 7);
              const message = escapeHtml(commit.commit.message.split("\n")[0]);
              const author = commit.author?.login || commit.commit.author.name;
              const avatar = commit.author?.avatar_url || "";

              return `
                        <div class="commit-item" onclick="loadCommitFiles('${repo}', '${
                commit.sha
              }')">
                            <div class="commit-header">
                                <span class="commit-sha">${sha}</span>
                                <span class="commit-date">${date}</span>
                            </div>
                            <div class="commit-message">${message}</div>
                            <div class="commit-author">
                                ${avatar ? `<img src="${avatar}" alt="">` : ""}
                                ${author}
                            </div>
                        </div>
                    `;
            })
            .join("");
        } catch (e) {
          listEl.innerHTML =
            '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      async function loadCommitFiles(repo, sha) {
        try {
          showToast("Načítám soubory...", "success");
          const res = await fetch(
            `https://api.github.com/repos/${repo}/commits/${sha}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (!res.ok) {
            showToast("Nelze načíst commit", "error");
            return;
          }

          const commit = await res.json();
          const files = commit.files || [];

          if (files.length === 0) {
            showToast("Žádné soubory", "error");
            return;
          }

          // Zobrazit soubory v commit itemu
          const listEl = document.getElementById("commitList");
          const items = listEl.querySelectorAll(".commit-item");
          items.forEach((item) => {
            const existingFiles = item.querySelector(".commit-files");
            if (existingFiles) existingFiles.remove();
          });

          // Najít správný commit item
          const commitItems = [...listEl.querySelectorAll(".commit-item")];
          const targetItem = commitItems.find(
            (item) =>
              item.querySelector(".commit-sha")?.textContent ===
              sha.substring(0, 7)
          );

          if (targetItem) {
            const filesHtml = files
              .map((f) => {
                const size = formatFileSize(f.changes || 0);
                const additions = f.additions || 0;
                const deletions = f.deletions || 0;
                return `<button class="commit-file-btn" onclick="event.stopPropagation(); loadFileFromCommit('${repo}', '${sha}', '${
                  f.filename
                }')">
                            📄 ${f.filename.split("/").pop()}
                            <span style="color:var(--success);">+${additions}</span>
                            <span style="color:var(--error);">-${deletions}</span>
                        </button>`;
              })
              .join("");

            targetItem.insertAdjacentHTML(
              "beforeend",
              `<div class="commit-files">${filesHtml}</div>`
            );
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      async function loadFileFromCommit(repo, sha, filename) {
        try {
          showToast("Načítám soubor...", "success");
          const res = await fetch(
            `https://api.github.com/repos/${repo}/contents/${filename}?ref=${sha}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (!res.ok) {
            showToast("Nelze načíst soubor", "error");
            return;
          }

          const fileData = await res.json();
          if (fileData.encoding === "base64") {
            const content = atob(fileData.content);
            const name =
              filename.split("/").pop() + ` (${sha.substring(0, 7)})`;
            const file = createFile(name, content);
            file.githubRepo = repo;
            activeFileId = file.id;
            codeInput.value = file.content;
            renderTabs();
            updatePreview();
            addToHistory("GitHub: " + name);
            closeCommitHistory();
            switchView("code");
            showToast("Soubor načten", "success");
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      // ============================================
      // DIFF VIEW
      // ============================================
      function openDiffView() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }

        const file = files.find((f) => f.id === activeFileId);
        if (!file || !file.githubRepo || !file.githubPath) {
          document.getElementById("diffInfo").innerHTML = "";
          document.getElementById("diffContainer").innerHTML =
            '<div class="github-empty">Není co porovnat. Otevři soubor z GitHubu.</div>';
          document.getElementById("diffViewModal").classList.add("active");
          return;
        }

        document.getElementById("diffViewModal").classList.add("active");
        loadDiff(file);
      }

      function closeDiffView() {
        document.getElementById("diffViewModal").classList.remove("active");
      }

      async function loadDiff(file) {
        const infoEl = document.getElementById("diffInfo");
        const containerEl = document.getElementById("diffContainer");

        infoEl.innerHTML = `<div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">
                📁 ${file.githubRepo} / ${file.githubPath}
            </div>`;
        containerEl.innerHTML =
          '<div class="github-loading">Načítám originál z GitHubu...</div>';

        try {
          const res = await fetch(
            `https://api.github.com/repos/${file.githubRepo}/contents/${file.githubPath}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (!res.ok) {
            containerEl.innerHTML =
              '<div class="github-empty">Nelze načíst originál z GitHubu</div>';
            return;
          }

          const data = await res.json();
          const originalContent =
            data.encoding === "base64" ? atob(data.content) : "";
          const localContent = codeInput.value;

          // Spočítat velikosti
          const originalSize = new Blob([originalContent]).size;
          const localSize = new Blob([localContent]).size;
          const sizeDiff = localSize - originalSize;

          // Vytvořit diff
          const diff = createDiff(originalContent, localContent);

          containerEl.innerHTML = `
                    <div class="diff-stats">
                        <div class="diff-stat added">+ ${
                          diff.additions
                        } přidáno</div>
                        <div class="diff-stat removed">- ${
                          diff.deletions
                        } odebráno</div>
                        <div class="diff-stat size">
                            📦 ${formatFileSize(
                              originalSize
                            )} → ${formatFileSize(localSize)}
                            (${sizeDiff >= 0 ? "+" : ""}${formatFileSize(
            Math.abs(sizeDiff)
          )})
                        </div>
                    </div>
                    <div class="diff-content">${diff.html}</div>
                `;
        } catch (e) {
          containerEl.innerHTML =
            '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      function createDiff(original, modified) {
        const originalLines = original.split("\n");
        const modifiedLines = modified.split("\n");

        let html = "";
        let additions = 0;
        let deletions = 0;

        // Jednoduchý line-by-line diff
        const maxLines = Math.max(originalLines.length, modifiedLines.length);

        let i = 0,
          j = 0;

        while (i < originalLines.length || j < modifiedLines.length) {
          const origLine = originalLines[i] || "";
          const modLine = modifiedLines[j] || "";

          if (i >= originalLines.length) {
            // Přidané řádky na konci
            html += `<div class="diff-line added"><span class="diff-line-number">+${
              j + 1
            }</span>${escapeHtml(modLine)}</div>`;
            additions++;
            j++;
          } else if (j >= modifiedLines.length) {
            // Odebrané řádky na konci
            html += `<div class="diff-line removed"><span class="diff-line-number">-${
              i + 1
            }</span>${escapeHtml(origLine)}</div>`;
            deletions++;
            i++;
          } else if (origLine === modLine) {
            // Stejné řádky
            html += `<div class="diff-line context"><span class="diff-line-number">${
              i + 1
            }</span>${escapeHtml(origLine)}</div>`;
            i++;
            j++;
          } else {
            // Změněné řádky
            html += `<div class="diff-line removed"><span class="diff-line-number">-${
              i + 1
            }</span>${escapeHtml(origLine)}</div>`;
            html += `<div class="diff-line added"><span class="diff-line-number">+${
              j + 1
            }</span>${escapeHtml(modLine)}</div>`;
            deletions++;
            additions++;
            i++;
            j++;
          }
        }

        if (additions === 0 && deletions === 0) {
          html =
            '<div class="diff-line context" style="text-align:center;padding:20px;color:var(--text-muted);">Žádné změny</div>';
        }

        return { html, additions, deletions };
      }

      // ============================================
      // GISTS
      // ============================================
      function openGistManager() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }
        document.getElementById("gistManagerModal").classList.add("active");
        loadGists();
      }

      function closeGistManager() {
        document.getElementById("gistManagerModal").classList.remove("active");
      }

      async function loadGists() {
        const listEl = document.getElementById("gistList");
        listEl.innerHTML = '<div class="github-loading">Načítám gists...</div>';

        try {
          const res = await fetch("https://api.github.com/gists?per_page=30", {
            headers: { Authorization: `token ${githubToken}` },
          });

          if (!res.ok) {
            listEl.innerHTML =
              '<div class="github-empty">Nelze načíst gists</div>';
            return;
          }

          const gists = await res.json();

          if (gists.length === 0) {
            listEl.innerHTML =
              '<div class="github-empty">Žádné gists. Vytvoř první!</div>';
            return;
          }

          listEl.innerHTML = gists
            .map((gist) => {
              const files = Object.keys(gist.files);
              const filename = files[0] || "untitled";
              const fileCount = files.length;
              const date = new Date(gist.created_at).toLocaleDateString(
                "cs-CZ"
              );
              const isPublic = gist.public;

              return `
                        <div class="gist-item">
                            <div class="gist-header">
                                <span class="gist-filename">${escapeHtml(
                                  filename
                                )}${
                fileCount > 1 ? ` (+${fileCount - 1})` : ""
              }</span>
                                <span class="gist-badge ${
                                  isPublic ? "public" : ""
                                }">${isPublic ? "Veřejný" : "Soukromý"}</span>
                            </div>
                            ${
                              gist.description
                                ? `<div class="gist-desc">${escapeHtml(
                                    gist.description
                                  )}</div>`
                                : ""
                            }
                            <div class="gist-meta">📅 ${date}</div>
                            <div class="gist-actions">
                                <button class="gist-action-btn" onclick="loadGistFile('${
                                  gist.id
                                }', '${filename}')">
                                    📥 Načíst
                                </button>
                                <button class="gist-action-btn" onclick="copyGistUrl('${
                                  gist.html_url
                                }')">
                                    🔗 Kopírovat URL
                                </button>
                                <button class="gist-action-btn" onclick="window.open('${
                                  gist.html_url
                                }', '_blank')">
                                    🌐 Otevřít
                                </button>
                                <button class="gist-action-btn danger" onclick="deleteGist('${
                                  gist.id
                                }')">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
            })
            .join("");
        } catch (e) {
          listEl.innerHTML =
            '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      function openCreateGistModal() {
        const file = files.find((f) => f.id === activeFileId);
        document.getElementById("gistFilename").value =
          file?.name || "index.html";
        document.getElementById("gistDescription").value = "";
        document.getElementById("gistPublic").checked = true;
        document.getElementById("createGistModal").classList.add("active");
      }

      function closeCreateGistModal() {
        document.getElementById("createGistModal").classList.remove("active");
      }

      async function createGist() {
        const filename =
          document.getElementById("gistFilename").value.trim() || "index.html";
        const description = document
          .getElementById("gistDescription")
          .value.trim();
        const isPublic = document.getElementById("gistPublic").checked;
        const content = codeInput.value;

        if (!content) {
          showToast("Soubor je prázdný", "error");
          return;
        }

        try {
          showToast("Vytvářím gist...", "success");

          const res = await fetch("https://api.github.com/gists", {
            method: "POST",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              description: description,
              public: isPublic,
              files: {
                [filename]: { content: content },
              },
            }),
          });

          if (res.ok) {
            const gist = await res.json();
            closeCreateGistModal();
            loadGists();

            // Kopírovat URL do schránky
            navigator.clipboard
              .writeText(gist.html_url)
              .then(() => {
                showToast("Gist vytvořen! URL zkopírována.", "success");
              })
              .catch(() => {
                showToast("Gist vytvořen!", "success");
              });
          } else {
            const err = await res.json();
            showToast("Chyba: " + (err.message || "Nelze vytvořit"), "error");
          }
        } catch (e) {
          showToast("Chyba při vytváření", "error");
        }
      }

      async function loadGistFile(gistId, filename) {
        try {
          showToast("Načítám gist...", "success");
          const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            headers: { Authorization: `token ${githubToken}` },
          });

          if (!res.ok) {
            showToast("Nelze načíst gist", "error");
            return;
          }

          const gist = await res.json();
          const fileData = gist.files[filename];

          if (fileData && fileData.content) {
            const file = createFile(filename, fileData.content);
            file.gistId = gistId;
            activeFileId = file.id;
            codeInput.value = file.content;
            renderTabs();
            updatePreview();
            addToHistory("Gist: " + filename);
            closeGistManager();
            switchView("code");
            showToast("Gist načten", "success");
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      function copyGistUrl(url) {
        navigator.clipboard
          .writeText(url)
          .then(() => {
            showToast("URL zkopírována", "success");
          })
          .catch(() => {
            showToast("Nelze kopírovat", "error");
          });
      }

      async function deleteGist(gistId) {
        if (!confirm("Smazat tento gist?")) return;

        try {
          showToast("Mažu gist...", "success");
          const res = await fetch(`https://api.github.com/gists/${gistId}`, {
            method: "DELETE",
            headers: { Authorization: `token ${githubToken}` },
          });

          if (res.ok || res.status === 204) {
            loadGists();
            showToast("Gist smazán", "success");
          } else {
            showToast("Nelze smazat", "error");
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      // ============================================
      // REPO SETTINGS
      // ============================================
      let currentRepoSettings = null;

      function openRepoSettings(fullName, name, description, isPrivate) {
        currentRepoSettings = fullName;
        document.getElementById("repoSettingsFullName").value = fullName;
        document.getElementById("repoSettingsName").value = name;
        document.getElementById("repoSettingsDesc").value = description.replace(
          /&quot;/g,
          '"'
        );
        document.getElementById("repoSettingsPrivate").checked = isPrivate;
        document.getElementById("repoSettingsTopics").value = "";
        document.getElementById("repoSettingsModal").classList.add("active");

        // Načíst topics
        loadRepoTopics(fullName);
      }

      function closeRepoSettings() {
        document.getElementById("repoSettingsModal").classList.remove("active");
        currentRepoSettings = null;
      }

      async function loadRepoTopics(fullName) {
        try {
          const res = await fetch(
            `https://api.github.com/repos/${fullName}/topics`,
            {
              headers: {
                Authorization: `token ${githubToken}`,
                Accept: "application/vnd.github.mercy-preview+json",
              },
            }
          );
          if (res.ok) {
            const data = await res.json();
            document.getElementById("repoSettingsTopics").value = (
              data.names || []
            ).join(", ");
          }
        } catch (e) {
          // Ignore error
        }
      }

      async function saveRepoSettings() {
        const fullName = document.getElementById("repoSettingsFullName").value;
        const newName = document
          .getElementById("repoSettingsName")
          .value.trim();
        const description = document
          .getElementById("repoSettingsDesc")
          .value.trim();
        const isPrivate = document.getElementById(
          "repoSettingsPrivate"
        ).checked;
        const topicsStr = document
          .getElementById("repoSettingsTopics")
          .value.trim();
        const topics = topicsStr
          ? topicsStr
              .split(",")
              .map((t) => t.trim().toLowerCase())
              .filter((t) => t)
          : [];

        if (!newName) {
          showToast("Zadej název repozitáře", "error");
          return;
        }

        try {
          showToast("Ukládám...", "success");

          // Aktualizace repo
          const res = await fetch(`https://api.github.com/repos/${fullName}`, {
            method: "PATCH",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: newName,
              description: description,
              private: isPrivate,
            }),
          });

          if (!res.ok) {
            const err = await res.json();
            showToast("Chyba: " + (err.message || "Nelze uložit"), "error");
            return;
          }

          // Aktualizace topics
          const owner = fullName.split("/")[0];
          const newFullName = `${owner}/${newName}`;

          await fetch(`https://api.github.com/repos/${newFullName}/topics`, {
            method: "PUT",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json",
              Accept: "application/vnd.github.mercy-preview+json",
            },
            body: JSON.stringify({ names: topics }),
          });

          closeRepoSettings();
          loadRepoManager();
          showToast("Nastavení uloženo!", "success");
        } catch (e) {
          showToast("Chyba při ukládání", "error");
        }
      }

      // ============================================
      // FORK
      // ============================================
      function openForkModal() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }
        document.getElementById("forkRepoName").value = "";
        document.getElementById("forkModal").classList.add("active");
      }

      function closeForkModal() {
        document.getElementById("forkModal").classList.remove("active");
      }

      async function forkRepo() {
        const repoName = document.getElementById("forkRepoName").value.trim();

        if (!repoName || !repoName.includes("/")) {
          showToast("Zadej repozitář ve formátu owner/repo", "error");
          return;
        }

        try {
          showToast("Vytvářím fork...", "success");

          const res = await fetch(
            `https://api.github.com/repos/${repoName}/forks`,
            {
              method: "POST",
              headers: {
                Authorization: `token ${githubToken}`,
                "Content-Type": "application/json",
              },
            }
          );

          if (res.ok || res.status === 202) {
            const fork = await res.json();
            closeForkModal();
            showToast(`Fork vytvořen: ${fork.full_name}`, "success");

            // Otevřít fork v prohlížeči po chvíli
            setTimeout(() => {
              if (confirm("Fork vytvořen! Otevřít ho teď?")) {
                loadGithubContents(fork.full_name, "");
                document
                  .getElementById("githubBrowserModal")
                  .classList.add("active");
              }
            }, 500);
          } else {
            const err = await res.json();
            if (res.status === 404) {
              showToast("Repozitář nenalezen", "error");
            } else {
              showToast("Chyba: " + (err.message || "Nelze forknout"), "error");
            }
          }
        } catch (e) {
          showToast("Chyba při vytváření forku", "error");
        }
      }

      // ============================================
      // THEME SWITCHING
      // ============================================
      let currentTheme = localStorage.getItem("htmlStudio_theme") || "dark";

      function setTheme(theme) {
        currentTheme = theme;
        localStorage.setItem("htmlStudio_theme", theme);

        if (theme === "light") {
          document.body.classList.add("light-theme");
          document.getElementById("themeLight")?.classList.add("active");
          document.getElementById("themeDark")?.classList.remove("active");
        } else {
          document.body.classList.remove("light-theme");
          document.getElementById("themeDark")?.classList.add("active");
          document.getElementById("themeLight")?.classList.remove("active");
        }
      }

      // Apply saved theme on load
      if (currentTheme === "light") {
        document.body.classList.add("light-theme");
      }

      // ============================================
      // MINIMAP
      // ============================================
      let minimapEnabled =
        localStorage.getItem("htmlStudio_minimap") === "true";

      function toggleMinimap() {
        const checkbox = document.getElementById("minimapToggle");
        minimapEnabled = checkbox?.checked || false;
        localStorage.setItem("htmlStudio_minimap", minimapEnabled);

        const minimap = document.getElementById("minimap");
        if (minimap) {
          minimap.classList.toggle("active", minimapEnabled);
          if (minimapEnabled) updateMinimap();
        }
      }

      function updateMinimap() {
        if (!minimapEnabled) return;

        const minimap = document.getElementById("minimap");
        const content = document.getElementById("minimapContent");
        const viewport = document.getElementById("minimapViewport");

        if (!minimap || !content || !viewport) return;

        // Update content
        content.textContent = codeInput.value;

        // Update viewport position
        const scrollRatio =
          codeInput.scrollTop /
          (codeInput.scrollHeight - codeInput.clientHeight || 1);
        const visibleRatio = codeInput.clientHeight / codeInput.scrollHeight;

        const minimapHeight = minimap.clientHeight;
        const viewportHeight = Math.max(20, minimapHeight * visibleRatio);
        const viewportTop = (minimapHeight - viewportHeight) * scrollRatio;

        viewport.style.height = viewportHeight + "px";
        viewport.style.top = viewportTop + "px";
      }

      // ============================================
      // EMMET SUPPORT
      // ============================================
      const emmetAbbreviations = {
        "!": '<!DOCTYPE html>\n<html lang="cs">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n</head>\n<body>\n    \n</body>\n</html>',
        "html:5":
          '<!DOCTYPE html>\n<html lang="cs">\n<head>\n    <meta charset="UTF-8">\n    <meta name="viewport" content="width=device-width, initial-scale=1.0">\n    <title>Document</title>\n</head>\n<body>\n    \n</body>\n</html>',
        "link:css": '<link rel="stylesheet" href="style.css">',
        "script:src": '<script src="script.js"><' + "/script>",
        "a:link": '<a href="http://"></a>',
        "a:mail": '<a href="mailto:"></a>',
        img: '<img src="" alt="">',
        "input:text": '<input type="text" name="" id="">',
        "input:email": '<input type="email" name="" id="">',
        "input:password": '<input type="password" name="" id="">',
        "input:submit": '<input type="submit" value="">',
        btn: '<button type="button"></button>',
        "btn:s": '<button type="submit"></button>',
        "form:get": '<form action="" method="get"></form>',
        "form:post": '<form action="" method="post"></form>',
      };

      function expandEmmet(abbr) {
        // Check simple abbreviations first
        if (emmetAbbreviations[abbr]) {
          return emmetAbbreviations[abbr];
        }

        // Parse complex Emmet syntax
        // Pattern: tag.class#id*count>child
        const match = abbr.match(
          /^(\w+)((?:\.[a-zA-Z0-9_-]+)*)(#[a-zA-Z0-9_-]+)?(?:\*(\d+))?(?:>(.+))?$/
        );

        if (!match) return null;

        const [, tag, classes, id, count, child] = match;
        const num = parseInt(count) || 1;

        let classStr = classes
          ? ' class="' + classes.replace(/\./g, " ").trim() + '"'
          : "";
        let idStr = id ? ' id="' + id.substring(1) + '"' : "";

        const selfClosing = [
          "img",
          "br",
          "hr",
          "input",
          "meta",
          "link",
        ].includes(tag);

        let result = "";
        for (let i = 0; i < num; i++) {
          if (selfClosing) {
            result += "<" + tag + classStr + idStr + ">\n";
          } else {
            let inner = child ? expandEmmet(child) || "" : "";
            result +=
              "<" + tag + classStr + idStr + ">" + inner + "</" + tag + ">\n";
          }
        }

        return result.trim();
      }

      function handleEmmetExpand(e) {
        if (e.key !== "Tab") return false;

        const pos = codeInput.selectionStart;
        const text = codeInput.value;

        // Find abbreviation before cursor
        let start = pos - 1;
        while (start >= 0 && /[a-zA-Z0-9.#:*>_-]/.test(text[start])) {
          start--;
        }
        start++;

        const abbr = text.substring(start, pos);
        if (!abbr || abbr.length < 1) return false;

        const expanded = expandEmmet(abbr);
        if (!expanded) return false;

        e.preventDefault();

        const before = text.substring(0, start);
        const after = text.substring(pos);
        codeInput.value = before + expanded + after;

        // Position cursor
        const cursorPos = (before + expanded).length;
        codeInput.selectionStart = codeInput.selectionEnd = cursorPos;

        updatePreview();
        markUnsaved();
        updateLineNumbers(codeInput, lineNumbers);

        showToast("Emmet: " + abbr, "success");
        return true;
      }

      codeInput.addEventListener("keydown", (e) => {
        if (e.key === "Tab" && !e.shiftKey) {
          if (handleEmmetExpand(e)) return;
        }
      });

      // ============================================
      // AUTOCOMPLETE
      // ============================================
      const htmlTags = [
        "div",
        "span",
        "p",
        "a",
        "img",
        "ul",
        "ol",
        "li",
        "table",
        "tr",
        "td",
        "th",
        "form",
        "input",
        "button",
        "label",
        "select",
        "option",
        "textarea",
        "header",
        "footer",
        "nav",
        "main",
        "section",
        "article",
        "aside",
        "h1",
        "h2",
        "h3",
        "h4",
        "h5",
        "h6",
        "strong",
        "em",
        "br",
        "hr",
        "video",
        "audio",
        "canvas",
        "svg",
        "script",
        "style",
        "link",
        "meta",
      ];

      const cssProperties = [
        "display",
        "position",
        "width",
        "height",
        "margin",
        "padding",
        "background",
        "background-color",
        "color",
        "font-size",
        "font-family",
        "font-weight",
        "text-align",
        "border",
        "border-radius",
        "flex",
        "flex-direction",
        "justify-content",
        "align-items",
        "gap",
        "grid",
        "grid-template-columns",
        "overflow",
        "opacity",
        "transform",
        "transition",
        "animation",
        "box-shadow",
        "z-index",
        "cursor",
        "visibility",
      ];

      const autocompletePopup = document.getElementById("autocompletePopup");
      let autocompleteItems = [];
      let autocompleteIndex = -1;
      let autocompleteStart = 0;

      function showAutocomplete(items, x, y) {
        if (items.length === 0) {
          hideAutocomplete();
          return;
        }

        autocompleteItems = items;
        autocompleteIndex = 0;

        autocompletePopup.innerHTML = items
          .map(
            (item, i) =>
              '<div class="autocomplete-item' +
              (i === 0 ? " selected" : "") +
              '" data-index="' +
              i +
              '">' +
              '<span class="tag">' +
              item.label +
              "</span>" +
              (item.detail
                ? '<span class="value">' + item.detail + "</span>"
                : "") +
              "</div>"
          )
          .join("");

        autocompletePopup.style.left =
          Math.min(x, window.innerWidth - 200) + "px";
        autocompletePopup.style.top =
          Math.min(y, window.innerHeight - 220) + "px";
        autocompletePopup.classList.add("active");

        // Click handler
        autocompletePopup
          .querySelectorAll(".autocomplete-item")
          .forEach((item) => {
            item.addEventListener("click", () => {
              applyAutocomplete(parseInt(item.dataset.index));
            });
          });
      }

      function hideAutocomplete() {
        autocompletePopup.classList.remove("active");
        autocompleteItems = [];
        autocompleteIndex = -1;
      }

      function applyAutocomplete(index) {
        const item = autocompleteItems[index];
        if (!item) return;

        const text = codeInput.value;
        const before = text.substring(0, autocompleteStart);
        const after = text.substring(codeInput.selectionStart);

        codeInput.value = before + item.insert + after;
        codeInput.selectionStart = codeInput.selectionEnd =
          autocompleteStart + item.insert.length;

        hideAutocomplete();
        updatePreview();
        markUnsaved();
        updateLineNumbers(codeInput, lineNumbers);
        codeInput.focus();
      }

      function handleAutocompleteKey(e) {
        if (!autocompletePopup.classList.contains("active")) return false;

        if (e.key === "ArrowDown") {
          e.preventDefault();
          autocompleteIndex =
            (autocompleteIndex + 1) % autocompleteItems.length;
          updateAutocompleteSelection();
          return true;
        }
        if (e.key === "ArrowUp") {
          e.preventDefault();
          autocompleteIndex =
            (autocompleteIndex - 1 + autocompleteItems.length) %
            autocompleteItems.length;
          updateAutocompleteSelection();
          return true;
        }
        if (e.key === "Enter" || e.key === "Tab") {
          e.preventDefault();
          applyAutocomplete(autocompleteIndex);
          return true;
        }
        if (e.key === "Escape") {
          hideAutocomplete();
          return true;
        }
        return false;
      }

      function updateAutocompleteSelection() {
        autocompletePopup
          .querySelectorAll(".autocomplete-item")
          .forEach((item, i) => {
            item.classList.toggle("selected", i === autocompleteIndex);
          });
      }

      function checkAutocomplete() {
        const pos = codeInput.selectionStart;
        const text = codeInput.value;

        // Find word before cursor
        let start = pos - 1;
        while (start >= 0 && /[a-zA-Z0-9-]/.test(text[start])) {
          start--;
        }
        start++;

        const word = text.substring(start, pos).toLowerCase();
        if (word.length < 2) {
          hideAutocomplete();
          return;
        }

        autocompleteStart = start;

        // Determine context (HTML or CSS)
        const beforeCursor = text.substring(0, pos);
        const inStyle =
          (beforeCursor.match(/<style/gi) || []).length >
          (beforeCursor.match(/<\/style/gi) || []).length;
        const inStyleAttr = /style\s*=\s*["'][^"']*$/.test(beforeCursor);

        let items = [];

        if (inStyle || inStyleAttr) {
          // CSS context
          items = cssProperties
            .filter((p) => p.startsWith(word))
            .slice(0, 8)
            .map((p) => ({ label: p, insert: p + ": ", detail: "CSS" }));
        } else if (text[start - 1] === "<") {
          // HTML tag context
          items = htmlTags
            .filter((t) => t.startsWith(word))
            .slice(0, 8)
            .map((t) => ({ label: t, insert: t, detail: "tag" }));
        }

        if (items.length > 0) {
          // Get cursor position
          const rect = codeInput.getBoundingClientRect();
          const lineHeight = 22.4;
          const lines = text.substring(0, pos).split("\n");
          const line = lines.length - 1;
          const col = lines[lines.length - 1].length;

          const x = rect.left + 60 + col * 8.4;
          const y =
            rect.top +
            16 +
            line * lineHeight -
            codeInput.scrollTop +
            lineHeight;

          showAutocomplete(items, x, y);
        } else {
          hideAutocomplete();
        }
      }

      codeInput.addEventListener("keydown", (e) => {
        if (handleAutocompleteKey(e)) return;
      });

      codeInput.addEventListener("input", () => {
        setTimeout(checkAutocomplete, 50);
      });

      codeInput.addEventListener("blur", () => {
        setTimeout(hideAutocomplete, 200);
      });

      // ============================================
      // DRAG & DROP FILES
      // ============================================
      const dropOverlay = document.getElementById("dropOverlay");
      const supportedExtensions = [
        "html",
        "htm",
        "css",
        "js",
        "json",
        "txt",
        "md",
        "xml",
        "svg",
        "php",
        "jsx",
        "ts",
        "tsx",
        "vue",
        "scss",
        "sass",
        "less",
      ];

      document.addEventListener("dragenter", (e) => {
        e.preventDefault();
        if (e.dataTransfer.types.includes("Files")) {
          dropOverlay.classList.add("active");
        }
      });

      document.addEventListener("dragover", (e) => {
        e.preventDefault();
      });

      document.addEventListener("dragleave", (e) => {
        if (
          e.relatedTarget === null ||
          !document.body.contains(e.relatedTarget)
        ) {
          dropOverlay.classList.remove("active");
        }
      });

      document.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropOverlay.classList.remove("active");

        const files = Array.from(e.dataTransfer.files);
        if (files.length === 0) return;

        let loadedCount = 0;

        for (const file of files) {
          const ext = file.name.split(".").pop().toLowerCase();

          if (!supportedExtensions.includes(ext)) {
            showToast("Nepodporovaný typ: " + file.name, "warning");
            continue;
          }

          try {
            const content = await file.text();
            const newFile = createFile(file.name, content);
            loadedCount++;
          } catch (err) {
            showToast("Chyba při čtení: " + file.name, "error");
          }
        }

        if (loadedCount > 0) {
          const lastFile = files[files.length - 1];
          if (lastFile) {
            activeFileId = lastFile.id;
            codeInput.value = lastFile.content;
          }
          renderTabs();
          renderFilesList();
          updatePreview();
          updateLineNumbers(codeInput, lineNumbers);
          showToast("Načteno " + loadedCount + " souborů", "success");
        }
      });

      // ============================================
      // SYNTAX HIGHLIGHTING
      // ============================================
      let syntaxEnabled = localStorage.getItem("htmlStudio_syntax") !== "false";
      const syntaxHighlight = document.getElementById("syntaxHighlight");

      function highlightSyntax(code, cursorPos = -1) {
        if (!syntaxEnabled || !syntaxHighlight) return;

        // Escape HTML
        let html = code
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;");

        // Detect file type
        const file = files.find((f) => f.id === activeFileId);
        const fileName = file?.name || "";
        const isCSS = fileName.endsWith(".css");
        const isJS =
          fileName.endsWith(".js") ||
          fileName.endsWith(".jsx") ||
          fileName.endsWith(".ts");

        if (isCSS) {
          html = highlightCSS(html);
        } else if (isJS) {
          html = highlightJS(html);
        } else {
          html = highlightHTML(html);
        }

        // Bracket matching
        if (cursorPos >= 0) {
          html = addBracketMatching(code, html, cursorPos);
        }

        syntaxHighlight.innerHTML = html;
      }

      function highlightHTML(code) {
        // Comments
        code = code.replace(
          /&lt;!--[\s\S]*?--&gt;/g,
          '<span class="comment">$&</span>'
        );

        // DOCTYPE
        code = code.replace(
          /(&lt;!DOCTYPE[^&]*&gt;)/gi,
          '<span class="doctype">$1</span>'
        );

        // Tags with attributes
        code = code.replace(
          /(&lt;\/?)([\w-]+)((?:\s+[\w-]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s&]+))?)*\s*\/?)(&gt;)/g,
          function (match, open, tag, attrs, close) {
            let result = '<span class="punctuation">' + open + "</span>";
            result += '<span class="tag">' + tag + "</span>";

            if (attrs) {
              // Parse attributes
              attrs = attrs.replace(
                /([\w-]+)(\s*=\s*)("[^"]*"|'[^']*')/g,
                '<span class="attr-name">$1</span><span class="punctuation">$2</span><span class="attr-value">$3</span>'
              );
              attrs = attrs.replace(
                /([\w-]+)(\s*=\s*)([^\s&"']+)/g,
                '<span class="attr-name">$1</span><span class="punctuation">$2</span><span class="attr-value">$3</span>'
              );
              result += attrs;
            }

            result += '<span class="punctuation">' + close + "</span>";
            return result;
          }
        );

        // Embedded CSS in style tags
        code = code.replace(
          /(&lt;style[^&]*&gt;)([\s\S]*?)(&lt;\/style&gt;)/gi,
          function (match, open, css, close) {
            return open + highlightCSS(css) + close;
          }
        );

        // Embedded JS in script tags
        code = code.replace(
          /(&lt;script[^&]*&gt;)([\s\S]*?)(&lt;\/script&gt;)/gi,
          function (match, open, js, close) {
            return open + highlightJS(js) + close;
          }
        );

        return code;
      }

      function highlightCSS(code) {
        // Comments
        code = code.replace(
          /(\/\*[\s\S]*?\*\/)/g,
          '<span class="comment">$1</span>'
        );

        // Selectors (before {)
        code = code.replace(
          /([.#]?[\w-]+(?:\s*,\s*[.#]?[\w-]+)*)\s*(\{)/g,
          '<span class="selector">$1</span><span class="punctuation">$2</span>'
        );

        // Properties and values
        code = code.replace(
          /([\w-]+)(\s*:\s*)([^;{}]+)(;?)/g,
          function (match, prop, colon, value, semi) {
            // Highlight numbers and units
            value = value.replace(
              /(\d+\.?\d*)(px|em|rem|%|vh|vw|s|ms|deg)?/g,
              '<span class="number">$1</span><span class="unit">$2</span>'
            );
            // Highlight colors
            value = value.replace(
              /(#[0-9a-fA-F]{3,8})/g,
              '<span class="value">$1</span>'
            );

            return (
              '<span class="property">' +
              prop +
              "</span>" +
              '<span class="punctuation">' +
              colon +
              "</span>" +
              value +
              '<span class="punctuation">' +
              semi +
              "</span>"
            );
          }
        );

        return code;
      }

      function highlightJS(code) {
        // Comments
        code = code.replace(/(\/\/[^\n]*)/g, '<span class="comment">$1</span>');
        code = code.replace(
          /(\/\*[\s\S]*?\*\/)/g,
          '<span class="comment">$1</span>'
        );

        // Strings
        code = code.replace(
          /("[^"\\]*(?:\\.[^"\\]*)*")/g,
          '<span class="string">$1</span>'
        );
        code = code.replace(
          /('[^'\\]*(?:\\.[^'\\]*)*')/g,
          '<span class="string">$1</span>'
        );
        code = code.replace(
          /(`[^`\\]*(?:\\.[^`\\]*)*`)/g,
          '<span class="string">$1</span>'
        );

        // Keywords
        const keywords = [
          "const",
          "let",
          "var",
          "function",
          "return",
          "if",
          "else",
          "for",
          "while",
          "do",
          "switch",
          "case",
          "break",
          "continue",
          "try",
          "catch",
          "finally",
          "throw",
          "class",
          "extends",
          "new",
          "this",
          "super",
          "import",
          "export",
          "from",
          "default",
          "async",
          "await",
          "yield",
          "typeof",
          "instanceof",
          "in",
          "of",
          "delete",
          "void",
          "true",
          "false",
          "null",
          "undefined",
          "NaN",
          "Infinity",
        ];
        keywords.forEach((kw) => {
          const regex = new RegExp("\\b(" + kw + ")\\b", "g");
          code = code.replace(regex, '<span class="keyword">$1</span>');
        });

        // Functions
        code = code.replace(
          /\b([\w$]+)\s*\(/g,
          '<span class="function">$1</span>('
        );

        // Numbers
        code = code.replace(
          /\b(\d+\.?\d*)\b/g,
          '<span class="number">$1</span>'
        );

        return code;
      }

      function addBracketMatching(originalCode, highlightedCode, cursorPos) {
        const brackets = { "(": ")", "[": "]", "{": "}", "<": ">" };
        const closeBrackets = { ")": "(", "]": "[", "}": "{", ">": "<" };

        const charAtCursor = originalCode[cursorPos];
        const charBefore = originalCode[cursorPos - 1];

        let bracketChar = null;
        let searchForward = true;
        let bracketPos = -1;

        // Check if cursor is at a bracket
        if (brackets[charAtCursor]) {
          bracketChar = charAtCursor;
          bracketPos = cursorPos;
          searchForward = true;
        } else if (closeBrackets[charAtCursor]) {
          bracketChar = charAtCursor;
          bracketPos = cursorPos;
          searchForward = false;
        } else if (brackets[charBefore]) {
          bracketChar = charBefore;
          bracketPos = cursorPos - 1;
          searchForward = true;
        } else if (closeBrackets[charBefore]) {
          bracketChar = charBefore;
          bracketPos = cursorPos - 1;
          searchForward = false;
        }

        if (!bracketChar || bracketPos < 0) return highlightedCode;

        // Find matching bracket
        const targetBracket = searchForward
          ? brackets[bracketChar]
          : closeBrackets[bracketChar];
        const openBracket = searchForward ? bracketChar : targetBracket;
        const closeBracket = searchForward ? targetBracket : bracketChar;

        let depth = 0;
        let matchPos = -1;

        if (searchForward) {
          for (let i = bracketPos; i < originalCode.length; i++) {
            if (originalCode[i] === openBracket) depth++;
            if (originalCode[i] === closeBracket) depth--;
            if (depth === 0) {
              matchPos = i;
              break;
            }
          }
        } else {
          for (let i = bracketPos; i >= 0; i--) {
            if (originalCode[i] === closeBracket) depth++;
            if (originalCode[i] === openBracket) depth--;
            if (depth === 0) {
              matchPos = i;
              break;
            }
          }
        }

        // We found a match - but highlighting in already-processed HTML is complex
        // For simplicity, we'll add a visual indicator through CSS class on the wrapper
        if (matchPos >= 0) {
          codeWrapper.dataset.bracketMatch = "true";
        } else {
          codeWrapper.dataset.bracketMatch = "false";
        }

        return highlightedCode;
      }

      function updateSyntaxHighlight() {
        if (!syntaxEnabled) return;
        const cursorPos = codeInput.selectionStart;
        highlightSyntax(codeInput.value, cursorPos);
      }

      function toggleSyntaxHighlight() {
        const checkbox = document.getElementById("syntaxToggle");
        syntaxEnabled = checkbox ? checkbox.checked : !syntaxEnabled;
        localStorage.setItem("htmlStudio_syntax", syntaxEnabled);

        if (syntaxEnabled) {
          codeWrapper.classList.remove("syntax-off");
          updateSyntaxHighlight();
          showToast("Syntax highlighting zapnut", "success");
        } else {
          codeWrapper.classList.add("syntax-off");
          showToast("Syntax highlighting vypnut", "success");
        }
      }

      // Sync scroll between textarea and highlight
      codeInput.addEventListener("scroll", () => {
        if (syntaxHighlight) {
          syntaxHighlight.scrollTop = codeInput.scrollTop;
          syntaxHighlight.scrollLeft = codeInput.scrollLeft;
        }
      });

      // Update highlight on input
      codeInput.addEventListener("input", () => {
        requestAnimationFrame(updateSyntaxHighlight);
      });

      // Update bracket matching on cursor move
      codeInput.addEventListener("click", updateSyntaxHighlight);
      codeInput.addEventListener("keyup", (e) => {
        if (
          [
            "ArrowLeft",
            "ArrowRight",
            "ArrowUp",
            "ArrowDown",
            "Home",
            "End",
          ].includes(e.key)
        ) {
          updateSyntaxHighlight();
        }
      });

      // ============================================
      // DEPLOY FUNCTIONS
      // ============================================
      let selectedDeployPlatform = "";

      function openDeployModal() {
        selectedDeployPlatform = "";
        document
          .querySelectorAll(".deploy-option")
          .forEach((o) => o.classList.remove("selected"));
        document.getElementById("deployInstructions").innerHTML = "";
        document.getElementById("deployModal").classList.add("active");
      }

      function closeDeployModal() {
        document.getElementById("deployModal").classList.remove("active");
      }

      function selectDeployPlatform(platform) {
        selectedDeployPlatform = platform;

        document
          .querySelectorAll(".deploy-option")
          .forEach((o) => o.classList.remove("selected"));
        document
          .getElementById(
            "deploy" + platform.charAt(0).toUpperCase() + platform.slice(1)
          )
          .classList.add("selected");

        const instructions = document.getElementById("deployInstructions");

        switch (platform) {
          case "vercel":
            instructions.innerHTML = `
                        <div class="deploy-steps">
                            <div class="deploy-step">
                                <div class="deploy-step-num">1</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Nainstaluj Vercel CLI</div>
                                    <div class="deploy-step-code">
                                        <span>npm i -g vercel</span>
                                        <button onclick="copyToClipboard('npm i -g vercel')">📋</button>
                                    </div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">2</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Exportuj projekt jako ZIP</div>
                                    <div class="deploy-step-desc">Použij "Export ZIP" v menu a rozbal do složky</div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">3</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Deploy!</div>
                                    <div class="deploy-step-code">
                                        <span>cd projekt && vercel</span>
                                        <button onclick="copyToClipboard('cd projekt && vercel')">📋</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p style="font-size:12px;color:var(--text-muted);margin-top:12px;">
                            💡 Nebo pushni na GitHub a připoj repo na <a href="https://vercel.com/new" target="_blank" style="color:var(--accent);">vercel.com/new</a>
                        </p>
                    `;
            break;

          case "netlify":
            instructions.innerHTML = `
                        <div class="deploy-steps">
                            <div class="deploy-step">
                                <div class="deploy-step-num">1</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Exportuj projekt jako ZIP</div>
                                    <div class="deploy-step-desc">Použij "Export ZIP" v menu</div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">2</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Jdi na Netlify Drop</div>
                                    <div class="deploy-step-desc">
                                        <a href="https://app.netlify.com/drop" target="_blank" style="color:var(--accent);">app.netlify.com/drop</a>
                                    </div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">3</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Přetáhni složku</div>
                                    <div class="deploy-step-desc">Rozbal ZIP a přetáhni složku na stránku. Hotovo! 🎉</div>
                                </div>
                            </div>
                        </div>
                        <p style="font-size:12px;color:var(--text-muted);margin-top:12px;">
                            💡 Nebo použij CLI: <code style="background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;">npx netlify-cli deploy</code>
                        </p>
                    `;
            break;

          case "github":
            instructions.innerHTML = `
                        <div class="deploy-steps">
                            <div class="deploy-step">
                                <div class="deploy-step-num">1</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Pushni na GitHub</div>
                                    <div class="deploy-step-desc">Použij "Uložit na GitHub" v menu Nástroje</div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">2</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Zapni GitHub Pages</div>
                                    <div class="deploy-step-desc">
                                        Repo → Settings → Pages → Source: "main" branch
                                    </div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">3</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Tvůj web je live!</div>
                                    <div class="deploy-step-code">
                                        <span>https://[user].github.io/[repo]/</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p style="font-size:12px;color:var(--success);margin-top:12px;">
                            ✅ Zdarma pro veřejné repozitáře!
                        </p>
                    `;
            break;

          case "surge":
            instructions.innerHTML = `
                        <div class="deploy-steps">
                            <div class="deploy-step">
                                <div class="deploy-step-num">1</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Nainstaluj Surge</div>
                                    <div class="deploy-step-code">
                                        <span>npm i -g surge</span>
                                        <button onclick="copyToClipboard('npm i -g surge')">📋</button>
                                    </div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">2</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Exportuj a rozbal projekt</div>
                                    <div class="deploy-step-desc">Použij "Export ZIP" a rozbal do složky</div>
                                </div>
                            </div>
                            <div class="deploy-step">
                                <div class="deploy-step-num">3</div>
                                <div class="deploy-step-content">
                                    <div class="deploy-step-title">Deploy!</div>
                                    <div class="deploy-step-code">
                                        <span>cd projekt && surge</span>
                                        <button onclick="copyToClipboard('cd projekt && surge')">📋</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <p style="font-size:12px;color:var(--text-muted);margin-top:12px;">
                            ⚡ Nejrychlejší způsob! Dostaneš URL jako <code>tvuj-projekt.surge.sh</code>
                        </p>
                    `;
            break;
        }
      }

      function openDomainModal() {
        document.getElementById("domainModal").classList.add("active");
      }

      function closeDomainModal() {
        document.getElementById("domainModal").classList.remove("active");
      }

      function copyToClipboard(text) {
        navigator.clipboard
          .writeText(text)
          .then(() => {
            showToast("Zkopírováno!", "success");
          })
          .catch(() => {
            // Fallback
            const textarea = document.createElement("textarea");
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand("copy");
            document.body.removeChild(textarea);
            showToast("Zkopírováno!", "success");
          });
      }

      // ============================================
      // LINE NUMBERS
      // ============================================
      function updateLineNumbers(textarea, lineNumbersEl) {
        if (!textarea || !lineNumbersEl) return;

        const lines = textarea.value.split("\n").length;
        let html = "";
        for (let i = 1; i <= lines; i++) {
          html += "<div>" + i + "</div>";
        }
        lineNumbersEl.innerHTML = html;
      }

      function syncScroll(textarea, lineNumbersEl) {
        if (lineNumbersEl) {
          lineNumbersEl.scrollTop = textarea.scrollTop;
        }
      }

      // Initialize line numbers
      codeInput.addEventListener("input", () =>
        updateLineNumbers(codeInput, lineNumbers)
      );
      codeInput.addEventListener("scroll", () => {
        syncScroll(codeInput, lineNumbers);
        updateMinimap();
      });
      codeWrapper.addEventListener("scroll", () => {
        lineNumbers.scrollTop = codeWrapper.scrollTop;
      });

      // Split view sync
      if (codeInputSplit) {
        codeInputSplit.addEventListener("input", () => {
          updateLineNumbers(codeInputSplit, lineNumbersSplit);
          // Sync with main editor
          const file = files.find((f) => f.id === activeFileId);
          if (file) {
            file.content = codeInputSplit.value;
            codeInput.value = codeInputSplit.value;
            updateLineNumbers(codeInput, lineNumbers);
          }
          updateSplitPreview();
        });
        codeInputSplit.addEventListener("scroll", () =>
          syncScroll(codeInputSplit, lineNumbersSplit)
        );
      }

      // ============================================
      // AUTO TAG PAIRING
      // ============================================
      const tagPairs = {
        "<div": "</div>",
        "<span": "</span>",
        "<p": "</p>",
        "<a": "</a>",
        "<h1": "</h1>",
        "<h2": "</h2>",
        "<h3": "</h3>",
        "<h4": "</h4>",
        "<h5": "</h5>",
        "<h6": "</h6>",
        "<ul": "</ul>",
        "<ol": "</ol>",
        "<li": "</li>",
        "<table": "</table>",
        "<tr": "</tr>",
        "<td": "</td>",
        "<th": "</th>",
        "<thead": "</thead>",
        "<tbody": "</tbody>",
        "<form": "</form>",
        "<button": "</button>",
        "<label": "</label>",
        "<select": "</select>",
        "<option": "</option>",
        "<textarea": "</textarea>",
        "<header": "</header>",
        "<footer": "</footer>",
        "<nav": "</nav>",
        "<main": "</main>",
        "<section": "</section>",
        "<article": "</article>",
        "<aside": "</aside>",
        "<figure": "</figure>",
        "<figcaption": "</figcaption>",
        "<video": "</video>",
        "<audio": "</audio>",
        "<canvas": "</canvas>",
        "<script": "<" + "/script>",
        "<style": "</style>",
        "<title": "</title>",
        "<head": "</head>",
        "<body": "</body>",
        "<html": "</html>",
      };

      function handleAutoClose(e, textarea) {
        if (e.key === ">") {
          const pos = textarea.selectionStart;
          const text = textarea.value;

          // Najdi začátek tagu
          let tagStart = pos - 1;
          while (tagStart >= 0 && text[tagStart] !== "<") {
            tagStart--;
          }

          if (tagStart >= 0) {
            const tagContent = text.substring(tagStart, pos);

            // Zkontroluj jestli to není self-closing nebo end tag
            if (!tagContent.includes("/") && !tagContent.includes("!")) {
              // Najdi název tagu
              const tagMatch = tagContent.match(/<(\w+)/);
              if (tagMatch) {
                const tagName = "<" + tagMatch[1].toLowerCase();
                const closeTag = tagPairs[tagName];

                if (closeTag) {
                  e.preventDefault();
                  const before = text.substring(0, pos);
                  const after = text.substring(pos);
                  textarea.value = before + ">" + closeTag + after;
                  textarea.selectionStart = textarea.selectionEnd = pos + 1;

                  // Sync pokud je split view
                  if (textarea === codeInput && codeInputSplit) {
                    codeInputSplit.value = textarea.value;
                    updateLineNumbers(codeInputSplit, lineNumbersSplit);
                  } else if (textarea === codeInputSplit) {
                    codeInput.value = textarea.value;
                    updateLineNumbers(codeInput, lineNumbers);
                  }

                  updateLineNumbers(
                    textarea,
                    textarea === codeInput ? lineNumbers : lineNumbersSplit
                  );
                  markUnsaved();
                  return true;
                }
              }
            }
          }
        }
        return false;
      }

      codeInput.addEventListener("keydown", (e) =>
        handleAutoClose(e, codeInput)
      );
      if (codeInputSplit) {
        codeInputSplit.addEventListener("keydown", (e) =>
          handleAutoClose(e, codeInputSplit)
        );
      }

      // ============================================
      // AUTOSAVE
      // ============================================
      let autosaveInterval = null;
      let lastSavedContent = "";

      function startAutosave() {
        if (autosaveInterval) clearInterval(autosaveInterval);

        autosaveInterval = setInterval(() => {
          const currentContent = codeInput.value;
          const file = files.find((f) => f.id === activeFileId);

          if (file && currentContent !== lastSavedContent) {
            file.content = currentContent;
            saveAllToLocalStorage();
            lastSavedContent = currentContent;
            showAutosaveIndicator();
          }
        }, 30000); // Každých 30 sekund
      }

      function saveAllToLocalStorage() {
        try {
          const data = {
            files: files.map((f) => ({
              name: f.name,
              content: f.content,
              folderPath: f.folderPath,
              githubRepo: f.githubRepo,
              githubPath: f.githubPath,
            })),
            activeFileId: activeFileId,
          };
          localStorage.setItem("htmlStudio_autosave", JSON.stringify(data));
        } catch (e) {
          console.warn("Autosave failed:", e);
        }
      }

      function loadAutosave() {
        try {
          const saved = localStorage.getItem("htmlStudio_autosave");
          if (saved) {
            const data = JSON.parse(saved);
            if (data.files && data.files.length > 0) {
              if (confirm("Nalezena neuložená práce. Obnovit?")) {
                files.length = 0;
                data.files.forEach((f, i) => {
                  const file = createFile(f.name, f.content);
                  file.folderPath = f.folderPath;
                  file.githubRepo = f.githubRepo;
                  file.githubPath = f.githubPath;
                });
                if (files.length > 0) {
                  activeFileId = files[0].id;
                  codeInput.value = files[0].content;
                  renderTabs();
                  renderFilesList();
                  updatePreview();
                  updateLineNumbers(codeInput, lineNumbers);
                }
              }
            }
          }
        } catch (e) {
          console.warn("Load autosave failed:", e);
        }
      }

      function showAutosaveIndicator() {
        const indicator = document.getElementById("autosaveIndicator");
        if (indicator) {
          indicator.classList.add("show");
          setTimeout(() => indicator.classList.remove("show"), 2000);
        }
      }

      // Start autosave on load
      startAutosave();
      // Check for autosave on load
      setTimeout(loadAutosave, 500);

      // ============================================
      // SPLIT VIEW
      // ============================================
      let splitViewActive = false;

      function toggleSplitView() {
        splitViewActive = !splitViewActive;

        if (splitViewActive) {
          document.getElementById("codeView").classList.remove("active");
          document.getElementById("previewView").classList.remove("active");
          document.getElementById("splitView").classList.add("active");

          // Sync content
          codeInputSplit.value = codeInput.value;
          updateLineNumbers(codeInputSplit, lineNumbersSplit);
          updateSplitPreview();

          // Update bottom nav
          document
            .querySelectorAll(".bottom-nav-item")
            .forEach((i) => i.classList.remove("active"));

          showToast("Split view zapnut", "success");
        } else {
          document.getElementById("splitView").classList.remove("active");
          document.getElementById("codeView").classList.add("active");
          currentView = "code";

          // Sync back
          codeInput.value = codeInputSplit.value;
          updateLineNumbers(codeInput, lineNumbers);
          updatePreview();

          // Update bottom nav
          document
            .querySelectorAll(".bottom-nav-item")
            .forEach((i) => i.classList.remove("active"));
          document
            .querySelector('.bottom-nav-item[onclick*="code"]')
            ?.classList.add("active");

          showToast("Split view vypnut", "success");
        }
      }

      function updateSplitPreview() {
        if (!splitPreviewFrame) return;

        const currentFile = files.find((f) => f.id === activeFileId);
        if (!currentFile) return;

        let htmlContent = codeInputSplit.value;

        // Pokud není HTML, najdi hlavní HTML
        if (!currentFile.name.match(/\.(html?|htm)$/i)) {
          const mainHtml = findMainHtmlFile();
          if (mainHtml) {
            htmlContent = mainHtml.content;
          }
        }

        htmlContent = processHtmlWithFiles(htmlContent);

        const doc = splitPreviewFrame.contentDocument;
        doc.open();
        doc.write(htmlContent);
        doc.close();
      }

      function refreshSplitPreview() {
        updateSplitPreview();
        showToast("Náhled aktualizován", "success");
      }

      // Split divider resize
      const splitDivider = document.getElementById("splitDivider");
      if (splitDivider) {
        let isDragging = false;

        splitDivider.addEventListener("mousedown", (e) => {
          isDragging = true;
          e.preventDefault();
        });

        splitDivider.addEventListener("touchstart", (e) => {
          isDragging = true;
        });

        document.addEventListener("mousemove", (e) => {
          if (!isDragging) return;
          const splitView = document.querySelector(".split-view");
          const splitCode = splitView.querySelector(".split-code");
          const rect = splitView.getBoundingClientRect();
          const percent = ((e.clientX - rect.left) / rect.width) * 100;
          if (percent > 20 && percent < 80) {
            splitCode.style.flex = "none";
            splitCode.style.width = percent + "%";
          }
        });

        document.addEventListener("mouseup", () => (isDragging = false));
        document.addEventListener("touchend", () => (isDragging = false));
      }

      // ============================================
      // EXPORT ZIP
      // ============================================
      async function exportAsZip() {
        if (files.length === 0) {
          showToast("Žádné soubory k exportu", "warning");
          return;
        }

        showToast("Vytvářím ZIP...", "success");

        // Dynamicky načti JSZip
        if (typeof JSZip === "undefined") {
          const script = document.createElement("script");
          script.src =
            "https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js";
          document.head.appendChild(script);

          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }

        try {
          const zip = new JSZip();

          // Přidej všechny soubory
          for (const file of files) {
            const path = file.folderPath
              ? file.folderPath + "/" + file.name
              : file.name;
            zip.file(path, file.content);
          }

          // Vygeneruj ZIP
          const blob = await zip.generateAsync({ type: "blob" });

          // Stáhni
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "projekt.zip";
          a.click();
          URL.revokeObjectURL(url);

          showToast("ZIP stažen!", "success");
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // SCREENSHOT
      // ============================================
      async function takeScreenshot() {
        showToast("Generuji screenshot...", "success");

        // Načti html2canvas
        if (typeof html2canvas === "undefined") {
          const script = document.createElement("script");
          script.src =
            "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js";
          document.head.appendChild(script);

          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }

        try {
          // Vytvoř dočasný iframe pro screenshot
          const iframe = document.createElement("iframe");
          iframe.style.cssText =
            "position:fixed;left:-9999px;width:1200px;height:800px;border:none;";
          document.body.appendChild(iframe);

          const doc = iframe.contentDocument;
          doc.open();
          doc.write(codeInput.value);
          doc.close();

          // Počkej na načtení
          await new Promise((r) => setTimeout(r, 500));

          const canvas = await html2canvas(doc.body, {
            width: 1200,
            height: 800,
            backgroundColor: "#ffffff",
          });

          document.body.removeChild(iframe);

          // Stáhni
          const link = document.createElement("a");
          link.download = "screenshot.png";
          link.href = canvas.toDataURL("image/png");
          link.click();

          showToast("Screenshot stažen!", "success");
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // SHARE AS LINK
      // ============================================
      function shareAsLink() {
        const code = codeInput.value;

        // Komprimuj pomocí LZString (jednoduchá base64 verze)
        const encoded = btoa(unescape(encodeURIComponent(code)));

        // Vytvoř URL
        const baseUrl = window.location.origin + window.location.pathname;
        const shareUrl = baseUrl + "#code=" + encoded;

        document.getElementById("shareUrlInput").value = shareUrl;

        // Velikost
        const sizeKB = (shareUrl.length / 1024).toFixed(1);
        document.getElementById("shareUrlSize").textContent =
          "Velikost URL: " +
          sizeKB +
          " KB" +
          (shareUrl.length > 2000 ? " ⚠️ URL je dlouhá" : "");

        // QR kód (pouze pokud je URL krátká)
        const qrDiv = document.getElementById("shareQR");
        if (shareUrl.length < 2000) {
          generateQRCode(shareUrl, qrDiv);
        } else {
          qrDiv.innerHTML =
            '<p style="color:var(--text-muted);font-size:12px;">URL je příliš dlouhá pro QR kód</p>';
        }

        document.getElementById("shareModal").classList.add("active");
      }

      function closeShareModal() {
        document.getElementById("shareModal").classList.remove("active");
      }

      function copyShareUrl() {
        const input = document.getElementById("shareUrlInput");
        input.select();
        document.execCommand("copy");
        showToast("URL zkopírována!", "success");
      }

      // Jednoduchý QR generátor
      function generateQRCode(text, container) {
        // Použijeme externí API pro jednoduchost
        const qrUrl =
          "https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=" +
          encodeURIComponent(text);
        container.innerHTML =
          '<img src="' + qrUrl + '" alt="QR kód" style="border-radius:8px;">';
      }

      // Načti sdílený kód z URL při startu
      function loadSharedCode() {
        const hash = window.location.hash;
        if (hash.startsWith("#code=")) {
          try {
            const encoded = hash.substring(6);
            const decoded = decodeURIComponent(escape(atob(encoded)));

            // Vytvoř nový soubor s kódem
            const file = createFile("shared.html", decoded);
            activeFileId = file.id;
            codeInput.value = decoded;
            renderTabs();
            updatePreview();
            updateLineNumbers(codeInput, lineNumbers);

            // Vyčisti URL
            history.replaceState(null, "", window.location.pathname);

            showToast("Sdílený kód načten!", "success");
          } catch (e) {
            console.error("Chyba při načítání sdíleného kódu:", e);
          }
        }
      }

      // ============================================
      // CSS GRID/FLEX EDITOR
      // ============================================
      let cssEditorState = {
        layout: "flex",
        flexDirection: "row",
        justifyContent: "flex-start",
        alignItems: "center",
        flexWrap: "nowrap",
        gap: "8px",
        gridTemplateColumns: "1fr 1fr",
        justifyItems: "center",
        itemCount: 5,
      };

      function openCSSEditor() {
        document.getElementById("cssEditorModal").classList.add("active");
        updateCSSPreview();
      }

      function closeCSSEditor() {
        document.getElementById("cssEditorModal").classList.remove("active");
      }

      function setCSSLayout(layout) {
        cssEditorState.layout = layout;

        document
          .getElementById("cssLayoutFlex")
          .classList.toggle("active", layout === "flex");
        document
          .getElementById("cssLayoutGrid")
          .classList.toggle("active", layout === "grid");
        document.getElementById("flexControls").style.display =
          layout === "flex" ? "block" : "none";
        document.getElementById("gridControls").style.display =
          layout === "grid" ? "block" : "none";

        updateCSSPreview();
      }

      function setCSSProp(prop, value) {
        cssEditorState[prop] = value;

        // Aktualizuj aktivní tlačítko
        const group = event.target.closest(".css-control-group");
        if (group) {
          group.querySelectorAll(".css-control-btn").forEach((btn) => {
            btn.classList.toggle("active", btn === event.target);
          });
        }

        updateCSSPreview();
      }

      function setCSSItems(count) {
        cssEditorState.itemCount = count;

        // Aktualizuj aktivní tlačítko
        const group = event.target.closest(".css-control-group");
        if (group) {
          group.querySelectorAll(".css-control-btn").forEach((btn) => {
            btn.classList.toggle("active", btn === event.target);
          });
        }

        updateCSSPreview();
      }

      function updateCSSPreview() {
        const preview = document.getElementById("cssEditorPreview");
        const codeEl = document.getElementById("cssEditorCode");

        // Aktualizuj počet položek
        let itemsHtml = "";
        for (let i = 1; i <= cssEditorState.itemCount; i++) {
          itemsHtml += '<div class="css-editor-item">' + i + "</div>";
        }
        preview.innerHTML = itemsHtml;

        // Aplikuj styly
        let styles = {};
        let cssCode = "";

        if (cssEditorState.layout === "flex") {
          styles = {
            display: "flex",
            flexDirection: cssEditorState.flexDirection,
            justifyContent: cssEditorState.justifyContent,
            alignItems: cssEditorState.alignItems,
            flexWrap: cssEditorState.flexWrap,
            gap: cssEditorState.gap,
          };
          cssCode = `.container {
    display: flex;
    flex-direction: ${cssEditorState.flexDirection};
    justify-content: ${cssEditorState.justifyContent};
    align-items: ${cssEditorState.alignItems};
    flex-wrap: ${cssEditorState.flexWrap};
    gap: ${cssEditorState.gap};
}`;
        } else {
          styles = {
            display: "grid",
            gridTemplateColumns: cssEditorState.gridTemplateColumns,
            gap: cssEditorState.gap,
            justifyItems: cssEditorState.justifyItems,
            alignItems: cssEditorState.alignItems,
          };
          cssCode = `.container {
    display: grid;
    grid-template-columns: ${cssEditorState.gridTemplateColumns};
    gap: ${cssEditorState.gap};
    justify-items: ${cssEditorState.justifyItems};
    align-items: ${cssEditorState.alignItems};
}`;
        }

        Object.assign(preview.style, styles);
        codeEl.textContent = cssCode;
      }

      function insertCSSCode() {
        const code = document.getElementById("cssEditorCode").textContent;

        // Vlož do kódu
        const pos = codeInput.selectionStart;
        const text = codeInput.value;
        codeInput.value =
          text.substring(0, pos) + "\n" + code + "\n" + text.substring(pos);

        closeCSSEditor();
        updatePreview();
        markUnsaved();
        updateLineNumbers(codeInput, lineNumbers);
        showToast("CSS vloženo!", "success");
      }

      // ============================================
      // CONTEXT MENU
      // ============================================
      const contextMenu = document.getElementById("contextMenu");
      let selectionStart = 0;
      let selectionEnd = 0;

      codeInput.addEventListener("contextmenu", function (e) {
        e.preventDefault();

        selectionStart = codeInput.selectionStart;
        selectionEnd = codeInput.selectionEnd;

        if (selectionStart === selectionEnd) {
          // Žádný výběr - skryj menu
          contextMenu.classList.remove("active");
          return;
        }

        // Pozice menu
        const rect = codeInput.getBoundingClientRect();
        let x = e.clientX;
        let y = e.clientY;

        // Ujisti se, že menu nepřesáhne obrazovku
        const menuWidth = 170;
        const menuHeight = 280;

        if (x + menuWidth > window.innerWidth) {
          x = window.innerWidth - menuWidth - 10;
        }
        if (y + menuHeight > window.innerHeight) {
          y = window.innerHeight - menuHeight - 10;
        }

        contextMenu.style.left = x + "px";
        contextMenu.style.top = y + "px";
        contextMenu.classList.add("active");
      });

      // Long press pro mobil
      let longPressTimer;
      codeInput.addEventListener("touchstart", function (e) {
        longPressTimer = setTimeout(() => {
          selectionStart = codeInput.selectionStart;
          selectionEnd = codeInput.selectionEnd;

          if (selectionStart !== selectionEnd) {
            const touch = e.touches[0];
            let x = touch.clientX;
            let y = touch.clientY;

            const menuWidth = 170;
            const menuHeight = 280;

            if (x + menuWidth > window.innerWidth) {
              x = window.innerWidth - menuWidth - 10;
            }
            if (y + menuHeight > window.innerHeight) {
              y = window.innerHeight - menuHeight - 10;
            }

            contextMenu.style.left = x + "px";
            contextMenu.style.top = y + "px";
            contextMenu.classList.add("active");
          }
        }, 500);
      });

      codeInput.addEventListener("touchend", function () {
        clearTimeout(longPressTimer);
      });

      codeInput.addEventListener("touchmove", function () {
        clearTimeout(longPressTimer);
      });

      document.addEventListener("click", function (e) {
        if (!contextMenu.contains(e.target)) {
          contextMenu.classList.remove("active");
        }
      });

      document.addEventListener("touchstart", function (e) {
        if (!contextMenu.contains(e.target) && e.target !== codeInput) {
          contextMenu.classList.remove("active");
        }
      });

      function wrapWithTag(tag) {
        const selected = codeInput.value.substring(
          selectionStart,
          selectionEnd
        );
        const wrapped = `<${tag}>${selected}</${tag}>`;

        codeInput.value =
          codeInput.value.substring(0, selectionStart) +
          wrapped +
          codeInput.value.substring(selectionEnd);
        codeInput.selectionStart = selectionStart;
        codeInput.selectionEnd = selectionStart + wrapped.length;

        updatePreview();
        markUnsaved();
        addToHistory(`Obalit <${tag}>`);
        contextMenu.classList.remove("active");
        codeInput.focus();
      }

      function wrapWithCustomTag() {
        const tag = prompt("Zadej název tagu:", "div");
        if (tag) {
          wrapWithTag(tag.trim());
        }
      }

      function commentSelection() {
        const selected = codeInput.value.substring(
          selectionStart,
          selectionEnd
        );
        const commented = `<!-- ${selected} -->`;

        codeInput.value =
          codeInput.value.substring(0, selectionStart) +
          commented +
          codeInput.value.substring(selectionEnd);

        updatePreview();
        markUnsaved();
        addToHistory("Zakomentovat");
        contextMenu.classList.remove("active");
        codeInput.focus();
      }

      function duplicateSelection() {
        const selected = codeInput.value.substring(
          selectionStart,
          selectionEnd
        );

        codeInput.value =
          codeInput.value.substring(0, selectionEnd) +
          "\n" +
          selected +
          codeInput.value.substring(selectionEnd);

        updatePreview();
        markUnsaved();
        addToHistory("Duplikovat");
        contextMenu.classList.remove("active");
        codeInput.focus();
      }

      function deleteSelection() {
        codeInput.value =
          codeInput.value.substring(0, selectionStart) +
          codeInput.value.substring(selectionEnd);
        codeInput.selectionStart = codeInput.selectionEnd = selectionStart;

        updatePreview();
        markUnsaved();
        addToHistory("Smazat");
        contextMenu.classList.remove("active");
        codeInput.focus();
      }

      // ============================================
      // AUTO CLOSE TAGS
      // ============================================
      const selfClosingTags = [
        "area",
        "base",
        "br",
        "col",
        "embed",
        "hr",
        "img",
        "input",
        "link",
        "meta",
        "param",
        "source",
        "track",
        "wbr",
      ];

      codeInput.addEventListener("keydown", function (e) {
        if (!autoCloseEnabled) return;

        // Auto close tag when typing >
        if (e.key === ">") {
          const cursorPos = codeInput.selectionStart;
          const textBefore = codeInput.value.substring(0, cursorPos);

          // Najdi poslední otevírací tag
          const tagMatch = textBefore.match(/<([a-zA-Z][a-zA-Z0-9]*)\s*[^>]*$/);

          if (tagMatch) {
            const tagName = tagMatch[1].toLowerCase();

            // Nekončí / (není self-closing)
            if (
              !textBefore.endsWith("/") &&
              !selfClosingTags.includes(tagName)
            ) {
              e.preventDefault();

              const closeTag = `></${tagName}>`;
              const before = codeInput.value.substring(0, cursorPos);
              const after = codeInput.value.substring(cursorPos);

              codeInput.value = before + closeTag + after;
              codeInput.selectionStart = codeInput.selectionEnd = cursorPos + 1; // Po >

              updatePreview();
              markUnsaved();
            }
          }
        }
      });

      // ============================================
      // RESPONSIVE PREVIEW
      // ============================================
      function setPreviewSize(size) {
        const wrapper = document.getElementById("previewWrapper");
        const label = document.getElementById("previewSizeLabel");
        const buttons = document.querySelectorAll(".responsive-btn");

        buttons.forEach((btn) => btn.classList.remove("active"));
        document.querySelector(`[data-size="${size}"]`).classList.add("active");

        wrapper.classList.remove("tablet", "mobile");

        if (size === "tablet") {
          wrapper.classList.add("tablet");
          label.textContent = "768px";
        } else if (size === "mobile") {
          wrapper.classList.add("mobile");
          label.textContent = "375px";
        } else {
          label.textContent = "100%";
        }
      }

      // ============================================
      // HTML VALIDATION
      // ============================================
      function validateHTML() {
        document.getElementById("validationModal").classList.add("active");
        const listEl = document.getElementById("validationList");

        const code = codeInput.value;
        const errors = [];
        const warnings = [];

        // Kontrola DOCTYPE
        if (!code.trim().toLowerCase().startsWith("<!doctype")) {
          warnings.push({
            line: 1,
            message: "Chybí <!DOCTYPE html> na začátku dokumentu",
          });
        }

        // Kontrola <html>, <head>, <body>
        if (!/<html[^>]*>/i.test(code)) {
          warnings.push({ line: 1, message: "Chybí <html> tag" });
        }
        if (!/<head[^>]*>/i.test(code)) {
          warnings.push({ line: 1, message: "Chybí <head> tag" });
        }
        if (!/<body[^>]*>/i.test(code)) {
          warnings.push({ line: 1, message: "Chybí <body> tag" });
        }

        // Kontrola <title>
        if (!/<title[^>]*>.*<\/title>/i.test(code)) {
          warnings.push({ line: 1, message: "Chybí <title> tag v hlavičce" });
        }

        // Kontrola nezavřených tagů
        const tagStack = [];
        const tagRegex = /<\/?([a-zA-Z][a-zA-Z0-9]*)[^>]*>/g;
        const lines = code.split("\n");
        let lineNum = 1;
        let charPos = 0;

        let match;
        while ((match = tagRegex.exec(code)) !== null) {
          // Zjisti číslo řádku
          while (
            charPos + lines[lineNum - 1].length + 1 <= match.index &&
            lineNum <= lines.length
          ) {
            charPos += lines[lineNum - 1].length + 1;
            lineNum++;
          }

          const fullTag = match[0];
          const tagName = match[1].toLowerCase();

          // Přeskoč self-closing tagy
          if (selfClosingTags.includes(tagName) || fullTag.endsWith("/>")) {
            continue;
          }

          if (fullTag.startsWith("</")) {
            // Zavírací tag
            if (tagStack.length === 0) {
              errors.push({
                line: lineNum,
                message: `Zavírací tag </${tagName}> bez odpovídajícího otevíracího`,
              });
            } else {
              const last = tagStack.pop();
              if (last.name !== tagName) {
                errors.push({
                  line: lineNum,
                  message: `Očekáván </${last.name}>, nalezen </${tagName}>`,
                });
                tagStack.push(last);
              }
            }
          } else {
            // Otevírací tag
            tagStack.push({ name: tagName, line: lineNum });
          }
        }

        // Nezavřené tagy
        tagStack.forEach((tag) => {
          errors.push({
            line: tag.line,
            message: `Tag <${tag.name}> není uzavřen`,
          });
        });

        // Kontrola prázdných atributů href/src
        const emptyAttrRegex = /(href|src)=["']["']/gi;
        lineNum = 1;
        for (const line of lines) {
          if (emptyAttrRegex.test(line)) {
            warnings.push({
              line: lineNum,
              message: "Prázdný atribut href nebo src",
            });
          }
          lineNum++;
        }

        // Kontrola alt u obrázků
        const imgRegex = /<img(?![^>]*alt=)[^>]*>/gi;
        lineNum = 1;
        for (const line of lines) {
          if (imgRegex.test(line)) {
            warnings.push({
              line: lineNum,
              message: "Obrázek <img> bez atributu alt",
            });
          }
          lineNum++;
        }

        // Zobrazit výsledky
        if (errors.length === 0 && warnings.length === 0) {
          listEl.innerHTML = `
                    <div class="validation-item success">
                        <div class="validation-message">✓ Žádné problémy nenalezeny!</div>
                    </div>
                `;
        } else {
          listEl.innerHTML =
            errors
              .map(
                (e) => `
                    <div class="validation-item error">
                        <div class="validation-line">Řádek ${e.line}</div>
                        <div class="validation-message">❌ ${e.message}</div>
                    </div>
                `
              )
              .join("") +
            warnings
              .map(
                (w) => `
                    <div class="validation-item warning">
                        <div class="validation-line">Řádek ${w.line}</div>
                        <div class="validation-message">⚠️ ${w.message}</div>
                    </div>
                `
              )
              .join("");
        }
      }

      function closeValidation() {
        document.getElementById("validationModal").classList.remove("active");
      }

      // ============================================
      // MINIFY
      // ============================================
      function minifyCode() {
        const code = codeInput.value;

        // Minifikace HTML
        let minified = code
          // Odstranit komentáře (kromě IE conditional)
          .replace(/<!--(?!\[if)[\s\S]*?-->/g, "")
          // Odstranit přebytečné mezery mezi tagy
          .replace(/>\s+</g, "><")
          // Odstranit mezery na začátku a konci řádků
          .replace(/^\s+|\s+$/gm, "")
          // Spojit řádky
          .replace(/\n/g, "")
          // Více mezer na jednu
          .replace(/\s{2,}/g, " ")
          // Mezery kolem = v atributech
          .replace(/\s*=\s*/g, "=");

        // Minifikace inline CSS
        const styleRegex = /<style[^>]*>([\s\S]*?)<\/style>/gi;
        minified = minified.replace(styleRegex, (match, css) => {
          const minCss = css
            .replace(/\/\*[\s\S]*?\*\//g, "")
            .replace(/\s+/g, " ")
            .replace(/\s*([{}:;,])\s*/g, "$1")
            .replace(/;}/g, "}")
            .trim();
          return "<style>" + minCss + "<" + "/style>";
        });

        // Minifikace inline JS
        const scriptRegex = /<script([^>]*)>([\s\S]*?)<\/script>/gi;
        minified = minified.replace(scriptRegex, (match, attrs, js) => {
          if (attrs && attrs.includes("src=")) return match;
          const minJs = js
            .replace(/\/\/.*$/gm, "")
            .replace(/\/\*[\s\S]*?\*\//g, "")
            .replace(/\s+/g, " ")
            .trim();
          return "<script" + attrs + ">" + minJs + "<" + "/script>";
        });

        const originalSize = new Blob([code]).size;
        const minifiedSize = new Blob([minified]).size;
        const saved = originalSize - minifiedSize;
        const percent = ((saved / originalSize) * 100).toFixed(1);

        codeInput.value = minified;
        updatePreview();
        markUnsaved();
        addToHistory("Minifikace");

        showToast(
          `Zmenšeno o ${formatFileSize(saved)} (${percent}%)`,
          "success"
        );
      }

      // ============================================
      // KEYBOARD SHORTCUTS
      // ============================================
      function openShortcuts() {
        document.getElementById("shortcutsModal").classList.add("active");
      }

      function closeShortcuts() {
        document.getElementById("shortcutsModal").classList.remove("active");
      }

      function runShortcut(action) {
        closeShortcuts();

        setTimeout(() => {
          switch (action) {
            case "save":
              saveToLocal();
              break;
            case "download":
              downloadFile();
              break;
            case "newFile":
              addNewTab();
              break;
            case "search":
              toggleSearch();
              break;
            case "format":
              formatCode();
              break;
            case "validate":
              validateHTML();
              break;
            case "minify":
              minifyCode();
              break;
            case "preview":
              switchView("preview");
              break;
            case "console":
              switchView("console");
              break;
            case "undo":
              undo();
              break;
            case "redo":
              redo();
              break;
            case "closeTab":
              if (files.length > 1) {
                closeTab(activeFileId);
              }
              break;
            case "colorScheme":
              openColorSchemes();
              break;
            case "publish":
              openPublish();
              break;
            case "seo":
              openSEO();
              break;
            case "devices":
              openDevices();
              break;
            case "screenshot":
              openScreenshot();
              break;
          }
        }, 100);
      }

      document.addEventListener("keydown", function (e) {
        // Ctrl/Cmd + S = Save
        if ((e.ctrlKey || e.metaKey) && e.key === "s") {
          e.preventDefault();
          saveToLocal();
        }
        // Ctrl/Cmd + Shift + S = Download
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "S") {
          e.preventDefault();
          downloadFile();
        }
        // Ctrl/Cmd + F = Search
        if ((e.ctrlKey || e.metaKey) && e.key === "f" && !e.shiftKey) {
          e.preventDefault();
          toggleSearch();
        }
        // Ctrl/Cmd + H = Replace
        if ((e.ctrlKey || e.metaKey) && e.key === "h") {
          e.preventDefault();
          toggleSearch();
        }
        // Ctrl/Cmd + N = New file
        if ((e.ctrlKey || e.metaKey) && e.key === "n") {
          e.preventDefault();
          addNewTab();
        }
        // Ctrl/Cmd + W = Close tab
        if ((e.ctrlKey || e.metaKey) && e.key === "w") {
          e.preventDefault();
          if (files.length > 1) {
            const idx = files.findIndex((f) => f.id === activeFileId);
            closeTab(activeFileId);
          }
        }
        // Ctrl/Cmd + Shift + F = Format
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "F") {
          e.preventDefault();
          formatCode();
        }
        // Ctrl/Cmd + P = Preview
        if ((e.ctrlKey || e.metaKey) && e.key === "p") {
          e.preventDefault();
          switchView("preview");
        }
        // Ctrl/Cmd + ` = Console
        if ((e.ctrlKey || e.metaKey) && e.key === "`") {
          e.preventDefault();
          switchView("console");
        }
        // Ctrl/Cmd + Shift + V = Validate
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "V") {
          e.preventDefault();
          validateHTML();
        }
        // Ctrl/Cmd + Shift + M = Minify
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "M") {
          e.preventDefault();
          minifyCode();
        }
        // Ctrl/Cmd + / = Shortcuts
        if ((e.ctrlKey || e.metaKey) && e.key === "/") {
          e.preventDefault();
          openShortcuts();
        }
      });

      // ============================================
      // LIVE SERVER
      // ============================================
      let liveServerActive = false;
      let liveServerUrl = "";

      function openLiveServer() {
        document.getElementById("liveServerModal").classList.add("active");
        updateServerStatus();
      }

      function closeLiveServer() {
        document.getElementById("liveServerModal").classList.remove("active");
      }

      function updateServerStatus() {
        const statusEl = document.getElementById("serverStatus");
        const infoEl = document.getElementById("serverInfo");
        const btnEl = document.getElementById("serverToggleBtn");

        if (liveServerActive) {
          statusEl.innerHTML = `
                    <div class="server-status-icon online">🟢</div>
                    <div style="font-size:14px;font-weight:500;margin-bottom:4px;">Server běží</div>
                    <div style="font-size:12px;color:var(--text-muted);">Sdílej URL nebo naskenuj QR</div>
                `;
          infoEl.style.display = "block";
          btnEl.textContent = "Zastavit server";
          btnEl.style.background = "var(--error)";
          btnEl.style.borderColor = "var(--error)";
        } else {
          statusEl.innerHTML = `
                    <div class="server-status-icon offline">📡</div>
                    <div style="font-size:14px;font-weight:500;margin-bottom:4px;">Server vypnutý</div>
                    <div style="font-size:12px;color:var(--text-muted);">Spusť server pro sdílení náhledu</div>
                `;
          infoEl.style.display = "none";
          btnEl.textContent = "Spustit server";
          btnEl.style.background = "";
          btnEl.style.borderColor = "";
        }
      }

      async function toggleLiveServer() {
        if (liveServerActive) {
          stopLiveServer();
        } else {
          await startLiveServer();
        }
      }

      async function startLiveServer() {
        try {
          showToast("Spouštím server...", "success");

          // Vytvoř Blob URL
          const html = codeInput.value;
          const blob = new Blob([html], { type: "text/html" });
          liveServerUrl = URL.createObjectURL(blob);

          // Pro skutečné sdílení bychom potřebovali backend
          // Tady simulujeme s lokální URL
          const shareUrl =
            window.location.href.split("?")[0] +
            "?preview=" +
            encodeURIComponent(btoa(html.substring(0, 1000)));

          liveServerActive = true;
          document.getElementById("serverUrl").textContent = liveServerUrl;
          document.getElementById("serverUrl").href = liveServerUrl;

          // Generuj QR kód
          generateQRCode(liveServerUrl);

          updateServerStatus();
          showToast("Server spuštěn!", "success");
        } catch (e) {
          showToast("Nelze spustit server", "error");
        }
      }

      function stopLiveServer() {
        if (liveServerUrl) {
          URL.revokeObjectURL(liveServerUrl);
        }
        liveServerActive = false;
        liveServerUrl = "";
        updateServerStatus();
        showToast("Server zastaven", "success");
      }

      function generateQRCode(url) {
        const qrContainer = document.getElementById("serverQR");
        qrContainer.innerHTML = "";

        // Jednoduchý QR generátor pomocí API
        const qrImg = document.createElement("img");
        qrImg.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(
          url
        )}`;
        qrImg.alt = "QR Code";
        qrImg.style.width = "150px";
        qrImg.style.height = "150px";
        qrContainer.appendChild(qrImg);
      }

      // ============================================
      // PWA / OFFLINE
      // ============================================

      // Uložit do cache před zavřením
      window.addEventListener("beforeunload", function (e) {
        const hasUnsaved = files.some((f) => f.unsaved);
        if (hasUnsaved) {
          e.preventDefault();
          e.returnValue = "Máš neuložené změny. Opravdu chceš odejít?";
        }
      });

      // Offline detekce
      window.addEventListener("online", () =>
        showToast("Zpět online", "success")
      );
      window.addEventListener("offline", () =>
        showToast("Offline režim", "warning")
      );

      async function openGithubBrowser() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }
        document.getElementById("githubBrowserModal").classList.add("active");
        githubCurrentRepo = "";
        githubCurrentPath = "";
        loadGithubRepos();
      }

      function closeGithubBrowser() {
        document
          .getElementById("githubBrowserModal")
          .classList.remove("active");
      }

      async function loadGithubRepos() {
        const browser = document.getElementById("githubBrowser");
        const pathEl = document.getElementById("githubPath");
        const branchBar = document.getElementById("githubBranchBar");

        // Skryjeme branch bar a resetujeme větev
        branchBar.style.display = "none";
        githubCurrentBranch = "main";
        githubCurrentRepo = "";
        githubCurrentPath = "";

        browser.innerHTML =
          '<div class="github-loading">Načítám repozitáře...</div>';
        pathEl.innerHTML =
          '<span class="github-path-item" onclick="loadGithubRepos()">Repozitáře</span>';

        try {
          const res = await fetch(
            "https://api.github.com/user/repos?sort=updated&per_page=50",
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );
          const repos = await res.json();

          if (repos.length === 0) {
            browser.innerHTML =
              '<div class="github-empty">Žádné repozitáře</div>';
            return;
          }

          browser.innerHTML =
            '<div class="github-list">' +
            repos
              .map(
                (repo) => `
                    <div class="github-item folder" onclick="loadGithubContents('${
                      repo.full_name
                    }', '')" style="flex-wrap:wrap;gap:8px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                        <span class="github-item-name">${repo.name}</span>
                        <span class="github-item-stars" title="Stars">⭐ ${
                          repo.stargazers_count || 0
                        }</span>
                        <span class="github-item-size">${
                          repo.private ? "🔒" : ""
                        }</span>
                        <div class="github-repo-actions">
                            <button class="github-small-btn" onclick="event.stopPropagation();openCloneUrl('${
                              repo.full_name
                            }', '${repo.clone_url}', '${
                  repo.ssh_url
                }')" title="Clone URL">📋</button>
                            <button class="github-small-btn" onclick="event.stopPropagation();openReadme('${
                              repo.full_name
                            }')" title="README">📖</button>
                            <button class="github-folder-btn" onclick="event.stopPropagation();loadGithubFolder('${
                              repo.full_name
                            }', '')">📥</button>
                        </div>
                    </div>
                `
              )
              .join("") +
            "</div>";
        } catch (e) {
          browser.innerHTML =
            '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      async function loadGithubContents(repo, path) {
        const browser = document.getElementById("githubBrowser");
        const pathEl = document.getElementById("githubPath");
        const branchBar = document.getElementById("githubBranchBar");

        githubCurrentRepo = repo;
        githubCurrentPath = path;

        browser.innerHTML = '<div class="github-loading">Načítám...</div>';

        // Načti větve pokud jsme v rootu repo
        if (!path && repo) {
          await loadGithubBranches(repo);
          branchBar.style.display = "flex";
        }

        // Build path breadcrumb
        let pathHtml = `<span class="github-path-item" onclick="loadGithubRepos()">Repozitáře</span> / `;
        pathHtml += `<span class="github-path-item" onclick="loadGithubContents('${repo}', '')">${
          repo.split("/")[1]
        }</span>`;

        if (path) {
          const parts = path.split("/");
          let currentPath = "";
          parts.forEach((part, i) => {
            currentPath += (i > 0 ? "/" : "") + part;
            const p = currentPath;
            pathHtml += ` / <span class="github-path-item" onclick="loadGithubContents('${repo}', '${p}')">${part}</span>`;
          });
        }
        pathEl.innerHTML = pathHtml;

        try {
          const url = `https://api.github.com/repos/${repo}/contents/${path}?ref=${githubCurrentBranch}`;
          const res = await fetch(url, {
            headers: { Authorization: `token ${githubToken}` },
          });
          const contents = await res.json();

          if (!Array.isArray(contents)) {
            // It's a file
            if (contents.encoding === "base64") {
              const content = atob(contents.content);
              githubFileSha = contents.sha;
              // Ulož SHA pro detekci konfliktů
              const fileKey = `${repo}/${path}`;
              githubFileLastSha[fileKey] = contents.sha;
              loadGithubFile(repo, path, content, contents.name);
            }
            return;
          }

          // Sort: folders first, then files
          contents.sort((a, b) => {
            if (a.type === b.type) return a.name.localeCompare(b.name);
            return a.type === "dir" ? -1 : 1;
          });

          browser.innerHTML =
            '<div class="github-list">' +
            contents
              .map((item) => {
                const isDir = item.type === "dir";
                const size = item.size ? formatFileSize(item.size) : "";
                const folderBtn = isDir
                  ? `<button class="github-folder-btn" onclick="event.stopPropagation();loadGithubFolder('${repo}', '${item.path}')">📥 Načíst</button>`
                  : "";
                return `
                        <div class="github-item ${
                          isDir ? "folder" : "file"
                        }" onclick="loadGithubContents('${repo}', '${
                  item.path
                }')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                ${
                                  isDir
                                    ? '<path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>'
                                    : '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>'
                                }
                            </svg>
                            <span class="github-item-name">${item.name}</span>
                            <span class="github-item-size">${size}</span>
                            ${folderBtn}
                        </div>
                    `;
              })
              .join("") +
            "</div>";

          if (contents.length === 0) {
            browser.innerHTML =
              '<div class="github-empty">Prázdná složka</div>';
          }
        } catch (e) {
          browser.innerHTML =
            '<div class="github-empty">Chyba při načítání</div>';
        }
      }

      // ============================================
      // CLONE URL
      // ============================================
      let currentCloneRepo = "";
      let currentCloneHttps = "";
      let currentCloneSsh = "";
      let currentCloneType = "https";

      function openCloneUrl(repoName, httpsUrl, sshUrl) {
        currentCloneRepo = repoName;
        currentCloneHttps = httpsUrl;
        currentCloneSsh = sshUrl;
        currentCloneType = "https";

        updateCloneUrlDisplay();

        document
          .querySelectorAll(".clone-url-tab")
          .forEach((t) => t.classList.remove("active"));
        document.querySelector(".clone-url-tab").classList.add("active");

        document.getElementById("cloneUrlModal").classList.add("active");
      }

      function setCloneType(type) {
        currentCloneType = type;

        document
          .querySelectorAll(".clone-url-tab")
          .forEach((t) => t.classList.remove("active"));
        event.target.classList.add("active");

        updateCloneUrlDisplay();
      }

      function updateCloneUrlDisplay() {
        const input = document.getElementById("cloneUrlInput");
        const help = document.getElementById("cloneUrlHelp");

        switch (currentCloneType) {
          case "https":
            input.value = `git clone ${currentCloneHttps}`;
            help.textContent =
              "Použij tento příkaz v terminálu. Budeš potřebovat GitHub token pro push.";
            break;
          case "ssh":
            input.value = `git clone ${currentCloneSsh}`;
            help.textContent =
              "Použij SSH klíč pro autentizaci. Nastav si SSH klíč v GitHub nastavení.";
            break;
          case "cli":
            input.value = `gh repo clone ${currentCloneRepo}`;
            help.textContent =
              "Vyžaduje nainstalovaný GitHub CLI (gh). Nainstaluj pomocí: brew install gh";
            break;
        }
      }

      function copyCloneUrl() {
        const input = document.getElementById("cloneUrlInput");
        input.select();
        document.execCommand("copy");
        showToast("Zkopírováno!", "success");
      }

      function closeCloneUrlModal() {
        document.getElementById("cloneUrlModal").classList.remove("active");
      }

      // ============================================
      // README PREVIEW
      // ============================================
      let currentReadmeRepo = "";
      let currentReadmeContent = "";

      async function openReadme(repoName) {
        currentReadmeRepo = repoName;

        document.getElementById("readmeContent").innerHTML =
          '<div class="github-loading">Načítám README...</div>';
        document.getElementById("readmeModal").classList.add("active");

        try {
          // Zkus README.md
          let res = await fetch(
            `https://api.github.com/repos/${repoName}/readme`,
            {
              headers: {
                Authorization: `token ${githubToken}`,
                Accept: "application/vnd.github.v3.raw",
              },
            }
          );

          if (res.ok) {
            currentReadmeContent = await res.text();
            const html = renderMarkdown(currentReadmeContent);
            document.getElementById("readmeContent").innerHTML = html;
          } else {
            document.getElementById("readmeContent").innerHTML =
              '<p style="color:var(--text-muted);text-align:center;">README nenalezen</p>';
          }
        } catch (e) {
          document.getElementById("readmeContent").innerHTML =
            '<p style="color:var(--error);">Chyba při načítání</p>';
        }
      }

      function renderMarkdown(md) {
        // Jednoduchý markdown parser
        let html = md
          // Escape HTML
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          // Code blocks
          .replace(/```(\w*)\n([\s\S]*?)```/g, "<pre><code>$2</code></pre>")
          // Inline code
          .replace(/`([^`]+)`/g, "<code>$1</code>")
          // Headers
          .replace(/^### (.+)$/gm, "<h3>$1</h3>")
          .replace(/^## (.+)$/gm, "<h2>$1</h2>")
          .replace(/^# (.+)$/gm, "<h1>$1</h1>")
          // Bold
          .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
          // Italic
          .replace(/\*(.+?)\*/g, "<em>$1</em>")
          // Links
          .replace(
            /\[([^\]]+)\]\(([^)]+)\)/g,
            '<a href="$2" target="_blank">$1</a>'
          )
          // Images
          .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
          // Blockquotes
          .replace(/^> (.+)$/gm, "<blockquote>$1</blockquote>")
          // Unordered lists
          .replace(/^[\*\-] (.+)$/gm, "<li>$1</li>")
          // Ordered lists
          .replace(/^\d+\. (.+)$/gm, "<li>$1</li>")
          // Paragraphs
          .replace(/\n\n/g, "</p><p>")
          // Line breaks
          .replace(/\n/g, "<br>");

        // Wrap lists
        html = html.replace(/(<li>.*?<\/li>)+/gs, "<ul>$&</ul>");

        return "<p>" + html + "</p>";
      }

      function loadReadmeToEditor() {
        if (currentReadmeContent) {
          const file = createFile("README.md", currentReadmeContent);
          activeFileId = file.id;
          codeInput.value = currentReadmeContent;
          renderTabs();
          updatePreview();
          updateLineNumbers(codeInput, lineNumbers);
          closeReadmeModal();
          showToast("README načten do editoru", "success");
        }
      }

      function closeReadmeModal() {
        document.getElementById("readmeModal").classList.remove("active");
      }

      // ============================================
      // GITIGNORE TEMPLATES
      // ============================================
      const gitignoreTemplates = {
        node: `# Node.js
node_modules/
npm-debug.log*
yarn-debug.log*
yarn-error.log*
.npm
.yarn
package-lock.json
yarn.lock
.env
.env.local
.env.*.local
dist/
build/
coverage/`,

        python: `# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
.venv/
pip-log.txt
.tox/
.coverage
.pytest_cache/
*.egg-info/
dist/
build/`,

        java: `# Java
*.class
*.jar
*.war
*.ear
*.log
target/
.gradle/
build/
out/
.idea/
*.iml`,

        web: `# Web/HTML
.DS_Store
Thumbs.db
*.log
node_modules/
dist/
build/
.cache/
.parcel-cache/
.sass-cache/
*.min.css
*.min.js`,

        macos: `# macOS
.DS_Store
.AppleDouble
.LSOverride
._*
.Spotlight-V100
.Trashes
.fseventsd`,

        windows: `# Windows
Thumbs.db
ehthumbs.db
Desktop.ini
$RECYCLE.BIN/
*.lnk
*.stackdump`,

        linux: `# Linux
*~
.fuse_hidden*
.Trash-*
.nfs*`,

        vscode: `# VS Code
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json
*.code-workspace
.history/`,

        jetbrains: `# JetBrains
.idea/
*.iml
*.ipr
*.iws
out/
.idea_modules/
cmake-build-*/`,
      };

      let selectedGitignoreTemplates = [];

      function toggleGitignoreTemplate(template) {
        const btn = event.target;
        const index = selectedGitignoreTemplates.indexOf(template);

        if (index === -1) {
          selectedGitignoreTemplates.push(template);
          btn.classList.add("selected");
        } else {
          selectedGitignoreTemplates.splice(index, 1);
          btn.classList.remove("selected");
        }

        updateGitignorePreview();
      }

      function updateGitignorePreview() {
        const preview = document.getElementById("gitignorePreview");

        if (selectedGitignoreTemplates.length === 0) {
          preview.value = "# Vyber šablonu výše";
          return;
        }

        let content = "# Generated by HTML Studio\n\n";

        selectedGitignoreTemplates.forEach((template) => {
          content += gitignoreTemplates[template] + "\n\n";
        });

        preview.value = content.trim();
      }

      function openGitignoreModal() {
        selectedGitignoreTemplates = [];
        document
          .querySelectorAll(".gitignore-template-btn")
          .forEach((btn) => btn.classList.remove("selected"));
        document.getElementById("gitignorePreview").value =
          "# Vyber šablonu výše";
        document.getElementById("gitignoreModal").classList.add("active");
      }

      function closeGitignoreModal() {
        document.getElementById("gitignoreModal").classList.remove("active");
      }

      function createGitignoreFile() {
        const content = document.getElementById("gitignorePreview").value;

        if (content === "# Vyber šablonu výše") {
          showToast("Nejprve vyber šablonu", "warning");
          return;
        }

        const file = createFile(".gitignore", content);
        activeFileId = file.id;
        codeInput.value = content;
        renderTabs();
        updatePreview();
        updateLineNumbers(codeInput, lineNumbers);
        closeGitignoreModal();
        showToast(".gitignore vytvořen", "success");
      }

      // ============================================
      // GITHUB BRANCHES
      // ============================================
      async function loadGithubBranches(repo) {
        try {
          const res = await fetch(
            `https://api.github.com/repos/${repo}/branches`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );
          githubBranches = await res.json();

          const select = document.getElementById("githubBranchSelect");
          select.innerHTML = githubBranches
            .map(
              (b) =>
                `<option value="${b.name}" ${
                  b.name === githubCurrentBranch ? "selected" : ""
                }>${b.name}</option>`
            )
            .join("");

          // Pokud aktuální větev neexistuje, nastav na default
          if (!githubBranches.find((b) => b.name === githubCurrentBranch)) {
            githubCurrentBranch = githubBranches[0]?.name || "main";
            select.value = githubCurrentBranch;
          }

          // Aktualizuj i commit modal branch select
          const commitBranchSelect =
            document.getElementById("githubCommitBranch");
          if (commitBranchSelect) {
            commitBranchSelect.innerHTML = select.innerHTML;
          }
        } catch (e) {
          console.error("Chyba při načítání větví:", e);
        }
      }

      function switchBranch(branch) {
        githubCurrentBranch = branch;
        loadGithubContents(githubCurrentRepo, githubCurrentPath);
        showToast("Přepnuto na větev: " + branch, "success");
      }

      function openNewBranchModal() {
        document.getElementById("newBranchFrom").textContent =
          githubCurrentBranch;
        document.getElementById("newBranchName").value = "";
        document.getElementById("newBranchModal").classList.add("active");
      }

      function closeNewBranchModal() {
        document.getElementById("newBranchModal").classList.remove("active");
      }

      async function createNewBranch() {
        const branchName = document
          .getElementById("newBranchName")
          .value.trim();

        if (!branchName) {
          showToast("Zadej název větve", "error");
          return;
        }

        // Validace názvu větve
        if (!/^[a-zA-Z0-9._\/-]+$/.test(branchName)) {
          showToast("Neplatný název větve", "error");
          return;
        }

        try {
          // Získej SHA aktuální větve
          const refRes = await fetch(
            `https://api.github.com/repos/${githubCurrentRepo}/git/ref/heads/${githubCurrentBranch}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );
          const refData = await refRes.json();
          const sha = refData.object.sha;

          // Vytvoř novou větev
          const createRes = await fetch(
            `https://api.github.com/repos/${githubCurrentRepo}/git/refs`,
            {
              method: "POST",
              headers: {
                Authorization: `token ${githubToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                ref: `refs/heads/${branchName}`,
                sha: sha,
              }),
            }
          );

          if (createRes.ok) {
            showToast("Větev vytvořena: " + branchName, "success");
            githubCurrentBranch = branchName;
            closeNewBranchModal();
            loadGithubContents(githubCurrentRepo, githubCurrentPath);
          } else {
            const err = await createRes.json();
            showToast(
              "Chyba: " + (err.message || "Nelze vytvořit větev"),
              "error"
            );
          }
        } catch (e) {
          showToast("Chyba při vytváření větve", "error");
        }
      }

      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + " B";
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + " KB";
        return (bytes / (1024 * 1024)).toFixed(1) + " MB";
      }

      // Načíst celou složku rekurzivně
      // Loading state
      let loadingCancelled = false;
      let loadingFilesList = [];

      function showLoadingModal(title) {
        loadingCancelled = false;
        document.getElementById("loadingTitle").textContent =
          title || "📥 Načítám...";
        document.getElementById("loadingBarFill").style.width = "0%";
        document.getElementById("loadingStatus").textContent = "Připravuji...";
        document.getElementById("loadingDetails").textContent = "";
        document.getElementById("loadingModal").classList.add("active");
      }

      function updateLoadingProgress(percent, status, details) {
        document.getElementById("loadingBarFill").style.width = percent + "%";
        if (status)
          document.getElementById("loadingStatus").textContent = status;
        if (details !== undefined)
          document.getElementById("loadingDetails").textContent = details;
      }

      function hideLoadingModal() {
        document.getElementById("loadingModal").classList.remove("active");
      }

      function cancelLoading() {
        loadingCancelled = true;
        hideLoadingModal();
        showToast("Načítání zrušeno", "warning");
      }

      async function loadGithubFolder(repo, path) {
        showLoadingModal(path ? `📁 ${path}` : `📦 ${repo.split("/")[1]}`);
        updateLoadingProgress(5, "Procházím strukturu...", "Hledám soubory");

        try {
          loadingFilesList = [];
          const allFiles = await fetchGithubFolderRecursive(repo, path);

          if (loadingCancelled) return;

          if (allFiles.length === 0) {
            hideLoadingModal();
            showToast("Žádné podporované soubory", "warning");
            return;
          }

          updateLoadingProgress(
            20,
            `Nalezeno ${allFiles.length} souborů`,
            "Stahuji obsah..."
          );

          // Načti obsah všech souborů
          let loadedCount = 0;
          for (let i = 0; i < allFiles.length; i++) {
            if (loadingCancelled) {
              // Když zrušeno, přidej alespoň co se stihlo
              break;
            }

            const fileInfo = allFiles[i];
            const percent = 20 + Math.round((i / allFiles.length) * 75);
            updateLoadingProgress(
              percent,
              `Stahuji ${i + 1}/${allFiles.length}`,
              fileInfo.name
            );

            try {
              const res = await fetch(
                `https://api.github.com/repos/${repo}/contents/${fileInfo.path}?ref=${githubCurrentBranch}`,
                {
                  headers: { Authorization: `token ${githubToken}` },
                }
              );
              const data = await res.json();

              if (data.encoding === "base64") {
                const content = atob(data.content);
                const file = createFile(fileInfo.name, content);
                file.githubRepo = repo;
                file.githubPath = fileInfo.path;
                file.githubSha = data.sha;
                file.githubBranch = githubCurrentBranch;
                file.folderPath = fileInfo.folderPath;

                // Ulož SHA pro detekci konfliktů
                const fileKey = `${repo}/${fileInfo.path}`;
                githubFileLastSha[fileKey] = data.sha;

                loadedCount++;
              }
            } catch (e) {
              console.warn("Nelze načíst:", fileInfo.path);
            }

            // Malá pauza aby UI reagovalo
            if (i % 5 === 0) {
              await new Promise((r) => setTimeout(r, 10));
            }
          }

          updateLoadingProgress(100, "Dokončuji...", "");

          if (loadedCount > 0) {
            // Najdi index.html nebo první HTML soubor
            const newFiles = files.slice(-loadedCount);
            let mainFile = newFiles.find(
              (f) => f.name.toLowerCase() === "index.html"
            );
            if (!mainFile)
              mainFile = newFiles.find(
                (f) => f.name.toLowerCase() === "index.htm"
              );
            if (!mainFile)
              mainFile = newFiles.find((f) => f.name.match(/\.(html?|htm)$/i));
            if (!mainFile) mainFile = newFiles[0];

            activeFileId = mainFile.id;
            codeInput.value = mainFile.content;
            renderTabs();
            renderFilesList();
            updatePreview();
            addToHistory("GitHub: " + (path || repo.split("/")[1]));

            // Scroll na aktivní tab
            setTimeout(() => {
              const activeTab = document.querySelector(".file-tab.active");
              if (activeTab)
                activeTab.scrollIntoView({
                  behavior: "smooth",
                  inline: "center",
                });
            }, 100);
          }

          hideLoadingModal();
          closeGithubBrowser();
          showToast(`Načteno ${loadedCount} souborů`, "success");
        } catch (e) {
          hideLoadingModal();
          showToast("Chyba: " + e.message, "error");
        }
      }

      async function fetchGithubFolderRecursive(repo, path, basePath = "") {
        if (loadingCancelled) return [];

        const allFiles = [];

        try {
          const res = await fetch(
            `https://api.github.com/repos/${repo}/contents/${path}?ref=${githubCurrentBranch}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );
          const contents = await res.json();

          if (!Array.isArray(contents)) return allFiles;

          // Aktualizuj progress při procházení
          const currentFolder = basePath || path || "kořen";
          updateLoadingProgress(10, "Procházím strukturu...", currentFolder);

          for (const item of contents) {
            if (loadingCancelled) break;

            if (item.type === "dir") {
              // Rekurzivně načti podsložku
              const subFiles = await fetchGithubFolderRecursive(
                repo,
                item.path,
                (basePath ? basePath + "/" : "") + item.name
              );
              allFiles.push(...subFiles);
            } else if (item.type === "file") {
              // Přidej pouze textové soubory (HTML, CSS, JS, atd.)
              const ext = item.name.split(".").pop().toLowerCase();
              const textExts = [
                "html",
                "htm",
                "css",
                "js",
                "json",
                "xml",
                "svg",
                "txt",
                "md",
                "php",
                "py",
                "jsx",
                "ts",
                "tsx",
                "vue",
                "scss",
                "sass",
                "less",
              ];

              if (textExts.includes(ext)) {
                allFiles.push({
                  name: item.name,
                  path: item.path,
                  folderPath: basePath,
                  size: item.size,
                });
              }
            }
          }
        } catch (e) {
          console.error("Chyba při načítání složky:", path, e);
        }

        return allFiles;
      }

      function loadGithubFile(repo, path, content, name) {
        const file = createFile(name, content);
        file.githubRepo = repo;
        file.githubPath = path;
        file.githubSha = githubFileSha;
        file.githubBranch = githubCurrentBranch;

        // Ulož SHA pro detekci konfliktů
        const fileKey = `${repo}/${path}`;
        githubFileLastSha[fileKey] = githubFileSha;

        activeFileId = file.id;
        codeInput.value = file.content;
        renderTabs();
        updatePreview();
        addToHistory("GitHub: " + name);
        closeGithubBrowser();
        switchView("code");
        showToast("Soubor načten z GitHubu", "success");
      }

      async function saveToGithub() {
        if (!githubToken) {
          showToast("Nejprve nastav GitHub token", "error");
          return;
        }

        const file = files.find((f) => f.id === activeFileId);
        if (!file) return;

        document.getElementById("githubCommitRepo").value =
          file.githubRepo || "";
        document.getElementById("githubCommitPath").value =
          file.githubPath || file.name;
        document.getElementById("githubCommitMessage").value =
          "Update " + file.name;
        document.getElementById(
          "githubCommitInfo"
        ).textContent = `Soubor: ${file.name}`;

        // Reset warningů
        document.getElementById("githubConflictWarning").innerHTML = "";
        document.getElementById("githubPullStatus").innerHTML = "";
        document.getElementById("githubPullBtn").style.display = "none";

        // Načti větve pokud máme repo
        if (file.githubRepo) {
          await loadGithubBranches(file.githubRepo);
          const branchSelect = document.getElementById("githubCommitBranch");
          branchSelect.value =
            file.githubBranch || githubCurrentBranch || "main";

          // Zkontroluj stav vzdáleného souboru
          setTimeout(checkRemoteStatus, 100);
        }

        document.getElementById("githubCommitModal").classList.add("active");
      }

      function closeGithubCommit() {
        document.getElementById("githubCommitModal").classList.remove("active");
        document.getElementById("githubConflictWarning").innerHTML = "";
        document.getElementById("githubPullStatus").innerHTML = "";
      }

      async function commitToGithub() {
        const repo = document.getElementById("githubCommitRepo").value.trim();
        const path = document.getElementById("githubCommitPath").value.trim();
        const message = document
          .getElementById("githubCommitMessage")
          .value.trim();
        const branch =
          document.getElementById("githubCommitBranch").value || "main";

        if (!repo || !path || !message) {
          showToast("Vyplň všechna pole", "error");
          return;
        }

        const file = files.find((f) => f.id === activeFileId);
        if (!file) return;

        try {
          showToast("Kontroluji stav...", "success");

          // Check if file exists to get SHA and detect conflicts
          let sha = file.githubSha || null;
          let remoteContent = null;
          let hasConflict = false;

          try {
            const checkRes = await fetch(
              `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`,
              {
                headers: { Authorization: `token ${githubToken}` },
              }
            );
            if (checkRes.ok) {
              const existing = await checkRes.json();
              const fileKey = `${repo}/${path}`;

              // Zkontroluj konflikt - SHA se změnilo od načtení
              if (
                githubFileLastSha[fileKey] &&
                githubFileLastSha[fileKey] !== existing.sha
              ) {
                hasConflict = true;
                remoteContent = atob(existing.content);
              }

              sha = existing.sha;
            }
          } catch {}

          // Zobraz varování o konfliktu
          if (hasConflict) {
            showConflictWarning(repo, path, branch, remoteContent);
            return;
          }

          showToast("Ukládám...", "success");

          const body = {
            message: message,
            content: btoa(unescape(encodeURIComponent(codeInput.value))),
            branch: branch,
          };
          if (sha) body.sha = sha;

          const res = await fetch(
            `https://api.github.com/repos/${repo}/contents/${path}`,
            {
              method: "PUT",
              headers: {
                Authorization: `token ${githubToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(body),
            }
          );

          if (res.ok) {
            const result = await res.json();
            file.githubRepo = repo;
            file.githubPath = path;
            file.githubSha = result.content.sha;
            file.githubBranch = branch;
            file.unsaved = false;

            // Aktualizuj uloženou SHA
            const fileKey = `${repo}/${path}`;
            githubFileLastSha[fileKey] = result.content.sha;

            renderTabs();
            closeGithubCommit();
            showToast("Uloženo na GitHub! (větev: " + branch + ")", "success");
          } else {
            const err = await res.json();
            if (res.status === 409) {
              showToast("Konflikt! Soubor byl změněn. Použij Pull.", "error");
            } else {
              showToast("Chyba: " + (err.message || "Nelze uložit"), "error");
            }
          }
        } catch (e) {
          showToast("Chyba při ukládání", "error");
        }
      }

      function showConflictWarning(repo, path, branch, remoteContent) {
        const warningDiv = document.getElementById("githubConflictWarning");
        warningDiv.innerHTML = `
                <div class="github-conflict-warning">
                    <h4>⚠️ Konflikt detekován!</h4>
                    <p>Soubor byl změněn na GitHubu od doby, kdy jsi ho načetl.</p>
                    <div class="github-conflict-actions">
                        <button class="modal-btn" onclick="pullFromGithub()">⬇️ Stáhnout novou verzi</button>
                        <button class="modal-btn primary" onclick="forceCommit()">⚡ Přepsat vzdálenou verzi</button>
                    </div>
                </div>
            `;
      }

      async function forceCommit() {
        const repo = document.getElementById("githubCommitRepo").value.trim();
        const path = document.getElementById("githubCommitPath").value.trim();
        const message = document
          .getElementById("githubCommitMessage")
          .value.trim();
        const branch =
          document.getElementById("githubCommitBranch").value || "main";

        const file = files.find((f) => f.id === activeFileId);
        if (!file) return;

        try {
          // Získej aktuální SHA
          const checkRes = await fetch(
            `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );
          const existing = await checkRes.json();

          const res = await fetch(
            `https://api.github.com/repos/${repo}/contents/${path}`,
            {
              method: "PUT",
              headers: {
                Authorization: `token ${githubToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: message + " (force)",
                content: btoa(unescape(encodeURIComponent(codeInput.value))),
                branch: branch,
                sha: existing.sha,
              }),
            }
          );

          if (res.ok) {
            const result = await res.json();
            file.githubSha = result.content.sha;
            const fileKey = `${repo}/${path}`;
            githubFileLastSha[fileKey] = result.content.sha;

            document.getElementById("githubConflictWarning").innerHTML = "";
            closeGithubCommit();
            showToast("Uloženo (přepsáno)", "success");
          } else {
            showToast("Chyba při ukládání", "error");
          }
        } catch (e) {
          showToast("Chyba", "error");
        }
      }

      async function pullFromGithub() {
        const repo = document.getElementById("githubCommitRepo").value.trim();
        const path = document.getElementById("githubCommitPath").value.trim();
        const branch =
          document.getElementById("githubCommitBranch").value || "main";

        if (!repo || !path) {
          showToast("Vyplň repozitář a cestu", "error");
          return;
        }

        try {
          showToast("Stahuji...", "success");

          const res = await fetch(
            `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (res.ok) {
            const data = await res.json();
            const content = decodeURIComponent(escape(atob(data.content)));

            // Aktualizuj soubor
            const file = files.find((f) => f.id === activeFileId);
            if (file) {
              file.content = content;
              file.githubSha = data.sha;

              const fileKey = `${repo}/${path}`;
              githubFileLastSha[fileKey] = data.sha;
            }

            codeInput.value = content;
            updatePreview();
            updateLineNumbers(codeInput, lineNumbers);

            document.getElementById("githubConflictWarning").innerHTML = "";
            document.getElementById("githubPullStatus").innerHTML = `
                        <div class="github-pull-info">
                            <div class="status ok">✅ Aktuální verze stažena</div>
                        </div>
                    `;

            showToast("Staženo z GitHubu", "success");
          } else {
            showToast("Soubor neexistuje na GitHubu", "error");
          }
        } catch (e) {
          showToast("Chyba při stahování", "error");
        }
      }

      async function checkRemoteStatus() {
        const repo = document.getElementById("githubCommitRepo").value.trim();
        const path = document.getElementById("githubCommitPath").value.trim();
        const branch =
          document.getElementById("githubCommitBranch").value || "main";
        const pullBtn = document.getElementById("githubPullBtn");
        const pullStatus = document.getElementById("githubPullStatus");

        if (!repo || !path) {
          pullStatus.innerHTML = "";
          pullBtn.style.display = "none";
          return;
        }

        try {
          const res = await fetch(
            `https://api.github.com/repos/${repo}/contents/${path}?ref=${branch}`,
            {
              headers: { Authorization: `token ${githubToken}` },
            }
          );

          if (res.ok) {
            const data = await res.json();
            const fileKey = `${repo}/${path}`;
            const localSha = githubFileLastSha[fileKey];

            if (localSha && localSha !== data.sha) {
              pullStatus.innerHTML = `
                            <div class="github-pull-info">
                                <div class="status warning">⚠️ Na GitHubu je novější verze</div>
                                <p style="margin:0;font-size:11px;color:var(--text-muted);">Doporučujeme stáhnout před uložením</p>
                            </div>
                        `;
              pullBtn.style.display = "inline-block";
            } else {
              pullStatus.innerHTML = `
                            <div class="github-pull-info">
                                <div class="status ok">✅ Lokální verze je aktuální</div>
                            </div>
                        `;
              pullBtn.style.display = "none";
            }
          } else {
            pullStatus.innerHTML = `
                        <div class="github-pull-info">
                            <div class="status">📝 Nový soubor (bude vytvořen)</div>
                        </div>
                    `;
            pullBtn.style.display = "none";
          }
        } catch (e) {
          pullStatus.innerHTML = "";
          pullBtn.style.display = "none";
        }
      }

      // ============================================
      // FORMAT CODE
      // ============================================
      function formatCode() {
        const code = codeInput.value;
        const formatted = formatHTML(code);
        codeInput.value = formatted;
        updatePreview();
        markUnsaved();
        updateLineNumbers(codeInput, lineNumbers);
        addToHistory("Formátování");
        showToast("Kód zformátován", "success");
      }

      function formatHTML(html) {
        // Odstraň přebytečné mezery a nové řádky
        let result = html.replace(/>\s+</g, "><").trim();

        // Definice tagů
        const selfClosingTags = [
          "area",
          "base",
          "br",
          "col",
          "embed",
          "hr",
          "img",
          "input",
          "link",
          "meta",
          "param",
          "source",
          "track",
          "wbr",
        ];
        const inlineTags = [
          "a",
          "abbr",
          "b",
          "bdo",
          "br",
          "button",
          "cite",
          "code",
          "dfn",
          "em",
          "i",
          "img",
          "input",
          "kbd",
          "label",
          "map",
          "object",
          "output",
          "q",
          "samp",
          "script",
          "select",
          "small",
          "span",
          "strong",
          "sub",
          "sup",
          "textarea",
          "time",
          "tt",
          "var",
        ];
        const preformattedTags = ["pre", "code", "script", "style", "textarea"];

        let formatted = "";
        let indent = 0;
        const indentStr = "  "; // 2 mezery
        let inPreformatted = false;
        let preformattedContent = "";
        let preformattedTag = "";

        // Rozděl na tokeny (tagy a text)
        const tokens = result.match(/<!--[\s\S]*?-->|<[^>]+>|[^<]+/g) || [];

        for (let i = 0; i < tokens.length; i++) {
          let token = tokens[i];

          // Přeskoč prázdné tokeny
          if (!token.trim()) continue;

          // Komentáře
          if (token.startsWith("<!--")) {
            formatted += indentStr.repeat(indent) + token + "\n";
            continue;
          }

          // Detekce preformatted bloků
          if (!inPreformatted) {
            for (const tag of preformattedTags) {
              if (
                token.toLowerCase().startsWith("<" + tag) &&
                !token.endsWith("/>")
              ) {
                inPreformatted = true;
                preformattedTag = tag;
                preformattedContent = token;
                break;
              }
            }
            if (inPreformatted) continue;
          }

          if (inPreformatted) {
            preformattedContent += token;
            if (token.toLowerCase() === "</" + preformattedTag + ">") {
              formatted +=
                indentStr.repeat(indent) + preformattedContent + "\n";
              inPreformatted = false;
              preformattedContent = "";
              preformattedTag = "";
            }
            continue;
          }

          // Zavírací tag
          if (token.startsWith("</")) {
            indent = Math.max(0, indent - 1);
            formatted += indentStr.repeat(indent) + token + "\n";
            continue;
          }

          // Otevírací tag
          if (token.startsWith("<")) {
            const tagMatch = token.match(/<([a-zA-Z0-9]+)/);
            const tagName = tagMatch ? tagMatch[1].toLowerCase() : "";
            const isSelfClosing =
              selfClosingTags.includes(tagName) || token.endsWith("/>");
            const isInline = inlineTags.includes(tagName);

            // DOCTYPE a jiné speciální tagy
            if (token.startsWith("<!") || token.startsWith("<?")) {
              formatted += token + "\n";
              continue;
            }

            formatted += indentStr.repeat(indent) + token;

            // Podívej se jestli následuje krátký textový obsah a zavírací tag
            const nextToken = tokens[i + 1];
            const afterNext = tokens[i + 2];

            if (
              nextToken &&
              !nextToken.startsWith("<") &&
              afterNext &&
              afterNext.toLowerCase() === "</" + tagName + ">" &&
              nextToken.trim().length < 60
            ) {
              // Krátký obsah - nech na jednom řádku
              formatted += nextToken + afterNext + "\n";
              i += 2;
              continue;
            }

            formatted += "\n";

            if (!isSelfClosing) {
              indent++;
            }
            continue;
          }

          // Text
          const trimmed = token.trim();
          if (trimmed) {
            formatted += indentStr.repeat(indent) + trimmed + "\n";
          }
        }

        // Vyčisti prázdné řádky na konci a dvojité prázdné řádky
        formatted = formatted.replace(/\n{3,}/g, "\n\n").trim();

        return formatted;
      }

      // ============================================
      // SETTINGS
      // ============================================
      // More menu
      function toggleMoreMenu() {
        const menu = document.getElementById("moreMenu");
        menu.classList.toggle("active");
      }

      function closeMoreMenu() {
        document.getElementById("moreMenu").classList.remove("active");
      }

      // Zavřít menu při kliknutí mimo
      document.addEventListener("click", function (e) {
        const menu = document.getElementById("moreMenu");
        const btn = document.getElementById("moreBtn");
        if (
          menu &&
          btn &&
          !menu.contains(e.target) &&
          !btn.contains(e.target)
        ) {
          menu.classList.remove("active");
        }
      });

      function openSettings() {
        document.getElementById("settingsSheet").classList.add("active");
        loadSettings();
      }

      function closeSettings() {
        document.getElementById("settingsSheet").classList.remove("active");
      }

      function loadSettings() {
        const fontSize = localStorage.getItem("htmlStudio_fontSize") || "14";
        const wordWrap = localStorage.getItem("htmlStudio_wordWrap") === "true";
        const autoClose =
          localStorage.getItem("htmlStudio_autoClose") !== "false";

        document.getElementById("fontSizeSelect").value = fontSize;
        document.getElementById("wordWrapToggle").checked = wordWrap;
        document.getElementById("autoCloseToggle").checked = autoClose;
        autoCloseEnabled = autoClose;

        // GitHub disconnect button
        const disconnectItem = document.getElementById("githubDisconnectItem");
        if (disconnectItem) {
          disconnectItem.style.display = githubToken ? "flex" : "none";
        }
      }

      function changeFontSize(size) {
        codeInput.style.fontSize = size + "px";
        localStorage.setItem("htmlStudio_fontSize", size);
      }

      function toggleWordWrap(enabled) {
        codeInput.style.whiteSpace = enabled ? "pre-wrap" : "pre";
        codeInput.style.wordBreak = enabled ? "break-all" : "normal";
        localStorage.setItem("htmlStudio_wordWrap", enabled);
      }

      let autoCloseEnabled = true;

      function toggleAutoClose(enabled) {
        autoCloseEnabled = enabled;
        localStorage.setItem("htmlStudio_autoClose", enabled);
      }

      function exportAllData() {
        const data = {
          files: files,
          prompts: prompts,
          settings: {
            fontSize: localStorage.getItem("htmlStudio_fontSize"),
            wordWrap: localStorage.getItem("htmlStudio_wordWrap"),
          },
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {
          type: "application/json",
        });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "html-studio-backup.json";
        a.click();
        showToast("Data exportována", "success");
        closeSettings();
      }

      function clearAllData() {
        if (confirm("Opravdu smazat všechna data? Toto nelze vrátit!")) {
          localStorage.removeItem("htmlStudio_files");
          localStorage.removeItem("htmlStudio_prompts");
          localStorage.removeItem("htmlStudio_activeId");
          localStorage.removeItem("htmlStudio_fontSize");
          localStorage.removeItem("htmlStudio_wordWrap");
          location.reload();
        }
      }

      function applySettings() {
        const fontSize = localStorage.getItem("htmlStudio_fontSize") || "14";
        const wordWrap = localStorage.getItem("htmlStudio_wordWrap") === "true";
        const autoClose =
          localStorage.getItem("htmlStudio_autoClose") !== "false";

        codeInput.style.fontSize = fontSize + "px";
        codeInput.style.whiteSpace = wordWrap ? "pre-wrap" : "pre";
        codeInput.style.wordBreak = wordWrap ? "break-all" : "normal";
        autoCloseEnabled = autoClose;
      }

      // ============================================
      // TOAST
      // ============================================
      function showToast(msg, type = "success") {
        const toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.className = `toast ${type} active`;
        setTimeout(() => toast.classList.remove("active"), 2500);
      }

      // ============================================
      // AI SETTINGS
      // ============================================
      let aiSettings = {
        provider: "gemini",
        model: "",
      };

      function loadAISettings() {
        const saved = localStorage.getItem("htmlStudio_ai");
        if (saved) {
          try {
            aiSettings = JSON.parse(saved);
            document.getElementById("aiProvider").value =
              aiSettings.provider || "gemini";

            // Nastav klíč pokud existuje
            if (aiSettings.apiKey) {
              document.getElementById("aiApiKey").value = aiSettings.apiKey;
              AI.setKey(aiSettings.provider, aiSettings.apiKey);
            }
          } catch (e) {}
        }

        // Naplň modely
        onProviderChange();

        // Vyber uložený model
        if (aiSettings.model) {
          document.getElementById("aiModel").value = aiSettings.model;
        }

        updateDemoKeyWarning();
      }

      function onProviderChange() {
        const provider = document.getElementById("aiProvider").value;
        const modelSelect = document.getElementById("aiModel");
        const models = AI.getModels(provider);

        modelSelect.innerHTML = models
          .map((m) => `<option value="${m.value}">${m.name}</option>`)
          .join("");

        aiSettings.provider = provider;
        AI.setDefaultProvider(provider);

        updateDemoKeyWarning();
        saveAISettings();
      }

      function updateDemoKeyWarning() {
        const provider = document.getElementById("aiProvider").value;
        const warning = document.getElementById("demoKeyWarning");
        const isDemo = AI.isUsingDemoKey(provider);
        warning.style.display = isDemo ? "block" : "none";
      }

      function saveAISettings() {
        const provider = document.getElementById("aiProvider").value;
        const apiKey = document.getElementById("aiApiKey").value;
        const model = document.getElementById("aiModel").value;

        aiSettings.provider = provider;
        aiSettings.apiKey = apiKey;
        aiSettings.model = model;

        // Nastav do AI modulu
        if (apiKey) {
          AI.setKey(provider, apiKey);
        }
        AI.setDefaultProvider(provider);
        if (model) {
          AI.setModel(provider, model);
        }

        localStorage.setItem("htmlStudio_ai", JSON.stringify(aiSettings));
        updateDemoKeyWarning();
      }

      // ============================================
      // AI CHAT
      // ============================================
      let aiConversation = [];

      function openAIChat() {
        document.getElementById("aiPanel").classList.add("active");
        document.getElementById("aiOverlay").classList.add("active");
        document.getElementById("aiInput").focus();
      }

      function closeAIChat() {
        document.getElementById("aiPanel").classList.remove("active");
        document.getElementById("aiOverlay").classList.remove("active");
      }

      function aiQuickAction(prompt) {
        document.getElementById("aiInput").value = prompt;
        sendAIMessage();
      }

      function addAIMessage(role, content) {
        const messagesEl = document.getElementById("aiMessages");
        const msgEl = document.createElement("div");
        msgEl.className = `ai-message ${role}`;

        // Formátování kódu
        let formatted = content;
        if (role === "assistant") {
          formatted = content.replace(
            /```html?\n?([\s\S]*?)```/g,
            "<pre>$1</pre>"
          );
          formatted = formatted.replace(/`([^`]+)`/g, "<code>$1</code>");
          formatted = formatted.replace(/\n/g, "<br>");
        }

        msgEl.innerHTML = formatted;
        messagesEl.appendChild(msgEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function showAITyping() {
        const messagesEl = document.getElementById("aiMessages");
        const typingEl = document.createElement("div");
        typingEl.className = "ai-message assistant";
        typingEl.id = "aiTyping";
        typingEl.innerHTML =
          '<div class="ai-typing"><span></span><span></span><span></span></div>';
        messagesEl.appendChild(typingEl);
        messagesEl.scrollTop = messagesEl.scrollHeight;
      }

      function hideAITyping() {
        const typingEl = document.getElementById("aiTyping");
        if (typingEl) typingEl.remove();
      }

      async function sendAIMessage() {
        const input = document.getElementById("aiInput");
        const message = input.value.trim();

        if (!message) return;

        input.value = "";
        addAIMessage("user", message);
        showAITyping();
        document.getElementById("aiSendBtn").disabled = true;

        const currentCode = codeInput.value;
        const systemPrompt = `Jsi AI asistent pro tvorbu HTML stránek. Uživatel pracuje s HTML editorem.
Vždy odpovídej ČESKY. Generuj české texty v HTML.

Aktuální HTML kód:
\`\`\`html
${currentCode}
\`\`\`

DŮLEŽITÉ INSTRUKCE:
- Pokud uživatel chce vytvořit novou stránku, vrať kompletní HTML včetně <!DOCTYPE html>, <html>, <head>, <body>
- Pokud uživatel chce upravit existující stránku, vrať POUZE nový kompletní HTML kód
- Vždy odpovídej POUZE kódem - žádný další text před nebo za kódem
- Kód musí být v jednom bloku \`\`\`html ... \`\`\`
- Design by měl být moderní, responzivní, s inline CSS
- Používej české texty pokud uživatel nepíše anglicky`;

        try {
          const response = await callAI(systemPrompt, message);
          hideAITyping();

          // Extrahuj HTML z odpovědi
          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);
          if (htmlMatch) {
            const newHtml = htmlMatch[1].trim();
            codeInput.value = newHtml;
            updatePreview();
            markUnsaved();
            addToHistory("AI: " + message.substring(0, 30));
            addAIMessage(
              "assistant",
              "✅ Kód byl aplikován!\n\n```html\n" +
                newHtml.substring(0, 500) +
                (newHtml.length > 500 ? "..." : "") +
                "\n```"
            );
          } else {
            addAIMessage("assistant", response);
          }
        } catch (e) {
          hideAITyping();
          addAIMessage("assistant", "❌ Chyba: " + e.message);
        }

        document.getElementById("aiSendBtn").disabled = false;
      }

      async function callAI(systemPrompt, userMessage) {
        const provider = aiSettings.provider || AI.config.defaultProvider;
        const model = aiSettings.model || AI.config.models[provider];

        // Použij AI modul
        return await AI.ask(systemPrompt + "\n\nUživatel: " + userMessage, {
          provider: provider,
          model: model,
          system: systemPrompt,
          maxTokens: 8192,
          temperature: 0.7,
        });
      }

      // ============================================
      // COMPONENTS
      // ============================================
      function openComponentsPanel() {
        document.getElementById("componentsModal").classList.add("active");
      }

      function closeComponentsPanel() {
        document.getElementById("componentsModal").classList.remove("active");
      }

      async function insertComponent(type) {
        closeComponentsPanel();
        showToast("Generuji komponentu...", "success");

        const componentPrompts = {
          header:
            "Vytvoř responzivní header/navigaci s logem vlevo a menu vpravo. Mobilní hamburger menu.",
          hero: "Vytvoř hero sekci s velkým nadpisem, podnadpisem, CTA tlačítkem a obrázkem na pozadí.",
          features:
            "Vytvoř sekci s 3 sloupci features/výhod s ikonami, nadpisy a popisky.",
          cards:
            "Vytvoř grid 3 produktových karet s obrázkem, názvem, popisem a cenou.",
          gallery: "Vytvoř responzivní galerii obrázků v mřížce 3x2.",
          testimonials:
            "Vytvoř sekci s 3 referencemi/recenzemi zákazníků s avatarem, jménem a textem.",
          pricing:
            "Vytvoř ceníkovou tabulku se 3 tarify (Basic, Pro, Enterprise).",
          contact:
            "Vytvoř kontaktní formulář s poli jméno, email, zpráva a tlačítko odeslat.",
          cta: "Vytvoř CTA sekci s výrazným nadpisem a dvěma tlačítky.",
          footer:
            "Vytvoř footer s 4 sloupci (O nás, Služby, Kontakt, Sociální sítě) a copyrightem.",
          faq: "Vytvoř FAQ sekci s 5 rozbalovacími otázkami a odpověďmi.",
          stats:
            "Vytvoř sekci se 4 statistikami/čísly (zákazníci, projekty, roky, ocenění).",
        };

        const prompt = componentPrompts[type] || `Vytvoř ${type} komponentu.`;
        const currentCode = codeInput.value;

        const systemPrompt = `Jsi expert na HTML/CSS. Uživatel chce přidat komponentu do své stránky.

Aktuální HTML:
\`\`\`html
${currentCode}
\`\`\`

INSTRUKCE:
- Pokud stránka nemá základní strukturu, vytvoř kompletní HTML s novou komponentou
- Pokud stránka má strukturu, přidej komponentu na vhodné místo (např. před </body>)
- Vrať CELÝ HTML kód včetně nové komponenty
- Design musí být moderní, responzivní, inline CSS
- Použij podobný styl jako zbytek stránky
- České texty
- Odpověz POUZE kódem v \`\`\`html ... \`\`\``;

        try {
          const response = await callAI(systemPrompt, prompt);
          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);

          if (htmlMatch) {
            codeInput.value = htmlMatch[1].trim();
            updatePreview();
            markUnsaved();
            addToHistory("Komponenta: " + type);
            showToast("Komponenta přidána!", "success");
          } else {
            showToast("Nepodařilo se vygenerovat", "error");
          }
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // TEMPLATES
      // ============================================
      function openTemplates() {
        document.getElementById("templatesModal").classList.add("active");
      }

      function closeTemplates() {
        document.getElementById("templatesModal").classList.remove("active");
      }

      async function loadTemplate(type) {
        if (!aiSettings.apiKey) {
          showToast("Pro šablony nastav API klíč", "error");
          return;
        }

        closeTemplates();
        showToast("Generuji šablonu...", "success");

        const templatePrompts = {
          landing:
            'Vytvoř kompletní landing page pro produkt/službu. Obsahuje: hero sekci s nadpisem a CTA, sekci features (3 výhody), sekci "jak to funguje", testimonials, pricing a footer.',
          portfolio:
            'Vytvoř osobní portfolio stránku. Obsahuje: hero s jménem a profesí, sekci "o mně", galerii projektů (6 karet), skills, kontaktní formulář a footer.',
          restaurant:
            'Vytvoř stránku pro restauraci. Obsahuje: hero s názvem a fotkou jídla, sekci "o nás", menu/jídelní lístek (předkrmy, hlavní chody, dezerty), galerii interiéru, otevírací dobu, rezervační formulář a footer s mapou.',
          business:
            "Vytvoř firemní webovou stránku. Obsahuje: hero s logem a sloganem, sekci služeb, o společnosti, tým (3 lidé), reference klientů, kontakt a footer.",
          blog: "Vytvoř blogovou stránku. Obsahuje: header s navigací, featured článek velký, grid 6 článků (obrázek, datum, nadpis, perex), sidebar s kategoriemi, newsletter signup a footer.",
          eshop:
            "Vytvoř e-shop stránku. Obsahuje: header s logem a košíkem, hero banner s akcí, grid 8 produktů (obrázek, název, cena, tlačítko koupit), kategorie, newsletter a footer.",
          event:
            "Vytvoř stránku pro událost/svatbu. Obsahuje: hero s datem a místem, příběh páru/o akci, program, galerii, RSVP formulář, countdown timer a footer.",
          app: "Vytvoř prezentační stránku pro mobilní aplikaci. Obsahuje: hero s mockupem telefonu, features (4-6), screenshots, download tlačítka (App Store, Google Play), testimonials a footer.",
        };

        const prompt =
          templatePrompts[type] || "Vytvoř moderní responzivní stránku.";

        const systemPrompt = `Jsi expert na tvorbu webových stránek. Vytvoř kompletní, profesionální HTML stránku.

POŽADAVKY:
- Kompletní HTML dokument (<!DOCTYPE html>, <html>, <head>, <body>)
- Moderní, profesionální design
- Plně responzivní (mobile-first)
- Inline CSS v <style> tagu
- České texty a placeholder obsah
- Realistické obrázky z picsum.photos nebo placehold.co
- Smooth scroll, hover efekty
- Odpověz POUZE kódem v \`\`\`html ... \`\`\``;

        try {
          const response = await callAI(systemPrompt, prompt);
          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);

          if (htmlMatch) {
            const file = createFile(type + ".html", htmlMatch[1].trim());
            activeFileId = file.id;
            codeInput.value = file.content;
            renderTabs();
            updatePreview();
            addToHistory("Šablona: " + type);
            switchView("preview");
            showToast("Šablona vytvořena!", "success");
          } else {
            showToast("Nepodařilo se vygenerovat", "error");
          }
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // UNSPLASH
      // ============================================
      function openUnsplash() {
        document.getElementById("unsplashModal").classList.add("active");
      }

      function closeUnsplash() {
        document.getElementById("unsplashModal").classList.remove("active");
      }

      async function searchUnsplash() {
        const query = document.getElementById("unsplashQuery").value.trim();
        if (!query) {
          showToast("Zadej hledaný výraz", "error");
          return;
        }

        const grid = document.getElementById("unsplashGrid");
        grid.innerHTML =
          '<div style="grid-column:1/-1;text-align:center;padding:20px;"><div class="github-loading">Hledám...</div></div>';

        // Používáme Unsplash Source API (nevyžaduje API klíč)
        const images = [];
        for (let i = 0; i < 12; i++) {
          images.push(
            `https://source.unsplash.com/400x300/?${encodeURIComponent(
              query
            )}&sig=${Date.now() + i}`
          );
        }

        grid.innerHTML = images
          .map(
            (url, i) => `
                <img src="${url}" class="unsplash-img" onclick="insertImage('${url}')" loading="lazy" alt="Image ${
              i + 1
            }">
            `
          )
          .join("");
      }

      function insertImage(url) {
        const largeUrl = url.replace("400x300", "1200x800");
        const imgTag = `<img src="${largeUrl}" alt="Image" style="max-width: 100%; height: auto;">`;

        // Vložit na pozici kurzoru nebo na konec body
        const code = codeInput.value;
        if (code.includes("</body>")) {
          codeInput.value = code.replace("</body>", imgTag + "\n</body>");
        } else {
          codeInput.value = code + "\n" + imgTag;
        }

        updatePreview();
        markUnsaved();
        addToHistory("Vložen obrázek");
        closeUnsplash();
        showToast("Obrázek vložen!", "success");
      }

      // ============================================
      // COLOR SCHEMES
      // ============================================
      function openColorSchemes() {
        document.getElementById("colorSchemesModal").classList.add("active");
      }

      function closeColorSchemes() {
        document.getElementById("colorSchemesModal").classList.remove("active");
      }

      async function applyColorScheme(scheme) {
        if (!aiSettings.apiKey) {
          showToast("Pro změnu barev nastav API klíč", "error");
          return;
        }

        closeColorSchemes();
        showToast("Měním barevné schéma...", "success");

        const schemes = {
          dark: "Tmavé schéma: pozadí #0f0f23, akcent #00d4aa (tyrkysová), text bílý",
          light:
            "Světlé schéma: pozadí #ffffff, akcent #2196f3 (modrá), text #333333",
          purple:
            "Fialové schéma: gradient pozadí #667eea → #764ba2, text bílý",
          green: "Zelené schéma: gradient pozadí #11998e → #38ef7d, text bílý",
          orange:
            "Oranžové/růžové schéma: gradient pozadí #ee0979 → #ff6a00, text bílý",
          blue: "Modré schéma: gradient pozadí #2193b0 → #6dd5ed, text bílý/tmavý",
        };

        const systemPrompt = `Změň barevné schéma této HTML stránky:

\`\`\`html
${codeInput.value}
\`\`\`

POŽADOVANÉ SCHÉMA: ${schemes[scheme]}

INSTRUKCE:
- Zachovej strukturu a obsah stránky
- Změň pouze barvy (pozadí, text, tlačítka, odkazy)
- Přidej gradientní pozadí kde je to vhodné
- Zajisti dobrý kontrast a čitelnost
- Vrať kompletní upravený HTML kód
- Odpověz POUZE kódem v \`\`\`html ... \`\`\``;

        try {
          const response = await callAI(systemPrompt, "Aplikuj barevné schéma");
          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);

          if (htmlMatch) {
            codeInput.value = htmlMatch[1].trim();
            updatePreview();
            markUnsaved();
            addToHistory("Barevné schéma: " + scheme);
            showToast("Barvy změněny!", "success");
          } else {
            showToast("Nepodařilo se změnit", "error");
          }
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // SEO CHECK
      // ============================================
      function openSEO() {
        document.getElementById("seoModal").classList.add("active");
        checkSEO();
      }

      function closeSEO() {
        document.getElementById("seoModal").classList.remove("active");
      }

      function checkSEO() {
        const code = codeInput.value;
        const results = [];

        // Title
        const titleMatch = code.match(/<title[^>]*>([^<]*)<\/title>/i);
        const titleLength = titleMatch ? titleMatch[1].length : 0;
        results.push({
          icon: "📌",
          label: "Title tag",
          value: titleMatch
            ? `"${titleMatch[1].substring(0, 30)}${
                titleMatch[1].length > 30 ? "..." : ""
              }" (${titleLength} znaků)`
            : "Chybí!",
          status: titleMatch
            ? titleLength >= 30 && titleLength <= 60
              ? "good"
              : "warn"
            : "bad",
        });

        // Meta description
        const descMatch = code.match(
          /<meta[^>]*name=["']description["'][^>]*content=["']([^"']*)["']/i
        );
        const descLength = descMatch ? descMatch[1].length : 0;
        results.push({
          icon: "📝",
          label: "Meta description",
          value: descMatch ? `${descLength} znaků` : "Chybí!",
          status: descMatch
            ? descLength >= 120 && descLength <= 160
              ? "good"
              : "warn"
            : "bad",
        });

        // H1
        const h1Match = code.match(/<h1[^>]*>([^<]*)<\/h1>/i);
        results.push({
          icon: "🔤",
          label: "H1 nadpis",
          value: h1Match ? `"${h1Match[1].substring(0, 40)}..."` : "Chybí!",
          status: h1Match ? "good" : "bad",
        });

        // Viewport
        const viewportMatch = code.match(/<meta[^>]*name=["']viewport["']/i);
        results.push({
          icon: "📱",
          label: "Viewport meta",
          value: viewportMatch ? "Přítomen" : "Chybí!",
          status: viewportMatch ? "good" : "bad",
        });

        // Charset
        const charsetMatch = code.match(/<meta[^>]*charset/i);
        results.push({
          icon: "🔣",
          label: "Charset",
          value: charsetMatch ? "Přítomen" : "Chybí!",
          status: charsetMatch ? "good" : "warn",
        });

        // Images with alt
        const imgCount = (code.match(/<img/gi) || []).length;
        const imgAltCount = (code.match(/<img[^>]*alt=["'][^"']+["']/gi) || [])
          .length;
        results.push({
          icon: "🖼️",
          label: "Obrázky s alt",
          value: `${imgAltCount}/${imgCount} má alt text`,
          status:
            imgCount === 0
              ? "good"
              : imgAltCount === imgCount
              ? "good"
              : imgAltCount > 0
              ? "warn"
              : "bad",
        });

        // Links
        const linkCount = (code.match(/<a[^>]*href/gi) || []).length;
        results.push({
          icon: "🔗",
          label: "Odkazy",
          value: `${linkCount} odkazů`,
          status: linkCount > 0 ? "good" : "warn",
        });

        // Open Graph
        const ogMatch = code.match(/<meta[^>]*property=["']og:/i);
        results.push({
          icon: "📢",
          label: "Open Graph",
          value: ogMatch ? "Přítomen" : "Chybí (pro sociální sítě)",
          status: ogMatch ? "good" : "warn",
        });

        const resultsEl = document.getElementById("seoResults");
        const goodCount = results.filter((r) => r.status === "good").length;
        const score = Math.round((goodCount / results.length) * 100);

        resultsEl.innerHTML = `
                <div style="text-align:center;margin-bottom:16px;">
                    <div style="font-size:36px;font-weight:bold;color:${
                      score >= 80
                        ? "var(--success)"
                        : score >= 50
                        ? "var(--warning)"
                        : "var(--error)"
                    };">${score}%</div>
                    <div style="font-size:12px;color:var(--text-muted);">SEO skóre</div>
                </div>
                ${results
                  .map(
                    (r) => `
                    <div class="seo-item">
                        <div class="seo-icon">${r.icon}</div>
                        <div class="seo-info">
                            <div class="seo-label">${r.label}</div>
                            <div class="seo-value">${r.value}</div>
                        </div>
                        <div class="seo-status ${r.status}">${
                      r.status === "good"
                        ? "✓"
                        : r.status === "warn"
                        ? "!"
                        : "✗"
                    }</div>
                    </div>
                `
                  )
                  .join("")}
            `;
      }

      async function fixSEOWithAI() {
        if (!aiSettings.apiKey) {
          showToast("Nastav API klíč", "error");
          return;
        }

        closeSEO();
        showToast("AI opravuje SEO...", "success");

        const systemPrompt = `Vylepši SEO této HTML stránky:

\`\`\`html
${codeInput.value}
\`\`\`

PŘIDEJ/OPRAV:
- <title> tag (30-60 znaků, výstižný)
- <meta name="description"> (120-160 znaků)
- <meta name="viewport">
- <meta charset="UTF-8">
- <h1> nadpis (pokud chybí)
- alt texty u obrázků
- Open Graph meta tagy (og:title, og:description, og:image)
- Sémantické HTML tagy (header, nav, main, footer, article, section)

Zachovej obsah a design, jen vylepši SEO.
Odpověz POUZE kódem v \`\`\`html ... \`\`\``;

        try {
          const response = await callAI(systemPrompt, "Oprav SEO");
          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);

          if (htmlMatch) {
            codeInput.value = htmlMatch[1].trim();
            updatePreview();
            markUnsaved();
            addToHistory("SEO oprava");
            showToast("SEO vylepšeno!", "success");
          }
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // DEVICE PREVIEW
      // ============================================
      function openDevices() {
        document.getElementById("devicesModal").classList.add("active");
        setDevice("iphone14", 390, 844);
      }

      function closeDevices() {
        document.getElementById("devicesModal").classList.remove("active");
      }

      function setDevice(name, width, height) {
        const buttons = document.querySelectorAll(".device-btn");
        buttons.forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        const frame = document.getElementById("deviceFrame");
        const preview = document.getElementById("devicePreview");

        frame.style.width = width + 20 + "px";
        preview.style.width = width + "px";
        preview.style.height = Math.min(height, 500) + "px";

        // Aktualizovat iframe
        const doc = preview.contentDocument;
        doc.open();
        doc.write(codeInput.value);
        doc.close();
      }

      // ============================================
      // PUBLISH
      // ============================================
      function openPublish() {
        if (!githubToken) {
          showToast("Nastav GitHub token v nastavení", "error");
          return;
        }
        document.getElementById("publishModal").classList.add("active");
        document.getElementById("publishResult").style.display = "none";

        const file = files.find((f) => f.id === activeFileId);
        document.getElementById("publishRepoName").value = (
          file?.name || "moje-stranka"
        )
          .replace(/\.html?$/, "")
          .replace(/[^a-z0-9-]/gi, "-");
      }

      function closePublish() {
        document.getElementById("publishModal").classList.remove("active");
      }

      async function publishToGitHub() {
        const repoName = document
          .getElementById("publishRepoName")
          .value.trim()
          .toLowerCase()
          .replace(/[^a-z0-9-]/g, "-");

        if (!repoName) {
          showToast("Zadej název repozitáře", "error");
          return;
        }

        showToast("Publikuji...", "success");

        try {
          // 1. Vytvoř repo
          let repoRes = await fetch("https://api.github.com/user/repos", {
            method: "POST",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              name: repoName,
              auto_init: true,
              private: false,
            }),
          });

          let repo;
          if (repoRes.status === 422) {
            // Repo už existuje - načti ho
            const userRes = await fetch("https://api.github.com/user", {
              headers: { Authorization: `token ${githubToken}` },
            });
            const user = await userRes.json();
            repo = {
              full_name: `${user.login}/${repoName}`,
              owner: { login: user.login },
            };
          } else if (repoRes.ok) {
            repo = await repoRes.json();
            await new Promise((r) => setTimeout(r, 1000)); // Počkej na vytvoření
          } else {
            throw new Error("Nelze vytvořit repozitář");
          }

          // 2. Nahraj index.html
          const content = btoa(unescape(encodeURIComponent(codeInput.value)));

          // Zkus získat SHA existujícího souboru
          let sha = null;
          try {
            const fileRes = await fetch(
              `https://api.github.com/repos/${repo.full_name}/contents/index.html`,
              {
                headers: { Authorization: `token ${githubToken}` },
              }
            );
            if (fileRes.ok) {
              const fileData = await fileRes.json();
              sha = fileData.sha;
            }
          } catch (e) {}

          const uploadRes = await fetch(
            `https://api.github.com/repos/${repo.full_name}/contents/index.html`,
            {
              method: "PUT",
              headers: {
                Authorization: `token ${githubToken}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                message: "Update from HTML Studio",
                content: content,
                sha: sha,
              }),
            }
          );

          if (!uploadRes.ok) throw new Error("Nelze nahrát soubor");

          // 3. Zapni GitHub Pages
          await fetch(`https://api.github.com/repos/${repo.full_name}/pages`, {
            method: "POST",
            headers: {
              Authorization: `token ${githubToken}`,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              source: { branch: "main", path: "/" },
            }),
          });

          const owner = repo.owner?.login || repo.full_name.split("/")[0];
          const pagesUrl = `https://${owner}.github.io/${repoName}/`;

          document.getElementById("publishResult").style.display = "block";
          document.getElementById("publishResult").innerHTML = `
                    <div style="text-align:center;padding:16px;background:rgba(81, 207, 102, 0.1);border-radius:12px;">
                        <div style="font-size:24px;margin-bottom:8px;">🎉</div>
                        <div style="font-size:14px;font-weight:500;margin-bottom:8px;">Publikováno!</div>
                        <a href="${pagesUrl}" target="_blank" class="publish-url">${pagesUrl}</a>
                        <div style="font-size:11px;color:var(--text-muted);">Může trvat 1-2 minuty než bude stránka aktivní</div>
                    </div>
                `;

          showToast("Stránka publikována!", "success");
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // SCREENSHOT TO HTML
      // ============================================
      let screenshotData = null;

      function openScreenshot() {
        document.getElementById("screenshotModal").classList.add("active");
        document.getElementById("screenshotPreview").style.display = "none";
        document.getElementById("generateFromScreenshot").style.display =
          "none";
        document.getElementById("screenshotInput").value = "";
        screenshotData = null;
      }

      function closeScreenshot() {
        document.getElementById("screenshotModal").classList.remove("active");
      }

      function handleScreenshot(input) {
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            screenshotData = e.target.result;
            document.getElementById("screenshotPreview").src = screenshotData;
            document.getElementById("screenshotPreview").style.display =
              "block";
            document.getElementById("generateFromScreenshot").style.display =
              "block";
          };
          reader.readAsDataURL(input.files[0]);
        }
      }

      async function generateFromScreenshot() {
        if (!screenshotData) {
          showToast("Nahraj obrázek", "error");
          return;
        }

        if (!aiSettings.apiKey) {
          showToast("Nastav API klíč", "error");
          return;
        }

        // Pouze Gemini a Claude podporují obrázky
        if (
          aiSettings.provider !== "gemini" &&
          aiSettings.provider !== "claude"
        ) {
          showToast("Pro obrázky použij Gemini nebo Claude", "error");
          return;
        }

        closeScreenshot();
        showToast("AI analyzuje obrázek...", "success");

        try {
          let response;

          if (aiSettings.provider === "gemini") {
            const base64 = screenshotData.split(",")[1];
            const model = aiSettings.model || "gemini-2.0-flash";

            const res = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${aiSettings.apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  contents: [
                    {
                      parts: [
                        {
                          text: "Analyzuj tento screenshot webové stránky a vytvoř podobnou HTML stránku. Snaž se co nejvíce přiblížit designu, rozložení a barvám. Vytvoř kompletní responzivní HTML s inline CSS. Odpověz POUZE kódem v ```html ... ```",
                        },
                        {
                          inline_data: {
                            mime_type: "image/jpeg",
                            data: base64,
                          },
                        },
                      ],
                    },
                  ],
                  generationConfig: { temperature: 0.7, maxOutputTokens: 8192 },
                }),
              }
            );

            const data = await res.json();
            response = data.candidates?.[0]?.content?.parts?.[0]?.text || "";
          } else if (aiSettings.provider === "claude") {
            const base64 = screenshotData.split(",")[1];
            const mediaType = screenshotData.split(";")[0].split(":")[1];

            const res = await fetch("https://api.anthropic.com/v1/messages", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "x-api-key": aiSettings.apiKey,
                "anthropic-version": "2023-06-01",
                "anthropic-dangerous-direct-browser-access": "true",
              },
              body: JSON.stringify({
                model: aiSettings.model || "claude-sonnet-4-20250514",
                max_tokens: 8192,
                messages: [
                  {
                    role: "user",
                    content: [
                      {
                        type: "image",
                        source: {
                          type: "base64",
                          media_type: mediaType,
                          data: base64,
                        },
                      },
                      {
                        type: "text",
                        text: "Analyzuj tento screenshot webové stránky a vytvoř podobnou HTML stránku. Snaž se co nejvíce přiblížit designu, rozložení a barvám. Vytvoř kompletní responzivní HTML s inline CSS. Odpověz POUZE kódem v ```html ... ```",
                      },
                    ],
                  },
                ],
              }),
            });

            const data = await res.json();
            response = data.content?.[0]?.text || "";
          }

          const htmlMatch = response.match(/```html?\n?([\s\S]*?)```/);

          if (htmlMatch) {
            const file = createFile(
              "from-screenshot.html",
              htmlMatch[1].trim()
            );
            activeFileId = file.id;
            codeInput.value = file.content;
            renderTabs();
            updatePreview();
            addToHistory("Z obrázku");
            switchView("preview");
            showToast("Stránka vygenerována!", "success");
          } else {
            showToast("Nepodařilo se vygenerovat", "error");
          }
        } catch (e) {
          showToast("Chyba: " + e.message, "error");
        }
      }

      // ============================================
      // INIT
      // ============================================
      function init() {
        const saved = localStorage.getItem("htmlStudio_files");
        const savedId = localStorage.getItem("htmlStudio_activeId");
        if (saved) {
          try {
            files = JSON.parse(saved);
            activeFileId = parseInt(savedId) || files[0]?.id;
            fileIdCounter = Math.max(...files.map((f) => f.id));
            files.forEach((f) => {
              if (!f.history) {
                f.history = [];
                f.historyIndex = -1;
              }
            });
          } catch {
            files = [];
          }
        }
        if (files.length === 0) {
          const f = createFile();
          activeFileId = f.id;
        }
        codeInput.value =
          files.find((f) => f.id === activeFileId)?.content || "";
        renderTabs();
        updatePreview();
        renderHistory();
        loadPrompts();
        loadGithubToken();
        loadAISettings();
        applySettings();
        addToHistory("Start");
        updateLineNumbers(codeInput, lineNumbers);

        // Apply saved theme
        setTheme(currentTheme);

        // Init minimap checkbox
        const minimapCheckbox = document.getElementById("minimapToggle");
        if (minimapCheckbox) minimapCheckbox.checked = minimapEnabled;
        if (minimapEnabled) {
          document.getElementById("minimap")?.classList.add("active");
          updateMinimap();
        }

        // Init syntax highlighting
        const syntaxCheckbox = document.getElementById("syntaxToggle");
        if (syntaxCheckbox) syntaxCheckbox.checked = syntaxEnabled;
        if (!syntaxEnabled) {
          codeWrapper.classList.add("syntax-off");
        }
        updateSyntaxHighlight();
      }

      let inputTimeout;
      codeInput.addEventListener("input", () => {
        updatePreview();
        markUnsaved();
        updateLineNumbers(codeInput, lineNumbers);
        updateMinimap();
        updateSyntaxHighlight();
        clearTimeout(inputTimeout);
        inputTimeout = setTimeout(() => addToHistory("Úprava"), 1500);
      });

      init();

      // Načti sdílený kód z URL hash
      loadSharedCode();
    </script>
  </body>
</html>
