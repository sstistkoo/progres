<!DOCTYPE html>
<html lang="cs" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Hlavní Editor</title>
    <!-- Načtení Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Načtení Font Awesome pro ikony -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <!-- NOVÉ: Knihovna CodeMirror pro syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <!-- NOVÉ: Téma pro CodeMirror (světlé) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
    
    <style>
        /* Jednoduchý styl pro plynulý přechod a aktivní položku */
        .file-item:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .file-item.active {
            background-color: #dbeafe; /* blue-100 */
            font-weight: 600;
            color: #1d4ed8; /* blue-700 */
        }
        
        /* Skrývání scrollbaru (volitelné, pro čistší vzhled na PC) */
        #parameter-list::-webkit-scrollbar {
            width: 6px;
        }
        #parameter-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* cool-gray-300 */
            border-radius: 3px;
        }
        #program-list::-webkit-scrollbar {
            width: 6px;
        }
        #program-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* cool-gray-300 */
            border-radius: 3px;
        }
        
        /* NOVÉ: Styly pro CodeMirror, aby vyplnil flex kontejner */
        .CodeMirror {
            flex: 1; /* Make it fill the flex container */
            width: 100%;
            height: 100%;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 14px; /* Zvětšení písma pro lepší čitelnost */
            line-height: 1.4;
        }
    </style>
</head>
<body class="h-full flex flex-col">

    <!-- 
      Hlavní kontejner
      'relative' je potřeba pro absolutní pozicování postranního panelu na mobilu 
    -->
    <div class="flex-1 flex relative overflow-hidden">

        <!-- 
          Levý postranní panel (Sidebar) -> Nyní "Nástroje a Detaily"
          - Na mobilu: 'fixed', 'inset-y-0', 'left-0', 'z-40' (vysoký z-index)
          - Schovaný mimo obrazovku: '-translate-x-full'
          - Na PC (lg:): 'relative', 'translate-x-0' (vrácení do normálního stavu)
        -->
        <nav id="tools-panel" class="fixed lg:relative inset-y-0 left-0 w-80 h-full bg-white border-r border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            
            <!-- Hlavička postranního panelu (NOVÁ) -->
            <div class="flex justify-between items-center p-4 border-b lg:hidden">
                <h2 class="text-lg font-semibold text-gray-800">Nástroje</h2>
                <button id="tools-close-btn" class="p-1 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <!-- Sekce: Nástroje (NOVÁ) -->
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Nástroje</h2>
                <div class="mt-2 space-y-2">
                    <button id="convert-to-absolute-btn" class="w-full px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Převést na Absolutní G-kód
                    </button>
                    <p class="text-xs text-gray-500">
                        Vygeneruje G-kód ze všech pohybů (G0, G1, G2, G3) načtených ze simulátoru.
                    </p>
                </div>
            </div>
            
        </nav>

        <!-- 
          Pravý postranní panel (OBNOVEN) -> Nyní "Detaily a Programy"
          - Na mobilu: 'fixed', 'inset-y-0', 'right-0', 'z-40'
          - Schovaný mimo obrazovku: 'translate-x-full'
          - Na PC (lg:): 'relative', 'translate-x-0'
        -->
        <aside id="details-panel" class="fixed lg:relative inset-y-0 right-0 w-80 h-full bg-white border-l border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <!-- Hlavička postranního panelu (NOVÁ) -->
            <div class="flex justify-between items-center p-4 border-b lg:hidden">
                <h2 class="text-lg font-semibold text-gray-800">Detaily a Programy</h2>
                <button id="details-close-btn" class="p-1 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <!-- Sekce: Seznam souborů (PŘESUNUTO SEM) -->
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Načtené programy</h2>
                <div id="program-list" class="mt-2 h-64 overflow-y-auto bg-gray-50 rounded-lg p-2 text-sm space-y-1">
                    <p class="text-gray-500 text-sm">Načítání dat...</p>
                </div>
            </div>

            <!-- Sekce: Čas stroje (PŘESUNUTO SEM) -->
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Strojní čas</h2>
                <div id="time-summary" class="mt-2 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Celkový čas (G1, G2, G3):</p>
                    <p id="total-time" class="text-2xl font-bold text-blue-600">Výpočet...</p>
                    <p id="time-details" class="text-xs text-gray-500"></p>
                </div>
            </div>

            <!-- Sekce: Parametry (PŘESUNUTO SEM) -->
            <div class="p-4 flex-1">
                <h2 class="text-lg font-semibold text-gray-800">R-Parametry</h2>
                <div id="parameter-list" class="mt-2 h-64 overflow-y-auto bg-gray-50 rounded-lg p-2 text-sm font-mono space-y-1">
                    <!-- Sem se dynamicky vloží parametry -->
                </div>
            </div>
        </aside>

        <!-- Overlay (NOVÝ) - pro ztmavení pozadí na mobilu -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Hlavní obsah (Editor) -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Záhlaví editoru -->
            <div class="bg-white border-b border-gray-200 p-3 flex justify-between items-center">
                
                <!-- Tlačítka vlevo (Menu + Detaily) -->
                <div class="flex items-center gap-2">
                    <!-- Tlačítko Menu (lg:hidden) -> Nyní pro Nástroje (vlevo) -->
                    <button id="tools-open-btn" class="p-2 mr-0 text-gray-600 hover:text-gray-800 lg:hidden">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
                
                <h1 id="current-file-name" class="text-xl font-semibold text-gray-900 truncate mx-2">
                    Editor
                </h1>
                
                <!-- Tlačítka vpravo (Uložit + Zavřít) -->
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="save-btn" onclick="copyToClipboard()" class="ml-0 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200">
                        Uložit
                    </button>
                    <!-- Tlačítko Zavřít (NOVÉ) -->
                    <button id="close-btn" onclick="closeTab()" title="Zavřít záložku" class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <!-- Tlačítko Detaily (PŘESUNUTO SEM) (lg:hidden) -> Nyní pro Detaily (vpravo) -->
                    <button id="details-open-btn" class="p-2 ml-1 text-gray-600 hover:text-gray-800 lg:hidden">
                        <i class="fas fa-list-ul fa-lg"></i>
                    </button>
                </div>
            </div>
            
            <!-- 
              Textový editor
              UPRAVENO: Toto je nyní CodeMirror editor. 
              Původní <textarea> je skryta a spravována knihovnou.
            -->
            <textarea id="main-editor" spellcheck="false" placeholder="Načtěte data ze simulátoru..."></textarea>
        </main>
    </div>

    <!-- NOVÉ: JS Knihovny pro CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <!-- NOVÉ: JS mód pro G-Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gcode/gcode.min.js"></script>

    <script>
        // Globální úložiště pro načtená data
        let loadedData = {
            rawCode: "",
            parameters: [],
            movements: [],
            loadedPrograms: {}
        };

        // DOM Elementy
        const mainEditor = document.getElementById('main-editor');
        const programListEl = document.getElementById('program-list');
        const parameterListEl = document.getElementById('parameter-list');
        const totalTimeEl = document.getElementById('total-time');
        const timeDetailsEl = document.getElementById('time-details');
        const currentFileNameEl = document.getElementById('current-file-name');
        
        // NOVÁ GLOBÁLNÍ PROMĚNNÁ: Instance CodeMirror editoru
        let cmEditor;

        // DOM Elementy pro mobilní menu
        const toolsPanel = document.getElementById('tools-panel');
        const overlay = document.getElementById('overlay');
        const toolsOpenBtn = document.getElementById('tools-open-btn');
        const toolsCloseBtn = document.getElementById('tools-close-btn');

        const detailsPanel = document.getElementById('details-panel');
        const detailsOpenBtn = document.getElementById('details-open-btn');
        const detailsCloseBtn = document.getElementById('details-close-btn');

        /**
         * Načte data z localStorage a spustí naplnění UI
         */
        function loadDataFromStorage() {
            const dataString = localStorage.getItem('cncExternalEditorData');
            if (!dataString) {
                // UPRAVENO: Použít cmEditor.setValue
                cmEditor.setValue("CHYBA: V localStorage nebyla nalezena žádná data (cncExternalEditorData).\n\nZkuste se vrátit do simulátoru a znovu kliknout na tlačítko 'Upravit'.");
                programListEl.innerHTML = '<p class="text-red-500 text-sm">Data nenalezena.</p>';
                totalTimeEl.textContent = "Chyba";
                return;
            }

            try {
                loadedData = JSON.parse(dataString);

                if (!loadedData.loadedPrograms || !loadedData.parameters || !loadedData.movements) {
                    throw new Error("Data v localStorage jsou nekompletní.");
                }

                populateProgramList(loadedData.loadedPrograms, loadedData.rawCode);
                populateParameters(loadedData.parameters);
                calculateMachiningTime(loadedData.movements);

                displayFileContent('main_program'); 

            } catch (error) {
                console.error("Chyba při parsování dat z localStorage:", error);
                // UPRAVENO: Použít cmEditor.setValue
                cmEditor.setValue(`CHYBA: Nepodařilo se zpracovat data z localStorage.\n\n${error.message}`);
            }
        }

        /**
         * Nastaví listenery pro otevírání/zavírání menu
         */
        function setupPanelListeners() {
            if (toolsOpenBtn && toolsCloseBtn && toolsPanel && overlay) {
                toolsOpenBtn.addEventListener('click', openToolsPanel);
                toolsCloseBtn.addEventListener('click', closeToolsPanel);
            }
            
            if (detailsOpenBtn && detailsCloseBtn && detailsPanel) {
                detailsOpenBtn.addEventListener('click', openDetailsPanel);
                detailsCloseBtn.addEventListener('click', closeDetailsPanel);
            }
            
            if (overlay) {
                overlay.addEventListener('click', () => {
                    closeToolsPanel();
                    closeDetailsPanel(); 
                });
            }
        }
        
        /** Otevře postranní panel */
        function openToolsPanel() {
            closeDetailsPanel(); 
            toolsPanel.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }

        /** Zavře postranní panel */
        function closeToolsPanel() {
            toolsPanel.classList.add('-translate-x-full');
            if (detailsPanel && detailsPanel.classList.contains('translate-x-full')) {
                overlay.classList.add('hidden');
            }
        }
        
        /** Otevře panel detailů */
        function openDetailsPanel() {
            closeToolsPanel(); 
            detailsPanel.classList.remove('translate-x-full');
            overlay.classList.remove('hidden');
        }

        /** Zavře panel detailů */
        function closeDetailsPanel() {
            detailsPanel.classList.add('translate-x-full');
            if (toolsPanel && toolsPanel.classList.contains('-translate-x-full')) {
                overlay.classList.add('hidden');
            }
        }
        

        /**
         * Naplní seznam souborů v postranním panelu
         */
        function populateProgramList(programs, mainCode) {
            programListEl.innerHTML = ''; 

            const mainEl = document.createElement('div');
            mainEl.textContent = "HLAVNÍ PROGRAM (.mpf)";
            mainEl.className = "file-item p-2 rounded-md cursor-pointer text-gray-700";
            mainEl.onclick = () => displayFileContent('main_program');
            programListEl.appendChild(mainEl);

            loadedData.loadedPrograms['main_program'] = mainCode;

            const subprogramNames = Object.keys(programs).sort();
            for (const filename of subprogramNames) {
                if (filename === 'main_program') continue; 

                const el = document.createElement('div');
                el.textContent = filename;
                el.className = "file-item p-2 rounded-md cursor-pointer text-gray-700";
                el.onclick = () => displayFileContent(filename);
                programListEl.appendChild(el);
            }
        }

        /**
         * Zobrazí obsah vybraného souboru v editoru
         */
        function displayFileContent(filename) {
            if (loadedData.loadedPrograms[filename] !== undefined) {
                // UPRAVENO: Použít cmEditor.setValue
                cmEditor.setValue(loadedData.loadedPrograms[filename]);
                currentFileNameEl.textContent = (filename === 'main_program') ? "Hlavní program" : filename;

                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent.startsWith(filename) || (filename === 'main_program' && item.textContent.startsWith("HLAVNÍ"))) {
                        item.classList.add('active');
                    }
                });

                if (detailsOpenBtn.offsetParent !== null) {
                    closeDetailsPanel();
                }

            } else {
                console.warn(`Soubor ${filename} nebyl nalezen v loadedData.`);
            }
        }

        /**
         * Zobrazí R-Parametry v postranním panelu
         */
        function populateParameters(parameters) {
            parameterListEl.innerHTML = ''; 
            
            const filteredParams = parameters.filter(([key, value]) => value !== 0);

            filteredParams.sort((a, b) => {
                const numA = parseInt(a[0].replace('R', ''));
                const numB = parseInt(b[0].replace('R', ''));
                return numA - numB;
            });

            if (filteredParams.length === 0) {
                parameterListEl.innerHTML = '<span class="text-gray-500">Žádné aktivní parametry.</span>';
                return;
            }

            for (const [key, value] of filteredParams) {
                const el = document.createElement('div');
                el.className = "flex justify-between";
                el.innerHTML = `<span class="text-gray-600">${key}:</span> <span class="font-semibold text-gray-800">${Number(value).toFixed(3)}</span>`;
                parameterListEl.appendChild(el);
            }
        }

        /**
         * Vypočítá a zobrazí celkový strojní čas
         */
        function calculateMachiningTime(movements) {
            let totalTimeMinutes = 0;

            if (!movements || movements.length === 0) {
                totalTimeEl.textContent = "N/A";
                return;
            }

            for (const move of movements) {
                if (move.rapid) continue;

                let distance = 0;
                if (move.isArc && move.arcPoints && move.arcPoints.length > 1) {
                    let lastPoint = { x: move.fromX, z: move.fromZ };
                    for (const point of move.arcPoints) {
                        distance += Math.hypot(point.x - lastPoint.x, point.z - lastPoint.z);
                        lastPoint = point;
                    }
                } else if (!move.isArc) {
                    distance = Math.hypot(move.toX - move.fromX, move.toZ - move.fromZ);
                }

                if (distance === 0) continue;

                let timeForMove = 0;

                if (move.feedMode === 'G95') { 
                    const feedPerMinute = move.feedRate * move.spindleSpeed; 
                    if (feedPerMinute > 0) {
                        timeForMove = distance / feedPerMinute; 
                    }
                } else { 
                    if (move.feedRate > 0) {
                        timeForMove = distance / move.feedRate; 
                    }
                }
                
                totalTimeMinutes += timeForMove;
            }

            const time = formatTime(totalTimeMinutes);
            totalTimeEl.textContent = time.formatted;
            timeDetailsEl.textContent = `(${totalTimeMinutes.toFixed(2)} minut)`;
        }

        /**
         * Převede minuty na formát H:MM:SS
         */
        function formatTime(totalMinutes) {
            const totalSeconds = Math.floor(totalMinutes * 60);
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => num.toString().padStart(2, '0');

            let formatted = "";
            if (hours > 0) {
                formatted = `${hours}:${pad(minutes)}:${pad(seconds)}`;
            } else {
                formatted = `${minutes}:${pad(seconds)}`;
            }

            return { formatted, hours, minutes, seconds };
        }

        /**
         * Zkopíruje aktuální obsah editoru do schránky
         */
        async function copyToClipboard() {
            // UPRAVENO: Použít cmEditor.getValue
            const textToCopy = cmEditor.getValue();
            const saveBtn = document.getElementById('save-btn');
            
            if (!saveBtn) return;
            const originalText = saveBtn.textContent;

            try {
                await navigator.clipboard.writeText(textToCopy);
                
                saveBtn.textContent = 'Zkopírováno!';
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-red-500');
                saveBtn.classList.add('bg-green-500');

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('bg-green-500');
                    saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);

            } catch (err) {
                console.error('Chyba při kopírování do schránky: ', err);

                saveBtn.textContent = 'Chyba!';
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-500');
                saveBtn.classList.add('bg-red-500');

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('bg-red-500');
                    saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 3000);
            }
        }
        
        /**
         * Zavře aktuální záložku prohlížeče
         */
        function closeTab() {
            window.close();
        }

        /**
         * Pomocná funkce pro formátování čísel do G-kódu
         */
        function formatNum(num) {
            return Number(num).toFixed(3).replace(/\.?0+$/, '');
        }

        /**
         * Převede 'movements' z localStorage na absolutní G-kód
         */
        function convertGCodeToAbsolute() {
            if (!loadedData.movements || loadedData.movements.length === 0) {
                alert("CHYBA: Nejsou načtena žádná data o pohybech ze simulátoru.");
                return;
            }

            let newCode = [];
            newCode.push('; --- KÓD PŘEVEDENÝ NA ABSOLUTNÍ HODNOTY ---');
            newCode.push('; --- Vygenerováno ze všech pohybů (G0-G3) ---');
            newCode.push('G90 ; Absolutní souřadnice');
            
            let lastFeed = -1;
            let lastSpindle = -1;
            let lastMoveType = ""; 

            for (const move of loadedData.movements) {
                const x = formatNum(move.toX);
                const z = formatNum(move.toZ);
                
                let line = "";

                if (move.type !== lastMoveType) {
                    line += `${move.type} `;
                    lastMoveType = move.type;
                }

                if (move.isArc && move.center) {
                    line += `X${x} Z${z}`;
                    
                    const i = formatNum(move.center.x - move.fromX);
                    const k = formatNum(move.center.z - move.fromZ);
                    line += ` I${i} K${k}`;
                    
                } else {
                    line += `X${x} Z${z}`;
                }

                if (!move.rapid) {
                    const f = formatNum(move.feedRate);
                    if (move.feedRate !== lastFeed) {
                        line += ` F${f}`;
                        lastFeed = move.feedRate;
                    }
                } else {
                    lastFeed = -1;
                }
                
                newCode.push(line);
            }

            // UPRAVENO: Použít cmEditor.setValue
            cmEditor.setValue(newCode.join('\n'));
            currentFileNameEl.textContent = "Absolutní G-kód (Přepočteno)";

            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });
            
            if (toolsOpenBtn.offsetParent !== null) {
                closeToolsPanel();
            }
        }

        /**
         * Spuštění po načtení DOM
         */
        window.addEventListener('DOMContentLoaded', () => {
            
            // NOVÉ: Inicializace CodeMirror editoru
            cmEditor = CodeMirror.fromTextArea(mainEditor, {
                lineNumbers: true,      // Přidá čísla řádků
                mode: 'gcode',          // Nastaví mód pro CNC
                theme: 'eclipse',       // Světlé téma
                lineWrapping: true,     // Automaticky zalamuje řádky
                readOnly: false
            });
            
            // NOVÉ: Nastavení, aby editor vyplnil flexibilní kontejner
            // Musí být provedeno po inicializaci
            const cmWrapper = cmEditor.getWrapperElement();
            cmWrapper.style.flex = '1';
            cmWrapper.style.minHeight = '0'; // Důležité pro flexbox
            
            // Až teď spustit zbytek
            loadDataFromStorage();
            setupPanelListeners();
            
            const convertBtn = document.getElementById('convert-to-absolute-btn');
            if (convertBtn) {
                convertBtn.addEventListener('click', convertGCodeToAbsolute);
            }
        });

    </script>
</body>
</html>
