<!DOCTYPE html>
<html lang="cs" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Hlavní Editor</title>
    <!-- Načtení Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Jednoduchý styl pro plynulý přechod a aktivní položku */
        .file-item:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .file-item.active {
            background-color: #dbeafe; /* blue-100 */
            font-weight: 600;
            color: #1d4ed8; /* blue-700 */
        }
    </style>
</head>
<body class="h-full flex flex-col">

    <!-- Hlavní kontejner -->
    <div class="flex-1 flex overflow-hidden">

        <!-- Levý postranní panel (Sidebar) -->
        <nav class="w-80 h-full bg-white border-r border-gray-200 overflow-y-auto flex flex-col shadow-lg">
            
            <!-- Sekce: Seznam souborů -->
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Načtené programy</h2>
                <div id="program-list" class="mt-2 space-y-1">
                    <!-- Sem se dynamicky vloží seznam souborů -->
                    <p class="text-gray-500 text-sm">Načítání dat...</p>
                </div>
            </div>

            <!-- Sekce: Čas stroje -->
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Strojní čas</h2>
                <div id="time-summary" class="mt-2 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Celkový čas (G1, G2, G3):</p>
                    <p id="total-time" class="text-2xl font-bold text-blue-600">Výpočet...</p>
                    <p id="time-details" class="text-xs text-gray-500"></p>
                </div>
            </div>

            <!-- Sekce: Parametry -->
            <div class="p-4 flex-1">
                <h2 class="text-lg font-semibold text-gray-800">R-Parametry</h2>
                <div id="parameter-list" class="mt-2 h-64 overflow-y-auto bg-gray-50 rounded-lg p-2 text-sm font-mono space-y-1">
                    <!-- Sem se dynamicky vloží parametry -->
                </div>
            </div>
        </nav>

        <!-- Hlavní obsah (Editor) -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Záhlaví editoru -->
            <div class="bg-white border-b border-gray-200 p-3 flex justify-between items-center">
                <h1 id="current-file-name" class="text-xl font-semibold text-gray-900">Editor</h1>
                <button onclick="saveAndClose()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">
                    Uložit a vrátit
                </button>
            </div>
            
            <!-- Textový editor -->
            <textarea id="main-editor" class="flex-1 w-full h-full p-4 font-mono text-sm resize-none outline-none" spellcheck="false" placeholder="Načtěte data ze simulátoru..."></textarea>
        </main>
    </div>

    <script>
        // Globální úložiště pro načtená data
        let loadedData = {
            rawCode: "",
            parameters: [],
            movements: [],
            loadedPrograms: {}
        };

        // DOM Elementy
        const mainEditor = document.getElementById('main-editor');
        const programListEl = document.getElementById('program-list');
        const parameterListEl = document.getElementById('parameter-list');
        const totalTimeEl = document.getElementById('total-time');
        const timeDetailsEl = document.getElementById('time-details');
        const currentFileNameEl = document.getElementById('current-file-name');

        /**
         * Spustí se po načtení stránky
         */
        window.onload = function() {
            loadDataFromStorage();
        };

        /**
         * Načte data z localStorage a spustí naplnění UI
         */
        function loadDataFromStorage() {
            const dataString = localStorage.getItem('cncExternalEditorData');
            if (!dataString) {
                mainEditor.value = "CHYBA: V localStorage nebyla nalezena žádná data (cncExternalEditorData).\n\nZkuste se vrátit do simulátoru a znovu kliknout na tlačítko 'Upravit'.";
                programListEl.innerHTML = '<p class="text-red-500 text-sm">Data nenalezena.</p>';
                totalTimeEl.textContent = "Chyba";
                return;
            }

            try {
                loadedData = JSON.parse(dataString);

                // Kontrola dat
                if (!loadedData.loadedPrograms || !loadedData.parameters || !loadedData.movements) {
                    throw new Error("Data v localStorage jsou nekompletní.");
                }

                // Spuštění funkcí pro naplnění UI
                populateProgramList(loadedData.loadedPrograms, loadedData.rawCode);
                populateParameters(loadedData.parameters);
                calculateMachiningTime(loadedData.movements);

                // Zobrazit hlavní program jako výchozí
                displayFileContent('main_program'); // Použijeme speciální klíč

            } catch (error) {
                console.error("Chyba při parsování dat z localStorage:", error);
                mainEditor.value = `CHYBA: Nepodařilo se zpracovat data z localStorage.\n\n${error.message}`;
            }
        }

        /**
         * Naplní seznam souborů v postranním panelu
         */
        function populateProgramList(programs, mainCode) {
            programListEl.innerHTML = ''; // Vyčistit

            // 1. Přidat hlavní program
            const mainEl = document.createElement('div');
            mainEl.textContent = "HLAVNÍ PROGRAM (.mpf)";
            mainEl.className = "file-item p-2 rounded-md cursor-pointer text-gray-700";
            mainEl.onclick = () => displayFileContent('main_program');
            programListEl.appendChild(mainEl);

            // Uložit obsah hlavního programu pod speciální klíč
            loadedData.loadedPrograms['main_program'] = mainCode;

            // 2. Přidat podprogramy
            const subprogramNames = Object.keys(programs).sort();
            for (const filename of subprogramNames) {
                // Přeskočit 'main_program', ten už máme
                if (filename === 'main_program') continue; 

                const el = document.createElement('div');
                el.textContent = filename;
                el.className = "file-item p-2 rounded-md cursor-pointer text-gray-700";
                el.onclick = () => displayFileContent(filename);
                programListEl.appendChild(el);
            }
        }

        /**
         * Zobrazí obsah vybraného souboru v editoru
         */
        function displayFileContent(filename) {
            if (loadedData.loadedPrograms[filename] !== undefined) {
                mainEditor.value = loadedData.loadedPrograms[filename];
                currentFileNameEl.textContent = (filename === 'main_program') ? "Hlavní program" : filename;

                // Aktualizovat aktivní třídu
                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.textContent.startsWith(filename) || (filename === 'main_program' && item.textContent.startsWith("HLAVNÍ"))) {
                        item.classList.add('active');
                    }
                });
            } else {
                console.warn(`Soubor ${filename} nebyl nalezen v loadedData.`);
            }
        }

        /**
         * Zobrazí R-Parametry v postranním panelu
         */
        function populateParameters(parameters) {
            parameterListEl.innerHTML = ''; // Vyčistit
            
            // Filtrovat jen nenulové
            const filteredParams = parameters.filter(([key, value]) => value !== 0);

            // Seřadit
            filteredParams.sort((a, b) => {
                const numA = parseInt(a[0].replace('R', ''));
                const numB = parseInt(b[0].replace('R', ''));
                return numA - numB;
            });

            if (filteredParams.length === 0) {
                parameterListEl.innerHTML = '<span class="text-gray-500">Žádné aktivní parametry.</span>';
                return;
            }

            for (const [key, value] of filteredParams) {
                const el = document.createElement('div');
                el.className = "flex justify-between";
                el.innerHTML = `<span class="text-gray-600">${key}:</span> <span class="font-semibold text-gray-800">${Number(value).toFixed(3)}</span>`;
                parameterListEl.appendChild(el);
            }
        }

        /**
         * Vypočítá a zobrazí celkový strojní čas
         */
        function calculateMachiningTime(movements) {
            let totalTimeMinutes = 0;

            if (!movements || movements.length === 0) {
                totalTimeEl.textContent = "N/A";
                return;
            }

            for (const move of movements) {
                // Přeskočit G0 (rapid) pohyby, ty jsou pro výpočet času (obvykle) irelevantní
                if (move.rapid) continue;

                // 1. Vypočítat délku dráhy
                let distance = 0;
                if (move.isArc && move.arcPoints && move.arcPoints.length > 1) {
                    // Pro oblouk sečteme délky jednotlivých segmentů
                    let lastPoint = { x: move.fromX, z: move.fromZ };
                    for (const point of move.arcPoints) {
                        distance += Math.hypot(point.x - lastPoint.x, point.z - lastPoint.z);
                        lastPoint = point;
                    }
                } else if (!move.isArc) {
                    // Pro přímý pohyb (G1)
                    distance = Math.hypot(move.toX - move.fromX, move.toZ - move.fromZ);
                }

                if (distance === 0) continue;

                // 2. Vypočítat čas pro tento pohyb (v minutách)
                let timeForMove = 0;

                if (move.feedMode === 'G95') { // Posuv na otáčku (mm/ot)
                    const feedPerMinute = move.feedRate * move.spindleSpeed; // mm/min
                    if (feedPerMinute > 0) {
                        timeForMove = distance / feedPerMinute; // min
                    }
                } else { // G94 - Posuv za minutu (mm/min)
                    if (move.feedRate > 0) {
                        timeForMove = distance / move.feedRate; // min
                    }
                }
                
                totalTimeMinutes += timeForMove;
            }

            // 3. Zobrazit výsledek
            const time = formatTime(totalTimeMinutes);
            totalTimeEl.textContent = time.formatted;
            timeDetailsEl.textContent = `(${totalTimeMinutes.toFixed(2)} minut)`;
        }

        /**
         * Převede minuty na formát H:MM:SS
         */
        function formatTime(totalMinutes) {
            const totalSeconds = Math.floor(totalMinutes * 60);
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => num.toString().padStart(2, '0');

            let formatted = "";
            if (hours > 0) {
                formatted = `${hours}:${pad(minutes)}:${pad(seconds)}`;
            } else {
                formatted = `${minutes}:${pad(seconds)}`;
            }

            return { formatted, hours, minutes, seconds };
        }

        /**
         * Uloží upravená data a vrátí se zpět do simulátoru
         */
        function saveAndClose() {
            // Najít aktivní soubor
            const activeItem = document.querySelector('.file-item.active');
            let activeFilename = 'main_program'; // Default
            if (activeItem) {
                 activeFilename = activeItem.textContent.startsWith("HLAVNÍ") ? 'main_program' : activeItem.textContent;
            }
            
            // Uložit aktuální obsah editoru do našeho globálního objektu
            loadedData.loadedPrograms[activeFilename] = mainEditor.value;

            // TODO: V budoucnu by zde byla složitější logika pro
            // "přepočítání" 'movements' a 'parameters' na základě změn v kódu.
            // Prozatím jen uložíme zpět upravené texty programů.

            // Aktualizovat data v localStorage
            // Uložíme jen upravený obsah programů
            const dataToSave = {
                ...loadedData,
                rawCode: loadedData.loadedPrograms['main_program'], // Aktualizovat hlavní kód
                // Ponechat staré movements a parameters, protože je zde neumíme přepočítat
            };
            
            localStorage.setItem('cncExternalEditorData', JSON.stringify(dataToSave));
            
            // Informovat uživatele a zavřít
            alert("Změny byly uloženy. \n\nVraťte se prosím ručně na záložku simulátoru a obnovte ji (F5), aby se změny načetly.");
            // window.close(); // Zavření okna nemusí vždy fungovat
        }

    </script>
</body>
</html>