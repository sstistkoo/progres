<!DOCTYPE html>
<html lang="cs" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Hlavní Editor</title>
    <!-- Načtení Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Načtení Font Awesome pro ikony -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <!-- Knihovna CodeMirror pro syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <!-- Téma pro CodeMirror (světlé) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/eclipse.min.css">
    
    <style>
        .file-item:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .file-item.active {
            background-color: #dbeafe; /* blue-100 */
            font-weight: 600;
            color: #1d4ed8; /* blue-700 */
        }
        
        #parameter-list::-webkit-scrollbar {
            width: 6px;
        }
        #parameter-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* cool-gray-300 */
            border-radius: 3px;
        }
        #program-list::-webkit-scrollbar {
            width: 6px;
        }
        #program-list::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* cool-gray-300 */
            border-radius: 3px;
        }
        
        .CodeMirror {
            flex: 1; 
            width: 100%;
            height: 100%;
            font-family: 'Menlo', 'Monaco', 'Consolas', monospace;
            font-size: 14px; 
            line-height: 1.4;
        }
    </style>
</head>
<body class="h-full flex flex-col">

    <div class="flex-1 flex relative overflow-hidden">

        <!-- Levý postranní panel (Nástroje) -->
        <nav id="tools-panel" class="fixed lg:relative inset-y-0 left-0 w-80 h-full bg-white border-r border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            
            <div class="flex justify-between items-center p-4 border-b lg:hidden">
                <h2 class="text-lg font-semibold text-gray-800">Nástroje</h2>
                <button id="tools-close-btn" class="p-1 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            
            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Nástroje</h2>
                <div class="mt-2 space-y-2">
                    <button id="convert-to-absolute-btn" class="w-full px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors duration-200">
                        Převést na Absolutní G-kód
                    </button>
                    <p class="text-xs text-gray-500">
                        Vygeneruje G-kód ze všech pohybů (G0, G1, G2, G3) načtených ze simulátoru.
                    </p>
                </div>
            </div>
            
        </nav>

        <!-- Pravý postranní panel (Detaily a Programy) -->
        <aside id="details-panel" class="fixed lg:relative inset-y-0 right-0 w-80 h-full bg-white border-l border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out">
            <div class="flex justify-between items-center p-4 border-b lg:hidden">
                <h2 class="text-lg font-semibold text-gray-800">Detaily a Programy</h2>
                <button id="details-close-btn" class="p-1 text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>

            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Načtené programy</h2>
                <div id="program-list" class="mt-2 h-64 overflow-y-auto bg-gray-50 rounded-lg p-2 text-sm space-y-1">
                    <p class="text-gray-500 text-sm">Načítání dat...</p>
                </div>
            </div>

            <div class="p-4 border-b">
                <h2 class="text-lg font-semibold text-gray-800">Strojní čas</h2>
                <div id="time-summary" class="mt-2 p-3 bg-gray-50 rounded-lg">
                    <p class="text-sm text-gray-600">Celkový čas (G1, G2, G3):</p>
                    <p id="total-time" class="text-2xl font-bold text-blue-600">Výpočet...</p>
                    <p id="time-details" class="text-xs text-gray-500"></p>
                </div>
            </div>

            <div class="p-4 flex-1">
                <h2 class="text-lg font-semibold text-gray-800">R-Parametry</h2>
                <div id="parameter-list" class="mt-2 h-64 overflow-y-auto bg-gray-50 rounded-lg p-2 text-sm font-mono space-y-1">
                    <!-- Sem se dynamicky vloží parametry -->
                </div>
            </div>
        </aside>

        <!-- Overlay pro ztmavení pozadí na mobilu -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Hlavní obsah (Editor) -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Záhlaví editoru -->
            <div class="bg-white border-b border-gray-200 p-3 flex justify-between items-center">
                
                <div class="flex items-center gap-2">
                    <button id="tools-open-btn" class="p-2 mr-0 text-gray-600 hover:text-gray-800 lg:hidden">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
                
                <h1 id="current-file-name" class="text-xl font-semibold text-gray-900 truncate mx-2">
                    Editor
                </h1>
                
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="save-btn" onclick="copyToClipboard()" class="ml-0 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors duration-200">
                        Uložit
                    </button>
                    <button id="close-btn" onclick="closeTab()" title="Zavřít záložku" class="px-3 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50">
                        <i class="fas fa-times"></i>
                    </button>
                    
                    <button id="details-open-btn" class="p-2 ml-1 text-gray-600 hover:text-gray-800 lg:hidden">
                        <i class="fas fa-list-ul fa-lg"></i>
                    </button>
                </div>
            </div>
            
            <textarea id="main-editor" spellcheck="false" placeholder="Načtěte data ze simulátoru..."></textarea>
        </main>
    </div>

    <!-- JS Knihovny pro CodeMirror -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/gcode/gcode.min.js"></script>

    <script>
        // Globální úložiště pro načtená data
        let loadedData = {
            mainProgramName: "", 
            parameters: [],
            programData: {} // Změna: už ne movements a loadedPrograms
        };
        
        let originalCodeStore = "";
        let isShowingAbsoluteCode = false;

        // DOM Elementy
        const mainEditor = document.getElementById('main-editor');
        const programListEl = document.getElementById('program-list');
        const parameterListEl = document.getElementById('parameter-list');
        const totalTimeEl = document.getElementById('total-time');
        const timeDetailsEl = document.getElementById('time-details');
        const currentFileNameEl = document.getElementById('current-file-name');
        
        let cmEditor;

        // DOM Elementy pro mobilní menu
        const toolsPanel = document.getElementById('tools-panel');
        const overlay = document.getElementById('overlay');
        const toolsOpenBtn = document.getElementById('tools-open-btn');
        const toolsCloseBtn = document.getElementById('tools-close-btn');

        const detailsPanel = document.getElementById('details-panel');
        const detailsOpenBtn = document.getElementById('details-open-btn');
        const detailsCloseBtn = document.getElementById('details-close-btn');

        /**
         * Načte data z localStorage a spustí naplnění UI
         */
        function loadDataFromStorage() {
            const dataString = localStorage.getItem('cncExternalEditorData');
            if (!dataString) {
                cmEditor.setValue("CHYBA: V localStorage nebyla nalezena žádná data (cncExternalEditorData).\n\nZkuste se vrátit do simulátoru a znovu kliknout na tlačítko 'Upravit'.");
                programListEl.innerHTML = '<p class="text-red-500 text-sm">Data nenalezena.</p>';
                totalTimeEl.textContent = "Chyba";
                return;
            }

            try {
                loadedData = JSON.parse(dataString);

                if (!loadedData.programData || !loadedData.parameters || !loadedData.mainProgramName) {
                    throw new Error("Data v localStorage jsou nekompletní nebo chybí 'programData' / 'mainProgramName'.");
                }

                populateProgramList(loadedData.programData);
                populateParameters(loadedData.parameters);
                
                // Zobrazit hlavní program (tím se spočítá i čas)
                displayFileContent(loadedData.mainProgramName); 

            } catch (error) {
                console.error("Chyba při parsování dat z localStorage:", error);
                cmEditor.setValue(`CHYBA: Nepodařilo se zpracovat data z localStorage.\n\n${error.message}`);
            }
        }

        /**
         * Nastaví listenery pro otevírání/zavírání menu
         */
        function setupPanelListeners() {
            if (toolsOpenBtn && toolsCloseBtn && toolsPanel && overlay) {
                toolsOpenBtn.addEventListener('click', openToolsPanel);
                toolsCloseBtn.addEventListener('click', closeToolsPanel);
            }
            
            if (detailsOpenBtn && detailsCloseBtn && detailsPanel) {
                detailsOpenBtn.addEventListener('click', openDetailsPanel);
                detailsCloseBtn.addEventListener('click', closeDetailsPanel);
            }
            
            if (overlay) {
                overlay.addEventListener('click', () => {
                    closeToolsPanel();
                    closeDetailsPanel(); 
                });
            }
        }
        
        function openToolsPanel() {
            closeDetailsPanel(); 
            toolsPanel.classList.remove('-translate-x-full');
            overlay.classList.remove('hidden');
        }

        function closeToolsPanel() {
            toolsPanel.classList.add('-translate-x-full');
            if (detailsPanel && detailsPanel.classList.contains('translate-x-full')) {
                overlay.classList.add('hidden');
            }
        }
        
        function openDetailsPanel() {
            closeToolsPanel(); 
            detailsPanel.classList.remove('translate-x-full');
            overlay.classList.remove('hidden');
        }

        function closeDetailsPanel() {
            detailsPanel.classList.add('translate-x-full');
            if (toolsPanel && toolsPanel.classList.contains('-translate-x-full')) {
                overlay.classList.add('hidden');
            }
        }
        

        /**
         * Naplní seznam souborů v postranním panelu
         */
        function populateProgramList(programData) {
            programListEl.innerHTML = ''; 

            const subprogramNames = Object.keys(programData).sort();
            
            for (const filename of subprogramNames) {
                const el = document.createElement('div');
                el.textContent = filename;
                el.dataset.filename = filename;
                el.className = "file-item p-2 rounded-md cursor-pointer text-gray-700";
                el.onclick = () => displayFileContent(filename);
                programListEl.appendChild(el);
            }
        }

        /**
         * Zobrazí obsah vybraného souboru v editoru
         */
        function displayFileContent(filename) {
            if (loadedData.programData[filename] !== undefined) {
                cmEditor.setValue(loadedData.programData[filename].text);
                currentFileNameEl.textContent = filename; 

                // Vypočítat strojní čas pro TENTO konkrétní program
                calculateMachiningTime(loadedData.programData[filename].movements);

                document.querySelectorAll('.file-item').forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.filename === filename) {
                        item.classList.add('active');
                    }
                });

                if (detailsOpenBtn.offsetParent !== null) {
                    closeDetailsPanel();
                }

                if (isShowingAbsoluteCode) {
                    const convertBtn = document.getElementById('convert-to-absolute-btn');
                    convertBtn.textContent = "Převést na Absolutní G-kód";
                    convertBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                    convertBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                    isShowingAbsoluteCode = false;
                    originalCodeStore = "";
                }

            } else {
                console.warn(`Soubor ${filename} nebyl nalezen v loadedData.`);
            }
        }

        /**
         * Zobrazí R-Parametry v postranním panelu
         */
        function populateParameters(parameters) {
            parameterListEl.innerHTML = ''; 
            
            const filteredParams = parameters.filter(([key, value]) => value !== 0);

            filteredParams.sort((a, b) => {
                const numA = parseInt(a[0].replace('R', ''));
                const numB = parseInt(b[0].replace('R', ''));
                return numA - numB;
            });

            if (filteredParams.length === 0) {
                parameterListEl.innerHTML = '<span class="text-gray-500">Žádné aktivní parametry.</span>';
                return;
            }

            for (const [key, value] of filteredParams) {
                const el = document.createElement('div');
                el.className = "flex justify-between";
                el.innerHTML = `<span class="text-gray-600">${key}:</span> <span class="font-semibold text-gray-800">${Number(value).toFixed(3)}</span>`;
                parameterListEl.appendChild(el);
            }
        }

        /**
         * Vypočítá a zobrazí celkový strojní čas
         */
        function calculateMachiningTime(movements) {
            let totalTimeMinutes = 0;

            if (!movements || movements.length === 0) {
                totalTimeEl.textContent = "N/A";
                return;
            }

            for (const move of movements) {
                if (move.rapid) continue;

                let distance = 0;
                if (move.isArc && move.arcPoints && move.arcPoints.length > 1) {
                    let lastPoint = { x: move.fromX, z: move.fromZ };
                    for (const point of move.arcPoints) {
                        distance += Math.hypot(point.x - lastPoint.x, point.z - lastPoint.z);
                        lastPoint = point;
                    }
                } else if (!move.isArc) {
                    distance = Math.hypot(move.toX - move.fromX, move.toZ - move.fromZ);
                }

                if (distance === 0) continue;

                let timeForMove = 0;

                if (move.feedMode === 'G95') { 
                    const feedPerMinute = move.feedRate * move.spindleSpeed; 
                    if (feedPerMinute > 0) {
                        timeForMove = distance / feedPerMinute; 
                    }
                } else { 
                    if (move.feedRate > 0) {
                        timeForMove = distance / move.feedRate; 
                    }
                }
                
                totalTimeMinutes += timeForMove;
            }

            const time = formatTime(totalTimeMinutes);
            totalTimeEl.textContent = time.formatted;
            timeDetailsEl.textContent = `(${totalTimeMinutes.toFixed(2)} minut)`;
        }

        /**
         * Převede minuty na formát H:MM:SS
         */
        function formatTime(totalMinutes) {
            const totalSeconds = Math.floor(totalMinutes * 60);
            
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const pad = (num) => num.toString().padStart(2, '0');

            let formatted = "";
            if (hours > 0) {
                formatted = `${hours}:${pad(minutes)}:${pad(seconds)}`;
            } else {
                formatted = `${minutes}:${pad(seconds)}`;
            }

            return { formatted, hours, minutes, seconds };
        }

        /**
         * Zkopíruje aktuální obsah editoru do schránky
         */
        async function copyToClipboard() {
            const textToCopy = cmEditor.getValue();
            const saveBtn = document.getElementById('save-btn');
            
            if (!saveBtn) return;
            const originalText = saveBtn.textContent;

            try {
                await navigator.clipboard.writeText(textToCopy);
                
                saveBtn.textContent = 'Zkopírováno!';
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-red-500');
                saveBtn.classList.add('bg-green-500');

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('bg-green-500');
                    saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);

            } catch (err) {
                console.error('Chyba při kopírování do schránky: ', err);

                saveBtn.textContent = 'Chyba!';
                saveBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'bg-green-500');
                saveBtn.classList.add('bg-red-500');

                setTimeout(() => {
                    saveBtn.textContent = originalText;
                    saveBtn.classList.remove('bg-red-500');
                    saveBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 3000);
            }
        }
        
        /**
         * Zavře aktuální záložku prohlížeče
         */
        function closeTab() {
            window.close();
        }

        /**
         * Pomocná funkce pro formátování čísel do G-kódu
         */
        function formatNum(num) {
            let s = Number(num).toFixed(3);
            if (s.indexOf('.') > -1) {
                 s = s.replace(/\.?0+$/, '');
            }
            if (s === "") return "0"; 
            return s;
        }

        /**
         * Spravuje přepínání mezi absolutním a původním kódem
         */
        function toggleAbsoluteCodeView() {
            const convertBtn = document.getElementById('convert-to-absolute-btn');
            if (isShowingAbsoluteCode) {
                cmEditor.setValue(originalCodeStore);
                originalCodeStore = "";
                
                convertBtn.textContent = "Převést na Absolutní G-kód";
                convertBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600');
                convertBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                
                isShowingAbsoluteCode = false;
                
                const activeItem = document.querySelector('.file-item.active');
                if (activeItem) {
                    currentFileNameEl.textContent = activeItem.dataset.filename;
                } else {
                    currentFileNameEl.textContent = loadedData.mainProgramName;
                }

            } else {
                originalCodeStore = cmEditor.getValue();
                
                const success = convertGCodeToAbsolute(); 
                
                if (success) {
                    convertBtn.textContent = "Vrátit zpět na původní kód";
                    convertBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                    convertBtn.classList.add('bg-gray-500', 'hover:bg-gray-600');
                    
                    isShowingAbsoluteCode = true;
                } else {
                    originalCodeStore = ""; 
                }
            }
        }

        /**
         * Převede 'movements' z localStorage na absolutní G-kód
         */
        function convertGCodeToAbsolute() {
            let activeFilename = loadedData.mainProgramName;
            const activeItem = document.querySelector('.file-item.active');
            if (activeItem) {
                activeFilename = activeItem.dataset.filename;
            }
            
            const movements = loadedData.programData[activeFilename]?.movements;

            if (!movements || movements.length === 0) {
                alert("CHYBA: Pro tento program nejsou načtena žádná data o pohybech ze simulátoru.");
                return false; 
            }
            
            const originalLines = originalCodeStore.split('\n');
            const originalHeader = originalLines.slice(0, 2).map(line => `; ${line.trim()}`);

            let newCode = [];
            newCode.push('; --- KÓD PŘEVEDENÝ NA ABSOLUTNÍ HODNOTY ---');
            newCode.push(...originalHeader);
            newCode.push(';');
            newCode.push('G90 ; Absolutní souřadnice');
            
            let lastFeed = -1;
            let lastSpindleSpeed = -1;
            let lastMoveType = ""; 
            let lastFeedMode = "";
            let lastSpindleMode = "";

            for (const move of movements) {
                let lineParts = [];

                if (move.feedMode !== lastFeedMode) {
                    lineParts.push(move.feedMode);
                    lastFeedMode = move.feedMode;
                }
                if (move.spindleMode !== lastSpindleMode) {
                    lineParts.push(move.spindleMode);
                    lastSpindleMode = move.spindleMode;
                }
                
                if (move.type !== lastMoveType) {
                    lineParts.push(move.type);
                    lastMoveType = move.type;
                }
                
                if (move.spindleSpeed !== lastSpindleSpeed) {
                    lineParts.push(`S${formatNum(move.spindleSpeed)}`);
                    lastSpindleSpeed = move.spindleSpeed;
                }

                const x = formatNum(move.toX);
                const z = formatNum(move.toZ);
                lineParts.push(`X${x}`);
                lineParts.push(`Z${z}`);
                
                if (move.isArc && move.center) {
                    const i = formatNum(move.center.x - move.fromX);
                    const k = formatNum(move.center.z - move.fromZ);
                    lineParts.push(`I${i}`);
                    lineParts.push(`K${k}`);
                }

                if (!move.rapid) {
                    const f = formatNum(move.feedRate);
                    if (move.feedRate !== lastFeed) {
                        lineParts.push(`F${f}`);
                        lastFeed = move.feedRate;
                    }
                } else {
                    lastFeed = -1; 
                }
                
                newCode.push(lineParts.join(' '));
            }

            cmEditor.setValue(newCode.join('\n'));
            
            // Nastavení záhlaví
            let activeFilenameForTitle = loadedData.mainProgramName;
            const activeItemForTitle = document.querySelector('.file-item.active');
            if (activeItemForTitle) {
                activeFilenameForTitle = activeItemForTitle.dataset.filename;
            }
            currentFileNameEl.textContent = `${activeFilenameForTitle} (Absolutní)`;

            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('active');
            });

            if (toolsOpenBtn.offsetParent !== null) {
                closeToolsPanel();
            }
            
            return true; 
        }

        /**
         * Spuštění po načtení DOM
         */
        window.addEventListener('DOMContentLoaded', () => {
            
            cmEditor = CodeMirror.fromTextArea(mainEditor, {
                lineNumbers: true,      
                mode: 'text/x-gcode', // OPRAVA: 'gcode' změněno na 'text/x-gcode'
                theme: 'eclipse',       
                lineWrapping: true,     
                readOnly: false
            });
            
            const cmWrapper = cmEditor.getWrapperElement();
            cmWrapper.style.flex = '1';
            cmWrapper.style.minHeight = '0'; 
            
            loadDataFromStorage();
            setupPanelListeners();
            
            const convertBtn = document.getElementById('convert-to-absolute-btn');
            if (convertBtn) {
                convertBtn.addEventListener('click', toggleAbsoluteCodeView); 
            }
        });

    </script>
</body>
</html>
