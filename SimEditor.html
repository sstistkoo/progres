<!DOCTYPE html>
<html lang="cs" class="h-full bg-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CNC Hlavní Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Styl scrollbarů */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }

        /* Editor a UI styly */
        .file-item { transition: all 0.2s; border-left: 4px solid transparent; }
        .file-item:hover { background-color: #e5e7eb; }
        .dark .file-item:hover { background-color: #374151; }
        .file-item.active { background-color: #dbeafe; border-left-color: #1d4ed8; }
        .dark .file-item.active { background-color: #1e40af; border-left-color: #60a5fa; }
        .file-item.active .truncate { color: #1e40af; font-weight: 600; }
        .dark .file-item.active .truncate { color: #bfdbfe; }
        
        .editor-wrapper { position: relative; width: 100%; height: 100%; background-color: #ffffff; overflow: hidden; }
        .editor-common { position: absolute; top: 0; left: 0; width: 100%; height: 100%; margin: 0; padding: 1rem; border: none; font-family: 'Menlo', 'Monaco', 'Consolas', 'Courier New', monospace; font-size: 15px; line-height: 1.6; white-space: pre; overflow: auto; box-sizing: border-box; tab-size: 4; }
        
        #editor-backdrop { z-index: 1; pointer-events: none; background-color: #fff; color: #374151 !important; }
        .dark #editor-backdrop { background-color: #1f2937; color: #d1d5db !important; }
        
        #main-editor { z-index: 2; color: transparent; background-color: transparent; caret-color: #000; resize: none; outline: none; }
        .dark #main-editor { caret-color: #fff; }
        #main-editor::selection { background-color: rgba(0, 120, 215, 0.3); color: transparent; }

        /* Syntax Highlighting */
        .hl-g { color: #2563eb; font-weight: bold; } .dark .hl-g { color: #60a5fa; }
        .hl-m { color: #db2777; font-weight: bold; } .dark .hl-m { color: #f472b6; }
        .hl-coord { color: #059669; } .dark .hl-coord { color: #34d399; }
        .hl-val { color: #d97706; } .dark .hl-val { color: #fbbf24; }
        .hl-feed { color: #0891b2; font-weight: bold; } .dark .hl-feed { color: #22d3ee; }
        .hl-param { color: #7c3aed; } .dark .hl-param { color: #a78bfa; }
        .hl-comment { color: #9ca3af; font-style: italic; } .dark .hl-comment { color: #9ca3af; }
        .hl-msg { color: #b45309; } .dark .hl-msg { color: #f59e0b; }
        .hl-block { color: #6b7280; font-size: 0.9em; } .dark .hl-block { color: #6b7280; }
        .hl-logic { color: #dc2626; font-weight: bold; } .dark .hl-logic { color: #ef4444; }
        .hl-sub { color: #9333ea; font-weight: bold; } .dark .hl-sub { color: #c084fc; }
        .hl-error { text-decoration: underline wavy red; cursor: help; }

        /* Modal & Autocomplete */
        .modal { display: none; position: fixed; z-index: 50; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background-color: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 350px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 80vh; overflow-y: auto; }
        html.dark .modal-content { background-color: #1f2937; color: white; border: 1px solid #374151; }

        #autocomplete-list { display: none; position: absolute; background: white; border: 1px solid #ccc; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 100; max-height: 150px; overflow-y: auto; width: 150px; border-radius: 4px; }
        html.dark #autocomplete-list { background: #1f2937; border-color: #4b5563; }
        .autocomplete-item { padding: 8px 12px; cursor: pointer; font-size: 14px; font-family: monospace; border-bottom: 1px solid #eee; }
        html.dark .autocomplete-item { border-bottom-color: #374151; color: #e5e7eb; }
        .autocomplete-item:hover, .autocomplete-item.selected { background-color: #e0f2fe; }
        html.dark .autocomplete-item:hover, html.dark .autocomplete-item.selected { background-color: #1e3a8a; }
        
        /* Validation Results */
        .validation-list { list-style: none; padding: 0; margin: 0; }
        .validation-item { padding: 8px; border-bottom: 1px solid #eee; font-size: 14px; display: flex; align-items: flex-start; gap: 10px; }
        html.dark .validation-item { border-bottom-color: #374151; }
        .v-error { color: #dc2626; } html.dark .v-error { color: #f87171; }
        .v-warn { color: #d97706; } html.dark .v-warn { color: #fbbf24; }
        .v-success { color: #059669; } html.dark .v-success { color: #34d399; }
    </style>
</head>
<body class="h-full flex flex-col overflow-hidden">

    <div class="flex-1 flex relative overflow-hidden">
        <!-- PANEL NÁSTROJŮ (LEVÝ) -->
        <nav id="tools-panel" class="fixed lg:relative inset-y-0 left-0 w-80 h-full bg-white border-r border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b lg:hidden dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Nástroje</h2>
                <button id="tools-close-btn" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 border-b dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-3">Hlavní Funkce</h2>
                
                <button id="check-program-btn" class="w-full px-3 py-2.5 mb-3 bg-purple-600 text-white rounded-md hover:bg-purple-700 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-check-circle"></i> Kontrola programu
                </button>

                <button id="new-program-btn" class="w-full px-3 py-2.5 mb-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                    <i class="fas fa-plus"></i> Nový program
                </button>

                <!-- SEKCE MAZÁNÍ (DYNAMICKÁ) -->
                <div class="mb-6">
                    <!-- Tlačítko 1: Výchozí Smazat -->
                    <button id="btn-initial-delete" class="w-full px-3 py-2.5 bg-red-600 text-white rounded-md hover:bg-red-700 focus:outline-none shadow-sm flex items-center justify-center gap-2 transition-all">
                        <i class="fas fa-trash-alt"></i> Smazat program
                    </button>
                    
                    <!-- Skupina 2: Smazat další / Zpět (Výchozí skryté) -->
                    <div id="group-delete-active" class="hidden flex gap-2 animate-fade-in">
                        <button id="btn-delete-next" class="flex-[2] px-3 py-2.5 bg-red-700 text-white rounded-md hover:bg-red-800 focus:outline-none shadow-sm font-bold transition-colors flex items-center justify-center gap-1" title="Smazat aktuální soubor a zobrazit další">
                            <i class="fas fa-trash"></i> Smazat další
                        </button>
                        <button id="btn-undo" class="flex-1 px-3 py-2.5 bg-gray-500 text-white rounded-md hover:bg-gray-600 focus:outline-none shadow-sm transition-colors flex items-center justify-center gap-1" title="Vrátit smazaný soubor">
                            <i class="fas fa-undo"></i> Zpět <span id="undo-count" class="text-xs bg-gray-700 px-1.5 py-0.5 rounded-full ml-1">0</span>
                        </button>
                    </div>
                </div>

                <div class="space-y-3 mb-6">
                    <button id="convert-to-absolute-btn" class="w-full px-3 py-2.5 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                        <i class="fas fa-exchange-alt"></i> Převést na Absolutní
                    </button>
                    <p class="text-xs text-gray-500 dark:text-gray-400 leading-relaxed">Vygeneruje lineární G-kód (G90).</p>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mb-6">
                    <h3 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3 flex items-center gap-2">
                        <i class="fas fa-sort-numeric-down text-blue-500"></i> Přečíslování
                    </h3>
                    <div class="flex gap-2 mb-2">
                        <button id="renumber-all-btn" class="flex-1 px-2 py-2.5 bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-gray-700 text-sm font-medium rounded-md shadow-sm">Vše</button>
                        <button id="renumber-custom-btn" class="flex-1 px-2 py-2.5 bg-white border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white text-gray-700 text-sm font-medium rounded-md shadow-sm"><i class="fas fa-cog"></i></button>
                    </div>
                    <button id="undo-renumber-btn" class="w-full px-3 py-2 bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-300 text-xs font-medium rounded-md hidden">
                        <i class="fas fa-undo mr-1"></i> Vrátit zpět
                    </button>
                </div>

                <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
                    <button id="download-btn" class="w-full px-3 py-2.5 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none shadow-sm flex items-center justify-center gap-2">
                        <i class="fas fa-download"></i> Stáhnout soubor
                    </button>
                </div>
            </div>
            <div class="p-4 flex-1">
                 <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">Info o souboru</h2>
                 <div id="file-stats" class="text-sm text-gray-600 dark:text-gray-400 space-y-1">
                     <p>Řádků: <span id="line-count" class="font-mono font-bold">0</span></p>
                     <p>Velikost: <span id="char-count" class="font-mono font-bold">0</span> znaků</p>
                 </div>
            </div>
        </nav>

        <!-- PRAVÝ PANEL (Seznam souborů) -->
        <aside id="details-panel" class="fixed lg:relative inset-y-0 right-0 w-80 h-full bg-white border-l border-gray-200 overflow-y-auto flex flex-col shadow-lg z-40 transform translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out dark:bg-gray-800 dark:border-gray-700">
            <div class="flex justify-between items-center p-4 border-b lg:hidden dark:border-gray-700">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-white">Programy</h2>
                <button id="details-close-btn" class="p-1 text-gray-500 hover:text-gray-700 dark:text-gray-400"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-4 border-b bg-gray-50 dark:bg-gray-900 dark:border-gray-700">
                <h2 class="text-sm font-bold text-gray-500 dark:text-gray-400 uppercase tracking-wider mb-2">Načtené soubory</h2>
                <div id="program-list" class="h-48 overflow-y-auto bg-white border border-gray-200 rounded-lg text-sm dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300">
                    <p class="text-gray-400 text-center p-4 italic">Žádné soubory</p>
                </div>
            </div>
            <div class="p-4 flex-1">
                <h2 class="text-lg font-semibold text-gray-800 dark:text-gray-200 mb-2">R-Parametry</h2>
                <div id="parameter-list" class="h-64 overflow-y-auto bg-white border border-gray-200 rounded-lg p-2 text-sm font-mono space-y-1 dark:bg-gray-800 dark:border-gray-600 dark:text-gray-300"></div>
            </div>
        </aside>

        <!-- Overlay -->
        <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 hidden lg:hidden"></div>

        <!-- Renumber Modal -->
        <div id="renumber-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Přečíslování bloků</h3>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Start (N):</label>
                        <input type="number" id="renumber-start" value="10" class="w-full border border-gray-300 rounded-md px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Krok (+):</label>
                        <input type="number" id="renumber-step" value="10" class="w-full border border-gray-300 rounded-md px-3 py-2 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                    </div>
                </div>
                <div class="mb-6 p-3 bg-gray-50 rounded-md border border-gray-200 dark:bg-gray-800 dark:border-gray-700">
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="renumber-selection-only" class="w-4 h-4 text-blue-600 rounded">
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300 font-medium">Pouze označený text</span>
                    </label>
                </div>
                <div class="flex justify-end gap-3 pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button id="modal-cancel" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md transition-colors dark:text-gray-300 dark:hover:bg-gray-700">Zrušit</button>
                    <button id="modal-confirm" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-md shadow-sm">Použít</button>
                </div>
            </div>
        </div>

        <!-- Validation Result Modal -->
        <div id="validation-modal" class="modal">
            <div class="modal-content">
                <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white flex items-center gap-2">
                    <i class="fas fa-stethoscope text-purple-500"></i> Výsledek kontroly
                </h3>
                <div id="validation-results" class="mb-6 max-h-64 overflow-y-auto"></div>
                <div class="flex justify-end pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="document.getElementById('validation-modal').classList.remove('show')" class="px-4 py-2 bg-purple-600 text-white hover:bg-purple-700 rounded-md shadow-sm">Zavřít</button>
                </div>
            </div>
        </div>

        <!-- HLAVNÍ EDITOR -->
        <main class="flex-1 flex flex-col overflow-hidden min-w-0 relative bg-white dark:bg-gray-900">
            <div class="bg-white border-b border-gray-200 p-3 flex justify-between items-center shadow-sm z-10 dark:bg-gray-800 dark:border-gray-700">
                <div class="flex items-center gap-2"><button id="tools-open-btn" class="p-2 mr-0 text-gray-600 hover:text-gray-800 dark:text-gray-300 lg:hidden"><i class="fas fa-bars fa-lg"></i></button></div>
                <h1 id="current-file-name" class="text-lg font-bold text-gray-800 dark:text-gray-200 truncate mx-4 flex items-center gap-2"><i class="far fa-file-alt text-gray-400"></i> <span>Bez názvu</span></h1>
                <div class="flex items-center gap-2 flex-shrink-0">
                    <button id="dark-mode-toggle" class="px-3 py-1.5 text-gray-600 dark:text-yellow-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors" title="Tmavý režim">
                        <i class="fas fa-moon dark:hidden"></i><i class="fas fa-sun hidden dark:block"></i>
                    </button>
                    <button id="save-btn" onclick="copyToClipboard()" class="ml-0 px-3 py-1.5 bg-blue-600 text-white text-sm font-medium rounded hover:bg-blue-700 shadow-sm"><i class="far fa-copy mr-1"></i> Kopírovat</button>
                    <button id="close-btn" onclick="window.close()" class="px-3 py-1.5 bg-red-100 text-red-600 hover:bg-red-200 rounded"><i class="fas fa-times"></i></button>
                    <button id="details-open-btn" class="p-2 ml-1 text-gray-600 hover:text-gray-800 dark:text-gray-300 lg:hidden"><i class="fas fa-list-ul fa-lg"></i></button>
                </div>
            </div>
            
            <div class="relative flex-1 editor-wrapper">
                <div id="editor-backdrop" class="editor-common"><div id="editor-highlights"></div></div>
                <textarea id="main-editor" class="editor-common" spellcheck="false" placeholder="Zde pište CNC kód..."></textarea>
                <div id="autocomplete-list"></div>
            </div>
        </main>
    </div>

    <script>
        // --- GLOBÁLNÍ PROMĚNNÉ ---
        let loadedData = { mainProgramName: "", parameters: new Map(), loadedPrograms: {} };
        let currentFile = "";
        let deletedFilesStack = []; // Zásobník pro Zpět
        let originalCodeStore = "";
        let isShowingAbsoluteCode = false;
        let codeBeforeRenumbering = "";
        let isRenumbered = false;

        // --- ELEMENTY ---
        const els = {
            editor: document.getElementById('main-editor'),
            backdrop: document.getElementById('editor-backdrop'),
            highlights: document.getElementById('editor-highlights'),
            progList: document.getElementById('program-list'),
            paramList: document.getElementById('parameter-list'),
            fileName: document.querySelector('#current-file-name span'),
            
            // Tlačítka mazání
            btnInitialDelete: document.getElementById('btn-initial-delete'),
            groupDeleteActive: document.getElementById('group-delete-active'),
            btnDeleteNext: document.getElementById('btn-delete-next'),
            btnUndo: document.getElementById('btn-undo'),
            undoCount: document.getElementById('undo-count'),

            // Nástroje
            checkProgBtn: document.getElementById('check-program-btn'),
            newProgBtn: document.getElementById('new-program-btn'),
            convertBtn: document.getElementById('convert-to-absolute-btn'),
            renumberAllBtn: document.getElementById('renumber-all-btn'),
            renumberCustomBtn: document.getElementById('renumber-custom-btn'),
            undoRenumberBtn: document.getElementById('undo-renumber-btn'),
            downloadBtn: document.getElementById('download-btn'),
            
            // Panely
            toolsPanel: document.getElementById('tools-panel'),
            detailsPanel: document.getElementById('details-panel'),
            overlay: document.getElementById('overlay'),
            
            // Modals
            modal: document.getElementById('renumber-modal'),
            modalStart: document.getElementById('renumber-start'),
            modalStep: document.getElementById('renumber-step'),
            modalSelection: document.getElementById('renumber-selection-only'),
            modalConfirm: document.getElementById('modal-confirm'),
            modalCancel: document.getElementById('modal-cancel')
        };

        // --- FUNKCE PRO UKLÁDÁNÍ (Musí být definována před použitím) ---
        function saveToStorage() {
            if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) {
                loadedData.loadedPrograms[currentFile] = els.editor.value;
            }
            const dataToStore = {
                mainProgramName: loadedData.mainProgramName,
                parameters: Array.from(loadedData.parameters.entries()),
                loadedPrograms: loadedData.loadedPrograms
            };
            localStorage.setItem('cncExternalEditorData', JSON.stringify(dataToStore));
        }

        function copyToClipboard() {
            saveToStorage();
            navigator.clipboard.writeText(els.editor.value).then(() => {
                const b = document.getElementById('save-btn');
                const original = b.innerHTML;
                b.innerHTML = '<i class="fas fa-check"></i> Zkopírováno';
                b.classList.remove('bg-blue-600');
                b.classList.add('bg-green-600');
                setTimeout(() => {
                    b.innerHTML = original;
                    b.classList.add('bg-blue-600');
                    b.classList.remove('bg-green-600');
                }, 2000);
            });
        }

        // --- LOGIKA MAZÁNÍ (Zde je vaše nová logika) ---
        function deleteCurrentFile() {
            if (!currentFile || !loadedData.loadedPrograms[currentFile]) {
                alert("Žádný soubor ke smazání.");
                return;
            }

            // 1. Uložit do zásobníku (Undo)
            deletedFilesStack.push({
                name: currentFile,
                content: loadedData.loadedPrograms[currentFile]
            });

            // 2. Smazat
            delete loadedData.loadedPrograms[currentFile];

            // 3. Najít další soubor
            const keys = Object.keys(loadedData.loadedPrograms);
            if (keys.length > 0) {
                // Inteligentní výběr: zkusit najít MPF, jinak první
                const nextFile = keys.find(k => k.toUpperCase().endsWith('.MPF')) || keys[0];
                loadedData.mainProgramName = nextFile;
                displayFile(nextFile);
            } else {
                createNewProgram(); // Pokud nic nezbylo
            }

            renderProgs();
            saveToStorage();
            updateDeleteUI();
        }

        function undoDelete() {
            if (deletedFilesStack.length === 0) return;

            // 1. Vytáhnout poslední
            const fileToRestore = deletedFilesStack.pop();

            // 2. Obnovit
            loadedData.loadedPrograms[fileToRestore.name] = fileToRestore.content;
            
            // 3. Přepnout na něj
            loadedData.mainProgramName = fileToRestore.name;
            displayFile(fileToRestore.name);

            renderProgs();
            saveToStorage();
            updateDeleteUI();
        }

        function updateDeleteUI() {
            if (deletedFilesStack.length > 0) {
                // Máme co vracet -> Zobrazit skupinu "Další / Zpět"
                els.btnInitialDelete.classList.add('hidden');
                els.groupDeleteActive.classList.remove('hidden');
                els.groupDeleteActive.classList.add('flex');
                els.undoCount.textContent = deletedFilesStack.length;
            } else {
                // Zásobník prázdný -> Zobrazit jen "Smazat"
                els.groupDeleteActive.classList.add('hidden');
                els.groupDeleteActive.classList.remove('flex');
                els.btnInitialDelete.classList.remove('hidden');
            }
        }

        // --- OSTATNÍ FUNKCE EDITORU ---
        function escapeHtml(text) {
            return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        function applySyntaxHighlighting() {
            let text = els.editor.value;
            let lines = text.split('\n');
            let labels = new Set();
            
            lines.forEach(line => {
                const match = line.match(/^\s*(?:N\d+\s*)?([a-zA-Z0-9_]+):/);
                if (match) labels.add(match[1]);
            });

            let styled = lines.map(line => {
                let code = line;
                let comm = "";
                let cIdx = line.indexOf(';');
                if (cIdx !== -1) {
                    code = line.substring(0, cIdx);
                    comm = `<span class="hl-comment">${escapeHtml(line.substring(cIdx))}</span>`;
                }
                
                // Ochrana MSG
                let placeholders = [];
                code = code.replace(/(MSG\s*\()(.*?)(\))/gi, (match) => {
                    placeholders.push(`<span class="hl-msg">${escapeHtml(match)}</span>`);
                    return `__MSG_${placeholders.length-1}__`;
                });

                code = escapeHtml(code);

                code = code
                    .replace(/\b(N\d+)\b/g, '<span class="hl-block">$1</span>')
                    .replace(/\b(G[0-3]|G0[0-3])\b/g, '<span class="hl-g text-red-500">$1</span>')
                    .replace(/\b(G\d+)\b/g, '<span class="hl-g">$1</span>')
                    .replace(/\b(M\d+)\b/g, '<span class="hl-m">$1</span>')
                    .replace(/([XZIKCR])(\s*=?\s*[\-\d\.]+)/g, '<span class="hl-coord">$1</span><span class="hl-val">$2</span>')
                    .replace(/\b([FSTD]\d*[\.]?\d+)\b/g, '<span class="hl-feed">$1</span><span class="hl-val">$2</span>')
                    .replace(/\b(R\d+)/g, '<span class="hl-param">$1</span>')
                    .replace(/\b(GOTOF|GOTOB|IF|ELSE|ENDIF|STOPRE)\b/g, '<span class="hl-logic">$1</span>')
                    .replace(/\b(L\d+)\b/g, '<span class="hl-sub">$1</span>');

                code = code.replace(/__MSG_(\d+)__/g, (m, i) => placeholders[i]);
                return code + comm;
            });
            els.highlights.innerHTML = styled.join('<br>') + '<br>';
        }

        function displayFile(name) {
            if (currentFile && loadedData.loadedPrograms[currentFile] !== undefined) {
                loadedData.loadedPrograms[currentFile] = els.editor.value;
            }
            if (!loadedData.loadedPrograms[name]) return;

            currentFile = name;
            loadedData.mainProgramName = name;
            
            els.editor.value = loadedData.loadedPrograms[name];
            els.fileName.textContent = name;
            
            // Update active class in list
            document.querySelectorAll('.file-item').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.name === name) el.classList.add('active');
            });

            applySyntaxHighlighting();
            updateStats();
        }

        function renderProgs() {
            els.progList.innerHTML = '';
            Object.keys(loadedData.loadedPrograms).sort().forEach(name => {
                const div = document.createElement('div');
                div.className = "file-item p-2 cursor-pointer text-sm border-b border-gray-100 dark:border-gray-700";
                if (name === currentFile) div.classList.add('active');
                
                const isMpf = name.toUpperCase().endsWith('.MPF');
                div.innerHTML = `<div class="truncate"><i class="${isMpf?'fas fa-star text-yellow-500':'fas fa-code text-gray-400'} mr-2"></i>${name}</div>`;
                div.dataset.name = name;
                div.onclick = () => displayFile(name);
                els.progList.appendChild(div);
            });
        }

        function createNewProgram() {
            const name = `PROG_${Object.keys(loadedData.loadedPrograms).length + 1}.SPF`;
            loadedData.loadedPrograms[name] = "; Nový program\nN10 G90 G54\nM17";
            displayFile(name);
            renderProgs();
            saveToStorage();
        }

        function updateStats() {
            const text = els.editor.value;
            document.getElementById('line-count').textContent = text.split('\n').length;
            document.getElementById('char-count').textContent = text.length;
        }

        // --- INIT ---
        function init() {
            // Load Dark Mode
            if (localStorage.getItem('cnc-dark-mode') === 'true') document.documentElement.classList.add('dark');
            
            // Event Listeners
            document.getElementById('dark-mode-toggle').onclick = () => {
                document.documentElement.classList.toggle('dark');
                localStorage.setItem('cnc-dark-mode', document.documentElement.classList.contains('dark'));
            };

            // Scroll Sync
            els.editor.onscroll = () => {
                els.backdrop.scrollTop = els.editor.scrollTop;
                els.backdrop.scrollLeft = els.editor.scrollLeft;
            };
            els.editor.oninput = () => { applySyntaxHighlighting(); updateStats(); };

            // Bind Buttons
            els.btnInitialDelete.onclick = deleteCurrentFile;
            els.btnDeleteNext.onclick = deleteCurrentFile;
            els.btnUndo.onclick = undoDelete;
            els.newProgBtn.onclick = createNewProgram;
            
            // Load Data
            const raw = localStorage.getItem('cncExternalEditorData');
            if (raw) {
                loadedData = JSON.parse(raw);
                if (Array.isArray(loadedData.parameters)) loadedData.parameters = new Map(loadedData.parameters);
                else loadedData.parameters = new Map(Object.entries(loadedData.parameters || {}));
                
                const keys = Object.keys(loadedData.loadedPrograms);
                if (keys.length > 0) {
                    let startFile = loadedData.mainProgramName;
                    if (!loadedData.loadedPrograms[startFile]) startFile = keys[0];
                    displayFile(startFile);
                } else {
                    createNewProgram();
                }
                renderProgs();
            } else {
                createNewProgram();
            }
            
            // Mobile Menu Logic
            document.getElementById('tools-open-btn').onclick = () => {
                els.toolsPanel.classList.remove('-translate-x-full');
                els.overlay.classList.remove('hidden');
            };
            document.getElementById('tools-close-btn').onclick = () => {
                els.toolsPanel.classList.add('-translate-x-full');
                els.overlay.classList.add('hidden');
            };
            document.getElementById('details-open-btn').onclick = () => {
                els.detailsPanel.classList.remove('translate-x-full');
                els.overlay.classList.remove('hidden');
            };
            document.getElementById('details-close-btn').onclick = () => {
                els.detailsPanel.classList.add('translate-x-full');
                els.overlay.classList.add('hidden');
            };
            els.overlay.onclick = () => {
                els.toolsPanel.classList.add('-translate-x-full');
                els.detailsPanel.classList.add('translate-x-full');
                els.overlay.classList.add('hidden');
            };
        }

        // Spustit
        init();
    </script>
</body>
</html>
